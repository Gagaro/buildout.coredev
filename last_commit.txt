Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-07-22T15:57:09+02:00
Author: Timo Stollenwerk (tisto) <tisto@plone.org>
Commit: https://github.com/plone/plone.app.upgrade/commit/b19921ca79e311e00dd5e4ba95783c1168d7a63c

Fix for #745.

Files changed:
M plone/app/upgrade/v50/betas.py
M plone/app/upgrade/v50/profiles/to_beta3/controlpanel.xml

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index ee41c8e..6a7f7ca 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -206,8 +206,58 @@ def to50beta2(context):
         # will only be there if from older plone instance
         pass
 
+# configlet id -> category
+cp_mapping = {
+    # General
+    'DateAndTime': 'plone-general',
+    'LanguageSettings': 'plone-general',
+    'NavigationSettings': 'plone-general',
+    'PloneReconfig': 'plone-general',  # Site
+    'QuickInstaller': 'plone-general',  # Add-ons
+    'SearchSettings': 'plone-general',
+    'plone.app.discussion': 'plone-general',  # Discussion
+    'tinymce': 'plone-general',
+    'plone.app.theming': 'plone-general',
+    'socialmedia': 'plone-general',
+    'syndication': 'plone-general',
+    # Content
+    'ContentRules': 'plone-content',
+    'EditingSettings': 'plone-content',
+    'ImageSettings': 'plone-content',
+    'MarkupSettings': 'plone-content',
+    'TypesSettings': 'plone-content',
+    'dexterity-types': 'plone-content',
+    # Users
+    'UsersGroups': 'plone-users',
+    # Security
+    'FilterSettings': 'plone-security',
+    'SecuritySettings': 'plone-security',
+    'errorLog': 'plone-security',
+    # Advanced
+    'Maintenance': 'plone-advanced',
+    'ZMI': 'plone-advanced',
+    'plone.app.caching': 'plone-advanced',
+    'plone.app.registry': 'plone-advanced',
+    'resourceregistries': 'plone-advanced',
+}
+
 
 def to50beta3(context):
     """5.0beta2 -> 5.0beta3"""
     loadMigrationProfile(context, 'profile-plone.app.upgrade.v50:to50beta3')
     loadMigrationProfile(context, 'profile-plone.app.querystring:upgrade_to_8')
+    portal = getSite()
+    cp_tool = getToolByName(portal, 'portal_controlpanel')
+    group_ids = [x.get('id') for x in cp_tool.getGroups()]
+    for group_id in group_ids:
+        for configlet in cp_tool.listActions():
+            if configlet.id in cp_mapping.keys():
+                configlet.category = cp_mapping[configlet.id]
+
+    configlets = cp_tool.listActions()
+    configlet = [
+        x for x in configlets
+        if x.id == 'TypesSettings'
+    ][0]
+    configlet.title = "Content Settings"
+    configlet.url_expr = "string:${portal_url}/@@content-controlpanel"
diff --git a/plone/app/upgrade/v50/profiles/to_beta3/controlpanel.xml b/plone/app/upgrade/v50/profiles/to_beta3/controlpanel.xml
index 90c6930..a5971df 100644
--- a/plone/app/upgrade/v50/profiles/to_beta3/controlpanel.xml
+++ b/plone/app/upgrade/v50/profiles/to_beta3/controlpanel.xml
@@ -21,82 +21,4 @@
     i18n:attributes="title">
   <permission>Plone Site Setup: TinyMCE</permission>
  </configlet>
-
- <configlet title="Content Rules" action_id="ContentRules" appId="Plone"
-    category="plone-content">
- </configlet>
- <configlet title="Date and Time" action_id="DateAndTime" appId="DateAndTime"
-    category="plone-general">
- </configlet>
- <configlet title="Editing" action_id="EditingSettings" appId="Plone"
-    category="plone-content">
- </configlet>
- <configlet title="HTML Filtering" action_id="FilterSettings" appId="FilterSettings"
-    category="plone-security">
- </configlet>
- <configlet title="Image Handling" action_id="ImagingSettings" appId="ImagingSettings"
-    category="plone-content">
- </configlet>
- <configlet title="Language" action_id="LanguageSettings" appId="Plone"
-    category="plone-general">
- </configlet>
- <configlet title="Mail" action_id="MailHost" appId="MailHost"
-    category="plone-general">
- </configlet>
- <configlet title="Maintenance" action_id="Maintenance" appId="Plone"
-    category="plone-advanced">
- </configlet>
- <configlet title="Markup" action_id="MarkupSettings" appId="MarkupSettings"
-    category="plone-security">
- </configlet>
- <configlet title="Navigation" action_id="NavigationSettings" appId="Plone"
-    category="plone-general">
- </configlet>
- <configlet title="Site" action_id="PloneReconfig" appId="Plone"
-    category="plone-general">
- </configlet>
- <configlet title="Themes" action_id="PortalSkin" appId="PortalSkin"
-    category="plone-general">
- </configlet>
- <configlet title="Add-ons" action_id="QuickInstaller" appId="QuickInstaller"
-    category="plone-general">
- </configlet>
- <configlet title="Search" action_id="SearchSettings" appId="Plone"
-    category="plone-general">
- </configlet>
- <configlet title="Security" action_id="SecuritySettings" appId="SecuritySettings"
-    category="plone-security">
- </configlet>
- <configlet title="Content Settings" action_id="TypesSettings" appId="TypesSettings"
-    category="plone-content"
-    url_expr="string:${portal_url}/@@content-controlpanel">
- </configlet>
- <configlet title="Users and Groups" action_id="UsersGroups" appId="UsersGroups"
-    category="plone-users">
- </configlet>
- <configlet title="Zope Management Interface" action_id="ZMI" appId="ZMI"
-    category="plone-advanced">
- </configlet>
- <configlet title="Dexterity Content Types" action_id="dexterity-types" appId="Plone"
-    category="plone-content">
- </configlet>
- <configlet title="Discussion" action_id="discussion" appId="plone.app.discussion"
-    category="plone-content">
- </configlet>
- <configlet title="Errors" action_id="errorLog" appId="ErrorLog"
-    category="plone-security">
- </configlet>
- <configlet title="Caching" action_id="plone.app.caching" appId="plone.app.caching"
-    category="plone-general">
- </configlet>
- <configlet title="Configuration Registry" action_id="plone.app.registry" appId="plone.app.registry"
-    category="plone-advanced">
- </configlet>
- <configlet title="Theming" action_id="plone.app.theming" appId="plone.app.theming"
-    category="plone-general">
- </configlet>
- <configlet title="Syndication" action_id="syndication" appId="Plone"
-    category="plone-general">
- </configlet>
-
 </object>


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-07-22T16:07:03+02:00
Author: Timo Stollenwerk (tisto) <tisto@plone.org>
Commit: https://github.com/plone/plone.app.upgrade/commit/2de177605aeb7743741d130e73dbcb6a658e7b59

Upgrade changelog.

Files changed:
M CHANGES.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index 87aaf18..3f3253f 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,10 @@ Changelog
 1.3.12 (unreleased)
 -------------------
 
-- Nothing changed yet.
+- Fix for 5.0b2 -> 5.0b3 upgrade step that removed permissions from most of
+  the control panel configlets. This fixes:
+  https://github.com/plone/Products.CMFPlone/issues/745
+  [sneridagh, timo]
 
 
 1.3.11 (2015-07-20)


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-07-22T22:45:16+02:00
Author: Roel Bruggink (jaroel) <roel@jaroel.nl>
Commit: https://github.com/plone/plone.app.upgrade/commit/14a8f16baa265238be5292dc927ab2f57372480e

Cleanup

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 6a7f7ca..ea35560 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -248,11 +248,9 @@ def to50beta3(context):
     loadMigrationProfile(context, 'profile-plone.app.querystring:upgrade_to_8')
     portal = getSite()
     cp_tool = getToolByName(portal, 'portal_controlpanel')
-    group_ids = [x.get('id') for x in cp_tool.getGroups()]
-    for group_id in group_ids:
-        for configlet in cp_tool.listActions():
-            if configlet.id in cp_mapping.keys():
-                configlet.category = cp_mapping[configlet.id]
+    for configlet in cp_tool.listActions():
+        if configlet.id in cp_mapping:
+            configlet.category = cp_mapping[configlet.id]
 
     configlets = cp_tool.listActions()
     configlet = [


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-07-23T08:30:09+02:00
Author: Roel Bruggink (jaroel) <roel@jaroel.nl>
Commit: https://github.com/plone/plone.app.upgrade/commit/198086523d64447957d9b46de97a622d16485979

Merge pull request #39 from plone/fix-745

Fix for #745.

Files changed:
M CHANGES.rst
M plone/app/upgrade/v50/betas.py
M plone/app/upgrade/v50/profiles/to_beta3/controlpanel.xml

diff --git a/CHANGES.rst b/CHANGES.rst
index 87aaf18..3f3253f 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,10 @@ Changelog
 1.3.12 (unreleased)
 -------------------
 
-- Nothing changed yet.
+- Fix for 5.0b2 -> 5.0b3 upgrade step that removed permissions from most of
+  the control panel configlets. This fixes:
+  https://github.com/plone/Products.CMFPlone/issues/745
+  [sneridagh, timo]
 
 
 1.3.11 (2015-07-20)
diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index ee41c8e..ea35560 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -206,8 +206,56 @@ def to50beta2(context):
         # will only be there if from older plone instance
         pass
 
+# configlet id -> category
+cp_mapping = {
+    # General
+    'DateAndTime': 'plone-general',
+    'LanguageSettings': 'plone-general',
+    'NavigationSettings': 'plone-general',
+    'PloneReconfig': 'plone-general',  # Site
+    'QuickInstaller': 'plone-general',  # Add-ons
+    'SearchSettings': 'plone-general',
+    'plone.app.discussion': 'plone-general',  # Discussion
+    'tinymce': 'plone-general',
+    'plone.app.theming': 'plone-general',
+    'socialmedia': 'plone-general',
+    'syndication': 'plone-general',
+    # Content
+    'ContentRules': 'plone-content',
+    'EditingSettings': 'plone-content',
+    'ImageSettings': 'plone-content',
+    'MarkupSettings': 'plone-content',
+    'TypesSettings': 'plone-content',
+    'dexterity-types': 'plone-content',
+    # Users
+    'UsersGroups': 'plone-users',
+    # Security
+    'FilterSettings': 'plone-security',
+    'SecuritySettings': 'plone-security',
+    'errorLog': 'plone-security',
+    # Advanced
+    'Maintenance': 'plone-advanced',
+    'ZMI': 'plone-advanced',
+    'plone.app.caching': 'plone-advanced',
+    'plone.app.registry': 'plone-advanced',
+    'resourceregistries': 'plone-advanced',
+}
+
 
 def to50beta3(context):
     """5.0beta2 -> 5.0beta3"""
     loadMigrationProfile(context, 'profile-plone.app.upgrade.v50:to50beta3')
     loadMigrationProfile(context, 'profile-plone.app.querystring:upgrade_to_8')
+    portal = getSite()
+    cp_tool = getToolByName(portal, 'portal_controlpanel')
+    for configlet in cp_tool.listActions():
+        if configlet.id in cp_mapping:
+            configlet.category = cp_mapping[configlet.id]
+
+    configlets = cp_tool.listActions()
+    configlet = [
+        x for x in configlets
+        if x.id == 'TypesSettings'
+    ][0]
+    configlet.title = "Content Settings"
+    configlet.url_expr = "string:${portal_url}/@@content-controlpanel"
diff --git a/plone/app/upgrade/v50/profiles/to_beta3/controlpanel.xml b/plone/app/upgrade/v50/profiles/to_beta3/controlpanel.xml
index 90c6930..a5971df 100644
--- a/plone/app/upgrade/v50/profiles/to_beta3/controlpanel.xml
+++ b/plone/app/upgrade/v50/profiles/to_beta3/controlpanel.xml
@@ -21,82 +21,4 @@
     i18n:attributes="title">
   <permission>Plone Site Setup: TinyMCE</permission>
  </configlet>
-
- <configlet title="Content Rules" action_id="ContentRules" appId="Plone"
-    category="plone-content">
- </configlet>
- <configlet title="Date and Time" action_id="DateAndTime" appId="DateAndTime"
-    category="plone-general">
- </configlet>
- <configlet title="Editing" action_id="EditingSettings" appId="Plone"
-    category="plone-content">
- </configlet>
- <configlet title="HTML Filtering" action_id="FilterSettings" appId="FilterSettings"
-    category="plone-security">
- </configlet>
- <configlet title="Image Handling" action_id="ImagingSettings" appId="ImagingSettings"
-    category="plone-content">
- </configlet>
- <configlet title="Language" action_id="LanguageSettings" appId="Plone"
-    category="plone-general">
- </configlet>
- <configlet title="Mail" action_id="MailHost" appId="MailHost"
-    category="plone-general">
- </configlet>
- <configlet title="Maintenance" action_id="Maintenance" appId="Plone"
-    category="plone-advanced">
- </configlet>
- <configlet title="Markup" action_id="MarkupSettings" appId="MarkupSettings"
-    category="plone-security">
- </configlet>
- <configlet title="Navigation" action_id="NavigationSettings" appId="Plone"
-    category="plone-general">
- </configlet>
- <configlet title="Site" action_id="PloneReconfig" appId="Plone"
-    category="plone-general">
- </configlet>
- <configlet title="Themes" action_id="PortalSkin" appId="PortalSkin"
-    category="plone-general">
- </configlet>
- <configlet title="Add-ons" action_id="QuickInstaller" appId="QuickInstaller"
-    category="plone-general">
- </configlet>
- <configlet title="Search" action_id="SearchSettings" appId="Plone"
-    category="plone-general">
- </configlet>
- <configlet title="Security" action_id="SecuritySettings" appId="SecuritySettings"
-    category="plone-security">
- </configlet>
- <configlet title="Content Settings" action_id="TypesSettings" appId="TypesSettings"
-    category="plone-content"
-    url_expr="string:${portal_url}/@@content-controlpanel">
- </configlet>
- <configlet title="Users and Groups" action_id="UsersGroups" appId="UsersGroups"
-    category="plone-users">
- </configlet>
- <configlet title="Zope Management Interface" action_id="ZMI" appId="ZMI"
-    category="plone-advanced">
- </configlet>
- <configlet title="Dexterity Content Types" action_id="dexterity-types" appId="Plone"
-    category="plone-content">
- </configlet>
- <configlet title="Discussion" action_id="discussion" appId="plone.app.discussion"
-    category="plone-content">
- </configlet>
- <configlet title="Errors" action_id="errorLog" appId="ErrorLog"
-    category="plone-security">
- </configlet>
- <configlet title="Caching" action_id="plone.app.caching" appId="plone.app.caching"
-    category="plone-general">
- </configlet>
- <configlet title="Configuration Registry" action_id="plone.app.registry" appId="plone.app.registry"
-    category="plone-advanced">
- </configlet>
- <configlet title="Theming" action_id="plone.app.theming" appId="plone.app.theming"
-    category="plone-general">
- </configlet>
- <configlet title="Syndication" action_id="syndication" appId="Plone"
-    category="plone-general">
- </configlet>
-
 </object>


