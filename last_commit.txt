Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2015-08-21T17:06:16+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.contenttypes/commit/ec5bd9d0c2f0e66ad9faa25a15e35120b0c3c123

Fixed corner case in topic migration.

- Create Plone 4.1 site, so with old-style Topic.
- Update to Plone 4.3 (not sure if this step is needed).  Do NOT install the new plone.app.collection.
- Migrate to Plone 5.0.
- Somehow there now is a dexterity Collection type with plone.dexterity.content.Item as klass.  No idea where this comes from...
- Migrate from ATCT to dexterity and migrate the Topics and you get a TypeError because Item cannot be adapted to ICollection.
This commit fixes it.

Files changed:
M plone/app/contenttypes/migration/utils.py

diff --git a/plone/app/contenttypes/migration/utils.py b/plone/app/contenttypes/migration/utils.py
index 22abb17..24e4e33 100644
--- a/plone/app/contenttypes/migration/utils.py
+++ b/plone/app/contenttypes/migration/utils.py
@@ -130,8 +130,14 @@ def installTypeIfNeeded(type_name):
     tt = getToolByName(portal, 'portal_types')
     fti = tt.getTypeInfo(type_name)
     if IDexterityFTI.providedBy(fti):
-        # the dx-type is already installed
-        return
+        # The dx-type is already installed, so keep it.  But this
+        # might be an old dexterity type of Collection, in which case
+        # it is better to replace it.
+        if type_name != 'Collection':
+            return
+        if fti.klass == 'plone.app.contenttypes.content.Collection':
+            # If the klass is fine, we are happy.
+            return
     if fti:
         tt.manage_delObjects(type_name)
     tt.manage_addTypeInformation('Dexterity FTI', id=type_name)


