Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2015-08-13T20:28:40+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.contenttypes/commit/3c5256157bf9f2ce7e7fd98e8297692f72cf8d74

fix the setting of layout on the portal

Files changed:
M plone/app/contenttypes/upgrades.py

diff --git a/plone/app/contenttypes/upgrades.py b/plone/app/contenttypes/upgrades.py
index 6cb7a5d..831ec40 100644
--- a/plone/app/contenttypes/upgrades.py
+++ b/plone/app/contenttypes/upgrades.py
@@ -3,6 +3,7 @@
 from plone.app.contenttypes.utils import DEFAULT_TYPES
 from plone.dexterity.interfaces import IDexterityFTI
 from zope.component import queryUtility
+from zope.component.hooks import getSite
 import logging
 
 logger = logging.getLogger(name="plone.app.contenttypes upgrade")
@@ -132,9 +133,9 @@ def enable_shortname_behavior(context):
 
 def use_new_view_names(context, types_to_fix=None):  # noqa
     """Migrate old view names to new view names."""
-
     # Don't reload the profile. Only change the settings.
-    portal_types = getToolByName(context, 'portal_types')
+    portal = getSite()
+    portal_types = getToolByName(portal, 'portal_types')
     if types_to_fix is None:
         types_to_fix = ['Folder', 'Collection', 'Plone Site']
     outdated_methods = [
@@ -180,22 +181,24 @@ def use_new_view_names(context, types_to_fix=None):  # noqa
             )
             logger.info("Updated view_methods for {}".format(ctype))
 
-    catalog = getToolByName(context, 'portal_catalog')
+    def _fixup(obj, view_map):
+        current = obj.getLayout()
+        if current in view_map:
+            default_page = obj.getDefaultPage()
+            obj.setLayout(view_map[current])
+            logger.info("Set view to {} for {}".format(
+                view_map[current], obj.absolute_url()
+            ))
+            if default_page:
+                # any defaultPage is switched of by setLayout
+                # and needs to set again
+                obj.setDefaultPage(default_page)
+
+    catalog = getToolByName(portal, 'portal_catalog')
     search = catalog.unrestrictedSearchResults
-
-    def _fixup(portal_type, view_map):
+    for portal_type in types_to_fix:
         for brain in search(portal_type=portal_type):
             obj = brain.getObject()
-            current = obj.getLayout()
-            if current in view_map.keys():
-                default_page = obj.getDefaultPage()
-                obj.setLayout(view_map[current])
-                logger.info("Set view to {} for {}".format(
-                    view_map[current], obj.absolute_url()
-                ))
-                if default_page:
-                    # any defaultPage is switched of by setLayout
-                    # and needs to set again
-                    obj.setDefaultPage(default_page)
-    for type_ in types_to_fix:
-        _fixup(type_, LISTING_VIEW_MAPPING)
+            _fixup(obj, LISTING_VIEW_MAPPING)
+        if portal_type == 'Plone Site':
+            _fixup(context, LISTING_VIEW_MAPPING)


Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2015-08-13T20:32:22+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.contenttypes/commit/d8df92bcab46663c65044f6de2fe2a3b343b4e47

add plone.app.querystring as a dependency (fix collections migrated from p4 to p5)

Files changed:
M plone/app/contenttypes/profiles/default/metadata.xml

diff --git a/plone/app/contenttypes/profiles/default/metadata.xml b/plone/app/contenttypes/profiles/default/metadata.xml
index b687208..bebaa1f 100644
--- a/plone/app/contenttypes/profiles/default/metadata.xml
+++ b/plone/app/contenttypes/profiles/default/metadata.xml
@@ -3,6 +3,7 @@
  <dependencies>
   <dependency>profile-plone.app.dexterity:default</dependency>
   <dependency>profile-plone.app.event:default</dependency>
+  <dependency>profile-plone.app.querystring:default</dependency>
   <dependency>profile-plone.app.relationfield:default</dependency>
   <dependency>profile-plone.app.versioningbehavior:default</dependency>
   <dependency>profile-plone.app.z3cform:default</dependency>


Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2015-08-13T20:32:54+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.contenttypes/commit/b3456f7bd28e25918c89a4d5f09b7361a3060250

remove obsolete css

Files changed:
M plone/app/contenttypes/browser/configure.zcml
D plone/app/contenttypes/browser/stylesheets/collection.css
D plone/app/contenttypes/profiles/default/cssregistry.xml

diff --git a/plone/app/contenttypes/browser/configure.zcml b/plone/app/contenttypes/browser/configure.zcml
index 49136b1..8aedfcb 100644
--- a/plone/app/contenttypes/browser/configure.zcml
+++ b/plone/app/contenttypes/browser/configure.zcml
@@ -7,12 +7,6 @@
 
   <include package="plone.app.contentmenu" />
 
-  <browser:resource
-      name="collection.css"
-      file="stylesheets/collection.css"
-      layer="plone.app.contenttypes.interfaces.IPloneAppContenttypesLayer"/>
-
-
   <!-- VIEWS FOR PLONE SITE ROOT -->
   <browser:pages
       for="Products.CMFPlone.interfaces.IPloneSiteRoot"
diff --git a/plone/app/contenttypes/browser/stylesheets/collection.css b/plone/app/contenttypes/browser/stylesheets/collection.css
deleted file mode 100644
index f77fbe6..0000000
--- a/plone/app/contenttypes/browser/stylesheets/collection.css
+++ /dev/null
@@ -1,12 +0,0 @@
-/* using plone contenttypes sprite for collection */
-
-.icons-on .contenttype-collection {
-    background: no-repeat transparent 0 -1724px url(contenttypes-sprite.png);
-}
-
-.icons-on .contenttype-collection {
-    line-height: 2em;
-    display: inline-block;
-    *display: block;
-    padding-left: 20px !important;
-}
diff --git a/plone/app/contenttypes/profiles/default/cssregistry.xml b/plone/app/contenttypes/profiles/default/cssregistry.xml
deleted file mode 100644
index e8b5068..0000000
--- a/plone/app/contenttypes/profiles/default/cssregistry.xml
+++ /dev/null
@@ -1,6 +0,0 @@
-<?xml version="1.0"?>
-<object name="portal_css" meta_type="Stylesheets Registry">
-
- <stylesheet id="++resource++collection.css" />
-
-</object>


Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2015-08-13T20:35:22+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.contenttypes/commit/32e5d2976389b88ab07bf98fd3453fa0c540ec06

update changeling

Files changed:
M CHANGES.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index 769dea1..6f56f1b 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,6 +4,13 @@ Changelog
 1.2b4 (unreleased)
 ------------------
 
+- Remove obsolete collections.css
+  [pbauer]
+
+- Add plone.app.querystring as a dependency (fixes collections migrated to p5
+  and dexterity).
+  [pbauer]
+
 - Migrate layout using the new listing-views when migrating folders.
   [pbauer]
 


