Repository: plone.app.upgrade
Branch: refs/heads/master
Date: 2015-05-31T07:48:38-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.app.upgrade/commit/49b2cfdb9485e0835803be5a2f799848d4fb4a2f

restore upgrades but check the version of plone before running

Files changed:
M plone/app/upgrade/utils.py
M plone/app/upgrade/v40/alphas.py
M plone/app/upgrade/v42/betas.py
M plone/app/upgrade/v42/configure.zcml
M plone/app/upgrade/v43/alphas.py

diff --git a/plone/app/upgrade/utils.py b/plone/app/upgrade/utils.py
index 66e72ff..a98b30b 100644
--- a/plone/app/upgrade/utils.py
+++ b/plone/app/upgrade/utils.py
@@ -277,3 +277,11 @@ def updateIconsInBrains(context, typesToUpdate=None):
         i += 1
     pghandler.finish()
     logger.info('Updated `getIcon` metadata.')
+
+
+def isPlone5():
+    try:
+        from Products.CMFPlone import __version__
+        return __version__[0] == '5'
+    except:
+        return False
\ No newline at end of file
diff --git a/plone/app/upgrade/v40/alphas.py b/plone/app/upgrade/v40/alphas.py
index 7c00c4d..da66bbf 100644
--- a/plone/app/upgrade/v40/alphas.py
+++ b/plone/app/upgrade/v40/alphas.py
@@ -22,6 +22,7 @@
 from plone.app.upgrade.utils import logger
 from plone.app.upgrade.utils import loadMigrationProfile
 from plone.app.upgrade.utils import unregisterSteps
+from plone.app.upgrade.utils import isPlone5
 from plone.portlet.static.static import IStaticPortlet
 from plone.portlets.interfaces import IPortletAssignmentMapping
 from plone.portlets.interfaces import IPortletAssignmentSettings
@@ -66,6 +67,8 @@ def rememberTheme(context):
 def threeX_alpha1(context):
     """3.x -> 4.0alpha1
     """
+    if not isPlone5():
+        loadMigrationProfile(context, 'profile-plone.app.jquerytools:default')
     loadMigrationProfile(context, 'profile-plone.app.upgrade.v40:3-4alpha1')
     loadMigrationProfile(
         context, 'profile-Products.CMFPlone:dependencies',
diff --git a/plone/app/upgrade/v42/betas.py b/plone/app/upgrade/v42/betas.py
index 26ed0a6..6008d56 100644
--- a/plone/app/upgrade/v42/betas.py
+++ b/plone/app/upgrade/v42/betas.py
@@ -4,6 +4,7 @@
 
 from plone.app.upgrade.utils import loadMigrationProfile
 from plone.app.upgrade.utils import installOrReinstallProduct
+from plone.app.upgrade.utils import isPlone5
 from Products.CMFCore.utils import getToolByName
 
 logger = logging.getLogger('plone.app.upgrade')
@@ -50,6 +51,8 @@ def to42beta2(context):
 def to42rc1(context):
     """4.2b2 -> 4.2rc1
     """
+    if not isPlone5():
+        loadMigrationProfile(context, 'profile-plone.app.jquery:default')   
     loadMigrationProfile(context, 'profile-plone.app.upgrade.v42:to42rc1')
 
 
@@ -80,6 +83,4 @@ def to42rc1_member_dashboard(context):
 def to42rc2(context):
     """4.2rc1 -> 4.2rc2
     """
-    loadMigrationProfile(context, 'profile-plone.app.upgrade.v42:to42rc2')
-
-
+    loadMigrationProfile(context, 'profile-plone.app.upgrade.v42:to42rc2')
\ No newline at end of file
diff --git a/plone/app/upgrade/v42/configure.zcml b/plone/app/upgrade/v42/configure.zcml
index d077344..f24fba9 100644
--- a/plone/app/upgrade/v42/configure.zcml
+++ b/plone/app/upgrade/v42/configure.zcml
@@ -1,8 +1,10 @@
 <configure
     xmlns="http://namespaces.zope.org/zope"
     xmlns:genericsetup="http://namespaces.zope.org/genericsetup"
+    xmlns:zcml="http://namespaces.zope.org/zcml"
     i18n_domain="plone">
 
+    <include package="plone.app.jquery" zcml:condition="not-have plone-5" />
     <include file="profiles.zcml" />
 
     <genericsetup:upgradeSteps
diff --git a/plone/app/upgrade/v43/alphas.py b/plone/app/upgrade/v43/alphas.py
index 258b7d4..5f61f6b 100644
--- a/plone/app/upgrade/v43/alphas.py
+++ b/plone/app/upgrade/v43/alphas.py
@@ -4,6 +4,7 @@
 from Products.CMFCore.utils import getToolByName
 from Products.ZCatalog.ProgressHandler import ZLogHandler
 from plone.app.upgrade.utils import loadMigrationProfile
+from plone.app.upgrade.utils import isPlone5
 from plone.app.upgrade.v40.alphas import cleanUpToolRegistry
 from Products.ZCTextIndex.interfaces import IZCTextIndex
 
@@ -104,7 +105,9 @@ def upgradePloneAppTheming(context):
 def upgradePloneAppJQuery(context):
     """ Upgrade TinyMCE WYSIWYG Editor to jQuery based version 1.3
     """
-    pass
+    if not isPlone5():
+        from plone.app.jquery.upgrades import upgrade_2_to_3
+        upgrade_2_to_3(context)
 
 def to43alpha1(context):
     """4.2 -> 4.3alpha1"""
@@ -229,4 +232,4 @@ def removeKSS(context):
 def upgradeTinyMCEAgain(context):
     qi = getToolByName(context, 'portal_quickinstaller')
     if 'Products.TinyMCE' in qi:
-        qi.upgradeProduct('Products.TinyMCE')
+        qi.upgradeProduct('Products.TinyMCE')
\ No newline at end of file


