Repository: plone.app.linkintegrity


Branch: refs/heads/master
Date: 2015-08-26T11:33:05+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.linkintegrity/commit/14c65f2d8f92c6a219754f71a53a39c7bd48ea6c

use a normal dict instead of a defaultdict since it makes for nicer log-messages

Files changed:
M plone/app/linkintegrity/browser/info.py
M plone/app/linkintegrity/tests/test_circular.py

diff --git a/plone/app/linkintegrity/browser/info.py b/plone/app/linkintegrity/browser/info.py
index 0fb9b06..7363028 100644
--- a/plone/app/linkintegrity/browser/info.py
+++ b/plone/app/linkintegrity/browser/info.py
@@ -7,7 +7,6 @@
 from Products.CMFPlone.interfaces.siteroot import IPloneSiteRoot
 from Products.Five import BrowserView
 from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile
-from collections import defaultdict
 from plone.app.linkintegrity.utils import getIncomingLinks
 from plone.app.linkintegrity.utils import linkintegrity_enabled
 from plone.uuid.interfaces import IUUID
@@ -109,7 +108,7 @@ def check_object(self, obj, excluded_path=None):
 
         Breaches originating from excluded_path are ignored.
         """
-        breaches = defaultdict(list)
+        breaches = {}
         direct_links = getIncomingLinks(obj)
         has_breaches = False
         for direct_link in direct_links:
@@ -121,6 +120,8 @@ def check_object(self, obj, excluded_path=None):
                 # source is in excluded_path
                 continue
             source = direct_link.from_object
+            if not breaches.get('sources'):
+                breaches['sources'] = []
             breaches['sources'].append({
                 'uid': IUUID(source),
                 'title': source.Title(),
@@ -136,7 +137,6 @@ def check_object(self, obj, excluded_path=None):
                 'portal_type': obj.portal_type,
                 'type_title': self.get_portal_type_title(obj),
             }
-        if has_breaches:
             return breaches
 
     def get_portal_type_title(self, obj):
diff --git a/plone/app/linkintegrity/tests/test_circular.py b/plone/app/linkintegrity/tests/test_circular.py
index 2005843..e097276 100644
--- a/plone/app/linkintegrity/tests/test_circular.py
+++ b/plone/app/linkintegrity/tests/test_circular.py
@@ -44,7 +44,8 @@ def test_circular_reference_subfolder_deletion(self):
 
         view = DeleteConfirmationInfo(self.portal, self.request)
         self.assertEqual(len(view.get_breaches([folder1])), 1)
-        self.assertEqual(len(view.get_breaches([doc1, doc2, doc3, folder1])), 0)
+        self.assertEqual(
+            len(view.get_breaches([doc1, doc2, doc3, folder1])), 0)
         self.assertEqual(len(view.get_breaches([doc2, folder1])), 2)
 
     def test_internal_breaches_are_dropped(self):


