Repository: plone.app.dexterity


Branch: refs/heads/2.0.x
Date: 2015-10-22T15:12:11+02:00
Author: Gil Forcada (gforcada) <gforcada@gnome.org>
Commit: https://github.com/plone/plone.app.dexterity/commit/0054e386682a3744739144fa3c623e9bac791f28

One letter variables are always a bad idea

'b' is doubly bad as it gets masked by pdb's own 'b' command.

Files changed:
M plone/app/dexterity/upgrades/to2001.py

diff --git a/plone/app/dexterity/upgrades/to2001.py b/plone/app/dexterity/upgrades/to2001.py
index b4a7c3c..c2c4a93 100644
--- a/plone/app/dexterity/upgrades/to2001.py
+++ b/plone/app/dexterity/upgrades/to2001.py
@@ -7,8 +7,8 @@
 def add_missing_uuids(context):
     catalog = getToolByName(context, 'portal_catalog')
     query = {'object_provides': IDexterityContent.__identifier__}
-    for b in catalog.unrestrictedSearchResults(query):
-        ob = b.getObject()
+    for brain in catalog.unrestrictedSearchResults(query):
+        ob = brain.getObject()
         if IUUID(ob, None) is None:
             addAttributeUUID(ob, None)
             ob.reindexObject(idxs=['UID'])


Repository: plone.app.dexterity


Branch: refs/heads/2.0.x
Date: 2015-10-22T15:12:56+02:00
Author: Gil Forcada Codinachs (gforcada) <gil.forcada@freitag.de>
Commit: https://github.com/plone/plone.app.dexterity/commit/1a597841bfbe0b1f480c45d44fe773a6b90a555c

Avoid re-adding the UUID

If an object already has a UID value on the catalog there is no need to add it again.

In cases where *LOTS* of objects get returned by the catalog call it can dramatically impact the upgrade.

Files changed:
M plone/app/dexterity/upgrades/to2001.py

diff --git a/plone/app/dexterity/upgrades/to2001.py b/plone/app/dexterity/upgrades/to2001.py
index c2c4a93..34750ff 100644
--- a/plone/app/dexterity/upgrades/to2001.py
+++ b/plone/app/dexterity/upgrades/to2001.py
@@ -8,6 +8,8 @@ def add_missing_uuids(context):
     catalog = getToolByName(context, 'portal_catalog')
     query = {'object_provides': IDexterityContent.__identifier__}
     for brain in catalog.unrestrictedSearchResults(query):
+        if getattr(brain, 'UID', None) is not None:
+            continue
         ob = brain.getObject()
         if IUUID(ob, None) is None:
             addAttributeUUID(ob, None)


Repository: plone.app.dexterity


Branch: refs/heads/2.0.x
Date: 2015-10-22T15:21:45+02:00
Author: Gil Forcada (gforcada) <gforcada@gnome.org>
Commit: https://github.com/plone/plone.app.dexterity/commit/c2f9cb8589918d202142671a1e89db4c678363af

Fix test

Files changed:
M plone/app/dexterity/tests/test_upgrades.py

diff --git a/plone/app/dexterity/tests/test_upgrades.py b/plone/app/dexterity/tests/test_upgrades.py
index fbe9528..c71f871 100644
--- a/plone/app/dexterity/tests/test_upgrades.py
+++ b/plone/app/dexterity/tests/test_upgrades.py
@@ -22,6 +22,8 @@ def test_add_missing_uuids(self):
         )
         setattr(page, ATTRIBUTE_NAME, None)
         self.assertTrue(IUUID(page, None) is None)
+        # reindex to remove the UUID it got when the page was created
+        page.reindexObject(idxs=['UID'])
 
         # run the migration
         add_missing_uuids(self.layer['portal'])


Repository: plone.app.dexterity


Branch: refs/heads/2.0.x
Date: 2015-10-22T15:21:45+02:00
Author: Gil Forcada (gforcada) <gforcada@gnome.org>
Commit: https://github.com/plone/plone.app.dexterity/commit/a2c267a5c82769c8e62e4dd36cdfed04cc5f294b

Update CHANGES.rst

Files changed:
M CHANGES.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index b2f160b..056f1ae 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,8 @@ Changelog
 2.0.17 (unreleased)
 -------------------
 
-- Nothing changed yet.
+- Avoid re-adding the UUID on an upgrade step.
+  [gforcada]
 
 
 2.0.16 (2015-09-28)


Repository: plone.app.dexterity


Branch: refs/heads/2.0.x
Date: 2015-10-23T10:42:42+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.dexterity/commit/7fd9bfff9645d86aa5835322eb4ffacd4e1b28ec

Merge pull request #190 from plone/2.0.x-gforcada-avoid-reindex

Avoid re-adding the UUID

Files changed:
M CHANGES.rst
M plone/app/dexterity/tests/test_upgrades.py
M plone/app/dexterity/upgrades/to2001.py

diff --git a/CHANGES.rst b/CHANGES.rst
index b2f160b..056f1ae 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,8 @@ Changelog
 2.0.17 (unreleased)
 -------------------
 
-- Nothing changed yet.
+- Avoid re-adding the UUID on an upgrade step.
+  [gforcada]
 
 
 2.0.16 (2015-09-28)
diff --git a/plone/app/dexterity/tests/test_upgrades.py b/plone/app/dexterity/tests/test_upgrades.py
index fbe9528..c71f871 100644
--- a/plone/app/dexterity/tests/test_upgrades.py
+++ b/plone/app/dexterity/tests/test_upgrades.py
@@ -22,6 +22,8 @@ def test_add_missing_uuids(self):
         )
         setattr(page, ATTRIBUTE_NAME, None)
         self.assertTrue(IUUID(page, None) is None)
+        # reindex to remove the UUID it got when the page was created
+        page.reindexObject(idxs=['UID'])
 
         # run the migration
         add_missing_uuids(self.layer['portal'])
diff --git a/plone/app/dexterity/upgrades/to2001.py b/plone/app/dexterity/upgrades/to2001.py
index b4a7c3c..34750ff 100644
--- a/plone/app/dexterity/upgrades/to2001.py
+++ b/plone/app/dexterity/upgrades/to2001.py
@@ -7,8 +7,10 @@
 def add_missing_uuids(context):
     catalog = getToolByName(context, 'portal_catalog')
     query = {'object_provides': IDexterityContent.__identifier__}
-    for b in catalog.unrestrictedSearchResults(query):
-        ob = b.getObject()
+    for brain in catalog.unrestrictedSearchResults(query):
+        if getattr(brain, 'UID', None) is not None:
+            continue
+        ob = brain.getObject()
         if IUUID(ob, None) is None:
             addAttributeUUID(ob, None)
             ob.reindexObject(idxs=['UID'])


