Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2015-09-27T21:06:48+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.contenttypes/commit/830a7babd006473e816a91bdca0c5b5e975c072c

Revert "Remove imports from p.a.linkintegrity to fix test-issues"

This reverts commit 51d140d34d5939a5b9b9b820080a1ae511cb0e74.

Files changed:
M CHANGES.rst
M plone/app/contenttypes/migration/utils.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 659afca..16021f9 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,8 +4,7 @@ Changelog
 1.2.5 (unreleased)
 ------------------
 
-- Remove imports from p.a.linkintegrity to fix test-issues.
-  [pbauer]
+- Nothing changed yet.
 
 
 1.2.4 (2015-09-27)
diff --git a/plone/app/contenttypes/migration/utils.py b/plone/app/contenttypes/migration/utils.py
index d059021..d15328c 100644
--- a/plone/app/contenttypes/migration/utils.py
+++ b/plone/app/contenttypes/migration/utils.py
@@ -20,6 +20,9 @@
 from plone.app.contenttypes.utils import DEFAULT_TYPES
 from plone.app.discussion.conversation import ANNOTATION_KEY as DISCUSSION_KEY
 from plone.app.discussion.interfaces import IConversation
+from plone.app.linkintegrity.handlers import modifiedArchetype
+from plone.app.linkintegrity.handlers import modifiedDexterity
+from plone.app.linkintegrity.handlers import referencedRelationship
 from plone.app.uuid.utils import uuidToObject
 from plone.contentrules.engine.interfaces import IRuleAssignmentManager
 from plone.dexterity.interfaces import IDexterityContent
@@ -370,16 +373,18 @@ def link_items(  # noqa
     else:
         target_type = 'AT'
 
-    if relationship == 'relatesTo':
-        # 'relatesTo' (plone.app.linkintegrity.handlers.referencedRelationship)
-        # is the relationship for linkintegrity-relations.
+    if relationship == referencedRelationship:
+        # 'relatesTo' is the relationship for linkintegrity-relations.
         # Linkintegrity-relations should automatically be (re)created by
         # plone.app.linkintegrity.handlers.modifiedDexterity or
         # plone.app.linkintegrity.handlers.modifiedArchetype
         # when a ObjectModifiedEvent is thrown.
         # These relations are only created if the source has a richtext-field
         # with a link to the target and should not be created manually.
-        modified(source_obj)
+        if source_type == 'AT':
+            modifiedArchetype(source_obj, None)
+        if source_type == 'DX':
+            modifiedDexterity(source_obj, None)
         return
 
     if source_type == 'AT':


Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2015-09-27T21:08:05+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.contenttypes/commit/be4666a9d9af2a812d722f86ea7930d2807c475d

Add plone.app.linkintegrity to dependencies due to test-issues

Files changed:
M CHANGES.rst
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 16021f9..a05d024 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,8 @@ Changelog
 1.2.5 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- Add plone.app.linkintegrity to dependencies due to test-issues.
+  [pbauer]
 
 
 1.2.4 (2015-09-27)
diff --git a/setup.py b/setup.py
index 901e2fb..9db6843 100644
--- a/setup.py
+++ b/setup.py
@@ -42,6 +42,7 @@ def read(*rnames):
           'plone.app.contentmenu',
           'plone.app.event >= 2.0a4',
           'plone.app.dexterity >= 2.0.7',  # has a fix for INameFromFilename
+          'plone.app.linkintegrity',
           'plone.app.querystring >= 1.2.2',  # custom_query support
           'plone.dexterity >= 2.2.1',  # behaviors can provide primaryfields
           'plone.app.relationfield',


