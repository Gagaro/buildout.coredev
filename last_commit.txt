Repository: plone.schemaeditor


Branch: refs/heads/master
Date: 2015-09-01T00:51:22+02:00
Author: Johannes Raggam (thet) <raggam-nl@adm.at>
Commit: https://github.com/plone/plone.schemaeditor/commit/796d47bc5faf63c30dadd6a2140c492a098aeae6

Make plone.protect.utils.addTokenToUrl a soft dependency, making this package usable in Plone &lt; 5.0.

Files changed:
M CHANGES.rst
M plone/schemaeditor/browser/schema/listing.py
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 40baee7..77345fa 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,9 @@ Changelog
 2.0.7 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- Make ``plone.protect.utils.addTokenToUrl`` a soft dependency, making this
+  package usable in Plone < 5.0.
+  [thet]
 
 
 2.0.6 (2015-07-18)
diff --git a/plone/schemaeditor/browser/schema/listing.py b/plone/schemaeditor/browser/schema/listing.py
index 0c35d01..a559c7e 100644
--- a/plone/schemaeditor/browser/schema/listing.py
+++ b/plone/schemaeditor/browser/schema/listing.py
@@ -7,13 +7,18 @@
 from plone.z3cform.layout import FormWrapper
 from plone.memoize.instance import memoize
 from plone.autoform.form import AutoExtensibleForm
-from plone.protect.utils import addTokenToUrl
 from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile
 
 from plone.schemaeditor import SchemaEditorMessageFactory as _
 from plone.schemaeditor.interfaces import IFieldFactory
 from plone.schemaeditor.utils import SchemaModifiedEvent
 
+try:
+    from plone.protect.utils import addTokenToUrl
+except ImportError:
+    addTokenToUrl = None
+
+
 
 class SchemaListing(AutoExtensibleForm, form.Form):
     implements(IEditForm)
@@ -83,7 +88,8 @@ def delete_url(self, field):
         if field.__name__ in self.context.fieldsWhichCannotBeDeleted:
             return
         url = '%s/%s/@@delete' % (self.context.absolute_url(), field.__name__)
-        url = addTokenToUrl(url, self.request)
+        if addTokenToUrl:
+            url = addTokenToUrl(url, self.request)
         return url
 
     @button.buttonAndHandler(
diff --git a/setup.py b/setup.py
index dbefdaa..b509a00 100644
--- a/setup.py
+++ b/setup.py
@@ -36,6 +36,7 @@
           'zope.schema',
           'zope.publisher',
           'z3c.form',
+          'plone.protect',
           'plone.z3cform',
           'plone.autoform',
       ],


Repository: plone.schemaeditor


Branch: refs/heads/master
Date: 2015-09-02T14:28:02+02:00
Author: Johannes Raggam (thet) <raggam-nl@adm.at>
Commit: https://github.com/plone/plone.schemaeditor/commit/2bd7b26dbe1a6e775f1b8e96f6e443feb35e1554

Merge pull request #31 from plone/thet-addTokenToUrl-softdependency

addTokenToUrl soft dependency

Files changed:
M CHANGES.rst
M plone/schemaeditor/browser/schema/listing.py
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 40baee7..77345fa 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,9 @@ Changelog
 2.0.7 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- Make ``plone.protect.utils.addTokenToUrl`` a soft dependency, making this
+  package usable in Plone < 5.0.
+  [thet]
 
 
 2.0.6 (2015-07-18)
diff --git a/plone/schemaeditor/browser/schema/listing.py b/plone/schemaeditor/browser/schema/listing.py
index 0c35d01..a559c7e 100644
--- a/plone/schemaeditor/browser/schema/listing.py
+++ b/plone/schemaeditor/browser/schema/listing.py
@@ -7,13 +7,18 @@
 from plone.z3cform.layout import FormWrapper
 from plone.memoize.instance import memoize
 from plone.autoform.form import AutoExtensibleForm
-from plone.protect.utils import addTokenToUrl
 from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile
 
 from plone.schemaeditor import SchemaEditorMessageFactory as _
 from plone.schemaeditor.interfaces import IFieldFactory
 from plone.schemaeditor.utils import SchemaModifiedEvent
 
+try:
+    from plone.protect.utils import addTokenToUrl
+except ImportError:
+    addTokenToUrl = None
+
+
 
 class SchemaListing(AutoExtensibleForm, form.Form):
     implements(IEditForm)
@@ -83,7 +88,8 @@ def delete_url(self, field):
         if field.__name__ in self.context.fieldsWhichCannotBeDeleted:
             return
         url = '%s/%s/@@delete' % (self.context.absolute_url(), field.__name__)
-        url = addTokenToUrl(url, self.request)
+        if addTokenToUrl:
+            url = addTokenToUrl(url, self.request)
         return url
 
     @button.buttonAndHandler(
diff --git a/setup.py b/setup.py
index dbefdaa..b509a00 100644
--- a/setup.py
+++ b/setup.py
@@ -36,6 +36,7 @@
           'zope.schema',
           'zope.publisher',
           'z3c.form',
+          'plone.protect',
           'plone.z3cform',
           'plone.autoform',
       ],


