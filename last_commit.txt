Repository: mockup


Branch: refs/heads/master
Date: 2015-08-11T15:34:39+02:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@redturtle.it>
Commit: https://github.com/plone/mockup/commit/255920f9b439be3ded88374d2a764413babd4a9c

Pat modal understands the data-view-url attribute

Files changed:
M CHANGES.rst
M mockup/patterns/modal/pattern.js
M mockup/tests/pattern-modal-test.js

diff --git a/CHANGES.rst b/CHANGES.rst
index 3b788cd..8b4ed2e 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -6,6 +6,9 @@ Changelog
 
 - add action value to form when using disableAjaxFormSubmit option on modal
   [vangheem]
+- Modal Pattern: If ``data-view-url`` attribute is available on the body, use
+  it. Otherwise look for ``data-base-url`` and finally for a ``<base>`` tag.
+  [ale-rt]
 
 - add "Save As" option in less builder
   [obct537]
diff --git a/mockup/patterns/modal/pattern.js b/mockup/patterns/modal/pattern.js
index a7b644f..8c010f4 100644
--- a/mockup/patterns/modal/pattern.js
+++ b/mockup/patterns/modal/pattern.js
@@ -156,19 +156,23 @@ define([
         onTimeout: null,
         redirectOnResponse: false,
         redirectToUrl: function($action, response, options) {
-          var baseUrl = '';
-          var reg = /<body.*data-base-url=[\"'](.*)[\"'].*/im.exec(response);
+          var reg;
+          reg = /<body.*data-view-url=[\"'](.*)[\"'].*/im.exec(response);
+          if (reg && reg.length > 1) {
+            // view url as data attribute on body (Plone 5)
+            return reg[1];
+          }
+          reg = /<body.*data-base-url=[\"'](.*)[\"'].*/im.exec(response);
           if (reg && reg.length > 1) {
             // Base url as data attribute on body (Plone 5)
-            baseUrl = reg[1];
-          } else {
-            reg = /<base.*href=[\"'](.*)[\"'].*/im.exec(response);
-            if (reg && reg.length > 1) {
+            return reg[1];
+          }
+          reg = /<base.*href=[\"'](.*)[\"'].*/im.exec(response);
+          if (reg && reg.length > 1) {
               // base tag available (Plone 4)
-              baseUrl = reg[1];
-            }
+              return reg[1];
           }
-          return baseUrl;
+          return '';
         }
       },
       routerOptions: {
diff --git a/mockup/tests/pattern-modal-test.js b/mockup/tests/pattern-modal-test.js
index 787689c..693150e 100644
--- a/mockup/tests/pattern-modal-test.js
+++ b/mockup/tests/pattern-modal-test.js
@@ -146,6 +146,10 @@ define([
             'ignore',
             '<html><body data-base-url="testurl3"></body></html>'
           )).to.equal('testurl3');
+          expect(modal.defaults.actionOptions.redirectToUrl(
+            'ignore',
+            '<html><body data-view-url="testurl4"></body></html>'
+          )).to.equal('testurl4');
           done();
         })
         .click();


Repository: mockup


Branch: refs/heads/master
Date: 2015-08-11T08:42:45-05:00
Author: Nathan Van Gheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/mockup/commit/0633c29b877ace8fb3711e60ae89309a55071961

Merge pull request #551 from plone/pat-modal-understands-data-view-url

Pat modal understands the data-view-url attribute

Files changed:
M CHANGES.rst
M mockup/patterns/modal/pattern.js
M mockup/tests/pattern-modal-test.js

diff --git a/CHANGES.rst b/CHANGES.rst
index 3b788cd..8b4ed2e 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -6,6 +6,9 @@ Changelog
 
 - add action value to form when using disableAjaxFormSubmit option on modal
   [vangheem]
+- Modal Pattern: If ``data-view-url`` attribute is available on the body, use
+  it. Otherwise look for ``data-base-url`` and finally for a ``<base>`` tag.
+  [ale-rt]
 
 - add "Save As" option in less builder
   [obct537]
diff --git a/mockup/patterns/modal/pattern.js b/mockup/patterns/modal/pattern.js
index a7b644f..8c010f4 100644
--- a/mockup/patterns/modal/pattern.js
+++ b/mockup/patterns/modal/pattern.js
@@ -156,19 +156,23 @@ define([
         onTimeout: null,
         redirectOnResponse: false,
         redirectToUrl: function($action, response, options) {
-          var baseUrl = '';
-          var reg = /<body.*data-base-url=[\"'](.*)[\"'].*/im.exec(response);
+          var reg;
+          reg = /<body.*data-view-url=[\"'](.*)[\"'].*/im.exec(response);
+          if (reg && reg.length > 1) {
+            // view url as data attribute on body (Plone 5)
+            return reg[1];
+          }
+          reg = /<body.*data-base-url=[\"'](.*)[\"'].*/im.exec(response);
           if (reg && reg.length > 1) {
             // Base url as data attribute on body (Plone 5)
-            baseUrl = reg[1];
-          } else {
-            reg = /<base.*href=[\"'](.*)[\"'].*/im.exec(response);
-            if (reg && reg.length > 1) {
+            return reg[1];
+          }
+          reg = /<base.*href=[\"'](.*)[\"'].*/im.exec(response);
+          if (reg && reg.length > 1) {
               // base tag available (Plone 4)
-              baseUrl = reg[1];
-            }
+              return reg[1];
           }
-          return baseUrl;
+          return '';
         }
       },
       routerOptions: {
diff --git a/mockup/tests/pattern-modal-test.js b/mockup/tests/pattern-modal-test.js
index 787689c..693150e 100644
--- a/mockup/tests/pattern-modal-test.js
+++ b/mockup/tests/pattern-modal-test.js
@@ -146,6 +146,10 @@ define([
             'ignore',
             '<html><body data-base-url="testurl3"></body></html>'
           )).to.equal('testurl3');
+          expect(modal.defaults.actionOptions.redirectToUrl(
+            'ignore',
+            '<html><body data-view-url="testurl4"></body></html>'
+          )).to.equal('testurl4');
           done();
         })
         .click();


