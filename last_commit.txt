Repository: plone.app.layout
Branch: refs/heads/master
Date: 2015-06-07T22:18:01-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.app.layout/commit/831a505bdcf73d3c54eb23f619437cc25c33fc7a

reuse getSiteLogo from CMFPlone.utils

Files changed:
M plone/app/layout/viewlets/common.py
M setup.py

diff --git a/plone/app/layout/viewlets/common.py b/plone/app/layout/viewlets/common.py
index 0e58d3f..663d321 100644
--- a/plone/app/layout/viewlets/common.py
+++ b/plone/app/layout/viewlets/common.py
@@ -18,15 +18,13 @@
 from Products.CMFCore.utils import getToolByName
 from Products.CMFPlone.interfaces import ISiteSchema
 from Products.CMFPlone.interfaces import ISearchSchema
-from Products.CMFPlone.utils import safe_unicode
+from Products.CMFPlone.utils import safe_unicode, getSiteLogo
 from Products.CMFPlone.interfaces import IPloneSiteRoot
 from Products.Five.browser import BrowserView
 from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile
 
 from plone.app.layout.globals.interfaces import IViewView
 from plone.protect.utils import addTokenToUrl
-from plone.formwidget.namedfile.converter import b64decode_file
-from plone.namedfile.file import NamedImage
 
 
 class ViewletBase(BrowserView):
@@ -193,18 +191,7 @@ def update(self):
         # TODO: should this be changed to settings.site_title?
         self.navigation_root_title = self.portal_state.navigation_root_title()
 
-        registry = getUtility(IRegistry)
-        settings = registry.forInterface(ISiteSchema, prefix="plone")
-        self.logo_title = settings.site_title
-
-        if getattr(settings, 'site_logo', False):
-            filename, data = b64decode_file(settings.site_logo)
-            data = NamedImage(data=data, filename=filename)
-            self.img_src = '{}/@@site-logo/{}'.format(
-                self.navigation_root_url, filename)
-        else:
-            self.img_src = '%s/logo.png' % (
-                self.navigation_root_url)
+        self.img_src = getSiteLogo(self.portal_state.portal())
 
 
 class GlobalSectionsViewlet(ViewletBase):
diff --git a/setup.py b/setup.py
index cafc4d4..c75db11 100644
--- a/setup.py
+++ b/setup.py
@@ -39,7 +39,7 @@
           'Products.CMFCore',
           'Products.CMFDynamicViewFTI',
           'Products.CMFEditions >=1.2.2',
-          'Products.CMFPlone >=4.3',  # XXX: should be 5.0
+          'Products.CMFPlone >=5.0b3.dev0',
           'setuptools',
           'zope.component',
           'zope.deprecation',


