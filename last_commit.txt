Repository: Products.CMFPlone
Branch: refs/heads/master
Date: 2015-04-13T21:47:39+02:00
Author: Patrick Gerken (do3cc) <do3cc@patrick-gerken.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/6eca9e274cd975da4c1026731679e68a3c0a2509

Fix another bad test

Now that browser layers get properly initialized, tests
that try to trigger manual initalization have to reset some state first.
Fix for d57a09966865809b27f6e3a1b4a1fdd851112a2a

Files changed:
M Products/CMFPlone/tests/testBrowserLayerPrecedence.py

diff --git a/Products/CMFPlone/tests/testBrowserLayerPrecedence.py b/Products/CMFPlone/tests/testBrowserLayerPrecedence.py
index b63b1fb..523b0cc 100644
--- a/Products/CMFPlone/tests/testBrowserLayerPrecedence.py
+++ b/Products/CMFPlone/tests/testBrowserLayerPrecedence.py
@@ -3,7 +3,6 @@
 # add-on products (a la plone.browserlayer).
 
 from plone.app.testing.bbb import PloneTestCase
-from zope.publisher.browser import TestRequest
 
 from zope.event import notify
 from zope.interface import Interface
@@ -20,6 +19,9 @@ class TestBrowserLayerPrecedence(PloneTestCase):
 
     def _get_request_interfaces(self):
         request = self.layer['request']
+        # Reset _plonebrowerlayer_ marker, so that we can still register
+        # additional layers for testing. (WTF here?)
+        del request._plonebrowserlayer_
         notify(BeforeTraverseEvent(self.portal, request))
         iro = list(request.__provides__.__iro__)
         return iro


