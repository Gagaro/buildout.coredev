Repository: plone.app.event


Branch: refs/heads/master
Date: 2015-07-20T17:35:20+02:00
Author: Rok Garbas (garbas) <rok@garbas.si>
Commit: https://github.com/plone/plone.app.event/commit/1625239ec225edbfe1e0bbb51de445774f1055d8

removing dependency on p.a.contenttypes

Files changed:
M plone/app/event/portlets/portlet_calendar.py
M plone/app/event/portlets/portlet_events.py

diff --git a/plone/app/event/portlets/portlet_calendar.py b/plone/app/event/portlets/portlet_calendar.py
index c5c7094..eb63e19 100644
--- a/plone/app/event/portlets/portlet_calendar.py
+++ b/plone/app/event/portlets/portlet_calendar.py
@@ -2,8 +2,6 @@
 from ComputedAttribute import ComputedAttribute
 from Products.CMFCore.utils import getToolByName
 from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile
-from plone.app.contenttypes.behaviors.collection import ISyndicatableCollection
-from plone.app.contenttypes.interfaces import IFolder
 from plone.app.event.base import RET_MODE_OBJECTS
 from plone.app.event.base import _prepare_range
 from plone.app.event.base import expand_events
@@ -30,7 +28,16 @@
 
 try:
     from plone.app.contenttypes.behaviors.collection import ISyndicatableCollection as ICollection  # noqa
+    from plone.app.contenttypes.interfaces import IFolder
+    search_base_uid_source = CatalogSource(object_provides={
+        'query': [
+            ICollection.__identifier__,
+            IFolder.__identifier__
+        ],
+        'operator': 'or'
+    })
 except ImportError:
+    search_base_uid_source = CatalogSource(is_folderish=True)
     ICollection = None
 
 PLMF = MessageFactory('plonelocales')
@@ -60,13 +67,7 @@ class ICalendarPortlet(IPortletDataProvider):
                     u'called on the site root.'
         ),
         required=False,
-        source=CatalogSource(object_provides={
-            'query': [
-                ISyndicatableCollection.__identifier__,
-                IFolder.__identifier__
-            ],
-            'operator': 'or'
-        }),
+        source=search_base_uid_source,
     )
 
 
@@ -208,7 +209,7 @@ def cal_data(self):
         events = []
         query.update(self.request.get('contentFilter', {}))
         search_base = self.search_base
-        if ICollection.providedBy(search_base):
+        if ICollection and ICollection.providedBy(search_base):
             # Whatever sorting is defined, we're overriding it.
             query = queryparser.parseFormquery(
                 search_base, search_base.query,
diff --git a/plone/app/event/portlets/portlet_events.py b/plone/app/event/portlets/portlet_events.py
index eff12c6..0f25aa8 100644
--- a/plone/app/event/portlets/portlet_events.py
+++ b/plone/app/event/portlets/portlet_events.py
@@ -2,8 +2,6 @@
 from ComputedAttribute import ComputedAttribute
 from Products.CMFCore.utils import getToolByName
 from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile
-from plone.app.contenttypes.behaviors.collection import ISyndicatableCollection
-from plone.app.contenttypes.interfaces import IFolder
 from plone.app.event.base import expand_events
 from plone.app.event.base import _prepare_range
 from plone.app.event.base import start_end_query
@@ -27,7 +25,16 @@
 
 try:
     from plone.app.contenttypes.behaviors.collection import ISyndicatableCollection as ICollection  # noqa
+    from plone.app.contenttypes.interfaces import IFolder
+    search_base_uid_source = CatalogSource(object_provides={
+        'query': [
+            ICollection.__identifier__,
+            IFolder.__identifier__
+        ],
+        'operator': 'or'
+    })
 except ImportError:
+    search_base_uid_source = CatalogSource(is_folderish=True)
     ICollection = None
 
 
@@ -61,13 +68,7 @@ class IEventsPortlet(IPortletDataProvider):
                     u'called on the site root.'
         ),
         required=False,
-        source=CatalogSource(object_provides={
-            'query': [
-                ISyndicatableCollection.__identifier__,
-                IFolder.__identifier__
-            ],
-            'operator': 'or'
-        }),
+        source=search_base_uid_source,
     )
 
 
@@ -155,7 +156,7 @@ def events(self):
         events = []
         query.update(self.request.get('contentFilter', {}))
         search_base = self.search_base
-        if ICollection.providedBy(search_base):
+        if ICollection and ICollection.providedBy(search_base):
             # Whatever sorting is defined, we're overriding it.
             query = queryparser.parseFormquery(
                 search_base, search_base.query,


Repository: plone.app.event


Branch: refs/heads/master
Date: 2015-07-20T18:46:06+02:00
Author: Rok Garbas (garbas) <rok@garbas.si>
Commit: https://github.com/plone/plone.app.event/commit/56d7d02f01d265fa74e269589b6dc71853c9f611

trigger events javascript after all patterns are initialized

Files changed:
M plone/app/event/browser/resources/event.js

diff --git a/plone/app/event/browser/resources/event.js b/plone/app/event/browser/resources/event.js
index 9c0a40e..dba0649 100644
--- a/plone/app/event/browser/resources/event.js
+++ b/plone/app/event/browser/resources/event.js
@@ -134,8 +134,7 @@ require([
         }
     }
 
-
-    $(window).load(function () {
+    function initilize_event() {
 
         // EDIT FORM
 
@@ -172,5 +171,16 @@ require([
         // EVENT LISTING CALENDAR POPUP
         event_listing_calendar_init($("#event_listing_calendar"));
 
-    });
+    };
+
+    // mockup-core should trigger event once it initiallized all patterns (in
+    // mockup-core) but it only sets body class once all patterns were
+    // initialized
+    var interval = setInterval(function(){
+      if ($(document.body).hasClass('patterns-loaded')) {
+        clearInterval(interval);
+        initilize_event();
+      }
+    }, 100);
+ 
 });


Repository: plone.app.event


Branch: refs/heads/master
Date: 2015-07-22T11:50:26+02:00
Author: Rok Garbas (garbas) <rok@garbas.si>
Commit: https://github.com/plone/plone.app.event/commit/3d4ec6fe445c862faa8e2d770e41dfd388e1d44f

reuse ICollection and search_base_uid_source between portlet_events.py and portlet_calendar.py

Files changed:
M plone/app/event/portlets/portlet_events.py

diff --git a/plone/app/event/portlets/portlet_events.py b/plone/app/event/portlets/portlet_events.py
index 0f25aa8..cca8cca 100644
--- a/plone/app/event/portlets/portlet_events.py
+++ b/plone/app/event/portlets/portlet_events.py
@@ -5,15 +5,16 @@
 from plone.app.event.base import expand_events
 from plone.app.event.base import _prepare_range
 from plone.app.event.base import start_end_query
-
 from plone.app.event.base import RET_MODE_ACCESSORS
 from plone.app.event.base import get_events
 from plone.app.event.base import localized_now
 from plone.app.event.portlets import get_calendar_url
+from plone.app.event.portlets.portlet_events import (
+    ICollection, search_base_uid_source
+)
 from plone.app.portlets import PloneMessageFactory as _
 from plone.app.portlets.portlets import base
 from plone.app.uuid.utils import uuidToObject
-from plone.app.vocabularies.catalog import CatalogSource
 from plone.memoize.compress import xhtml_compress
 from plone.portlets.interfaces import IPortletDataProvider
 from zExceptions import NotFound
@@ -23,20 +24,6 @@
 from zope.interface import implementer
 from plone.app.querystring import queryparser
 
-try:
-    from plone.app.contenttypes.behaviors.collection import ISyndicatableCollection as ICollection  # noqa
-    from plone.app.contenttypes.interfaces import IFolder
-    search_base_uid_source = CatalogSource(object_provides={
-        'query': [
-            ICollection.__identifier__,
-            IFolder.__identifier__
-        ],
-        'operator': 'or'
-    })
-except ImportError:
-    search_base_uid_source = CatalogSource(is_folderish=True)
-    ICollection = None
-
 
 class IEventsPortlet(IPortletDataProvider):
 


Repository: plone.app.event


Branch: refs/heads/master
Date: 2015-07-22T12:05:59+02:00
Author: Rok Garbas (garbas) <rok@garbas.si>
Commit: https://github.com/plone/plone.app.event/commit/a4ac89ef871bff86445b9daccbf3b8a4167b8f0f

adding Changelog entries for recent changes

Files changed:
M CHANGES.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index 447ade8..4c1c245 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,12 @@ Changelog
 2.0b2 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- initialize events.js javascript after all patterns are initialized.
+  [garbas]
+
+- removing dependency on plone.app.contenttypes that introduce with latest
+  changes to portlets code.
+  [garbas]
 
 
 2.0b1 (2015-07-18)


Repository: plone.app.event


Branch: refs/heads/master
Date: 2015-07-22T12:46:25+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.event/commit/ae3843986695fe10d546bc9e4368935ba692ba7e

Merge pull request #195 from garbas/master

removing dependency on p.a.contenttypes

Files changed:
M CHANGES.rst
M plone/app/event/browser/resources/event.js
M plone/app/event/portlets/portlet_calendar.py
M plone/app/event/portlets/portlet_events.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 447ade8..4c1c245 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,12 @@ Changelog
 2.0b2 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- initialize events.js javascript after all patterns are initialized.
+  [garbas]
+
+- removing dependency on plone.app.contenttypes that introduce with latest
+  changes to portlets code.
+  [garbas]
 
 
 2.0b1 (2015-07-18)
diff --git a/plone/app/event/browser/resources/event.js b/plone/app/event/browser/resources/event.js
index 9c0a40e..dba0649 100644
--- a/plone/app/event/browser/resources/event.js
+++ b/plone/app/event/browser/resources/event.js
@@ -134,8 +134,7 @@ require([
         }
     }
 
-
-    $(window).load(function () {
+    function initilize_event() {
 
         // EDIT FORM
 
@@ -172,5 +171,16 @@ require([
         // EVENT LISTING CALENDAR POPUP
         event_listing_calendar_init($("#event_listing_calendar"));
 
-    });
+    };
+
+    // mockup-core should trigger event once it initiallized all patterns (in
+    // mockup-core) but it only sets body class once all patterns were
+    // initialized
+    var interval = setInterval(function(){
+      if ($(document.body).hasClass('patterns-loaded')) {
+        clearInterval(interval);
+        initilize_event();
+      }
+    }, 100);
+ 
 });
diff --git a/plone/app/event/portlets/portlet_calendar.py b/plone/app/event/portlets/portlet_calendar.py
index c5c7094..eb63e19 100644
--- a/plone/app/event/portlets/portlet_calendar.py
+++ b/plone/app/event/portlets/portlet_calendar.py
@@ -2,8 +2,6 @@
 from ComputedAttribute import ComputedAttribute
 from Products.CMFCore.utils import getToolByName
 from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile
-from plone.app.contenttypes.behaviors.collection import ISyndicatableCollection
-from plone.app.contenttypes.interfaces import IFolder
 from plone.app.event.base import RET_MODE_OBJECTS
 from plone.app.event.base import _prepare_range
 from plone.app.event.base import expand_events
@@ -30,7 +28,16 @@
 
 try:
     from plone.app.contenttypes.behaviors.collection import ISyndicatableCollection as ICollection  # noqa
+    from plone.app.contenttypes.interfaces import IFolder
+    search_base_uid_source = CatalogSource(object_provides={
+        'query': [
+            ICollection.__identifier__,
+            IFolder.__identifier__
+        ],
+        'operator': 'or'
+    })
 except ImportError:
+    search_base_uid_source = CatalogSource(is_folderish=True)
     ICollection = None
 
 PLMF = MessageFactory('plonelocales')
@@ -60,13 +67,7 @@ class ICalendarPortlet(IPortletDataProvider):
                     u'called on the site root.'
         ),
         required=False,
-        source=CatalogSource(object_provides={
-            'query': [
-                ISyndicatableCollection.__identifier__,
-                IFolder.__identifier__
-            ],
-            'operator': 'or'
-        }),
+        source=search_base_uid_source,
     )
 
 
@@ -208,7 +209,7 @@ def cal_data(self):
         events = []
         query.update(self.request.get('contentFilter', {}))
         search_base = self.search_base
-        if ICollection.providedBy(search_base):
+        if ICollection and ICollection.providedBy(search_base):
             # Whatever sorting is defined, we're overriding it.
             query = queryparser.parseFormquery(
                 search_base, search_base.query,
diff --git a/plone/app/event/portlets/portlet_events.py b/plone/app/event/portlets/portlet_events.py
index eff12c6..cca8cca 100644
--- a/plone/app/event/portlets/portlet_events.py
+++ b/plone/app/event/portlets/portlet_events.py
@@ -2,20 +2,19 @@
 from ComputedAttribute import ComputedAttribute
 from Products.CMFCore.utils import getToolByName
 from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile
-from plone.app.contenttypes.behaviors.collection import ISyndicatableCollection
-from plone.app.contenttypes.interfaces import IFolder
 from plone.app.event.base import expand_events
 from plone.app.event.base import _prepare_range
 from plone.app.event.base import start_end_query
-
 from plone.app.event.base import RET_MODE_ACCESSORS
 from plone.app.event.base import get_events
 from plone.app.event.base import localized_now
 from plone.app.event.portlets import get_calendar_url
+from plone.app.event.portlets.portlet_events import (
+    ICollection, search_base_uid_source
+)
 from plone.app.portlets import PloneMessageFactory as _
 from plone.app.portlets.portlets import base
 from plone.app.uuid.utils import uuidToObject
-from plone.app.vocabularies.catalog import CatalogSource
 from plone.memoize.compress import xhtml_compress
 from plone.portlets.interfaces import IPortletDataProvider
 from zExceptions import NotFound
@@ -25,11 +24,6 @@
 from zope.interface import implementer
 from plone.app.querystring import queryparser
 
-try:
-    from plone.app.contenttypes.behaviors.collection import ISyndicatableCollection as ICollection  # noqa
-except ImportError:
-    ICollection = None
-
 
 class IEventsPortlet(IPortletDataProvider):
 
@@ -61,13 +55,7 @@ class IEventsPortlet(IPortletDataProvider):
                     u'called on the site root.'
         ),
         required=False,
-        source=CatalogSource(object_provides={
-            'query': [
-                ISyndicatableCollection.__identifier__,
-                IFolder.__identifier__
-            ],
-            'operator': 'or'
-        }),
+        source=search_base_uid_source,
     )
 
 
@@ -155,7 +143,7 @@ def events(self):
         events = []
         query.update(self.request.get('contentFilter', {}))
         search_base = self.search_base
-        if ICollection.providedBy(search_base):
+        if ICollection and ICollection.providedBy(search_base):
             # Whatever sorting is defined, we're overriding it.
             query = queryparser.parseFormquery(
                 search_base, search_base.query,


