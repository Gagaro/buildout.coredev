Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-06-29T14:05:14+02:00
Author: Ramon Navarro Bosch (bloodbare) <ramon.nb@gmail.com>
Commit: https://github.com/plone/plone.app.upgrade/commit/51d83b41f72e2873967fdde4c7294d9d8225da67

In case its upgrading from p.a.e &lt; 2 to plone 5 it breaks, on alpha1 there is record for first_weekday, so we need to move it to alpha3 upgrade

Files changed:
M plone/app/upgrade/v50/alphas.py

diff --git a/plone/app/upgrade/v50/alphas.py b/plone/app/upgrade/v50/alphas.py
index 05fbbe7..8becc52 100644
--- a/plone/app/upgrade/v50/alphas.py
+++ b/plone/app/upgrade/v50/alphas.py
@@ -98,9 +98,6 @@ def migrate_registry_settings(portal):
         # Try to get the value from portal_calendar, if available.
         portal_calendar = getattr(portal, 'portal_calendar', None)
         first_weekday = getattr(portal_calendar, 'firstweekday', None)
-    if first_weekday is not None:
-        # Set it. Otherwise, let plone.app.event install routine set it.
-        registry['plone.first_weekday'] = first_weekday
 
 
 def migrate_members_default_view(portal):
@@ -139,6 +136,14 @@ def to50alhpa3(context):
     """5.0alpha2 - > 5.0alpha3"""
     loadMigrationProfile(context, 'profile-plone.app.upgrade.v50:to50alpha3')
 
+    portal = getToolByName(context, 'portal_url').getPortalObject()
+    registry = portal.portal_registry
+    # At alpha3 we have the registry entry so we can migrate here
+    first_weekday = registry.get('plone.app.event.first_weekday', None)
+    if first_weekday is not None:
+        # Set it. Otherwise, let plone.app.event install routine set it.
+        registry['plone.first_weekday'] = first_weekday
+
 
 def upgrade_editing_controlpanel_settings(context):
     """Copy editing control panel settings from portal properties into the new


