Repository: plone.app.form
Branch: refs/heads/master
Date: 2015-05-29T09:28:44Z
Author: Tom Gross (tomgross) <itconsense@gmail.com>
Commit: https://github.com/plone/plone.app.form/commit/a287d6e563b190ccfb0de0c3162da84a9ad82393

remove CMFDefault dependency

Files changed:
A plone/app/form/widgets/fileupload.py
M CHANGES.rst
M plone/app/form/configure.zcml
M plone/app/form/widgets/configure.zcml
M plone/app/form/widgets/interfaces.py
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 767b4d2..14d8d17 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,8 @@ Changelog
 2.3.3 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- Remove CMFDefault dependency
+  [tomgross]
 
 
 2.3.2 (2015-05-04)
@@ -441,4 +442,4 @@ Changelog
 - Initial package structure.
   [zopeskel]
 
-.. _`#241`: https://github.com/plone/Products.CMFPlone/issues/241
\ No newline at end of file
+.. _`#241`: https://github.com/plone/Products.CMFPlone/issues/241
diff --git a/plone/app/form/configure.zcml b/plone/app/form/configure.zcml
index 7eb204b..586113b 100644
--- a/plone/app/form/configure.zcml
+++ b/plone/app/form/configure.zcml
@@ -42,7 +42,7 @@
       />
 
   <!-- Let Five's add views look pretty in CMF/Plone -->
-  <configure package="Products.CMFDefault.skin">
+  <configure package="Products.CMFPlone.browser.templates">
 
       <browser:page
         name="five_template"
diff --git a/plone/app/form/widgets/configure.zcml b/plone/app/form/widgets/configure.zcml
index 9100f64..51fc46e 100644
--- a/plone/app/form/widgets/configure.zcml
+++ b/plone/app/form/widgets/configure.zcml
@@ -1,13 +1,8 @@
 <configure
-    xmlns="http://namespaces.zope.org/zope"
-    xmlns:browser="http://namespaces.zope.org/browser"
-    xmlns:five="http://namespaces.zope.org/five">
+    xmlns="http://namespaces.zope.org/zope">
 
-    <!-- use the FileUploadWidget from CMFDefault as the default
-         widget for the FileUpload field from that package;
-         the zcml in that package is excluded by CMFPlone -->
     <adapter
-        factory="Products.CMFDefault.formlib.widgets.FileUploadWidget"
+        factory=".fileupload.FileUploadWidget"
         permission="zope.Public"
         />
 
diff --git a/plone/app/form/widgets/fileupload.py b/plone/app/form/widgets/fileupload.py
new file mode 100644
index 0000000..9d6155e
--- /dev/null
+++ b/plone/app/form/widgets/fileupload.py
@@ -0,0 +1,44 @@
+##############################################################################
+#
+# Copyright (c) 2006 Zope Foundation and Contributors.
+#
+# This software is subject to the provisions of the Zope Public License,
+# Version 2.1 (ZPL).  A copy of the ZPL should accompany this distribution.
+# THIS SOFTWARE IS PROVIDED "AS IS" AND ANY AND ALL EXPRESS OR IMPLIED
+# WARRANTIES ARE DISCLAIMED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+# WARRANTIES OF TITLE, MERCHANTABILITY, AGAINST INFRINGEMENT, AND FITNESS
+# FOR A PARTICULAR PURPOSE.
+#
+##############################################################################
+""" Custom formlib fileupload widget. """
+
+
+from plone.app.form.widgets.interfaces import IFileUpload
+from zope.app.form.browser import FileWidget
+from zope.app.form.interfaces import ConversionError
+from zope.app.form.interfaces import IInputWidget
+from zope.interface import implementsOnly
+from zope.component import adapts
+from zope.publisher.interfaces.browser import IBrowserRequest
+
+
+class FileUploadWidget(FileWidget):
+
+    implementsOnly(IInputWidget)
+    adapts(IFileUpload, IBrowserRequest)
+
+    def _toFieldValue(self, input):
+        if not input:
+            return self.context.missing_value
+        try:
+            filename = input.filename.split('\\')[-1] # for IE
+            input.filename = filename.strip().replace(' ','_')
+        except AttributeError, e:
+            raise ConversionError(zope_('Form input is not a file object'), e)
+        return input
+
+    def hasInput(self):
+        return ((self.required and self.name+".used" in self.request.form) or
+                self.request.form.get(self.name))
+
+
diff --git a/plone/app/form/widgets/interfaces.py b/plone/app/form/widgets/interfaces.py
index 7b48d7b..5191f6e 100644
--- a/plone/app/form/widgets/interfaces.py
+++ b/plone/app/form/widgets/interfaces.py
@@ -1,5 +1,6 @@
 # -*- coding: utf-8 -*-
 from zope.interface import Interface
+from zope.schema.interfaces import IField
 
 
 class IDateComponents(Interface):
@@ -14,3 +15,9 @@ def result(date=None,
                minute_step=5):
         """Returns a dict with date information.
         """
+
+class IFileUpload(IField):
+
+    """A field for file uploads.
+    """
+
diff --git a/setup.py b/setup.py
index 3fbedf0..d89568c 100644
--- a/setup.py
+++ b/setup.py
@@ -44,7 +44,6 @@
           'plone.app.vocabularies',
           'plone.locking',
           'Products.CMFCore',
-          'Products.CMFDefault',
           'setuptools',
           'zope.browser',
           'zope.component',


Repository: plone.app.form
Branch: refs/heads/master
Date: 2015-05-29T12:53:20Z
Author: Tom Gross (tomgross) <itconsense@gmail.com>
Commit: https://github.com/plone/plone.app.form/commit/e6d6052847b4508eb600679c3a11a6cd1206d322

adjust five_template path

Files changed:
M plone/app/form/configure.zcml

diff --git a/plone/app/form/configure.zcml b/plone/app/form/configure.zcml
index 586113b..753ba09 100644
--- a/plone/app/form/configure.zcml
+++ b/plone/app/form/configure.zcml
@@ -42,12 +42,12 @@
       />
 
   <!-- Let Five's add views look pretty in CMF/Plone -->
-  <configure package="Products.CMFPlone.browser.templates">
+  <configure package="Products.CMFPlone.browser">
 
       <browser:page
         name="five_template"
         for="zope.browser.interfaces.IAdding"
-        template="five_template.pt"
+        template="templates/five_template.pt"
         permission="zope2.View"
         />
 


Repository: plone.app.form
Branch: refs/heads/master
Date: 2015-05-30T13:38:54+02:00
Author: Timo Stollenwerk (tisto) <tisto@plone.org>
Commit: https://github.com/plone/plone.app.form/commit/8ab071a52049099ea3afaaf05d6f1f46edd9d25b

Merge pull request #12 from plone/tomgross-nocmfdefault

remove CMFDefault dependency

Files changed:
A plone/app/form/widgets/fileupload.py
M CHANGES.rst
M plone/app/form/configure.zcml
M plone/app/form/widgets/configure.zcml
M plone/app/form/widgets/interfaces.py
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 767b4d2..14d8d17 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,8 @@ Changelog
 2.3.3 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- Remove CMFDefault dependency
+  [tomgross]
 
 
 2.3.2 (2015-05-04)
@@ -441,4 +442,4 @@ Changelog
 - Initial package structure.
   [zopeskel]
 
-.. _`#241`: https://github.com/plone/Products.CMFPlone/issues/241
\ No newline at end of file
+.. _`#241`: https://github.com/plone/Products.CMFPlone/issues/241
diff --git a/plone/app/form/configure.zcml b/plone/app/form/configure.zcml
index 7eb204b..753ba09 100644
--- a/plone/app/form/configure.zcml
+++ b/plone/app/form/configure.zcml
@@ -42,12 +42,12 @@
       />
 
   <!-- Let Five's add views look pretty in CMF/Plone -->
-  <configure package="Products.CMFDefault.skin">
+  <configure package="Products.CMFPlone.browser">
 
       <browser:page
         name="five_template"
         for="zope.browser.interfaces.IAdding"
-        template="five_template.pt"
+        template="templates/five_template.pt"
         permission="zope2.View"
         />
 
diff --git a/plone/app/form/widgets/configure.zcml b/plone/app/form/widgets/configure.zcml
index 9100f64..51fc46e 100644
--- a/plone/app/form/widgets/configure.zcml
+++ b/plone/app/form/widgets/configure.zcml
@@ -1,13 +1,8 @@
 <configure
-    xmlns="http://namespaces.zope.org/zope"
-    xmlns:browser="http://namespaces.zope.org/browser"
-    xmlns:five="http://namespaces.zope.org/five">
+    xmlns="http://namespaces.zope.org/zope">
 
-    <!-- use the FileUploadWidget from CMFDefault as the default
-         widget for the FileUpload field from that package;
-         the zcml in that package is excluded by CMFPlone -->
     <adapter
-        factory="Products.CMFDefault.formlib.widgets.FileUploadWidget"
+        factory=".fileupload.FileUploadWidget"
         permission="zope.Public"
         />
 
diff --git a/plone/app/form/widgets/fileupload.py b/plone/app/form/widgets/fileupload.py
new file mode 100644
index 0000000..9d6155e
--- /dev/null
+++ b/plone/app/form/widgets/fileupload.py
@@ -0,0 +1,44 @@
+##############################################################################
+#
+# Copyright (c) 2006 Zope Foundation and Contributors.
+#
+# This software is subject to the provisions of the Zope Public License,
+# Version 2.1 (ZPL).  A copy of the ZPL should accompany this distribution.
+# THIS SOFTWARE IS PROVIDED "AS IS" AND ANY AND ALL EXPRESS OR IMPLIED
+# WARRANTIES ARE DISCLAIMED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+# WARRANTIES OF TITLE, MERCHANTABILITY, AGAINST INFRINGEMENT, AND FITNESS
+# FOR A PARTICULAR PURPOSE.
+#
+##############################################################################
+""" Custom formlib fileupload widget. """
+
+
+from plone.app.form.widgets.interfaces import IFileUpload
+from zope.app.form.browser import FileWidget
+from zope.app.form.interfaces import ConversionError
+from zope.app.form.interfaces import IInputWidget
+from zope.interface import implementsOnly
+from zope.component import adapts
+from zope.publisher.interfaces.browser import IBrowserRequest
+
+
+class FileUploadWidget(FileWidget):
+
+    implementsOnly(IInputWidget)
+    adapts(IFileUpload, IBrowserRequest)
+
+    def _toFieldValue(self, input):
+        if not input:
+            return self.context.missing_value
+        try:
+            filename = input.filename.split('\\')[-1] # for IE
+            input.filename = filename.strip().replace(' ','_')
+        except AttributeError, e:
+            raise ConversionError(zope_('Form input is not a file object'), e)
+        return input
+
+    def hasInput(self):
+        return ((self.required and self.name+".used" in self.request.form) or
+                self.request.form.get(self.name))
+
+
diff --git a/plone/app/form/widgets/interfaces.py b/plone/app/form/widgets/interfaces.py
index 7b48d7b..5191f6e 100644
--- a/plone/app/form/widgets/interfaces.py
+++ b/plone/app/form/widgets/interfaces.py
@@ -1,5 +1,6 @@
 # -*- coding: utf-8 -*-
 from zope.interface import Interface
+from zope.schema.interfaces import IField
 
 
 class IDateComponents(Interface):
@@ -14,3 +15,9 @@ def result(date=None,
                minute_step=5):
         """Returns a dict with date information.
         """
+
+class IFileUpload(IField):
+
+    """A field for file uploads.
+    """
+
diff --git a/setup.py b/setup.py
index 3fbedf0..d89568c 100644
--- a/setup.py
+++ b/setup.py
@@ -44,7 +44,6 @@
           'plone.app.vocabularies',
           'plone.locking',
           'Products.CMFCore',
-          'Products.CMFDefault',
           'setuptools',
           'zope.browser',
           'zope.component',


