Repository: mockup
Branch: refs/heads/master
Date: 2015-06-04T23:05:00-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/mockup/commit/389bfdc7eb17506bc44b76fe171f35984bdd3c58

fix some issues with editing and improve styles

Files changed:
M mockup/patterns/resourceregistry/js/fields.js
M mockup/patterns/resourceregistry/js/overrides.js
M mockup/patterns/resourceregistry/js/registry.js
M mockup/patterns/resourceregistry/pattern.resourceregistry.less

diff --git a/mockup/patterns/resourceregistry/js/fields.js b/mockup/patterns/resourceregistry/js/fields.js
index 6d9ec6f..e59ddc9 100644
--- a/mockup/patterns/resourceregistry/js/fields.js
+++ b/mockup/patterns/resourceregistry/js/fields.js
@@ -339,14 +339,20 @@ define([
       // move data
       var data = this.options.containerData[this.resourceName];
       this.options.containerData[value] = data;
-      // and now delete old
-      delete this.options.containerData[this.resourceName];
-      this.resourceName = value;
+
+      if(this.resourceName !== value){
+        // and now delete old
+        delete this.options.containerData[this.resourceName];
+      }
+      this.resourceName = this.options.value = this.options.form.options.name = this.options.form.name = value;
 
       if(this.options.parent){
         this.options.parent.options.name = value;
         this.options.parent.render();
       }
+      if(this.options.form){
+        this.options.form.$('h3').html(value);
+      }
       return this.handleError(false);
     },
     serializedModel: function(){
diff --git a/mockup/patterns/resourceregistry/js/overrides.js b/mockup/patterns/resourceregistry/js/overrides.js
index b794d94..10c53a9 100644
--- a/mockup/patterns/resourceregistry/js/overrides.js
+++ b/mockup/patterns/resourceregistry/js/overrides.js
@@ -128,16 +128,20 @@ define([
         }
         var items = [];
         var url;
-        if(resource.js && resource.js.indexOf('++plone++') !== -1){
-          url = base + resource.js;
-          if(overrides.indexOf(url) === -1){
-            items.push({id: url, text: url});
+        if(resource.js){
+          if(resource.js && resource.js.indexOf('++plone++') !== -1){
+            url = base + resource.js;
+            if(overrides.indexOf(url) === -1){
+              items.push({id: url, text: url});
+            }
           }
         }
-        for(var i=0; i<resource.css.length; i=i+1){
-          url = base + resource.css[i];
-          if(overrides.indexOf(url) === -1 && url.indexOf('++plone++') !== -1){
-            items.push({id: url, text: url});
+        if(resource.css){
+          for(var i=0; i<resource.css.length; i=i+1){
+            url = base + resource.css[i];
+            if(overrides.indexOf(url) === -1 && url.indexOf('++plone++') !== -1){
+              items.push({id: url, text: url});
+            }
           }
         }
         return items;
diff --git a/mockup/patterns/resourceregistry/js/registry.js b/mockup/patterns/resourceregistry/js/registry.js
index f1c623d..214ca77 100644
--- a/mockup/patterns/resourceregistry/js/registry.js
+++ b/mockup/patterns/resourceregistry/js/registry.js
@@ -33,7 +33,8 @@ define([
           containerData: self.options.containerData,
           resourceName: self.options.name,
           registryView: self.options.registryView,
-          parent: self.options.parent
+          parent: self.options.parent,
+          form: self
         });
         if(!options.value){
           options.value = '';
@@ -185,6 +186,10 @@ define([
       if(window.confirm(_t('Are you sure you want to delete the ${name} resource?', {name: this.options.name}))){
         delete this.options.registryView.options.data.resources[this.options.name];
         this.options.registryView.dirty = true;
+        if(this.options.registryView.activeResource &&
+           this.options.registryView.activeResource.resource.name === this.options.name){
+          this.options.registryView.activeResource = null;
+        }
         this.options.registryView.render();
       }
     }
@@ -245,8 +250,7 @@ define([
         e.preventDefault();
       }
       var options = $.extend({}, this.options, {
-        containerData: this.options.registryView.options.data.bundles,
-        parent: this
+        containerData: this.options.registryView.options.data.bundles
       });
       var resource = new BundleEntryView(options);
       this.registryView.showResourceEditor(resource, this, 'bundle');
@@ -264,6 +268,10 @@ define([
       if(window.confirm(_t('Are you sure you want to delete the ${name} bundle?', {name: this.options.name}))){
         delete this.options.registryView.options.data.bundles[this.options.name];
         this.options.registryView.dirty = true;
+        if(this.options.registryView.activeResource &&
+           this.options.registryView.activeResource.resource.name === this.options.name){
+          this.options.registryView.activeResource = null;
+        }
         this.options.registryView.render();
       }
     },
@@ -520,8 +528,17 @@ define([
         development: self.options.data.development && 'true' || 'false'
       }, function(){
         self.dirty = false;
+        var activeResource = self.activeResource;
+        self.activeResource = null;
         self.previousData = self._copyData();
         self.render();
+        if(activeResource){
+          var name = activeResource.resource.name;
+          self.options.data.resources[name] = {
+            enabled: true
+          };
+          self.items.resources[name].editResource();
+        }
       });
     },
 
diff --git a/mockup/patterns/resourceregistry/pattern.resourceregistry.less b/mockup/patterns/resourceregistry/pattern.resourceregistry.less
index 9c3b691..634a3f9 100644
--- a/mockup/patterns/resourceregistry/pattern.resourceregistry.less
+++ b/mockup/patterns/resourceregistry/pattern.resourceregistry.less
@@ -134,4 +134,12 @@
             margin: -6px -12px -6px;
         }
     }
+
+    .bundles{
+        .list-group-item.active{
+            a{
+                color: white;
+            }
+        }
+    }
 }


