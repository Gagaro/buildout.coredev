Repository: plone.app.contentrules


Branch: refs/heads/master
Date: 2015-09-10T12:23:03+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.contentrules/commit/9ff1cf3e33ee587a02575f136b2ff7b38b6608f0

Use z3c.form for custom email-action form template

Files changed:
M CHANGES.rst
M plone/app/contentrules/actions/templates/mail.pt

diff --git a/CHANGES.rst b/CHANGES.rst
index ecd4bd0..ddb7203 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,9 @@ Changelog
 4.0.7 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- Use z3c.form for custom email-action form template.
+  Fixes https://github.com/plone/Products.CMFPlone/issues/892
+  [pbauer]
 
 
 4.0.6 (2015-07-18)
diff --git a/plone/app/contentrules/actions/templates/mail.pt b/plone/app/contentrules/actions/templates/mail.pt
index 1748a43..3161104 100644
--- a/plone/app/contentrules/actions/templates/mail.pt
+++ b/plone/app/contentrules/actions/templates/mail.pt
@@ -1,174 +1,28 @@
-<html xmlns="http://www.w3.org/1999/xhtml"
-      xmlns:metal="http://xml.zope.org/namespaces/metal"
-      xmlns:tal="http://xml.zope.org/namespaces/tal"
-      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
-      metal:use-macro="context/main_template/macros/master"
-      i18n:domain="plone">
-<head>
-</head>
-
-<body>
-<metal:main fill-slot="main">
-
-    <metal:block metal:define-macro="form">
-
-     <tal:status define="status view/status" condition="status">
-         <dl class="portalMessage error"
-             tal:condition="view/errors">
-             <dt i18n:translate="">
-                 Error
-             </dt>
-             <dd tal:content="status" />
-         </dl>
-
-         <dl class="portalMessage info"
-             tal:condition="not: view/errors">
-             <dt i18n:translate="">
-                 Info
-             </dt>
-             <dd tal:content="status" />
-         </dl>
-     </tal:status>
-
-     <h1  class="documentFirstHeading"
-          i18n:translate=""
-          tal:condition="view/label"
-          tal:content="view/label"
-          metal:define-slot="heading"
-          >Do something</h1>
-
-     <div class="documentDescription" tal:content="view/description|nothing">Description</div>
-
-    <div id="content-core">
-    <form action="." metal:define-macro="master"
-          tal:attributes="action request/URL;
-                          class string:kssattr-formname-${view/__name__}"
-          method="post"
-          enctype="multipart/form-data"
-          id="zc.page.browser_form">
-
-      <metal:block define-macro="header">
-
-        <tal:block replace="nothing">
-          <div class="form-status"
-           tal:define="status view/status"
-           tal:condition="status">
-
-              <div class="summary"
-                   i18n:translate=""
-                   tal:content="view/status">
-                Form status summary
-              </div>
-
-              <ul id="formlib-errors" class="errors" tal:condition="view/errors">
-                 <li tal:repeat="error view/error_views">
-                    <span tal:replace="structure error">Error Type</span>
-                 </li>
-              </ul>
-          </div>
-      </tal:block>
-
-      </metal:block>
-
-      <div metal:define-slot="extra_info" tal:replace="nothing">
-      </div>
-
-      <fieldset tal:define="form_name view/form_name|nothing"
-                tal:omit-tag="not:form_name">
-        <legend tal:condition="form_name"
-                tal:content="form_name"
-                i18n:translate="">Form name</legend>
-      <tal:block tal:repeat="widget view/widgets">
-        <div class="field"
-             tal:define="description widget/hint;
-                         error widget/error;
-                         normalized_name python:widget.name.replace('.', '-');
-                         fieldname_class string:kssattr-fieldname-${widget/name};
-                         error_class python:error and ' error' or ' '"
-             tal:attributes="id string:formfield-${normalized_name};
-                             class string:field ${fieldname_class}${error_class}">
-              <label tal:condition="widget/label"
-                     tal:attributes="for widget/name">
-                <span i18n:translate=""
-                      tal:content="widget/label">label</span>
-              </label>
-              <span class="fieldRequired" title="Required"
-                    tal:condition="widget/required"
-                    i18n:translate="label_required"
-                    i18n:attributes="title title_required;">
-                (Required)
-              </span>
-              <div class="formHelp"
-                   i18n:translate=""
-                   tal:content="description"
-                   tal:condition="description"
-                   >field description</div>
-    	  <tal:comment tal:condition="nothing">
-    	    <!-- The structure keyword is necessary as Invariant strings have a
-    	         span tag. It is often useful to set Invariant errors on the
-    		 fields they refer to. -->
-    	  </tal:comment>
-              <div class="fieldErrorBox" tal:content="structure error">
-                The Error
-              </div>
-              <div class="widget formlibInlineValidation" tal:content="structure widget">
-              <input type="text" /></div>
-              <tal:comment tal:condition="nothing">
-                <!-- TODO Put this back, the Zope3 way.
-                <img src="alert.gif" alt="Error"
-                tal:replace="structure context/alert.gif" />
-                -->
-              </tal:comment>
-        </div>
-    </tal:block>
-
-      <metal:block define-slot="above_buttons" />
-    <div id="actionsView">
-      <span class="actionButtons"
-            tal:condition="view/availableActions"
-            metal:define-slot="bottom_buttons">
-        <input tal:repeat="action view/actions"
-               tal:replace="structure action/render"
-               />
-      </span>
-    </div>
-      </fieldset>
-    </form>
-
-    <h1 i18n:translate="title_contentrules_mailsub">Substitutions</h1>
-
-    <p i18n:translate="description-contentrules-mailsub">
-        Some content in the subject, email source, email recipient and message
-        may be replaced with "$&#123;&#125;" variables from the table below.
-    </p>
-
-    <table class="listing">
-    <thead>
-        <tr>
-            <th i18n:translate="category-contentrules-mailsub">Category</th>
-            <th i18n:translate="variable-contentrules-mailsub">Variable</th>
-            <th i18n:translate="substitution-contentrules-mailsub">Substitution</th>
-        </tr>
-    </thead>
-    <tbody>
-    <tal:block tal:define="sublist here/@@stringinterp_info/substitutionList"
-         tal:repeat="category sublist">
-         <tr tal:repeat="item python:category['items']">
-             <td tal:content="category/category">All Content</td>
-             <td>${<span tal:replace="item/id">url</span>}</td>
-             <td tal:content="item/description">URL</td>
-         </tr>
-    </tal:block>
-    </tbody>
-    </table>
-
-    <script type="text/javascript"
-        tal:define="extra_script view/extra_script | nothing"
-        tal:condition="extra_script"
-        tal:content="structure extra_script" />
-
-    </div>
-
-</metal:block>
-</metal:main>
-</body></html>
+<metal:block use-macro="context/@@ploneform-macros/titlelessform" />
+
+<h1 i18n:translate="title_contentrules_mailsub">Substitutions</h1>
+
+<p i18n:translate="description-contentrules-mailsub">
+    Some content in the subject, email source, email recipient and message
+    may be replaced with "$&#123;&#125;" variables from the table below.
+</p>
+
+<table class="listing">
+<thead>
+    <tr>
+        <th i18n:translate="category-contentrules-mailsub">Category</th>
+        <th i18n:translate="variable-contentrules-mailsub">Variable</th>
+        <th i18n:translate="substitution-contentrules-mailsub">Substitution</th>
+    </tr>
+</thead>
+<tbody>
+<tal:block tal:define="sublist here/@@stringinterp_info/substitutionList"
+     tal:repeat="category sublist">
+     <tr tal:repeat="item python:category['items']">
+         <td tal:content="category/category">All Content</td>
+         <td>${<span tal:replace="item/id">url</span>}</td>
+         <td tal:content="item/description">URL</td>
+     </tr>
+</tal:block>
+</tbody>
+</table>


Repository: plone.app.contentrules


Branch: refs/heads/master
Date: 2015-09-10T13:22:26+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.contentrules/commit/11efd3f06c396262357062cd7465119e302ddfa0

test custom form

Files changed:
M plone/app/contentrules/tests/test_action_mail.py

diff --git a/plone/app/contentrules/tests/test_action_mail.py b/plone/app/contentrules/tests/test_action_mail.py
index 287cef7..520aadc 100644
--- a/plone/app/contentrules/tests/test_action_mail.py
+++ b/plone/app/contentrules/tests/test_action_mail.py
@@ -80,6 +80,8 @@ def testInvokeAddView(self):
         self.assertTrue(isinstance(addview, MailAddFormView))
 
         addview.form_instance.update()
+        output = addview.form_instance()
+        self.assertIn('<h1>Substitutions</h1>', output)
         content = addview.form_instance.create(data={'subject': 'My Subject',
                                                      'source': 'foo@bar.be',
                                                      'recipients': 'foo@bar.be,bar@foo.be',


Repository: plone.app.contentrules


Branch: refs/heads/master
Date: 2015-09-10T13:38:36+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.contentrules/commit/ad87bfdf6745f9ef3d7b6be11cbc47ff7edd5ffe

fix modals by creating an auth_token for each form

Files changed:
M plone/app/contentrules/browser/templates/manage-elements.pt

diff --git a/plone/app/contentrules/browser/templates/manage-elements.pt b/plone/app/contentrules/browser/templates/manage-elements.pt
index 49d5988..b05164a 100644
--- a/plone/app/contentrules/browser/templates/manage-elements.pt
+++ b/plone/app/contentrules/browser/templates/manage-elements.pt
@@ -8,8 +8,7 @@
 
 <body>
 
-<div metal:fill-slot="prefs_configlet_main"
-     tal:define="auth_token context/@@authenticator/token">
+<div metal:fill-slot="prefs_configlet_main">
 
     <link rel="stylesheet" type="text/css" media="all"
           href="++resource++manage-contentrules.css"
@@ -49,6 +48,7 @@
           </span>
         </div>
         <form tal:attributes="action view/view_url" method="post"
+              tal:define="auth_token context/@@authenticator/token"
               tal:repeat="condition conditions">
             <span tal:replace="structure context/@@authenticator/authenticator"></span>
             <a tal:attributes="name string:condition++${condition/idx}"></a>
@@ -125,6 +125,7 @@
           </span>
         </div>
         <form tal:attributes="action view/view_url" method="post"
+              tal:define="auth_token context/@@authenticator/token"
               tal:repeat="action actions">
             <span tal:replace="structure context/@@authenticator/authenticator"></span>
             <a tal:attributes="name string:action++${action/idx}"></a>


Repository: plone.app.contentrules


Branch: refs/heads/master
Date: 2015-09-10T22:15:51+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.contentrules/commit/90c2bb6aa59fe29e6517bb29727be0bc52642ab2

Merge pull request #16 from plone/fix_email_action

Use z3c.form for custom email-action form template

Files changed:
M CHANGES.rst
M plone/app/contentrules/actions/templates/mail.pt
M plone/app/contentrules/browser/templates/manage-elements.pt
M plone/app/contentrules/tests/test_action_mail.py

diff --git a/CHANGES.rst b/CHANGES.rst
index ecd4bd0..ddb7203 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,9 @@ Changelog
 4.0.7 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- Use z3c.form for custom email-action form template.
+  Fixes https://github.com/plone/Products.CMFPlone/issues/892
+  [pbauer]
 
 
 4.0.6 (2015-07-18)
diff --git a/plone/app/contentrules/actions/templates/mail.pt b/plone/app/contentrules/actions/templates/mail.pt
index 1748a43..3161104 100644
--- a/plone/app/contentrules/actions/templates/mail.pt
+++ b/plone/app/contentrules/actions/templates/mail.pt
@@ -1,174 +1,28 @@
-<html xmlns="http://www.w3.org/1999/xhtml"
-      xmlns:metal="http://xml.zope.org/namespaces/metal"
-      xmlns:tal="http://xml.zope.org/namespaces/tal"
-      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
-      metal:use-macro="context/main_template/macros/master"
-      i18n:domain="plone">
-<head>
-</head>
-
-<body>
-<metal:main fill-slot="main">
-
-    <metal:block metal:define-macro="form">
-
-     <tal:status define="status view/status" condition="status">
-         <dl class="portalMessage error"
-             tal:condition="view/errors">
-             <dt i18n:translate="">
-                 Error
-             </dt>
-             <dd tal:content="status" />
-         </dl>
-
-         <dl class="portalMessage info"
-             tal:condition="not: view/errors">
-             <dt i18n:translate="">
-                 Info
-             </dt>
-             <dd tal:content="status" />
-         </dl>
-     </tal:status>
-
-     <h1  class="documentFirstHeading"
-          i18n:translate=""
-          tal:condition="view/label"
-          tal:content="view/label"
-          metal:define-slot="heading"
-          >Do something</h1>
-
-     <div class="documentDescription" tal:content="view/description|nothing">Description</div>
-
-    <div id="content-core">
-    <form action="." metal:define-macro="master"
-          tal:attributes="action request/URL;
-                          class string:kssattr-formname-${view/__name__}"
-          method="post"
-          enctype="multipart/form-data"
-          id="zc.page.browser_form">
-
-      <metal:block define-macro="header">
-
-        <tal:block replace="nothing">
-          <div class="form-status"
-           tal:define="status view/status"
-           tal:condition="status">
-
-              <div class="summary"
-                   i18n:translate=""
-                   tal:content="view/status">
-                Form status summary
-              </div>
-
-              <ul id="formlib-errors" class="errors" tal:condition="view/errors">
-                 <li tal:repeat="error view/error_views">
-                    <span tal:replace="structure error">Error Type</span>
-                 </li>
-              </ul>
-          </div>
-      </tal:block>
-
-      </metal:block>
-
-      <div metal:define-slot="extra_info" tal:replace="nothing">
-      </div>
-
-      <fieldset tal:define="form_name view/form_name|nothing"
-                tal:omit-tag="not:form_name">
-        <legend tal:condition="form_name"
-                tal:content="form_name"
-                i18n:translate="">Form name</legend>
-      <tal:block tal:repeat="widget view/widgets">
-        <div class="field"
-             tal:define="description widget/hint;
-                         error widget/error;
-                         normalized_name python:widget.name.replace('.', '-');
-                         fieldname_class string:kssattr-fieldname-${widget/name};
-                         error_class python:error and ' error' or ' '"
-             tal:attributes="id string:formfield-${normalized_name};
-                             class string:field ${fieldname_class}${error_class}">
-              <label tal:condition="widget/label"
-                     tal:attributes="for widget/name">
-                <span i18n:translate=""
-                      tal:content="widget/label">label</span>
-              </label>
-              <span class="fieldRequired" title="Required"
-                    tal:condition="widget/required"
-                    i18n:translate="label_required"
-                    i18n:attributes="title title_required;">
-                (Required)
-              </span>
-              <div class="formHelp"
-                   i18n:translate=""
-                   tal:content="description"
-                   tal:condition="description"
-                   >field description</div>
-    	  <tal:comment tal:condition="nothing">
-    	    <!-- The structure keyword is necessary as Invariant strings have a
-    	         span tag. It is often useful to set Invariant errors on the
-    		 fields they refer to. -->
-    	  </tal:comment>
-              <div class="fieldErrorBox" tal:content="structure error">
-                The Error
-              </div>
-              <div class="widget formlibInlineValidation" tal:content="structure widget">
-              <input type="text" /></div>
-              <tal:comment tal:condition="nothing">
-                <!-- TODO Put this back, the Zope3 way.
-                <img src="alert.gif" alt="Error"
-                tal:replace="structure context/alert.gif" />
-                -->
-              </tal:comment>
-        </div>
-    </tal:block>
-
-      <metal:block define-slot="above_buttons" />
-    <div id="actionsView">
-      <span class="actionButtons"
-            tal:condition="view/availableActions"
-            metal:define-slot="bottom_buttons">
-        <input tal:repeat="action view/actions"
-               tal:replace="structure action/render"
-               />
-      </span>
-    </div>
-      </fieldset>
-    </form>
-
-    <h1 i18n:translate="title_contentrules_mailsub">Substitutions</h1>
-
-    <p i18n:translate="description-contentrules-mailsub">
-        Some content in the subject, email source, email recipient and message
-        may be replaced with "$&#123;&#125;" variables from the table below.
-    </p>
-
-    <table class="listing">
-    <thead>
-        <tr>
-            <th i18n:translate="category-contentrules-mailsub">Category</th>
-            <th i18n:translate="variable-contentrules-mailsub">Variable</th>
-            <th i18n:translate="substitution-contentrules-mailsub">Substitution</th>
-        </tr>
-    </thead>
-    <tbody>
-    <tal:block tal:define="sublist here/@@stringinterp_info/substitutionList"
-         tal:repeat="category sublist">
-         <tr tal:repeat="item python:category['items']">
-             <td tal:content="category/category">All Content</td>
-             <td>${<span tal:replace="item/id">url</span>}</td>
-             <td tal:content="item/description">URL</td>
-         </tr>
-    </tal:block>
-    </tbody>
-    </table>
-
-    <script type="text/javascript"
-        tal:define="extra_script view/extra_script | nothing"
-        tal:condition="extra_script"
-        tal:content="structure extra_script" />
-
-    </div>
-
-</metal:block>
-</metal:main>
-</body></html>
+<metal:block use-macro="context/@@ploneform-macros/titlelessform" />
+
+<h1 i18n:translate="title_contentrules_mailsub">Substitutions</h1>
+
+<p i18n:translate="description-contentrules-mailsub">
+    Some content in the subject, email source, email recipient and message
+    may be replaced with "$&#123;&#125;" variables from the table below.
+</p>
+
+<table class="listing">
+<thead>
+    <tr>
+        <th i18n:translate="category-contentrules-mailsub">Category</th>
+        <th i18n:translate="variable-contentrules-mailsub">Variable</th>
+        <th i18n:translate="substitution-contentrules-mailsub">Substitution</th>
+    </tr>
+</thead>
+<tbody>
+<tal:block tal:define="sublist here/@@stringinterp_info/substitutionList"
+     tal:repeat="category sublist">
+     <tr tal:repeat="item python:category['items']">
+         <td tal:content="category/category">All Content</td>
+         <td>${<span tal:replace="item/id">url</span>}</td>
+         <td tal:content="item/description">URL</td>
+     </tr>
+</tal:block>
+</tbody>
+</table>
diff --git a/plone/app/contentrules/browser/templates/manage-elements.pt b/plone/app/contentrules/browser/templates/manage-elements.pt
index 49d5988..b05164a 100644
--- a/plone/app/contentrules/browser/templates/manage-elements.pt
+++ b/plone/app/contentrules/browser/templates/manage-elements.pt
@@ -8,8 +8,7 @@
 
 <body>
 
-<div metal:fill-slot="prefs_configlet_main"
-     tal:define="auth_token context/@@authenticator/token">
+<div metal:fill-slot="prefs_configlet_main">
 
     <link rel="stylesheet" type="text/css" media="all"
           href="++resource++manage-contentrules.css"
@@ -49,6 +48,7 @@
           </span>
         </div>
         <form tal:attributes="action view/view_url" method="post"
+              tal:define="auth_token context/@@authenticator/token"
               tal:repeat="condition conditions">
             <span tal:replace="structure context/@@authenticator/authenticator"></span>
             <a tal:attributes="name string:condition++${condition/idx}"></a>
@@ -125,6 +125,7 @@
           </span>
         </div>
         <form tal:attributes="action view/view_url" method="post"
+              tal:define="auth_token context/@@authenticator/token"
               tal:repeat="action actions">
             <span tal:replace="structure context/@@authenticator/authenticator"></span>
             <a tal:attributes="name string:action++${action/idx}"></a>
diff --git a/plone/app/contentrules/tests/test_action_mail.py b/plone/app/contentrules/tests/test_action_mail.py
index 287cef7..520aadc 100644
--- a/plone/app/contentrules/tests/test_action_mail.py
+++ b/plone/app/contentrules/tests/test_action_mail.py
@@ -80,6 +80,8 @@ def testInvokeAddView(self):
         self.assertTrue(isinstance(addview, MailAddFormView))
 
         addview.form_instance.update()
+        output = addview.form_instance()
+        self.assertIn('<h1>Substitutions</h1>', output)
         content = addview.form_instance.create(data={'subject': 'My Subject',
                                                      'source': 'foo@bar.be',
                                                      'recipients': 'foo@bar.be,bar@foo.be',


