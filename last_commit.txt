Repository: borg.localrole
Branch: refs/heads/master
Date: 2015-05-27T13:45:25+02:00
Author: Gaudenz Steinlin () <gaudenz.steinlin@cirrax.com>
Commit: https://github.com/plone/borg.localrole/commit/342347d231f4ac34fa1a5d6910eda420711f6f65

Don't use id(obj) in cache keys

The Python id function does not guarantee to be unique during a request.
Results are only unique during the lifetime of an object, but an object
may be garbage collected before the request is over. Just don't cache
the result if no better key is available.

Files changed:
M CHANGES.txt
M borg/localrole/workspace.py

diff --git a/CHANGES.txt b/CHANGES.txt
index 039a6f1..bb5827a 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -4,7 +4,8 @@ Changelog
 3.1.2 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- Don't use id(obj) in cache keys
+  [gaudenz]
 
 
 3.1.1 (2014-10-23)
diff --git a/borg/localrole/workspace.py b/borg/localrole/workspace.py
index a1bea37..6506568 100644
--- a/borg/localrole/workspace.py
+++ b/borg/localrole/workspace.py
@@ -123,7 +123,7 @@ def clra_cache_key(method, self, user, obj, object_roles):
     try:
         oid = obj.getPhysicalPath()
     except AttributeError:
-        oid = id(obj)
+        raise DontCache
     return (user.getId(), oid, tuple(object_roles))
 
 


