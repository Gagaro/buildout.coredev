Repository: Products.CMFPlone
Branch: refs/heads/master
Date: 2015-04-23T16:30:37+02:00
Author: Ramon Navarro Bosch () <ramon@iMac-de-Ramon.local>
Commit: https://github.com/plone/Products.CMFPlone/commit/b2f38b9224b4ca2169552acc6eddf0f88b2b9210

Not using portal_state because TestRequest can't have annotations and it breaks on plone.app.z3cform

Files changed:
M Products/CMFPlone/patterns/__init__.py

diff --git a/Products/CMFPlone/patterns/__init__.py b/Products/CMFPlone/patterns/__init__.py
index 962bea2..b851396 100644
--- a/Products/CMFPlone/patterns/__init__.py
+++ b/Products/CMFPlone/patterns/__init__.py
@@ -16,7 +16,7 @@
 from Products.CMFCore.utils import getToolByName
 from zope.ramcache.interfaces import ram
 from plone.app.theming.utils import isThemeEnabled
-from zope.component import queryMultiAdapter
+from zope.component.hooks import getSite
 
 
 class PloneSettingsAdapter(object):
@@ -84,8 +84,7 @@ def tinymce(self):
         current_path = folder.absolute_url()[len(config['portal_url']):]
 
         # Check if theme has a custom content css
-        portal_state = queryMultiAdapter((self.context, self.request), name=u"plone_portal_state")
-        portal = portal_state.portal()
+        portal = getSite()
         # Volatile attribute to cache the current theme
         if hasattr(portal, '_v_currentTheme'):
             themeObj = portal._v_currentTheme


