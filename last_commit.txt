Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-09-17T15:24:11+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/978d43503c1545515a2f9d0afec45cbb7db7d737

Move calendar_starting_year and calendar_future_years_available to registry

Files changed:
M CHANGES.rst
M Products/CMFPlone/interfaces/controlpanel.py
M Products/CMFPlone/profiles/default/propertiestool.xml
M Products/CMFPlone/skins/plone_scripts/date_components_support.py
M Products/CMFPlone/tests/testDateComponentsSupport.py

diff --git a/CHANGES.rst b/CHANGES.rst
index a2731b7..68a6c04 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -8,13 +8,17 @@ Changelog
 5.0rc3 (unreleased)
 -------------------
 
+- Move calendar_starting_year and calendar_future_years_available to
+  registry and Products.Archetypes.
+  [pbauer]
+
 - Add view @@hero to be included by plonetheme.barceloneta with diazo.
   [pbauer]
 
 - Fix #991: improve contrast for pending state in tollbar.
   [pabo3000]
 
-- remove unused code to create NavTree probably left from Plone 3.0 times 
+- remove unused code to create NavTree probably left from Plone 3.0 times
   and since a while handled by plone.app.portlets.
   [jensens]
 
diff --git a/Products/CMFPlone/interfaces/controlpanel.py b/Products/CMFPlone/interfaces/controlpanel.py
index bc0286f..d433a33 100644
--- a/Products/CMFPlone/interfaces/controlpanel.py
+++ b/Products/CMFPlone/interfaces/controlpanel.py
@@ -885,21 +885,6 @@ class ISearchSchema(Interface):
         required=False,
         default=160,
     )
-# TODO: These need to get moved into ATCT setup profile.
-# 'ATBooleanCriterion',
-# 'ATDateCriteria',
-# 'ATDateRangeCriterion',
-# 'ATListCriterion',
-# 'ATPortalTypeCriterion',
-# 'ATReferenceCriterion',
-# 'ATSelectionCriterion',
-# 'ATSimpleIntCriterion',
-# 'ATSimpleStringCriterion',
-# 'ATSortCriterion',
-# 'ChangeSet',
-# 'ATCurrentAuthorCriterion',
-# 'ATPathCriterion',
-# 'ATRelativePathCriterion',
 
 
 class ISecuritySchema(Interface):
diff --git a/Products/CMFPlone/profiles/default/propertiestool.xml b/Products/CMFPlone/profiles/default/propertiestool.xml
index 86ea886..43a15c3 100644
--- a/Products/CMFPlone/profiles/default/propertiestool.xml
+++ b/Products/CMFPlone/profiles/default/propertiestool.xml
@@ -45,8 +45,6 @@
    <element value="Site Administrator"/>
    <element value="Reviewer"/>
   </property>
-  <property name="calendar_starting_year" type="int">2001</property>
-  <property name="calendar_future_years_available" type="int">5</property>
   <property name="default_page" type="lines">
    <element value="index_html"/>
    <element value="index.html"/>
diff --git a/Products/CMFPlone/skins/plone_scripts/date_components_support.py b/Products/CMFPlone/skins/plone_scripts/date_components_support.py
index d8df51b..c751867 100644
--- a/Products/CMFPlone/skins/plone_scripts/date_components_support.py
+++ b/Products/CMFPlone/skins/plone_scripts/date_components_support.py
@@ -63,15 +63,14 @@ def month_names():
     date = PLONE_CEILING
 
 # Get portal year range
-site_properties = context.portal_properties.site_properties
+registry = context.portal_registry
 if starting_year is None:
-    min_year = site_properties.getProperty('calendar_starting_year', 1999)
+    min_year = registry['Products.Archetypes.calendar_starting_year']
 else:
     min_year = starting_year
 if ending_year is None:
     if future_years is None:
-        max_year = site_properties.getProperty(
-                        'calendar_future_years_available', 5) + now.year()
+        max_year = registry['Products.Archetypes.calendar_future_years_available'] + now.year()
     else:
         max_year = future_years + now.year()
 else:
diff --git a/Products/CMFPlone/tests/testDateComponentsSupport.py b/Products/CMFPlone/tests/testDateComponentsSupport.py
index bb7877f..237e350 100644
--- a/Products/CMFPlone/tests/testDateComponentsSupport.py
+++ b/Products/CMFPlone/tests/testDateComponentsSupport.py
@@ -21,10 +21,11 @@ def testElements(self):
 
     def testYears(self):
         this_year = DateTime().year()
-        site_properties = self.portal.portal_properties.site_properties
-        min_year = site_properties.getProperty('calendar_starting_year', 1999)
-        max_year = site_properties.getProperty(
-                        'calendar_future_years_available', 5) + this_year
+        from plone.registry.interfaces import IRegistry
+        from zope.component import getUtility
+        registry = getUtility(IRegistry)
+        min_year = registry.get('Products.Archetypes.calendar_starting_year', 1999)
+        max_year = registry.get('Products.Archetypes.calendar_future_years_available', 5) + this_year
 
         data = [
             {'selected': None, 'id': '--', 'value': '0000'}
@@ -176,10 +177,11 @@ def testElements(self):
 
     def testYears(self):
         this_year = DateTime().year()
-        site_properties = self.portal.portal_properties.site_properties
-        min_year = site_properties.getProperty('calendar_starting_year', 1999)
-        max_year = site_properties.getProperty(
-                        'calendar_future_years_available', 5) + this_year
+        from plone.registry.interfaces import IRegistry
+        from zope.component import getUtility
+        registry = getUtility(IRegistry)
+        min_year = registry.get('Products.Archetypes.calendar_starting_year', 1999)
+        max_year = registry.get('Products.Archetypes.calendar_future_years_available', 5) + this_year
 
         data = [
             {'selected': None, 'id': '--', 'value': '0000'}


