Repository: mockup
Branch: refs/heads/master
Date: 2015-03-12T15:04:09+02:00
Author: Asko Soukka (datakurre) <asko.soukka@iki.fi>
Commit: https://github.com/plone/mockup/commit/d443e1d6a62fb867ad2859abb06bca96e5e11ac1

Fix less variable overrides by executing less-modify.js after the first less build

Files changed:
M mockup/patterns/resourceregistry/js/builder.js

diff --git a/mockup/patterns/resourceregistry/js/builder.js b/mockup/patterns/resourceregistry/js/builder.js
index 14781a9..25ee193 100644
--- a/mockup/patterns/resourceregistry/js/builder.js
+++ b/mockup/patterns/resourceregistry/js/builder.js
@@ -113,6 +113,10 @@ define([
       /* XXX okay, wish there were a better way,
          but we need to pool to find the out if it's down loading less */
       self.addResult(config.less.length + _t(' css files to build'));
+      var lessModified = Boolean(
+          self.rview.options.data.lessModifyUrl === null ||
+          self.rview.options.data.lessModifyUrl === undefined
+      );
       var checkFinished = function(){
         var $styles =  $('style[type="text/css"][id]', iframe.document);
         for(var i=0; i<$styles.length; i=i+1){
@@ -122,7 +126,7 @@ define([
             return self.finished(true);
           }
         }
-        if($styles.length === config.less.length){
+        if($styles.length === config.less.length && lessModified === true){
           // we're finished, save it
           var data = {};
           $styles.each(function(){
@@ -150,6 +154,16 @@ define([
               self.finished(true);
             }
           });
+        }else if($styles.length === config.less.length){
+          $styles.each(function(){$(this).remove();});
+
+          script = document.createElement('script');
+          script.setAttribute('type', 'text/javascript');
+          script.setAttribute('src', self.rview.options.data.lessModifyUrl);
+          head.appendChild(script);
+
+          lessModified = true;
+          setTimeout(checkFinished, 300);
         }else{
           setTimeout(checkFinished, 300);
         }
@@ -223,4 +237,4 @@ define([
   };
 
   return Builder;
-});
\ No newline at end of file
+});


Repository: mockup
Branch: refs/heads/master
Date: 2015-03-12T15:04:09+02:00
Author: Asko Soukka (datakurre) <asko.soukka@iki.fi>
Commit: https://github.com/plone/mockup/commit/a91d7dc266f853d7a55bc92fb2ba23cb5a462c5d

Update changelog

Files changed:
M CHANGES.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index 960f140..3c2f390 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -95,6 +95,10 @@ Fixes and enhancements:
   tags.
   [ACatlla, thet]
 
+- Fix less variable overrides on resourceregistry pattern when building
+  CSS from less resources
+  [datakurre]
+
 - Depend on ``tinymce-builded`` 4.1.6, include TinyMCE copy and sed
   configuration in here and fix some sed tasks.
   Revert cd89d377e10a28b797fd3c9d48410ad6ad597486: "Remove bower dependency on


Repository: mockup
Branch: refs/heads/master
Date: 2015-03-12T08:21:26-05:00
Author: Nathan Van Gheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/mockup/commit/3782970864ec3aef65c115f0e7338735e7d62111

Merge pull request #444 from plone/datakurre-add-less-modify

Fix less variable overrides by executing less-modify.js between the build and saving

Files changed:
M CHANGES.rst
M mockup/patterns/resourceregistry/js/builder.js

diff --git a/CHANGES.rst b/CHANGES.rst
index 960f140..3c2f390 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -95,6 +95,10 @@ Fixes and enhancements:
   tags.
   [ACatlla, thet]
 
+- Fix less variable overrides on resourceregistry pattern when building
+  CSS from less resources
+  [datakurre]
+
 - Depend on ``tinymce-builded`` 4.1.6, include TinyMCE copy and sed
   configuration in here and fix some sed tasks.
   Revert cd89d377e10a28b797fd3c9d48410ad6ad597486: "Remove bower dependency on
diff --git a/mockup/patterns/resourceregistry/js/builder.js b/mockup/patterns/resourceregistry/js/builder.js
index 14781a9..25ee193 100644
--- a/mockup/patterns/resourceregistry/js/builder.js
+++ b/mockup/patterns/resourceregistry/js/builder.js
@@ -113,6 +113,10 @@ define([
       /* XXX okay, wish there were a better way,
          but we need to pool to find the out if it's down loading less */
       self.addResult(config.less.length + _t(' css files to build'));
+      var lessModified = Boolean(
+          self.rview.options.data.lessModifyUrl === null ||
+          self.rview.options.data.lessModifyUrl === undefined
+      );
       var checkFinished = function(){
         var $styles =  $('style[type="text/css"][id]', iframe.document);
         for(var i=0; i<$styles.length; i=i+1){
@@ -122,7 +126,7 @@ define([
             return self.finished(true);
           }
         }
-        if($styles.length === config.less.length){
+        if($styles.length === config.less.length && lessModified === true){
           // we're finished, save it
           var data = {};
           $styles.each(function(){
@@ -150,6 +154,16 @@ define([
               self.finished(true);
             }
           });
+        }else if($styles.length === config.less.length){
+          $styles.each(function(){$(this).remove();});
+
+          script = document.createElement('script');
+          script.setAttribute('type', 'text/javascript');
+          script.setAttribute('src', self.rview.options.data.lessModifyUrl);
+          head.appendChild(script);
+
+          lessModified = true;
+          setTimeout(checkFinished, 300);
         }else{
           setTimeout(checkFinished, 300);
         }
@@ -223,4 +237,4 @@ define([
   };
 
   return Builder;
-});
\ No newline at end of file
+});


