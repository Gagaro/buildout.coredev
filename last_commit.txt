Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-10T20:48:52+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/c77e9d96bb4df6ecbd05519c284068ec53311922

migrate search_results_description_length

Files changed:
M plone/app/upgrade/v50/betas.py
M plone/app/upgrade/v50/profiles/to_rc2/registry.xml

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 7592674..969777b 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -3,6 +3,7 @@
 from Products.CMFPlone.interfaces import IMailSchema
 from Products.CMFPlone.interfaces import IMarkupSchema
 from Products.CMFPlone.interfaces import ISecuritySchema
+from Products.CMFPlone.interfaces import ISearchSchema
 from Products.CMFPlone.interfaces import ISiteSchema
 from Products.CMFPlone.interfaces import IUserGroupsSettingsSchema
 from Products.CMFPlone.interfaces import ILanguageSchema
@@ -410,3 +411,13 @@ def to50rc2(context):
         if portal.hasProperty(p):
             portal._delProperty(p)
 
+    # Migrate settings from portal_properties to the configuration registry
+    pprop = getToolByName(portal, 'portal_properties')
+    site_properties = pprop['site_properties']
+
+    if site_properties.hasProperty('search_results_description_length'):
+        registry = getUtility(IRegistry)
+        settings = registry.forInterface(ISearchSchema, prefix='plone')
+        value = site_properties.getProperty(
+            'search_results_description_length', 160)
+        settings.search_results_description_length = value
diff --git a/plone/app/upgrade/v50/profiles/to_rc2/registry.xml b/plone/app/upgrade/v50/profiles/to_rc2/registry.xml
index 534327c..1b93620 100644
--- a/plone/app/upgrade/v50/profiles/to_rc2/registry.xml
+++ b/plone/app/upgrade/v50/profiles/to_rc2/registry.xml
@@ -2,4 +2,6 @@
 <registry>
   <records interface="Products.CMFPlone.interfaces.ISiteSchema"
            prefix="plone" />
+  <records interface="Products.CMFPlone.interfaces.ISearchSchema"
+           prefix="plone" />
 </registry>
\ No newline at end of file


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-10T20:55:26+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/a236cc7bd2950708832c300c542e906b8d8881c6

Merge pull request #48 from plone/search_results_description_length

migrate search_results_description_length

Files changed:
M plone/app/upgrade/v50/betas.py
M plone/app/upgrade/v50/profiles/to_rc2/registry.xml

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 7592674..969777b 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -3,6 +3,7 @@
 from Products.CMFPlone.interfaces import IMailSchema
 from Products.CMFPlone.interfaces import IMarkupSchema
 from Products.CMFPlone.interfaces import ISecuritySchema
+from Products.CMFPlone.interfaces import ISearchSchema
 from Products.CMFPlone.interfaces import ISiteSchema
 from Products.CMFPlone.interfaces import IUserGroupsSettingsSchema
 from Products.CMFPlone.interfaces import ILanguageSchema
@@ -410,3 +411,13 @@ def to50rc2(context):
         if portal.hasProperty(p):
             portal._delProperty(p)
 
+    # Migrate settings from portal_properties to the configuration registry
+    pprop = getToolByName(portal, 'portal_properties')
+    site_properties = pprop['site_properties']
+
+    if site_properties.hasProperty('search_results_description_length'):
+        registry = getUtility(IRegistry)
+        settings = registry.forInterface(ISearchSchema, prefix='plone')
+        value = site_properties.getProperty(
+            'search_results_description_length', 160)
+        settings.search_results_description_length = value
diff --git a/plone/app/upgrade/v50/profiles/to_rc2/registry.xml b/plone/app/upgrade/v50/profiles/to_rc2/registry.xml
index 534327c..1b93620 100644
--- a/plone/app/upgrade/v50/profiles/to_rc2/registry.xml
+++ b/plone/app/upgrade/v50/profiles/to_rc2/registry.xml
@@ -2,4 +2,6 @@
 <registry>
   <records interface="Products.CMFPlone.interfaces.ISiteSchema"
            prefix="plone" />
+  <records interface="Products.CMFPlone.interfaces.ISearchSchema"
+           prefix="plone" />
 </registry>
\ No newline at end of file


