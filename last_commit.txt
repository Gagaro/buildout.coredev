Repository: diazo


Branch: refs/heads/master
Date: 2015-09-02T23:27:26-07:00
Author: Laurence Rowe (lrowe) <laurence@lrowe.co.uk>
Commit: https://github.com/plone/diazo/commit/98b77b47502ec2d0fc325979ce2043e0e3bc2c95

Switch from experimental.cssselect to cssselect.

Files changed:
M lib/diazo/cssrules.py
M setup.py
M versions.cfg

diff --git a/lib/diazo/cssrules.py b/lib/diazo/cssrules.py
index 4512ea7..aae4d98 100644
--- a/lib/diazo/cssrules.py
+++ b/lib/diazo/cssrules.py
@@ -12,7 +12,7 @@
 from __future__ import absolute_import
 from optparse import OptionParser
 from lxml import etree
-from experimental.cssselect import css_to_xpath
+from cssselect import GenericTranslator
 from . import utils
 import sys
 import logging
@@ -21,6 +21,16 @@
 usage = __doc__
 
 
+class LocationPathTranslator(GenericTranslator):
+    def xpath_descendant_combinator(self, left, right):
+        """right is a child, grand-child or further descendant of left"""
+        return left.join('//', right)
+
+
+_generic_translator = GenericTranslator()
+_location_path_translator = LocationPathTranslator()
+
+
 def convert_css_selectors(rules):
     """Convert css rules to xpath rules element tree in place
     """
@@ -41,17 +51,17 @@ def convert_css_selectors(rules):
             if not value:
                 element.attrib[localname] = ""
                 continue
-            if css_prefix is not None:
-                prefix = css_prefix
-            elif (tag_namespace == utils.namespaces['diazo'] and
-                  localname in ('content', 'content-children', 'if-content',
-                                'if-not-content') or
+            if (tag_namespace == utils.namespaces['diazo'] and
+                localname in ('content', 'content-children', 'if-content',
+                              'if-not-content') or
                     (tag_namespace == utils.namespaces['xsl'] and
                      localname in ('match',))):
-                prefix = '//'
+                prefix = css_prefix or '//'
+                tr = _location_path_translator
             else:
-                prefix = 'descendant-or-self::'
-            element.attrib[localname] = css_to_xpath(value, prefix=prefix)
+                prefix = css_prefix or 'descendant-or-self::'
+                tr = _generic_translator
+            element.attrib[localname] = tr.css_to_xpath(value, prefix=prefix)
 
     return rules
 
diff --git a/setup.py b/setup.py
index 0564cac..a2290bc 100644
--- a/setup.py
+++ b/setup.py
@@ -51,7 +51,7 @@
     install_requires=[
         'setuptools',
         'lxml',
-        'experimental.cssselect',
+        'cssselect',
         'future',
         'six'],
     extras_require=extras_require,
diff --git a/versions.cfg b/versions.cfg
index febea31..4b66da6 100644
--- a/versions.cfg
+++ b/versions.cfg
@@ -3,7 +3,7 @@ versions = versions
 
 [versions]
 WebOb = 1.4
-experimental.cssselect = 0.3
+cssselect = 0.9.1
 lxml = 3.3.5
 repoze.xmliter = 0.5
 FormEncode = 1.3.0a1


Repository: diazo


Branch: refs/heads/master
Date: 2015-09-03T17:21:45-04:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/diazo/commit/39560904387f3d661b857f6b4ef155038ffb4f16

Add missing changelog entry for 1.1.2

Files changed:
M docs/CHANGES.txt

diff --git a/docs/CHANGES.txt b/docs/CHANGES.txt
index d8346b5..9668c93 100644
--- a/docs/CHANGES.txt
+++ b/docs/CHANGES.txt
@@ -4,6 +4,9 @@ Changelog
 1.1.2 (unreleased)
 ------------------
 
+* Allow inline content for after and before.
+  [ebrehault]
+
 * Fixed issue with remote themes via https connections
   [loechel]
 


Repository: diazo


Branch: refs/heads/master
Date: 2015-09-03T17:26:21-04:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/diazo/commit/7aa79864ace2b17fa0f2865a7540574e3f6fef77

Bump to 1.2.0

Files changed:
M docs/CHANGES.txt
M setup.py

diff --git a/docs/CHANGES.txt b/docs/CHANGES.txt
index 9668c93..a4e93c9 100644
--- a/docs/CHANGES.txt
+++ b/docs/CHANGES.txt
@@ -1,11 +1,18 @@
 Changelog
 =========
 
-1.1.2 (unreleased)
+1.2.0 (unreleased)
+------------------
+
+* Extend cssselect instead of using experimental.cssselect
+  [elro]
+
+
+1.1.2 (2015-09-03)
 ------------------
 
 * Allow inline content for after and before.
-  [ebrehault]
+  [ebrehault, elro]
 
 * Fixed issue with remote themes via https connections
   [loechel]
diff --git a/setup.py b/setup.py
index a2290bc..3a918e3 100644
--- a/setup.py
+++ b/setup.py
@@ -19,7 +19,7 @@
 
 setup(
     name='diazo',
-    version='1.1.2.dev0',
+    version='1.2.0.dev0',
     description='''Diazo implements a Deliverance like language using a pure
         XSLT engine. With Diazo, you "compile" your theme and ruleset in one
         step, then use a superfast/simple transform on each request thereafter.


