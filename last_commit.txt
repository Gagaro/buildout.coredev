Repository: plone.resourceeditor


Branch: refs/heads/master
Date: 2015-08-07T12:54:54-05:00
Author: Sam Schwartz (obct537) <schwas45@uwosh.edu>
Commit: https://github.com/plone/plone.resourceeditor/commit/59c6e6a2b498d6cb7f988edab2aa99234234f8ac

Added the option to replace absolute url with relative

Files changed:
M plone/resourceeditor/browser.py

diff --git a/plone/resourceeditor/browser.py b/plone/resourceeditor/browser.py
index a0580c4..12ba9a0 100644
--- a/plone/resourceeditor/browser.py
+++ b/plone/resourceeditor/browser.py
@@ -1,7 +1,10 @@
 import urllib
 import os.path
 import json
+import re
+import posixpath
 
+from urlparse import urlparse
 from time import localtime, strftime
 from zope.component import queryMultiAdapter
 from zope.component.hooks import getSite
@@ -171,6 +174,23 @@ def saveFile(self, path, value):
         path = path.lstrip('/').encode('utf-8')
         value = unicode(value.strip(), 'utf-8')
         value = value.replace('\r\n', '\n')
+        
+        if self.request.form['relativeUrls'] == 'true':
+            reg = re.compile('url\(([^)]+)\)')
+            urls = reg.findall(value)
+            
+            location = self.request.URL[0:self.request.URL.find('@@')]
+            base = urlparse(location)
+            for url in urls:
+                asset = urlparse(url.strip("'").strip('"'))
+                if base.netloc != asset.netloc:
+                    continue
+                
+                base_dir = '.' + posixpath.dirname(base.path)
+                target = '.' + asset.path
+                out = posixpath.relpath(target, start=base_dir)
+                value = value.replace(url.strip('"').strip("'"), out)
+        
         self.context.writeFile(path, value.encode('utf-8'))
         self.request.response.setHeader('Content-Type', 'application/json')
         return json.dumps({'success': 'save'})
@@ -996,6 +1016,7 @@ def getFile(self, path):
     def saveFile(self, path, value):
         processInputs(self.request)
 
+        import pdb; pdb.set_trace()
         path = self.request.form.get('path', path)
         value = self.request.form.get('value', value)
 


Repository: plone.resourceeditor


Branch: refs/heads/master
Date: 2015-08-07T12:57:12-05:00
Author: Sam Schwartz (obct537) <schwas45@uwosh.edu>
Commit: https://github.com/plone/plone.resourceeditor/commit/2742ce3ca732896e65f29eb42890009223c2f616

Removed forgotten breakpoint

Files changed:
M plone/resourceeditor/browser.py

diff --git a/plone/resourceeditor/browser.py b/plone/resourceeditor/browser.py
index 12ba9a0..329730c 100644
--- a/plone/resourceeditor/browser.py
+++ b/plone/resourceeditor/browser.py
@@ -1016,7 +1016,6 @@ def getFile(self, path):
     def saveFile(self, path, value):
         processInputs(self.request)
 
-        import pdb; pdb.set_trace()
         path = self.request.form.get('path', path)
         value = self.request.form.get('value', value)
 


Repository: plone.resourceeditor


Branch: refs/heads/master
Date: 2015-08-07T13:05:00-05:00
Author: Sam Schwartz (obct537) <schwas45@uwosh.edu>
Commit: https://github.com/plone/plone.resourceeditor/commit/8354f2c75d64078f4d7998417037d99f9baa9443

Made the request URL substring more specific

Files changed:
M plone/resourceeditor/browser.py

diff --git a/plone/resourceeditor/browser.py b/plone/resourceeditor/browser.py
index 329730c..bb84a02 100644
--- a/plone/resourceeditor/browser.py
+++ b/plone/resourceeditor/browser.py
@@ -179,7 +179,7 @@ def saveFile(self, path, value):
             reg = re.compile('url\(([^)]+)\)')
             urls = reg.findall(value)
             
-            location = self.request.URL[0:self.request.URL.find('@@')]
+            location = self.request.URL[0:self.request.URL.find('@@plone.resourceeditor')]
             base = urlparse(location)
             for url in urls:
                 asset = urlparse(url.strip("'").strip('"'))


Repository: plone.resourceeditor


Branch: refs/heads/master
Date: 2015-08-07T13:07:27-05:00
Author: Sam Schwartz (obct537) <schwas45@uwosh.edu>
Commit: https://github.com/plone/plone.resourceeditor/commit/408718f9009029e0b6804094b5913385d1b999f3

Updated changelog

Files changed:
M CHANGES.txt
M plone/resourceeditor/browser.py

diff --git a/CHANGES.txt b/CHANGES.txt
index febc486..3504936 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -4,6 +4,8 @@ Changelog
 2.0.1 (unreleased)
 ------------------
 
+- Added ability to convert absolute to relative urls
+  [obct537]
 - Fixed issue with ascii encoding [obct537]
 - now properly serves filesystem files to the thememapper 
   [obct537]
diff --git a/plone/resourceeditor/browser.py b/plone/resourceeditor/browser.py
index bb84a02..0af62ae 100644
--- a/plone/resourceeditor/browser.py
+++ b/plone/resourceeditor/browser.py
@@ -179,6 +179,7 @@ def saveFile(self, path, value):
             reg = re.compile('url\(([^)]+)\)')
             urls = reg.findall(value)
             
+            #Trim off the @@plone.resourceeditor bit to just give us the theme url
             location = self.request.URL[0:self.request.URL.find('@@plone.resourceeditor')]
             base = urlparse(location)
             for url in urls:


Repository: plone.resourceeditor


Branch: refs/heads/master
Date: 2015-08-07T13:42:53-05:00
Author: Sam Schwartz (obct537) <schwas45@uwosh.edu>
Commit: https://github.com/plone/plone.resourceeditor/commit/9fc9d2c8bfae990c2af7debe88f27d12ac0585b3

Fixed issue preventing file saving

Files changed:
M plone/resourceeditor/browser.py

diff --git a/plone/resourceeditor/browser.py b/plone/resourceeditor/browser.py
index 0af62ae..99ee83c 100644
--- a/plone/resourceeditor/browser.py
+++ b/plone/resourceeditor/browser.py
@@ -175,7 +175,7 @@ def saveFile(self, path, value):
         value = unicode(value.strip(), 'utf-8')
         value = value.replace('\r\n', '\n')
         
-        if self.request.form['relativeUrls'] == 'true':
+        if 'relativeUrls' in self.request.form:
             reg = re.compile('url\(([^)]+)\)')
             urls = reg.findall(value)
             


Repository: plone.resourceeditor


Branch: refs/heads/master
Date: 2015-08-10T14:26:43-05:00
Author: Nathan Van Gheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.resourceeditor/commit/4941a76cd3668aac7cd6ab5a2f67449730f7421d

Merge pull request #9 from plone/relative_urls

Relative urls for LESS builder

Files changed:
M CHANGES.txt
M plone/resourceeditor/browser.py

diff --git a/CHANGES.txt b/CHANGES.txt
index febc486..3504936 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -4,6 +4,8 @@ Changelog
 2.0.1 (unreleased)
 ------------------
 
+- Added ability to convert absolute to relative urls
+  [obct537]
 - Fixed issue with ascii encoding [obct537]
 - now properly serves filesystem files to the thememapper 
   [obct537]
diff --git a/plone/resourceeditor/browser.py b/plone/resourceeditor/browser.py
index a0580c4..99ee83c 100644
--- a/plone/resourceeditor/browser.py
+++ b/plone/resourceeditor/browser.py
@@ -1,7 +1,10 @@
 import urllib
 import os.path
 import json
+import re
+import posixpath
 
+from urlparse import urlparse
 from time import localtime, strftime
 from zope.component import queryMultiAdapter
 from zope.component.hooks import getSite
@@ -171,6 +174,24 @@ def saveFile(self, path, value):
         path = path.lstrip('/').encode('utf-8')
         value = unicode(value.strip(), 'utf-8')
         value = value.replace('\r\n', '\n')
+        
+        if 'relativeUrls' in self.request.form:
+            reg = re.compile('url\(([^)]+)\)')
+            urls = reg.findall(value)
+            
+            #Trim off the @@plone.resourceeditor bit to just give us the theme url
+            location = self.request.URL[0:self.request.URL.find('@@plone.resourceeditor')]
+            base = urlparse(location)
+            for url in urls:
+                asset = urlparse(url.strip("'").strip('"'))
+                if base.netloc != asset.netloc:
+                    continue
+                
+                base_dir = '.' + posixpath.dirname(base.path)
+                target = '.' + asset.path
+                out = posixpath.relpath(target, start=base_dir)
+                value = value.replace(url.strip('"').strip("'"), out)
+        
         self.context.writeFile(path, value.encode('utf-8'))
         self.request.response.setHeader('Content-Type', 'application/json')
         return json.dumps({'success': 'save'})


