Repository: Products.CMFPlone
Branch: refs/heads/master
Date: 2015-01-29T19:13:45+01:00
Author: Ramon Navarro Bosch () <ramon@iMac-de-Ramon.local>
Commit: https://github.com/plone/Products.CMFPlone/commit/4b73760206955785941e8691ea1f8d53e722dd03

Forcing an specific JS/CSS resource for a view

Files changed:
M Products/CMFPlone/resources/__init__.py
M Products/CMFPlone/resources/browser/scripts.py
M Products/CMFPlone/resources/browser/styles.py

diff --git a/Products/CMFPlone/resources/__init__.py b/Products/CMFPlone/resources/__init__.py
index 19a173b..9a616c0 100644
--- a/Products/CMFPlone/resources/__init__.py
+++ b/Products/CMFPlone/resources/__init__.py
@@ -10,6 +10,16 @@ def onThemeApplied(event):
     # theme.disabled_bundles
 
 
+def add_resource_on_request(request, resource):
+    """ Adds the resource to the request
+    """
+    if hasattr(request, 'enabled_resources'):
+        if isinstance(resource, str):
+            request.enabled_resources.append(resource)
+    else:
+        request.enabled_resources = [resource]
+
+
 def add_bundle_on_request(request, bundle):
     """ Adds the bundle to the request
     """
diff --git a/Products/CMFPlone/resources/browser/scripts.py b/Products/CMFPlone/resources/browser/scripts.py
index 603ba47..0e02e9a 100644
--- a/Products/CMFPlone/resources/browser/scripts.py
+++ b/Products/CMFPlone/resources/browser/scripts.py
@@ -95,6 +95,26 @@ def scripts(self):
         })
         result.extend(self.ordered_bundles_result())
 
+        # Add manual added resources
+        resources = self.get_resources()
+        if hasattr(self.request, 'enabled_resources'):
+            for resource in self.request.enabled_resources:
+                if resource in resources:
+                    data = resources[resource]
+                    if data.js:
+                        url = urlparse(data.js)
+                        if url.netloc == '':
+                            # Local
+                            src = "%s/%s" % (self.portal_url, data.js)
+                        else:
+                            src = "%s" % (data.js)
+
+                        data = {
+                            'bundle': 'none',
+                            'conditionalcomment': '',  # noqa
+                            'src': src}
+                        result.append(data)
+
         # Add diazo url
         origin = None
         if self.diazo_production_js and self.development is False:
diff --git a/Products/CMFPlone/resources/browser/styles.py b/Products/CMFPlone/resources/browser/styles.py
index c4f60c7..dd3bd3d 100644
--- a/Products/CMFPlone/resources/browser/styles.py
+++ b/Products/CMFPlone/resources/browser/styles.py
@@ -75,6 +75,14 @@ def styles(self):
         Get all the styles
         """
         result = self.ordered_bundles_result()
+        # Add manual added resources
+        resources = self.get_resources()
+        if hasattr(self.request, 'enabled_resources'):
+            for resource in self.request.enabled_resources:
+                if resource in resources:                
+                    for data in self.get_urls(resources[resource], None):
+                        result.append(data)
+
         # Add diazo css
         origin = None
         if self.diazo_production_css and self.development is False:


