Repository: plone.app.querystring


Branch: refs/heads/master
Date: 2015-11-21T01:49:40+01:00
Author: Johannes Raggam () <raggam-nl@adm.at>
Commit: https://github.com/plone/plone.app.querystring/commit/b93fdf77814b1173f8b20d362765fa723d2c1c3d

Add upgrade step to replace selection.is with selection.any operations in querystrings also for objects using the Collection behavior.

Files changed:
M CHANGES.rst
M plone/app/querystring/profiles/default/metadata.xml
M plone/app/querystring/upgrades.py
M plone/app/querystring/upgrades.zcml

diff --git a/CHANGES.rst b/CHANGES.rst
index 29ed7e3..8e25c36 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,7 +10,9 @@ New:
 
 Fixes:
 
-- *add item here*
+- Add upgrade step to replace selection.is with selection.any operations in
+  querystrings also for objects using the Collection behavior.
+  [thet]
 
 
 1.3.11 (2015-10-30)
diff --git a/plone/app/querystring/profiles/default/metadata.xml b/plone/app/querystring/profiles/default/metadata.xml
index 7705a50..f88f99c 100644
--- a/plone/app/querystring/profiles/default/metadata.xml
+++ b/plone/app/querystring/profiles/default/metadata.xml
@@ -1,6 +1,6 @@
 <?xml version="1.0"?>
 <metadata>
-  <version>12</version>
+  <version>13</version>
   <dependencies>
       <dependency>profile-plone.app.registry:default</dependency>
   </dependencies>
diff --git a/plone/app/querystring/upgrades.py b/plone/app/querystring/upgrades.py
index 750f521..34307cf 100644
--- a/plone/app/querystring/upgrades.py
+++ b/plone/app/querystring/upgrades.py
@@ -18,7 +18,9 @@ def upgrade_1_to_2_typo_in_registry(context):
     registry[name] = values
 
 
-def fix_select_all_existing_collections(context):
+def fix_select_all_existing_collections(
+        context,
+        query={"portal_type": "Collection"}):
 
     indexes_to_fix = [
         u'portal_type',
@@ -34,9 +36,7 @@ def fix_select_all_existing_collections(context):
             u"plone.app.querystring.operation.selection.any",
     }
     catalog = context.portal_catalog
-    brains = catalog.unrestrictedSearchResults(
-        portal_type="Collection"
-    )
+    brains = catalog.unrestrictedSearchResults(**query)
 
     for brain in brains:
         changed = False
@@ -56,3 +56,11 @@ def fix_select_all_existing_collections(context):
         if changed:
             obj.query = fixed_querystring
             obj.reindexObject()
+
+
+def fix_select_all_syndicatable_collections(context):
+
+    return fix_select_all_existing_collections(
+        context,
+        query={"object_provides": "plone.app.contenttypes.behaviors.collection.ISyndicatableCollection"}  # noqa
+    )
diff --git a/plone/app/querystring/upgrades.zcml b/plone/app/querystring/upgrades.zcml
index 633c896..3ae8358 100644
--- a/plone/app/querystring/upgrades.zcml
+++ b/plone/app/querystring/upgrades.zcml
@@ -121,4 +121,13 @@
       handler=".upgrades.fix_select_all_existing_collections"
       />
 
+  <genericsetup:upgradeStep
+      source="12"
+      destination="13"
+      title="Fix ISyndicatableCollection objects"
+      profile="plone.app.querystring:default"
+      description="Fix indexes on Dexterity objects by changing 'is' operators to 'any'. All objects using the Collection behavior are fixed."
+      handler=".upgrades.fix_select_all_syndicatable_collections"
+      />
+
 </configure>


