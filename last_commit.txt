Repository: plone.theme
Branch: refs/heads/2.x
Date: 2015-06-10T09:32:11-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.theme/commit/6c2fa101ca96c37a80fa1cce90e01ced22f077f6

restore 2.x to provide ICMFDefaultSkin again

Files changed:
M CHANGES.rst
M plone/theme/interfaces.py
M plone/theme/layer.py
M plone/theme/tests/testBrowserLayerPrecedence.py
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 141efe6..3cafa14 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,8 @@ Changelog
 2.1.5 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- restore 2.x branch as being for plone < 5. Revert 2.1.4 changes.
+  [vangheem]
 
 
 2.1.4 (2015-04-28)
diff --git a/plone/theme/interfaces.py b/plone/theme/interfaces.py
index 359f8ee..a91f378 100644
--- a/plone/theme/interfaces.py
+++ b/plone/theme/interfaces.py
@@ -1,4 +1,7 @@
-from zope.publisher.interfaces.browser import IDefaultBrowserLayer
+try:
+    from Products.CMFDefault.interfaces import ICMFDefaultSkin as IDefaultBrowserLayer
+except ImportError:
+    from zope.publisher.interfaces.browser import IDefaultBrowserLayer
 
 
 class IDefaultPloneLayer(IDefaultBrowserLayer):
diff --git a/plone/theme/layer.py b/plone/theme/layer.py
index 2451c5c..fbba3fd 100644
--- a/plone/theme/layer.py
+++ b/plone/theme/layer.py
@@ -12,6 +12,13 @@
     IDefaultBrowserLayer,
     ]
 
+try:
+    from Products.CMFDefault.interfaces import ICMFDefaultSkin
+except ImportError:
+    pass
+else:
+    default_layers.append(ICMFDefaultSkin)
+
 
 def mark_layer(site, event):
     """Mark the request with a layer corresponding to the current skin,
@@ -19,7 +26,7 @@ def mark_layer(site, event):
     """
     if getattr(event.request, "_plonetheme_", False):
         return
-    event.request._plonetheme_=True
+    event.request._plonetheme_ = True
 
     portal_skins = getToolByName(site, 'portal_skins', None)
     if portal_skins is not None:
diff --git a/plone/theme/tests/testBrowserLayerPrecedence.py b/plone/theme/tests/testBrowserLayerPrecedence.py
index 0ce5207..73e4ac7 100644
--- a/plone/theme/tests/testBrowserLayerPrecedence.py
+++ b/plone/theme/tests/testBrowserLayerPrecedence.py
@@ -70,7 +70,7 @@ def testLayerPrecedence(self):
         if self.theme_layer is not None:
             self.assertEqual(theme_layer_pos, 0)
             self.assertTrue(theme_layer_pos < additive_layer_pos)
-            # for BBB, IDefaultPloneLayer is not present
+            # for BBB, IDefaultPloneLayer and ICMFDefaultSkin are not present
             # unless there are theme layers which extend them.
             self.assertTrue(additive_layer_pos < plone_default_pos)
         self.assertTrue(additive_layer_pos < zope_default_pos)
diff --git a/setup.py b/setup.py
index 1df1361..dee29c8 100644
--- a/setup.py
+++ b/setup.py
@@ -24,7 +24,6 @@ def read(*rnames):
       classifiers=[
           "Environment :: Web Environment",
           "Framework :: Plone",
-          "Framework :: Plone :: 5.0",
           "Framework :: Zope2",
           "License :: OSI Approved :: GNU General Public License (GPL)",
           "Operating System :: OS Independent",


