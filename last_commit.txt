Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-09-10T20:50:33+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/682878a61f3698c2bf6d21cff45abba9dfcd86b4

add search_results_description_length to registry and use in livesearch

Files changed:
M Products/CMFPlone/browser/ploneview.py
M Products/CMFPlone/browser/search.py
M Products/CMFPlone/interfaces/controlpanel.py

diff --git a/Products/CMFPlone/browser/ploneview.py b/Products/CMFPlone/browser/ploneview.py
index bea2e4d..315f198 100644
--- a/Products/CMFPlone/browser/ploneview.py
+++ b/Products/CMFPlone/browser/ploneview.py
@@ -136,6 +136,8 @@ def normalizeString(self, text):
     def cropText(self, text, length, ellipsis='...'):
         """Crop text on a word boundary
         """
+        if not length:
+            return text
         converted = False
         if not isinstance(text, unicode):
             text = utils.safe_unicode(text)
@@ -281,7 +283,7 @@ def getIcon(self, item):
         """Returns an object which implements the IContentIcon interface and
         provides the informations necessary to render an icon. The item
         parameter needs to be adaptable to IContentIcon. Icons can be disabled
-        globally or just for anonymous users with the icon_visibility site 
+        globally or just for anonymous users with the icon_visibility site
         setting.
         """
         context = aq_inner(self.context)
diff --git a/Products/CMFPlone/browser/search.py b/Products/CMFPlone/browser/search.py
index f8980b3..5680714 100644
--- a/Products/CMFPlone/browser/search.py
+++ b/Products/CMFPlone/browser/search.py
@@ -1,15 +1,17 @@
 # -*- coding: utf-8 -*-
 
 from DateTime import DateTime
-from plone.app.contentlisting.interfaces import IContentListing
 from Products.CMFCore.utils import getToolByName
-from Products.CMFPlone.browser.navtree import getNavigationRoot
 from Products.CMFPlone.PloneBatch import Batch
+from Products.CMFPlone.browser.navtree import getNavigationRoot
 from Products.ZCTextIndex.ParseTree import ParseError
+from ZTUtils import make_query
+from plone.app.contentlisting.interfaces import IContentListing
+from plone.registry.interfaces import IRegistry
 from zope.component import getMultiAdapter
+from zope.component import queryUtility
 from zope.i18nmessageid import MessageFactory
 from zope.publisher.browser import BrowserView
-from ZTUtils import make_query
 
 import json
 
@@ -203,11 +205,15 @@ def __call__(self):
         results = self.results(batch=False, use_content_listing=False)
         batch = Batch(results, per_page, start=(page - 1) * per_page)
 
+        registry = queryUtility(IRegistry)
+        length = registry['plone.search_results_description_length']
+        plone_view = getMultiAdapter(
+            (self.context, self.request), name='plone')
         for item in batch:
             items.append({
                 'id': item.UID,
                 'title': item.Title,
-                'description': item.Description,
+                'description': plone_view.cropText(item.Description, length),
                 'url': item.getURL(),
                 'state': item.review_state
             })
diff --git a/Products/CMFPlone/interfaces/controlpanel.py b/Products/CMFPlone/interfaces/controlpanel.py
index 1c30b86..911f867 100644
--- a/Products/CMFPlone/interfaces/controlpanel.py
+++ b/Products/CMFPlone/interfaces/controlpanel.py
@@ -877,6 +877,13 @@ class ISearchSchema(Interface):
             source="plone.app.vocabularies.PortalTypes"
         ),
     )
+
+    search_results_description_length = schema.Int(
+        title=_(u"Crop the item description in search result listings "
+                u"after a number of characters."),
+        required=False,
+        default=160,
+    )
 # TODO: These need to get moved into ATCT setup profile.
 # 'ATBooleanCriterion',
 # 'ATDateCriteria',


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-09-10T20:50:33+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/3fce2a07b9ccb9885431f59db131769c1ac2f3ee

Use None if there is no search_results_description_length

Files changed:
M Products/CMFPlone/browser/search.py

diff --git a/Products/CMFPlone/browser/search.py b/Products/CMFPlone/browser/search.py
index 5680714..868ded0 100644
--- a/Products/CMFPlone/browser/search.py
+++ b/Products/CMFPlone/browser/search.py
@@ -206,7 +206,7 @@ def __call__(self):
         batch = Batch(results, per_page, start=(page - 1) * per_page)
 
         registry = queryUtility(IRegistry)
-        length = registry['plone.search_results_description_length']
+        length = registry.get('plone.search_results_description_length')
         plone_view = getMultiAdapter(
             (self.context, self.request), name='plone')
         for item in batch:


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-09-10T20:56:25+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/7415b51baba242e9bb937bd90d6e6db987c36f92

Merge pull request #909 from plone/search_results_description_length

add search_results_description_length to registry and use in livesearch

Files changed:
M Products/CMFPlone/browser/ploneview.py
M Products/CMFPlone/browser/search.py
M Products/CMFPlone/interfaces/controlpanel.py

diff --git a/Products/CMFPlone/browser/ploneview.py b/Products/CMFPlone/browser/ploneview.py
index bea2e4d..315f198 100644
--- a/Products/CMFPlone/browser/ploneview.py
+++ b/Products/CMFPlone/browser/ploneview.py
@@ -136,6 +136,8 @@ def normalizeString(self, text):
     def cropText(self, text, length, ellipsis='...'):
         """Crop text on a word boundary
         """
+        if not length:
+            return text
         converted = False
         if not isinstance(text, unicode):
             text = utils.safe_unicode(text)
@@ -281,7 +283,7 @@ def getIcon(self, item):
         """Returns an object which implements the IContentIcon interface and
         provides the informations necessary to render an icon. The item
         parameter needs to be adaptable to IContentIcon. Icons can be disabled
-        globally or just for anonymous users with the icon_visibility site 
+        globally or just for anonymous users with the icon_visibility site
         setting.
         """
         context = aq_inner(self.context)
diff --git a/Products/CMFPlone/browser/search.py b/Products/CMFPlone/browser/search.py
index f8980b3..868ded0 100644
--- a/Products/CMFPlone/browser/search.py
+++ b/Products/CMFPlone/browser/search.py
@@ -1,15 +1,17 @@
 # -*- coding: utf-8 -*-
 
 from DateTime import DateTime
-from plone.app.contentlisting.interfaces import IContentListing
 from Products.CMFCore.utils import getToolByName
-from Products.CMFPlone.browser.navtree import getNavigationRoot
 from Products.CMFPlone.PloneBatch import Batch
+from Products.CMFPlone.browser.navtree import getNavigationRoot
 from Products.ZCTextIndex.ParseTree import ParseError
+from ZTUtils import make_query
+from plone.app.contentlisting.interfaces import IContentListing
+from plone.registry.interfaces import IRegistry
 from zope.component import getMultiAdapter
+from zope.component import queryUtility
 from zope.i18nmessageid import MessageFactory
 from zope.publisher.browser import BrowserView
-from ZTUtils import make_query
 
 import json
 
@@ -203,11 +205,15 @@ def __call__(self):
         results = self.results(batch=False, use_content_listing=False)
         batch = Batch(results, per_page, start=(page - 1) * per_page)
 
+        registry = queryUtility(IRegistry)
+        length = registry.get('plone.search_results_description_length')
+        plone_view = getMultiAdapter(
+            (self.context, self.request), name='plone')
         for item in batch:
             items.append({
                 'id': item.UID,
                 'title': item.Title,
-                'description': item.Description,
+                'description': plone_view.cropText(item.Description, length),
                 'url': item.getURL(),
                 'state': item.review_state
             })
diff --git a/Products/CMFPlone/interfaces/controlpanel.py b/Products/CMFPlone/interfaces/controlpanel.py
index 1c30b86..911f867 100644
--- a/Products/CMFPlone/interfaces/controlpanel.py
+++ b/Products/CMFPlone/interfaces/controlpanel.py
@@ -877,6 +877,13 @@ class ISearchSchema(Interface):
             source="plone.app.vocabularies.PortalTypes"
         ),
     )
+
+    search_results_description_length = schema.Int(
+        title=_(u"Crop the item description in search result listings "
+                u"after a number of characters."),
+        required=False,
+        default=160,
+    )
 # TODO: These need to get moved into ATCT setup profile.
 # 'ATBooleanCriterion',
 # 'ATDateCriteria',


