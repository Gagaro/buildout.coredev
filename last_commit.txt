Repository: Products.CMFPlone
Branch: refs/heads/master
Date: 2015-03-09T12:25:29-07:00
Author: David Glick (davisagli) <david@glicksoftware.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/6c17e31e441988577ece1e8cc31286fb4ec31f9e

try a patch to avoid checking for updated templates when not in debug mode

Files changed:
A Products/CMFPlone/patches/templatecookcheck.py
M Products/CMFPlone/patches/__init__.py

diff --git a/Products/CMFPlone/patches/__init__.py b/Products/CMFPlone/patches/__init__.py
index 3499b59..9d93dd2 100644
--- a/Products/CMFPlone/patches/__init__.py
+++ b/Products/CMFPlone/patches/__init__.py
@@ -24,3 +24,6 @@
 
 import sendmail
 sendmail.applyPatches()
+
+import templatecookcheck        # Make sure templates aren't re-read in
+                                # production sites
diff --git a/Products/CMFPlone/patches/templatecookcheck.py b/Products/CMFPlone/patches/templatecookcheck.py
new file mode 100644
index 0000000..1f01d61
--- /dev/null
+++ b/Products/CMFPlone/patches/templatecookcheck.py
@@ -0,0 +1,32 @@
+# The implementation in zope.pagetemplate always checks for
+# updated files unless python is run with -O, but we want to
+# base this on the Zope2 debug mode flag.
+
+
+from zope.pagetemplate.pagetemplatefile import PageTemplateFile
+import Globals
+import logging
+import os
+
+
+def _cook_check(self):
+    if self._v_last_read and not Globals.DevelopmentMode:  # was 'not __debug__'
+        return
+    __traceback_info__ = self.filename
+    try:
+        mtime = os.path.getmtime(self.filename)
+    except OSError:
+        mtime = 0
+    if self._v_program is not None and mtime == self._v_last_read:
+        return
+    text, type_ = self._read_file()
+    self.pt_edit(text, type_)
+    assert self._v_cooked
+    if self._v_errors:
+        logging.error('PageTemplateFile: Error in template %s: %s',
+                self.filename, '\n'.join(self._v_errors))
+        return
+    self._v_last_read = mtime
+
+
+PageTemplateFile._cook_check = _cook_check


