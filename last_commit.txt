Repository: Products.CMFPlone


Branch: refs/heads/4.3.x
Date: 2015-08-14T00:46:26+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/a0b57c70ae5ac5c838ac6a5b4c1a2a280638e340

Added __nonzero__ to PloneBatch.

This avoids using the deprecated __len__ method.

Files changed:
M Products/CMFPlone/PloneBatch.py

diff --git a/Products/CMFPlone/PloneBatch.py b/Products/CMFPlone/PloneBatch.py
index 19816f1..67c725a 100644
--- a/Products/CMFPlone/PloneBatch.py
+++ b/Products/CMFPlone/PloneBatch.py
@@ -24,6 +24,11 @@ def __len__(self):
         ('Using len() for getting the actual pagesize is deprecated. Use the '
          '`pagesize` attribute instead.'))
 
+    def __nonzero__(self):
+        # Without __nonzero__ a bool(self) would call len(self), which
+        # gives a deprecation warning.
+        return bool(self.length)
+
     def initialize(self, start, end, size):
         super(Batch, self).initialize(start, end, size)
         self.pagerange, self.pagerangestart, self.pagerangeend = \


Repository: Products.CMFPlone


Branch: refs/heads/4.3.x
Date: 2015-08-14T00:48:31+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/c0a9aab96166f747b08605fd6a1589a3a54c561c

Give better options in deprecation warning for PloneBatch.__len__.

Until now we were advocating use of the 'pagesize' attribute but we are
actually using the 'length' attribute.

I do not understand why we deprecated it in the first place, except
when this is because of possible confusion of batch length and
sequence length.  But then we should be pointing them at both options,
which we now do.

Also, adding a '__nonzero__' method in the previous commit to handle
'bool(batch)' calls, really helps in avoiding calls to the '__len__'
method.

Files changed:
M Products/CMFPlone/PloneBatch.py

diff --git a/Products/CMFPlone/PloneBatch.py b/Products/CMFPlone/PloneBatch.py
index 67c725a..6471ae3 100644
--- a/Products/CMFPlone/PloneBatch.py
+++ b/Products/CMFPlone/PloneBatch.py
@@ -21,8 +21,10 @@ def __init__(self, sequence, size, start=0, end=0, orphan=0,
     def __len__(self):
         return self.length
     __len__ = deprecated(__len__,
-        ('Using len() for getting the actual pagesize is deprecated. Use the '
-         '`pagesize` attribute instead.'))
+        ('Using len() is deprecated. Use the `length` attribute for the '
+         'size of the current page, which is what we return now. '
+         'Use the `sequence_length` attribute for the size of the '
+         'entire sequence. '))
 
     def __nonzero__(self):
         # Without __nonzero__ a bool(self) would call len(self), which


