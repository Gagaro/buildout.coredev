Repository: plone.app.content


Branch: refs/heads/master
Date: 2015-07-22T16:30:21+02:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@redturtle.it>
Commit: https://github.com/plone/plone.app.content/commit/44299dc0631f4c2b50735f9016963f64dcf52a7c

When clicking cancel on the delete_confirmation got to the view_url

Files changed:
M CHANGES.rst
M plone/app/content/browser/actions.py
M plone/app/content/tests/test_actions.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 28729ef..931f9bf 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -5,6 +5,8 @@ Changelog
 ------------------
 
 - Fix i18n of '"title" has already been deleted'.
+- When clicking cancel on the delete_confirmation got to the view_url.
+  [ale-rt]
 
 
 3.0.7 (2015-07-18)
diff --git a/plone/app/content/browser/actions.py b/plone/app/content/browser/actions.py
index cb95120..30d130e 100644
--- a/plone/app/content/browser/actions.py
+++ b/plone/app/content/browser/actions.py
@@ -40,6 +40,15 @@ class DeleteConfirmationForm(form.Form, LockingBase):
     template = ViewPageTemplateFile('templates/delete_confirmation.pt')
     enableCSRFProtection = True
 
+    def view_url(self):
+        ''' Facade to the homonymous plone_context_state method
+        '''
+        context_state = getMultiAdapter(
+            (self.context, self.request),
+            name='plone_context_state'
+        )
+        return context_state.view_url()
+
     @property
     def items_to_delete(self):
         catalog = getToolByName(self.context, 'portal_catalog')
@@ -72,7 +81,12 @@ def handle_delete(self, action):
     @button.buttonAndHandler(
         _(u'label_cancel', default=u'Cancel'), name='Cancel')
     def handle_cancel(self, action):
-        self.request.response.redirect(self.context.absolute_url())
+        environ = self.request.environ
+        if environ.get('HTTP_X_REQUESTED_WITH') == 'XMLHttpRequest':
+            target = self.context.absolute_url()
+        else:
+            target = self.view_url()
+        return self.request.response.redirect(target)
 
 
 def valid_id(self):
diff --git a/plone/app/content/tests/test_actions.py b/plone/app/content/tests/test_actions.py
index 9494341..9206fc6 100644
--- a/plone/app/content/tests/test_actions.py
+++ b/plone/app/content/tests/test_actions.py
@@ -99,7 +99,11 @@ def test_delete_confirmation_cancel(self):
 
         self.browser.open(folder.absolute_url() + '/delete_confirmation')
         self.browser.getControl(name='form.buttons.Cancel').click()
-        self.assertEqual(self.browser.url, folder.absolute_url())
+        context_state = getMultiAdapter(
+            (folder, self.request),
+            name='plone_context_state'
+        )
+        self.assertEqual(self.browser.url, context_state.view_url())
 
     def prepare_for_acquisition_tests(self):
         """create content and an alternate authenticated browser session


Repository: plone.app.content


Branch: refs/heads/master
Date: 2015-07-22T10:41:29-05:00
Author: Nathan Van Gheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.app.content/commit/bf4527cbec824a1e171f7301ff54949c8ec5ac2f

Merge pull request #41 from plone/38-fix-delete-confirmation-redirect

When clicking cancel on the delete_confirmation got to the view_url

Files changed:
M CHANGES.rst
M plone/app/content/browser/actions.py
M plone/app/content/tests/test_actions.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 28729ef..931f9bf 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -5,6 +5,8 @@ Changelog
 ------------------
 
 - Fix i18n of '"title" has already been deleted'.
+- When clicking cancel on the delete_confirmation got to the view_url.
+  [ale-rt]
 
 
 3.0.7 (2015-07-18)
diff --git a/plone/app/content/browser/actions.py b/plone/app/content/browser/actions.py
index cb95120..30d130e 100644
--- a/plone/app/content/browser/actions.py
+++ b/plone/app/content/browser/actions.py
@@ -40,6 +40,15 @@ class DeleteConfirmationForm(form.Form, LockingBase):
     template = ViewPageTemplateFile('templates/delete_confirmation.pt')
     enableCSRFProtection = True
 
+    def view_url(self):
+        ''' Facade to the homonymous plone_context_state method
+        '''
+        context_state = getMultiAdapter(
+            (self.context, self.request),
+            name='plone_context_state'
+        )
+        return context_state.view_url()
+
     @property
     def items_to_delete(self):
         catalog = getToolByName(self.context, 'portal_catalog')
@@ -72,7 +81,12 @@ def handle_delete(self, action):
     @button.buttonAndHandler(
         _(u'label_cancel', default=u'Cancel'), name='Cancel')
     def handle_cancel(self, action):
-        self.request.response.redirect(self.context.absolute_url())
+        environ = self.request.environ
+        if environ.get('HTTP_X_REQUESTED_WITH') == 'XMLHttpRequest':
+            target = self.context.absolute_url()
+        else:
+            target = self.view_url()
+        return self.request.response.redirect(target)
 
 
 def valid_id(self):
diff --git a/plone/app/content/tests/test_actions.py b/plone/app/content/tests/test_actions.py
index 9494341..9206fc6 100644
--- a/plone/app/content/tests/test_actions.py
+++ b/plone/app/content/tests/test_actions.py
@@ -99,7 +99,11 @@ def test_delete_confirmation_cancel(self):
 
         self.browser.open(folder.absolute_url() + '/delete_confirmation')
         self.browser.getControl(name='form.buttons.Cancel').click()
-        self.assertEqual(self.browser.url, folder.absolute_url())
+        context_state = getMultiAdapter(
+            (folder, self.request),
+            name='plone_context_state'
+        )
+        self.assertEqual(self.browser.url, context_state.view_url())
 
     def prepare_for_acquisition_tests(self):
         """create content and an alternate authenticated browser session


