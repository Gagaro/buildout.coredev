Repository: Products.MimetypesRegistry


Branch: refs/heads/master
Date: 2015-09-19T15:26:59+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/Products.MimetypesRegistry/commit/45008570c5c150cd4651bc4c009172f977666fd6

Get default_charset value from registry

Files changed:
M CHANGES.rst
M Products/MimetypesRegistry/MimeTypesRegistry.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 1828d90..44e831e 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,8 @@ Changelog
 2.0.9 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- Use registry to look up default_charset value when available.
+  [esteele]
 
 
 2.0.8 (2015-06-29)
diff --git a/Products/MimetypesRegistry/MimeTypesRegistry.py b/Products/MimetypesRegistry/MimeTypesRegistry.py
index d7830cc..ed706b7 100644
--- a/Products/MimetypesRegistry/MimeTypesRegistry.py
+++ b/Products/MimetypesRegistry/MimeTypesRegistry.py
@@ -23,6 +23,7 @@
 from Products.MimetypesRegistry.mime_types import magic
 from Products.PageTemplates.PageTemplateFile import PageTemplateFile
 from types import UnicodeType
+from zope.component import getUtility
 from zope.contenttype import guess_content_type
 from zope.interface import implements
 import fnmatch
@@ -418,13 +419,19 @@ def guess_encoding(self, data):
             data = data.encode('UTF-8')
         encoding = guess_encoding(data)
         if encoding is None:
-            try:
-                site_props = getToolByName(
-                    self,
-                    'portal_properties').site_properties
-                encoding = site_props.getProperty('default_charset', 'UTF-8')
-            except:
-                encoding = 'UTF-8'
+            portal_props = getToolByName(self, 'portal_properties')
+            if portal_props \
+               and 'site_properties' in portal_props \
+               and 'default_charset' in portal_props.site_properties:
+                encoding = portal_props.site_properties.getProperty(
+                    'default_charset', 'UTF-8')
+            else:
+                try:
+                    from plone.registry.interfaces import IRegistry
+                    registry = getUtility(IRegistry)
+                    registry.get('plone.default_charset', 'UTF-8')
+                except ImportError:
+                    encoding = 'UTF-8'
         return encoding
 
     security.declareProtected(ManagePortal, 'manage_delObjects')


Repository: Products.MimetypesRegistry


Branch: refs/heads/master
Date: 2015-09-19T15:33:24+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/Products.MimetypesRegistry/commit/3cf9afe6e9d5f88304d219f379c873ccfc8cdb91

Better check for propertiessheet value

Files changed:
M Products/MimetypesRegistry/MimeTypesRegistry.py

diff --git a/Products/MimetypesRegistry/MimeTypesRegistry.py b/Products/MimetypesRegistry/MimeTypesRegistry.py
index ed706b7..b73016d 100644
--- a/Products/MimetypesRegistry/MimeTypesRegistry.py
+++ b/Products/MimetypesRegistry/MimeTypesRegistry.py
@@ -422,7 +422,7 @@ def guess_encoding(self, data):
             portal_props = getToolByName(self, 'portal_properties')
             if portal_props \
                and 'site_properties' in portal_props \
-               and 'default_charset' in portal_props.site_properties:
+               and hasattr(portal_props.site_properties, 'default_charset'):
                 encoding = portal_props.site_properties.getProperty(
                     'default_charset', 'UTF-8')
             else:


Repository: Products.MimetypesRegistry


Branch: refs/heads/master
Date: 2015-09-19T18:26:52+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/Products.MimetypesRegistry/commit/37e9ef721341018e1c431b2982c2329d4dec221c

Returning a value would make this a lot more effective.

Files changed:
M Products/MimetypesRegistry/MimeTypesRegistry.py

diff --git a/Products/MimetypesRegistry/MimeTypesRegistry.py b/Products/MimetypesRegistry/MimeTypesRegistry.py
index b73016d..89990cf 100644
--- a/Products/MimetypesRegistry/MimeTypesRegistry.py
+++ b/Products/MimetypesRegistry/MimeTypesRegistry.py
@@ -429,7 +429,7 @@ def guess_encoding(self, data):
                 try:
                     from plone.registry.interfaces import IRegistry
                     registry = getUtility(IRegistry)
-                    registry.get('plone.default_charset', 'UTF-8')
+                    encoding = registry.get('plone.default_charset', 'UTF-8')
                 except ImportError:
                     encoding = 'UTF-8'
         return encoding


Repository: Products.MimetypesRegistry


Branch: refs/heads/master
Date: 2015-09-20T12:26:35+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/Products.MimetypesRegistry/commit/07e1ddc6de1fc34416bca13bed064e1eb6d313fc

Default to utf-8

Files changed:
M Products/MimetypesRegistry/MimeTypesRegistry.py

diff --git a/Products/MimetypesRegistry/MimeTypesRegistry.py b/Products/MimetypesRegistry/MimeTypesRegistry.py
index 89990cf..dc97b05 100644
--- a/Products/MimetypesRegistry/MimeTypesRegistry.py
+++ b/Products/MimetypesRegistry/MimeTypesRegistry.py
@@ -7,7 +7,6 @@
 from Products.CMFCore.ActionProviderBase import ActionProviderBase
 from Products.CMFCore.permissions import ManagePortal
 from Products.CMFCore.utils import UniqueObject
-from Products.CMFCore.utils import getToolByName
 from Products.CMFCore.utils import registerToolInterface
 from Products.MimetypesRegistry.MimeTypeItem import MimeTypeItem
 from Products.MimetypesRegistry.common import MimeTypeException
@@ -23,7 +22,6 @@
 from Products.MimetypesRegistry.mime_types import magic
 from Products.PageTemplates.PageTemplateFile import PageTemplateFile
 from types import UnicodeType
-from zope.component import getUtility
 from zope.contenttype import guess_content_type
 from zope.interface import implements
 import fnmatch
@@ -419,19 +417,7 @@ def guess_encoding(self, data):
             data = data.encode('UTF-8')
         encoding = guess_encoding(data)
         if encoding is None:
-            portal_props = getToolByName(self, 'portal_properties')
-            if portal_props \
-               and 'site_properties' in portal_props \
-               and hasattr(portal_props.site_properties, 'default_charset'):
-                encoding = portal_props.site_properties.getProperty(
-                    'default_charset', 'UTF-8')
-            else:
-                try:
-                    from plone.registry.interfaces import IRegistry
-                    registry = getUtility(IRegistry)
-                    encoding = registry.get('plone.default_charset', 'UTF-8')
-                except ImportError:
-                    encoding = 'UTF-8'
+            encoding = 'utf-8'
         return encoding
 
     security.declareProtected(ManagePortal, 'manage_delObjects')


Repository: Products.MimetypesRegistry


Branch: refs/heads/master
Date: 2015-09-20T17:23:08+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.MimetypesRegistry/commit/3c26fd56bac5349f4626d665ad87c1a289a0bb2c

Merge pull request #4 from plone/portal-properties-cleanup

Portal properties cleanup

Files changed:
M CHANGES.rst
M Products/MimetypesRegistry/MimeTypesRegistry.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 1828d90..44e831e 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,8 @@ Changelog
 2.0.9 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- Use registry to look up default_charset value when available.
+  [esteele]
 
 
 2.0.8 (2015-06-29)
diff --git a/Products/MimetypesRegistry/MimeTypesRegistry.py b/Products/MimetypesRegistry/MimeTypesRegistry.py
index d7830cc..dc97b05 100644
--- a/Products/MimetypesRegistry/MimeTypesRegistry.py
+++ b/Products/MimetypesRegistry/MimeTypesRegistry.py
@@ -7,7 +7,6 @@
 from Products.CMFCore.ActionProviderBase import ActionProviderBase
 from Products.CMFCore.permissions import ManagePortal
 from Products.CMFCore.utils import UniqueObject
-from Products.CMFCore.utils import getToolByName
 from Products.CMFCore.utils import registerToolInterface
 from Products.MimetypesRegistry.MimeTypeItem import MimeTypeItem
 from Products.MimetypesRegistry.common import MimeTypeException
@@ -418,13 +417,7 @@ def guess_encoding(self, data):
             data = data.encode('UTF-8')
         encoding = guess_encoding(data)
         if encoding is None:
-            try:
-                site_props = getToolByName(
-                    self,
-                    'portal_properties').site_properties
-                encoding = site_props.getProperty('default_charset', 'UTF-8')
-            except:
-                encoding = 'UTF-8'
+            encoding = 'utf-8'
         return encoding
 
     security.declareProtected(ManagePortal, 'manage_delObjects')


