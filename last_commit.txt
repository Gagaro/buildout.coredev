Repository: mockup
Branch: refs/heads/master
Date: 2015-04-16T19:22:10Z
Author: Franco Pellegrini (frapell) <frapell@gmail.com>
Commit: https://github.com/plone/mockup/commit/9c86ba226f8772f8bdcf69090d1aed174373a9f6

TinyMCE: bugfix, where a link had to be guessed because of missing data- attributes, use set instead of setRaw. Add tests.

Files changed:
M CHANGES.rst
M mockup/patterns/tinymce/js/links.js
M mockup/tests/pattern-tinymce-test.js

diff --git a/CHANGES.rst b/CHANGES.rst
index cf46386..b27e6b3 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,6 +4,10 @@ Changelog
 2.0.3 (unreleased)
 ------------------
 
+- TinyMCE: bugfix, where a link had to be guessed because of missing data-
+  attributes, use set instead of setRaw. Add tests.
+  [frapell]
+
 - Add recurrence pattern styles to widget bundle.
   [thet]
 
diff --git a/mockup/patterns/tinymce/js/links.js b/mockup/patterns/tinymce/js/links.js
index dfe2265..1f3983d 100644
--- a/mockup/patterns/tinymce/js/links.js
+++ b/mockup/patterns/tinymce/js/links.js
@@ -632,10 +632,10 @@ define([
         }
       } else if (href[0] === '#') {
         this.linkType = 'anchor';
-        this.linkTypes.anchor.setRaw(href.substring(1));
+        this.linkTypes.anchor.set(href.substring(1));
       } else {
         this.linkType = 'external';
-        this.linkTypes.external.setRaw(href);
+        this.linkTypes.external.set(href);
       }
     },
 
diff --git a/mockup/tests/pattern-tinymce-test.js b/mockup/tests/pattern-tinymce-test.js
index 503feef..7118861 100644
--- a/mockup/tests/pattern-tinymce-test.js
+++ b/mockup/tests/pattern-tinymce-test.js
@@ -365,6 +365,27 @@ define([
       expect(pattern.linkModal.linkType).to.equal('upload');
     });
 
+    it('test guess link when no data- attribute present', function() {
+      var pattern = createTinymce();
+
+      pattern.tiny.setContent('<a href="foobar">foobar</a>');
+
+      pattern.tiny.selection.select(pattern.tiny.dom.getRoot().getElementsByTagName('a')[0]);
+      pattern.addLinkClicked();
+
+      expect(pattern.linkModal.linkTypes.external.$input.val()).to.equal('foobar');
+    });
+
+    it('test guess anchor when no data- attribute present', function() {
+      var pattern = createTinymce();
+
+      pattern.tiny.setContent('<a href="#foobar">foobar</a><a class="mceItemAnchor" name="foobar"></a>');
+
+      pattern.tiny.selection.select(pattern.tiny.dom.getRoot().getElementsByTagName('a')[0]);
+      pattern.addLinkClicked();
+
+      expect(pattern.linkModal.linkTypes.anchor.toUrl()).to.equal('#foobar');
+    });
 
   });
 


