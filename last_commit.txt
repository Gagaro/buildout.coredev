Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2015-08-14T11:33:45+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.contenttypes/commit/91a861a9ca674842409522844d571edcfbb58c4b

add test_default_pages_are_kept_during_migration

Files changed:
M plone/app/contenttypes/tests/test_migration.py

diff --git a/plone/app/contenttypes/tests/test_migration.py b/plone/app/contenttypes/tests/test_migration.py
index 9cafa0c..aedcad2 100644
--- a/plone/app/contenttypes/tests/test_migration.py
+++ b/plone/app/contenttypes/tests/test_migration.py
@@ -1801,6 +1801,45 @@ def test_comments_are_migrated(self):
             dx_comment.getText(),
             '<p>Hey Dude! \xc3\x84 is not ascii.</p>')
 
+    def test_default_pages_are_kept_during_migration(self):
+        """Check that the default pages are not lost when migrating."""
+        set_browserlayer(self.request)
+        # create some content and set default pages
+        self.portal.invokeFactory('Document', 'document')
+        at_document = self.portal['document']
+        at_document.setText(u'Document with some comments')
+
+        self.portal.invokeFactory('Folder', 'folder')
+        at_folder = self.portal['folder']
+
+        at_folder.invokeFactory('Document', 'subdocument')
+        at_subdocument = at_folder['subdocument']
+
+        self.portal.setLayout('folder_summary_view')
+        self.portal.setDefaultPage('document')
+
+        at_folder.setLayout('folder_tabular_view')
+        at_folder.setDefaultPage('subdocument')
+
+        # migrate content
+        applyProfile(self.portal, 'plone.app.contenttypes:default')
+
+        migration_view = getMultiAdapter(
+            (self.portal, self.request),
+            name=u'migrate_from_atct'
+        )
+        results = migration_view(from_form=True)
+        dx_folder = self.portal['folder']
+
+        # test that view-methods are updated
+        self.assertTrue(self.portal.getLayout(), 'summary_view')
+        # test that defaultpage is kept
+        self.assertTrue(self.portal.getDefaultPage(), 'document')
+        # test that view-methods are updated
+        self.assertTrue(dx_folder.getLayout(), 'tabular_view')
+        # test that defaultpage is kept
+        self.assertTrue(dx_folder.getDefaultPage(), 'subdocument')
+
 
 class MigrateDexterityBaseClassIntegrationTest(unittest.TestCase):
 


Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2015-08-14T11:37:13+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.contenttypes/commit/478dd9c0cd1157d92364964e59678a6c96f8463a

use more methods to get a possible default_page

Files changed:
M plone/app/contenttypes/migration/migration.py

diff --git a/plone/app/contenttypes/migration/migration.py b/plone/app/contenttypes/migration/migration.py
index cf728aa..084d84e 100644
--- a/plone/app/contenttypes/migration/migration.py
+++ b/plone/app/contenttypes/migration/migration.py
@@ -174,7 +174,8 @@ def last_migrate_layout(self):
         """
         old_layout = self.old.getLayout() or getattr(self.old, 'layout', None)
         if old_layout in LISTING_VIEW_MAPPING.keys():
-            default_page = self.old.getDefaultPage()
+            default_page = self.old.getDefaultPage() or \
+                getattr(self.old, 'default_page')
             self.new.setLayout(LISTING_VIEW_MAPPING[old_layout])
             if default_page:
                 # any defaultPage is switched of by setLayout


Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2015-08-14T12:38:43+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.contenttypes/commit/406b462492002715b9592e735143a84b1c659cb3

re-set default_page after migration since we're unable to unregister Products.CMFDynamicViewFTI.browserdefault.check_default_page

Files changed:
M plone/app/contenttypes/migration/migration.py
M plone/app/contenttypes/tests/test_migration.py

diff --git a/plone/app/contenttypes/migration/migration.py b/plone/app/contenttypes/migration/migration.py
index 084d84e..09f2fee 100644
--- a/plone/app/contenttypes/migration/migration.py
+++ b/plone/app/contenttypes/migration/migration.py
@@ -89,6 +89,17 @@ def __init__(self, *args, **kwargs):
             "Migrating {0}".format(
                 '/'.join(self.old.getPhysicalPath())))
 
+    def beforeChange_store_default_page(self):
+        """If the item is the default page store that info to set it again.
+
+        Products.CMFDynamicViewFTI.browserdefault.check_default_page
+        would unset the default page during the migration.
+        """
+        context_state = getMultiAdapter(
+            (self.old, self.old.REQUEST), name=u'plone_context_state')
+        if context_state.is_default_page():
+            setattr(self.old, '_migration_is_default_page', True)
+
     def beforeChange_store_comments_on_portal(self):
         """Comments from plone.app.discussion are lost when the
            old object is renamed...
@@ -122,6 +133,12 @@ def last_migrate_comments(self):
         portal = getToolByName(self.old, 'portal_url').getPortalObject()
         move_comments(portal, self.new)
 
+    def last_migrate_default_page(self):
+        """If the item was the default page set it again."""
+        if getattr(self.old, '_migration_is_default_page', False):
+            parent = self.new.__parent__
+            parent.setDefaultPage(self.new.id)
+
 
 class ATCTFolderMigrator(CMFFolderMigrator):
     """Base for folderish ATCT
diff --git a/plone/app/contenttypes/tests/test_migration.py b/plone/app/contenttypes/tests/test_migration.py
index aedcad2..709d26b 100644
--- a/plone/app/contenttypes/tests/test_migration.py
+++ b/plone/app/contenttypes/tests/test_migration.py
@@ -1821,6 +1821,12 @@ def test_default_pages_are_kept_during_migration(self):
         at_folder.setLayout('folder_tabular_view')
         at_folder.setDefaultPage('subdocument')
 
+        self.portal.invokeFactory('Folder', 'folder2')
+        at_folder2 = self.portal['folder2']
+        at_folder2.invokeFactory('Document', 'subdocument2')
+        at_subdocument2 = at_folder2['subdocument2']
+        at_folder2.setLayout('folder_listing')
+
         # migrate content
         applyProfile(self.portal, 'plone.app.contenttypes:default')
 
@@ -1830,15 +1836,16 @@ def test_default_pages_are_kept_during_migration(self):
         )
         results = migration_view(from_form=True)
         dx_folder = self.portal['folder']
+        dx_folder2 = self.portal['folder2']
 
         # test that view-methods are updated
         self.assertTrue(self.portal.getLayout(), 'summary_view')
-        # test that defaultpage is kept
-        self.assertTrue(self.portal.getDefaultPage(), 'document')
-        # test that view-methods are updated
         self.assertTrue(dx_folder.getLayout(), 'tabular_view')
+        self.assertTrue(dx_folder2.getLayout(), 'listing_view')
         # test that defaultpage is kept
+        self.assertTrue(self.portal.getDefaultPage(), 'document')
         self.assertTrue(dx_folder.getDefaultPage(), 'subdocument')
+        self.assertIsNone(dx_folder2.getDefaultPage())
 
 
 class MigrateDexterityBaseClassIntegrationTest(unittest.TestCase):


Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2015-08-14T12:39:55+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.contenttypes/commit/942987d23c8ba3c0e547d301e939d52068397123

Merge pull request #253 from plone/default_page_unset

re-set default page during migration

Files changed:
M plone/app/contenttypes/migration/migration.py
M plone/app/contenttypes/tests/test_migration.py

diff --git a/plone/app/contenttypes/migration/migration.py b/plone/app/contenttypes/migration/migration.py
index cf728aa..09f2fee 100644
--- a/plone/app/contenttypes/migration/migration.py
+++ b/plone/app/contenttypes/migration/migration.py
@@ -89,6 +89,17 @@ def __init__(self, *args, **kwargs):
             "Migrating {0}".format(
                 '/'.join(self.old.getPhysicalPath())))
 
+    def beforeChange_store_default_page(self):
+        """If the item is the default page store that info to set it again.
+
+        Products.CMFDynamicViewFTI.browserdefault.check_default_page
+        would unset the default page during the migration.
+        """
+        context_state = getMultiAdapter(
+            (self.old, self.old.REQUEST), name=u'plone_context_state')
+        if context_state.is_default_page():
+            setattr(self.old, '_migration_is_default_page', True)
+
     def beforeChange_store_comments_on_portal(self):
         """Comments from plone.app.discussion are lost when the
            old object is renamed...
@@ -122,6 +133,12 @@ def last_migrate_comments(self):
         portal = getToolByName(self.old, 'portal_url').getPortalObject()
         move_comments(portal, self.new)
 
+    def last_migrate_default_page(self):
+        """If the item was the default page set it again."""
+        if getattr(self.old, '_migration_is_default_page', False):
+            parent = self.new.__parent__
+            parent.setDefaultPage(self.new.id)
+
 
 class ATCTFolderMigrator(CMFFolderMigrator):
     """Base for folderish ATCT
@@ -174,7 +191,8 @@ def last_migrate_layout(self):
         """
         old_layout = self.old.getLayout() or getattr(self.old, 'layout', None)
         if old_layout in LISTING_VIEW_MAPPING.keys():
-            default_page = self.old.getDefaultPage()
+            default_page = self.old.getDefaultPage() or \
+                getattr(self.old, 'default_page')
             self.new.setLayout(LISTING_VIEW_MAPPING[old_layout])
             if default_page:
                 # any defaultPage is switched of by setLayout
diff --git a/plone/app/contenttypes/tests/test_migration.py b/plone/app/contenttypes/tests/test_migration.py
index 9cafa0c..709d26b 100644
--- a/plone/app/contenttypes/tests/test_migration.py
+++ b/plone/app/contenttypes/tests/test_migration.py
@@ -1801,6 +1801,52 @@ def test_comments_are_migrated(self):
             dx_comment.getText(),
             '<p>Hey Dude! \xc3\x84 is not ascii.</p>')
 
+    def test_default_pages_are_kept_during_migration(self):
+        """Check that the default pages are not lost when migrating."""
+        set_browserlayer(self.request)
+        # create some content and set default pages
+        self.portal.invokeFactory('Document', 'document')
+        at_document = self.portal['document']
+        at_document.setText(u'Document with some comments')
+
+        self.portal.invokeFactory('Folder', 'folder')
+        at_folder = self.portal['folder']
+
+        at_folder.invokeFactory('Document', 'subdocument')
+        at_subdocument = at_folder['subdocument']
+
+        self.portal.setLayout('folder_summary_view')
+        self.portal.setDefaultPage('document')
+
+        at_folder.setLayout('folder_tabular_view')
+        at_folder.setDefaultPage('subdocument')
+
+        self.portal.invokeFactory('Folder', 'folder2')
+        at_folder2 = self.portal['folder2']
+        at_folder2.invokeFactory('Document', 'subdocument2')
+        at_subdocument2 = at_folder2['subdocument2']
+        at_folder2.setLayout('folder_listing')
+
+        # migrate content
+        applyProfile(self.portal, 'plone.app.contenttypes:default')
+
+        migration_view = getMultiAdapter(
+            (self.portal, self.request),
+            name=u'migrate_from_atct'
+        )
+        results = migration_view(from_form=True)
+        dx_folder = self.portal['folder']
+        dx_folder2 = self.portal['folder2']
+
+        # test that view-methods are updated
+        self.assertTrue(self.portal.getLayout(), 'summary_view')
+        self.assertTrue(dx_folder.getLayout(), 'tabular_view')
+        self.assertTrue(dx_folder2.getLayout(), 'listing_view')
+        # test that defaultpage is kept
+        self.assertTrue(self.portal.getDefaultPage(), 'document')
+        self.assertTrue(dx_folder.getDefaultPage(), 'subdocument')
+        self.assertIsNone(dx_folder2.getDefaultPage())
+
 
 class MigrateDexterityBaseClassIntegrationTest(unittest.TestCase):
 


