Repository: Products.CMFPlone
Branch: refs/heads/master
Date: 2015-05-01T00:38:44-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/945b68c8fb321eb337d506b6ed136fde24b92ae5

make live search and search form give consistent results closes https://github.com/plone/Products.CMFPlone/issues/451

Files changed:
M CHANGES.rst
M Products/CMFPlone/browser/search.py

diff --git a/CHANGES.rst b/CHANGES.rst
index fb56aef..2331156 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -8,6 +8,9 @@ Changelog
 5.0b2 (unreleased)
 ------------------
 
+- make live search and search form give consistent results
+  [vangheem]
+
 - only show edit bar if user logged in
   [vangheem]
 
diff --git a/Products/CMFPlone/browser/search.py b/Products/CMFPlone/browser/search.py
index 95e1071..5551540 100644
--- a/Products/CMFPlone/browser/search.py
+++ b/Products/CMFPlone/browser/search.py
@@ -6,6 +6,7 @@
 from Products.CMFPlone.browser.navtree import getNavigationRoot
 from Products.CMFPlone.PloneBatch import Batch
 from Products.ZCTextIndex.ParseTree import ParseError
+from urllib import quote_plus
 from zope.component import getMultiAdapter
 from zope.i18nmessageid import MessageFactory
 from zope.publisher.browser import BrowserView
@@ -18,6 +19,7 @@
 # We should accept both a simple space, unicode u'\u0020 but also a
 # multi-space, so called 'waji-kankaku', unicode u'\u3000'
 MULTISPACE = u'\u3000'.encode('utf-8')
+BAD_CHARS = ('?', '-', '+', '*', MULTISPACE)
 EVER = DateTime('1970-01-03')
 
 
@@ -36,6 +38,14 @@ class Search(BrowserView):
 
     valid_keys = ('sort_on', 'sort_order', 'sort_limit', 'fq', 'fl', 'facet')
 
+    def munge_search_term(self, q):
+        for char in BAD_CHARS:
+            q = q.replace(char, ' ')
+        r = q.split()
+        r = " AND ".join(r)
+        r = quote_chars(r) + '*'
+        return r
+
     def results(self, query=None, batch=True, b_size=10, b_start=0,
                 use_content_listing=True):
         """ Get properly wrapped search results from the catalog.
@@ -85,7 +95,7 @@ def filter_query(self, query):
             if v and ((k in valid_keys) or k.startswith('facet.')):
                 query[k] = v
         if text:
-            query['SearchableText'] = quote_chars(text)
+            query['SearchableText'] = self.munge_search_term(text)
 
         # don't filter on created at all if we want all results
         created = query.get('created')
@@ -189,12 +199,6 @@ def __call__(self):
         except:
             page = 1
 
-        # form = self.request.form
-        # if 'SearchableText' in form:
-            # let's add * around for better results
-        #    if '*' not in form['SearchableText']:
-        #        form['SearchableText'] = '*' + form['SearchableText'] + '*'
-
         results = self.results(batch=False, use_content_listing=False)
         batch = Batch(results, per_page, start=(page - 1) * per_page)
 


