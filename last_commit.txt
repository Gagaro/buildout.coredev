Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2015-09-18T10:58:46+02:00
Author: Victor Fernandez de Alba (sneridagh) <sneridagh@gmail.com>
Commit: https://github.com/plone/plone.app.contenttypes/commit/c31f07565e936afccc5a2db192f4325c1d2a839e

Make consistent use of LeadImage behavior everywhere. Related to plone/plone.app.contenttypes#1012.

Files changed:
M plone/app/contenttypes/behaviors/configure.zcml
M plone/app/contenttypes/behaviors/leadimage.pt
M plone/app/contenttypes/behaviors/viewlets.py
M plone/app/contenttypes/browser/templates/newsitem.pt

diff --git a/plone/app/contenttypes/behaviors/configure.zcml b/plone/app/contenttypes/behaviors/configure.zcml
index cdb8c0f..6f9fcab 100644
--- a/plone/app/contenttypes/behaviors/configure.zcml
+++ b/plone/app/contenttypes/behaviors/configure.zcml
@@ -21,7 +21,7 @@
     for=".leadimage.ILeadImage"
     view="plone.app.layout.globals.interfaces.IViewView"
     class=".viewlets.LeadImageViewlet"
-    manager="plone.app.layout.viewlets.interfaces.IAboveContentTitle"
+    manager="plone.app.layout.viewlets.interfaces.IBelowContentTitle"
     template="leadimage.pt"
     permission="zope2.View"
     />
diff --git a/plone/app/contenttypes/behaviors/leadimage.pt b/plone/app/contenttypes/behaviors/leadimage.pt
index 1c50f80..ce72c84 100644
--- a/plone/app/contenttypes/behaviors/leadimage.pt
+++ b/plone/app/contenttypes/behaviors/leadimage.pt
@@ -1,6 +1,19 @@
-<div class="leadImage" tal:condition="view/available">
-  <img tal:define="has_img context/image|nothing;
-                   scales context/@@images|nothing"
-       tal:condition="python:has_img and scales" 
-       tal:replace="structure python: scales.scale('image', scale='mini').tag(css_class='newsImage')" />
+<div class="leadImage"
+     tal:condition="view/available"
+     tal:define="scale_func context/@@images;
+                 scaled_image python: getattr(context.aq_explicit, 'image', False) and scale_func.scale('image', scale='mini')">
+
+  <figure class="newsImageContainer" tal:condition="python: scaled_image">
+    <a tal:define="here_url context/@@plone_context_state/object_url;
+                   large_image python: scale_func.scale('image', scale='large');"
+        class="pat-plone-modal" data-pat-plone-modal="image: true"
+        tal:attributes="href large_image/url">
+      <img tal:replace="structure python: scaled_image.tag(css_class='newsImage')" />
+      <figcaption tal:condition="context/image_caption|nothing"
+          tal:content="structure context/image_caption">
+      </figcaption>
+    </a>
+  </figure>
+
 </div>
+
diff --git a/plone/app/contenttypes/behaviors/viewlets.py b/plone/app/contenttypes/behaviors/viewlets.py
index bfa37ae..acc66ef 100644
--- a/plone/app/contenttypes/behaviors/viewlets.py
+++ b/plone/app/contenttypes/behaviors/viewlets.py
@@ -1,6 +1,5 @@
 # -*- coding: utf-8 -*-
 from plone.app.contenttypes.behaviors.leadimage import ILeadImage
-from plone.app.contenttypes.interfaces import INewsItem
 from plone.app.layout.viewlets import ViewletBase
 
 
@@ -10,5 +9,3 @@ class LeadImageViewlet(ViewletBase):
     def update(self):
         self.context = ILeadImage(self.context)
         self.available = True if self.context.image else False
-        if INewsItem.providedBy(self.context):
-            self.available = False
diff --git a/plone/app/contenttypes/browser/templates/newsitem.pt b/plone/app/contenttypes/browser/templates/newsitem.pt
index cb91583..b86d964 100644
--- a/plone/app/contenttypes/browser/templates/newsitem.pt
+++ b/plone/app/contenttypes/browser/templates/newsitem.pt
@@ -9,32 +9,12 @@
 
 <metal:content-core fill-slot="content-core">
 <metal:block define-macro="content-core"
-    tal:define="templateId template/getId;
-                scale_func context/@@images;
-                scaled_image python: getattr(context.aq_explicit, 'image', False) and scale_func.scale('image', scale='mini')">
-  <figure class="newsImageContainer" tal:condition="python: scaled_image">
-    <a tal:define="here_url context/@@plone_context_state/object_url;
-                   large_image python: scale_func.scale('image', scale='large');"
-        class="pat-plone-modal" data-pat-plone-modal="image: true"
-        tal:attributes="href large_image/url">
-      <img tal:replace="structure python: scaled_image.tag(css_class='newsImage')" />
-      <figcaption tal:condition="context/image_caption|nothing"
-          tal:content="structure context/image_caption">
-      </figcaption>
-    </a>
-  </figure>
+    tal:define="templateId template/getId;">
 
   <div id="parent-fieldname-text"
       tal:condition="context/text"
       tal:content="structure context/text/output" />
 
-  <div class="newsFileContainer"
-      tal:condition="python: getattr(context.aq_explicit, 'image', False) and not scaled_image">
-    <a tal:content="structure python:context.image_caption or context.image.filename"
-        tal:attributes="href python:'%s/@@download/image' % context.absolute_url()">
-    </a>
-  </div>
-
 </metal:block>
 </metal:content-core>
 


