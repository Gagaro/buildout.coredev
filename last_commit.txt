Repository: plone.app.querystring
Branch: refs/heads/1.2.x
Date: 2015-04-27T11:16:38-03:00
Author: Rodrigo Ferreira de Souza (rodfersou) <rodfersou@gmail.com>
Commit: https://github.com/plone/plone.app.querystring/commit/704ea80fec13fffe91fc5b3c71547c5fec9f0e97

Issue 32 changes to 1.2.x branch

Files changed:
A plone/app/querystring/profiles/upgrades/to_5/registry.xml
M CHANGES.rst
M plone/app/querystring/profiles.zcml
M plone/app/querystring/profiles/default/metadata.xml
M plone/app/querystring/profiles/default/registry.xml
M plone/app/querystring/queryparser.py
M plone/app/querystring/tests/testQueryParser.py
M plone/app/querystring/upgrades.zcml

diff --git a/CHANGES.rst b/CHANGES.rst
index 1c27fdf..931ff15 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,8 @@ Changelog
 1.2.4 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- Fix collection not filtering integer field (closes `#32`_).
+  [rodfersou]
 
 
 1.2.3 (2014-10-20)
@@ -183,3 +184,5 @@ Changelog
 ----------------
 
 * Initial release
+
+.. _`#32`: https://github.com/plone/plone.app.querystring/issues/32
diff --git a/plone/app/querystring/profiles.zcml b/plone/app/querystring/profiles.zcml
index 6138de8..ab184ff 100644
--- a/plone/app/querystring/profiles.zcml
+++ b/plone/app/querystring/profiles.zcml
@@ -19,4 +19,12 @@
             provides="Products.GenericSetup.interfaces.EXTENSION"
             />
 
+    <genericsetup:registerProfile
+        name="upgrade_to_5"
+        title="Querystring Upgrade profile to v5"
+        description=""
+        directory="profiles/upgrades/to_5"
+        provides="Products.GenericSetup.interfaces.EXTENSION"
+        />
+
  </configure>
diff --git a/plone/app/querystring/profiles/default/metadata.xml b/plone/app/querystring/profiles/default/metadata.xml
index 7d9b6bd..c637d7b 100644
--- a/plone/app/querystring/profiles/default/metadata.xml
+++ b/plone/app/querystring/profiles/default/metadata.xml
@@ -1,6 +1,6 @@
 <?xml version="1.0"?>
 <metadata>
-  <version>4</version>
+  <version>5</version>
   <dependencies>
       <dependency>profile-plone.app.registry:default</dependency>
   </dependencies>
diff --git a/plone/app/querystring/profiles/default/registry.xml b/plone/app/querystring/profiles/default/registry.xml
index 3ab91c8..10f9c7d 100644
--- a/plone/app/querystring/profiles/default/registry.xml
+++ b/plone/app/querystring/profiles/default/registry.xml
@@ -22,7 +22,7 @@
              prefix="plone.app.querystring.operation.int.is">
         <value key="title" i18n:translate="">Equals</value>
         <value key="description"></value>
-        <value key="operation">plone.app.querystring.queryparser._equal</value>
+        <value key="operation">plone.app.querystring.queryparser._intEqual</value>
         <value key="widget">StringWidget</value>
     </records>
 
@@ -30,7 +30,7 @@
              prefix="plone.app.querystring.operation.int.lessThan">
         <value key="title" i18n:translate="">Less than</value>
         <value key="description"></value>
-        <value key="operation">plone.app.querystring.queryparser._lessThan</value>
+        <value key="operation">plone.app.querystring.queryparser._intLessThan</value>
         <value key="widget">StringWidget</value>
     </records>
 
@@ -38,7 +38,7 @@
              prefix="plone.app.querystring.operation.int.largerThan">
         <value key="title" i18n:translate="">Larger than</value>
         <value key="description"></value>
-        <value key="operation">plone.app.querystring.queryparser._largerThan</value>
+        <value key="operation">plone.app.querystring.queryparser._intLargerThan</value>
         <value key="widget">StringWidget</value>
     </records>
 
@@ -179,6 +179,14 @@
     </records>
 
     <records interface="plone.app.querystring.interfaces.IQueryOperation"
+             prefix="plone.app.querystring.operation.intselection.is">
+        <value key="title" i18n:translate="">Is</value>
+        <value key="description" i18n:translate="">Tip: you can use * to autocomplete.</value>
+        <value key="operation">plone.app.querystring.queryparser._intEqual</value>
+        <value key="widget">MultipleSelectionWidget</value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryOperation"
              prefix="plone.app.querystring.operation.string.path">
         <value key="title" i18n:translate="">Absolute path</value>
         <value key="description" i18n:translate="">Location in the site structure</value>
diff --git a/plone/app/querystring/profiles/upgrades/to_5/registry.xml b/plone/app/querystring/profiles/upgrades/to_5/registry.xml
new file mode 100644
index 0000000..8265161
--- /dev/null
+++ b/plone/app/querystring/profiles/upgrades/to_5/registry.xml
@@ -0,0 +1,36 @@
+<registry xmlns:i18n="http://xml.zope.org/namespaces/i18n"
+          i18n:domain="plone">
+
+    <records interface="plone.app.querystring.interfaces.IQueryOperation"
+             prefix="plone.app.querystring.operation.int.is">
+        <value key="title" i18n:translate="">Equals</value>
+        <value key="description"></value>
+        <value key="operation">plone.app.querystring.queryparser._intEqual</value>
+        <value key="widget">StringWidget</value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryOperation"
+             prefix="plone.app.querystring.operation.int.lessThan">
+        <value key="title" i18n:translate="">Less than</value>
+        <value key="description"></value>
+        <value key="operation">plone.app.querystring.queryparser._intLessThan</value>
+        <value key="widget">StringWidget</value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryOperation"
+             prefix="plone.app.querystring.operation.int.largerThan">
+        <value key="title" i18n:translate="">Larger than</value>
+        <value key="description"></value>
+        <value key="operation">plone.app.querystring.queryparser._intLargerThan</value>
+        <value key="widget">StringWidget</value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryOperation"
+             prefix="plone.app.querystring.operation.intselection.is">
+        <value key="title" i18n:translate="">Is</value>
+        <value key="description" i18n:translate="">Tip: you can use * to autocomplete.</value>
+        <value key="operation">plone.app.querystring.queryparser._intEqual</value>
+        <value key="widget">MultipleSelectionWidget</value>
+    </records>
+
+</registry>
diff --git a/plone/app/querystring/queryparser.py b/plone/app/querystring/queryparser.py
index 3e48952..9cc011c 100644
--- a/plone/app/querystring/queryparser.py
+++ b/plone/app/querystring/queryparser.py
@@ -64,6 +64,15 @@ def _equal(context, row):
     return {row.index: {'query': row.values, }}
 
 
+def _intEqual(context, row):
+    values = None
+    if type(row.values) is list:
+        values = [int(v) for v in row.values]
+    elif type(row.values) is str:
+        values = int(row.values)
+    return {row.index: {'query': values, }}
+
+
 def _isTrue(context, row):
     return {row.index: {'query': True, }}
 
@@ -92,6 +101,19 @@ def _largerThan(context, row):
     return tmp
 
 
+def _intLargerThan(context, row):
+    value = None
+    if type(row.values) is str:
+        value = int(row.values)
+    tmp = {row.index:
+           {
+               'query': value,
+               'range': 'min',
+           },
+           }
+    return tmp
+
+
 def _lessThan(context, row):
     tmp = {row.index:
            {
@@ -102,6 +124,19 @@ def _lessThan(context, row):
     return tmp
 
 
+def _intLessThan(context, row):
+    value = None
+    if type(row.values) is str:
+        value = int(row.values)
+    tmp = {row.index:
+           {
+               'query': value,
+               'range': 'max',
+           },
+           }
+    return tmp
+
+
 def _currentUser(context, row):
     """Current user lookup"""
     mt = getToolByName(context, 'portal_membership')
diff --git a/plone/app/querystring/tests/testQueryParser.py b/plone/app/querystring/tests/testQueryParser.py
index e831564..07bc2ae 100644
--- a/plone/app/querystring/tests/testQueryParser.py
+++ b/plone/app/querystring/tests/testQueryParser.py
@@ -240,14 +240,42 @@ def test__between_reversed_dates(self):
                     'range': 'minmax'}}
         self.assertEqual(parsed, expected)
 
-    def test__largerThan(self):
+    def test__equal(self):
         data = Row(
             index='modified',
-            operator='_largerThan',
+            operator='_equal',
             values='2010/03/18'
         )
-        parsed = queryparser._largerThan(MockSite(), data)
-        expected = {'modified': {'query': '2010/03/18', 'range': 'min'}}
+        parsed = queryparser._equal(MockSite(), data)
+        expected = {'modified': {'query': '2010/03/18'}}
+        self.assertEqual(parsed, expected)
+
+        data = Row(
+            index='modified',
+            operator='_equal',
+            values=['2010/03/18', '2010/03/19']
+        )
+        parsed = queryparser._equal(MockSite(), data)
+        expected = {'modified': {'query': ['2010/03/18', '2010/03/19']}}
+        self.assertEqual(parsed, expected)
+
+    def test__intEqual(self):
+        data = Row(
+            index='modified',
+            operator='_intEqual',
+            values='20'
+        )
+        parsed = queryparser._intEqual(MockSite(), data)
+        expected = {'modified': {'query': 20}}
+        self.assertEqual(parsed, expected)
+
+        data = Row(
+            index='modified',
+            operator='_intEqual',
+            values=['20', '21']
+        )
+        parsed = queryparser._intEqual(MockSite(), data)
+        expected = {'modified': {'query': [20, 21]}}
         self.assertEqual(parsed, expected)
 
     def test__lessThan(self):
@@ -260,6 +288,36 @@ def test__lessThan(self):
         expected = {'modified': {'query': '2010/03/18', 'range': 'max'}}
         self.assertEqual(parsed, expected)
 
+    def test__intLessThan(self):
+        data = Row(
+            index='modified',
+            operator='_intLessThan',
+            values='20'
+        )
+        parsed = queryparser._intLessThan(MockSite(), data)
+        expected = {'modified': {'query': 20, 'range': 'max'}}
+        self.assertEqual(parsed, expected)
+
+    def test__largerThan(self):
+        data = Row(
+            index='modified',
+            operator='_largerThan',
+            values='2010/03/18'
+        )
+        parsed = queryparser._largerThan(MockSite(), data)
+        expected = {'modified': {'query': '2010/03/18', 'range': 'min'}}
+        self.assertEqual(parsed, expected)
+
+    def test__intLargerThan(self):
+        data = Row(
+            index='modified',
+            operator='_intLargerThan',
+            values='20'
+        )
+        parsed = queryparser._intLargerThan(MockSite(), data)
+        expected = {'modified': {'query': 20, 'range': 'min'}}
+        self.assertEqual(parsed, expected)
+
     def test__currentUser(self):
         # Anonymous user
         u = MockUser()
diff --git a/plone/app/querystring/upgrades.zcml b/plone/app/querystring/upgrades.zcml
index 960b47d..97f10fa 100644
--- a/plone/app/querystring/upgrades.zcml
+++ b/plone/app/querystring/upgrades.zcml
@@ -31,4 +31,14 @@
         />
   </genericsetup:upgradeSteps>
 
+  <genericsetup:upgradeSteps
+      source="4"
+      destination="5"
+      profile="plone.app.querystring:default">
+    <genericsetup:upgradeDepends
+        title="Fix int operators"
+        import_profile="plone.app.querystring:upgrade_to_5"
+        />
+  </genericsetup:upgradeSteps>
+
 </configure>


Repository: plone.app.querystring
Branch: refs/heads/1.2.x
Date: 2015-04-28T01:02:48+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.querystring/commit/d2c45f3374ce896512caf114c06b5fab19e06d66

Merge pull request #34 from plone/issue_32_12x

Issue 32 changes to 1.2.x branch

Files changed:
A plone/app/querystring/profiles/upgrades/to_5/registry.xml
M CHANGES.rst
M plone/app/querystring/profiles.zcml
M plone/app/querystring/profiles/default/metadata.xml
M plone/app/querystring/profiles/default/registry.xml
M plone/app/querystring/queryparser.py
M plone/app/querystring/tests/testQueryParser.py
M plone/app/querystring/upgrades.zcml

diff --git a/CHANGES.rst b/CHANGES.rst
index 1c27fdf..931ff15 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,8 @@ Changelog
 1.2.4 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- Fix collection not filtering integer field (closes `#32`_).
+  [rodfersou]
 
 
 1.2.3 (2014-10-20)
@@ -183,3 +184,5 @@ Changelog
 ----------------
 
 * Initial release
+
+.. _`#32`: https://github.com/plone/plone.app.querystring/issues/32
diff --git a/plone/app/querystring/profiles.zcml b/plone/app/querystring/profiles.zcml
index 6138de8..ab184ff 100644
--- a/plone/app/querystring/profiles.zcml
+++ b/plone/app/querystring/profiles.zcml
@@ -19,4 +19,12 @@
             provides="Products.GenericSetup.interfaces.EXTENSION"
             />
 
+    <genericsetup:registerProfile
+        name="upgrade_to_5"
+        title="Querystring Upgrade profile to v5"
+        description=""
+        directory="profiles/upgrades/to_5"
+        provides="Products.GenericSetup.interfaces.EXTENSION"
+        />
+
  </configure>
diff --git a/plone/app/querystring/profiles/default/metadata.xml b/plone/app/querystring/profiles/default/metadata.xml
index 7d9b6bd..c637d7b 100644
--- a/plone/app/querystring/profiles/default/metadata.xml
+++ b/plone/app/querystring/profiles/default/metadata.xml
@@ -1,6 +1,6 @@
 <?xml version="1.0"?>
 <metadata>
-  <version>4</version>
+  <version>5</version>
   <dependencies>
       <dependency>profile-plone.app.registry:default</dependency>
   </dependencies>
diff --git a/plone/app/querystring/profiles/default/registry.xml b/plone/app/querystring/profiles/default/registry.xml
index 3ab91c8..10f9c7d 100644
--- a/plone/app/querystring/profiles/default/registry.xml
+++ b/plone/app/querystring/profiles/default/registry.xml
@@ -22,7 +22,7 @@
              prefix="plone.app.querystring.operation.int.is">
         <value key="title" i18n:translate="">Equals</value>
         <value key="description"></value>
-        <value key="operation">plone.app.querystring.queryparser._equal</value>
+        <value key="operation">plone.app.querystring.queryparser._intEqual</value>
         <value key="widget">StringWidget</value>
     </records>
 
@@ -30,7 +30,7 @@
              prefix="plone.app.querystring.operation.int.lessThan">
         <value key="title" i18n:translate="">Less than</value>
         <value key="description"></value>
-        <value key="operation">plone.app.querystring.queryparser._lessThan</value>
+        <value key="operation">plone.app.querystring.queryparser._intLessThan</value>
         <value key="widget">StringWidget</value>
     </records>
 
@@ -38,7 +38,7 @@
              prefix="plone.app.querystring.operation.int.largerThan">
         <value key="title" i18n:translate="">Larger than</value>
         <value key="description"></value>
-        <value key="operation">plone.app.querystring.queryparser._largerThan</value>
+        <value key="operation">plone.app.querystring.queryparser._intLargerThan</value>
         <value key="widget">StringWidget</value>
     </records>
 
@@ -179,6 +179,14 @@
     </records>
 
     <records interface="plone.app.querystring.interfaces.IQueryOperation"
+             prefix="plone.app.querystring.operation.intselection.is">
+        <value key="title" i18n:translate="">Is</value>
+        <value key="description" i18n:translate="">Tip: you can use * to autocomplete.</value>
+        <value key="operation">plone.app.querystring.queryparser._intEqual</value>
+        <value key="widget">MultipleSelectionWidget</value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryOperation"
              prefix="plone.app.querystring.operation.string.path">
         <value key="title" i18n:translate="">Absolute path</value>
         <value key="description" i18n:translate="">Location in the site structure</value>
diff --git a/plone/app/querystring/profiles/upgrades/to_5/registry.xml b/plone/app/querystring/profiles/upgrades/to_5/registry.xml
new file mode 100644
index 0000000..8265161
--- /dev/null
+++ b/plone/app/querystring/profiles/upgrades/to_5/registry.xml
@@ -0,0 +1,36 @@
+<registry xmlns:i18n="http://xml.zope.org/namespaces/i18n"
+          i18n:domain="plone">
+
+    <records interface="plone.app.querystring.interfaces.IQueryOperation"
+             prefix="plone.app.querystring.operation.int.is">
+        <value key="title" i18n:translate="">Equals</value>
+        <value key="description"></value>
+        <value key="operation">plone.app.querystring.queryparser._intEqual</value>
+        <value key="widget">StringWidget</value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryOperation"
+             prefix="plone.app.querystring.operation.int.lessThan">
+        <value key="title" i18n:translate="">Less than</value>
+        <value key="description"></value>
+        <value key="operation">plone.app.querystring.queryparser._intLessThan</value>
+        <value key="widget">StringWidget</value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryOperation"
+             prefix="plone.app.querystring.operation.int.largerThan">
+        <value key="title" i18n:translate="">Larger than</value>
+        <value key="description"></value>
+        <value key="operation">plone.app.querystring.queryparser._intLargerThan</value>
+        <value key="widget">StringWidget</value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryOperation"
+             prefix="plone.app.querystring.operation.intselection.is">
+        <value key="title" i18n:translate="">Is</value>
+        <value key="description" i18n:translate="">Tip: you can use * to autocomplete.</value>
+        <value key="operation">plone.app.querystring.queryparser._intEqual</value>
+        <value key="widget">MultipleSelectionWidget</value>
+    </records>
+
+</registry>
diff --git a/plone/app/querystring/queryparser.py b/plone/app/querystring/queryparser.py
index 3e48952..9cc011c 100644
--- a/plone/app/querystring/queryparser.py
+++ b/plone/app/querystring/queryparser.py
@@ -64,6 +64,15 @@ def _equal(context, row):
     return {row.index: {'query': row.values, }}
 
 
+def _intEqual(context, row):
+    values = None
+    if type(row.values) is list:
+        values = [int(v) for v in row.values]
+    elif type(row.values) is str:
+        values = int(row.values)
+    return {row.index: {'query': values, }}
+
+
 def _isTrue(context, row):
     return {row.index: {'query': True, }}
 
@@ -92,6 +101,19 @@ def _largerThan(context, row):
     return tmp
 
 
+def _intLargerThan(context, row):
+    value = None
+    if type(row.values) is str:
+        value = int(row.values)
+    tmp = {row.index:
+           {
+               'query': value,
+               'range': 'min',
+           },
+           }
+    return tmp
+
+
 def _lessThan(context, row):
     tmp = {row.index:
            {
@@ -102,6 +124,19 @@ def _lessThan(context, row):
     return tmp
 
 
+def _intLessThan(context, row):
+    value = None
+    if type(row.values) is str:
+        value = int(row.values)
+    tmp = {row.index:
+           {
+               'query': value,
+               'range': 'max',
+           },
+           }
+    return tmp
+
+
 def _currentUser(context, row):
     """Current user lookup"""
     mt = getToolByName(context, 'portal_membership')
diff --git a/plone/app/querystring/tests/testQueryParser.py b/plone/app/querystring/tests/testQueryParser.py
index e831564..07bc2ae 100644
--- a/plone/app/querystring/tests/testQueryParser.py
+++ b/plone/app/querystring/tests/testQueryParser.py
@@ -240,14 +240,42 @@ def test__between_reversed_dates(self):
                     'range': 'minmax'}}
         self.assertEqual(parsed, expected)
 
-    def test__largerThan(self):
+    def test__equal(self):
         data = Row(
             index='modified',
-            operator='_largerThan',
+            operator='_equal',
             values='2010/03/18'
         )
-        parsed = queryparser._largerThan(MockSite(), data)
-        expected = {'modified': {'query': '2010/03/18', 'range': 'min'}}
+        parsed = queryparser._equal(MockSite(), data)
+        expected = {'modified': {'query': '2010/03/18'}}
+        self.assertEqual(parsed, expected)
+
+        data = Row(
+            index='modified',
+            operator='_equal',
+            values=['2010/03/18', '2010/03/19']
+        )
+        parsed = queryparser._equal(MockSite(), data)
+        expected = {'modified': {'query': ['2010/03/18', '2010/03/19']}}
+        self.assertEqual(parsed, expected)
+
+    def test__intEqual(self):
+        data = Row(
+            index='modified',
+            operator='_intEqual',
+            values='20'
+        )
+        parsed = queryparser._intEqual(MockSite(), data)
+        expected = {'modified': {'query': 20}}
+        self.assertEqual(parsed, expected)
+
+        data = Row(
+            index='modified',
+            operator='_intEqual',
+            values=['20', '21']
+        )
+        parsed = queryparser._intEqual(MockSite(), data)
+        expected = {'modified': {'query': [20, 21]}}
         self.assertEqual(parsed, expected)
 
     def test__lessThan(self):
@@ -260,6 +288,36 @@ def test__lessThan(self):
         expected = {'modified': {'query': '2010/03/18', 'range': 'max'}}
         self.assertEqual(parsed, expected)
 
+    def test__intLessThan(self):
+        data = Row(
+            index='modified',
+            operator='_intLessThan',
+            values='20'
+        )
+        parsed = queryparser._intLessThan(MockSite(), data)
+        expected = {'modified': {'query': 20, 'range': 'max'}}
+        self.assertEqual(parsed, expected)
+
+    def test__largerThan(self):
+        data = Row(
+            index='modified',
+            operator='_largerThan',
+            values='2010/03/18'
+        )
+        parsed = queryparser._largerThan(MockSite(), data)
+        expected = {'modified': {'query': '2010/03/18', 'range': 'min'}}
+        self.assertEqual(parsed, expected)
+
+    def test__intLargerThan(self):
+        data = Row(
+            index='modified',
+            operator='_intLargerThan',
+            values='20'
+        )
+        parsed = queryparser._intLargerThan(MockSite(), data)
+        expected = {'modified': {'query': 20, 'range': 'min'}}
+        self.assertEqual(parsed, expected)
+
     def test__currentUser(self):
         # Anonymous user
         u = MockUser()
diff --git a/plone/app/querystring/upgrades.zcml b/plone/app/querystring/upgrades.zcml
index 960b47d..97f10fa 100644
--- a/plone/app/querystring/upgrades.zcml
+++ b/plone/app/querystring/upgrades.zcml
@@ -31,4 +31,14 @@
         />
   </genericsetup:upgradeSteps>
 
+  <genericsetup:upgradeSteps
+      source="4"
+      destination="5"
+      profile="plone.app.querystring:default">
+    <genericsetup:upgradeDepends
+        title="Fix int operators"
+        import_profile="plone.app.querystring:upgrade_to_5"
+        />
+  </genericsetup:upgradeSteps>
+
 </configure>


