Repository: plone.dexterity


Branch: refs/heads/master
Date: 2015-09-20T17:31:25+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.dexterity/commit/daa8d26f6af8e3e02ec5fdcc4506d0b5122d9b5b

Use registry lookup for types_use_view_action_in_listings

Files changed:
M CHANGES.rst
M plone/dexterity/browser/edit.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 69d0bad..06111a0 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -5,6 +5,9 @@ Changelog
 2.3.5 (unreleased)
 ------------------
 
+- Use registry lookup for types_use_view_action_in_listings
+  [esteele]
+
 - Don't check type constraints in AddForm.update() if request provides
   IDeferSecurityChecks.
   [alecm]
diff --git a/plone/dexterity/browser/edit.py b/plone/dexterity/browser/edit.py
index f891d25..1eb4dce 100644
--- a/plone/dexterity/browser/edit.py
+++ b/plone/dexterity/browser/edit.py
@@ -8,6 +8,7 @@
 from plone.dexterity.i18n import MessageFactory as _
 from plone.dexterity.interfaces import IDexterityEditForm
 from plone.dexterity.interfaces import IDexterityFTI
+from plone.registry.interfaces import IRegistry
 from plone.z3cform import layout
 from z3c.form import button
 from z3c.form import form
@@ -43,21 +44,13 @@ def handleCancel(self, action):
 
     def nextURL(self):
         view_url = self.context.absolute_url()
-        portal_properties = getToolByName(self, 'portal_properties', None)
-        if portal_properties is not None:
-            site_properties = getattr(
-                portal_properties,
-                'site_properties',
-                None
-            )
-            portal_type = self.portal_type
-            if site_properties is not None and portal_type is not None:
-                use_view_action = site_properties.getProperty(
-                    'typesUseViewActionInListings',
-                    ()
-                )
-                if portal_type in use_view_action:
-                    view_url = view_url + '/view'
+        portal_type = self.portal_type
+        if portal_type is not None:
+            registry = getUtility(IRegistry)
+            use_view_action = registry.get(
+                'plone.types_view_action_in_listings', [])
+            if portal_type in use_view_action:
+                view_url = view_url + '/view'
         return view_url
 
     def update(self):


Repository: plone.dexterity


Branch: refs/heads/master
Date: 2015-09-20T17:31:26+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.dexterity/commit/c1129e93bcd3128ac9ee7c105f93f2bf7c11404f

Fix registry id

Files changed:
M plone/dexterity/browser/edit.py

diff --git a/plone/dexterity/browser/edit.py b/plone/dexterity/browser/edit.py
index 1eb4dce..4a01ecc 100644
--- a/plone/dexterity/browser/edit.py
+++ b/plone/dexterity/browser/edit.py
@@ -48,7 +48,7 @@ def nextURL(self):
         if portal_type is not None:
             registry = getUtility(IRegistry)
             use_view_action = registry.get(
-                'plone.types_view_action_in_listings', [])
+                'plone.types_use_view_action_in_listings', [])
             if portal_type in use_view_action:
                 view_url = view_url + '/view'
         return view_url


Repository: plone.dexterity


Branch: refs/heads/master
Date: 2015-09-20T17:31:26+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.dexterity/commit/825042b5a4fc34759486398afb19fafce3e8a2c1

Handle missing portal_type value (seems to only be a test issue at this point)

Files changed:
M plone/dexterity/browser/edit.py

diff --git a/plone/dexterity/browser/edit.py b/plone/dexterity/browser/edit.py
index 4a01ecc..29106b4 100644
--- a/plone/dexterity/browser/edit.py
+++ b/plone/dexterity/browser/edit.py
@@ -44,7 +44,7 @@ def handleCancel(self, action):
 
     def nextURL(self):
         view_url = self.context.absolute_url()
-        portal_type = self.portal_type
+        portal_type = getattr(self, 'portal_type', None)
         if portal_type is not None:
             registry = getUtility(IRegistry)
             use_view_action = registry.get(


Repository: plone.dexterity


Branch: refs/heads/master
Date: 2015-09-20T17:31:40+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.dexterity/commit/69cd55d20ed910aab7a6fc65ee8020dccb723b46

Merge pull request #41 from plone/portal-properties-cleanup

Portal properties cleanup

Files changed:
M CHANGES.rst
M plone/dexterity/browser/edit.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 69d0bad..06111a0 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -5,6 +5,9 @@ Changelog
 2.3.5 (unreleased)
 ------------------
 
+- Use registry lookup for types_use_view_action_in_listings
+  [esteele]
+
 - Don't check type constraints in AddForm.update() if request provides
   IDeferSecurityChecks.
   [alecm]
diff --git a/plone/dexterity/browser/edit.py b/plone/dexterity/browser/edit.py
index f891d25..29106b4 100644
--- a/plone/dexterity/browser/edit.py
+++ b/plone/dexterity/browser/edit.py
@@ -8,6 +8,7 @@
 from plone.dexterity.i18n import MessageFactory as _
 from plone.dexterity.interfaces import IDexterityEditForm
 from plone.dexterity.interfaces import IDexterityFTI
+from plone.registry.interfaces import IRegistry
 from plone.z3cform import layout
 from z3c.form import button
 from z3c.form import form
@@ -43,21 +44,13 @@ def handleCancel(self, action):
 
     def nextURL(self):
         view_url = self.context.absolute_url()
-        portal_properties = getToolByName(self, 'portal_properties', None)
-        if portal_properties is not None:
-            site_properties = getattr(
-                portal_properties,
-                'site_properties',
-                None
-            )
-            portal_type = self.portal_type
-            if site_properties is not None and portal_type is not None:
-                use_view_action = site_properties.getProperty(
-                    'typesUseViewActionInListings',
-                    ()
-                )
-                if portal_type in use_view_action:
-                    view_url = view_url + '/view'
+        portal_type = getattr(self, 'portal_type', None)
+        if portal_type is not None:
+            registry = getUtility(IRegistry)
+            use_view_action = registry.get(
+                'plone.types_use_view_action_in_listings', [])
+            if portal_type in use_view_action:
+                view_url = view_url + '/view'
         return view_url
 
     def update(self):


