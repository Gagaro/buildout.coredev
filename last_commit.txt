Repository: plone.app.search


Branch: refs/heads/1.1.x
Date: 2015-07-02T07:43:03+02:00
Author: Timo Stollenwerk (tisto) <tisto@plone.org>
Commit: https://github.com/plone/plone.app.search/commit/acced918aff9172464fcf54330c28c340629d3a4

Do not use the 'template' ZCML attribute to register the search and
  updated_search views.

Files changed:
M CHANGES.rst
M plone/app/search/browser.py
M plone/app/search/configure.zcml

diff --git a/CHANGES.rst b/CHANGES.rst
index 6951cb4..dc12fbb 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -5,20 +5,23 @@ Changelog
 1.1.9 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- Do not use the 'template' ZCML attribute to register the search and
+  updated_search views. This allows us to override those views.
+  [timo]
 
 
 1.1.8 (2014-09-07)
 ------------------
 
-- (backport) #13999 Do not error if Plone 3 advanced search parameters 
+- (backport) #13999 Do not error if Plone 3 advanced search parameters
   are used
   [anthonygerrard]
 
+
 1.1.7 (2014-03-11)
 ------------------
 
-- (back port) URL bar is not correctly updated after clicking 
+- (back port) URL bar is not correctly updated after clicking
   pagination or updating search. Fixing regression introduced in 1.1.5
   [anthonygerrard]
 
@@ -53,7 +56,7 @@ Changelog
 1.1.3 (2013-03-05)
 ------------------
 
-- Readded fix made by eleddy in 1.0.4 wrongfully removed from 1.1.x 
+- Readded fix made by eleddy in 1.0.4 wrongfully removed from 1.1.x
   [ichimdav]
 
 - Restored compatibility with IE <= 8 for search.js broke in previous egg
diff --git a/plone/app/search/browser.py b/plone/app/search/browser.py
index 71eb1b9..5cdb928 100644
--- a/plone/app/search/browser.py
+++ b/plone/app/search/browser.py
@@ -5,6 +5,7 @@
 from Products.CMFCore.utils import getToolByName
 from Products.CMFPlone.browser.navtree import getNavigationRoot
 from Products.CMFPlone.PloneBatch import Batch
+from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile
 from Products.ZCTextIndex.ParseTree import ParseError
 from zope.component import getMultiAdapter
 from zope.i18nmessageid import MessageFactory
@@ -34,6 +35,13 @@ class Search(BrowserView):
 
     valid_keys = ('sort_on', 'sort_order', 'sort_limit', 'fq', 'fl', 'facet')
 
+    def __init__(self, context, request):
+        super(Search, self).__init__(context, request)
+        if self.__name__ == 'updated_search':
+            self.template = ViewPageTemplateFile('updated_search.pt')
+        else:
+            self.template = ViewPageTemplateFile('search.pt')
+
     def results(self, query=None, batch=True, b_size=10, b_start=0):
         """ Get properly wrapped search results from the catalog.
         Everything in Plone that performs searches should go through this view.
diff --git a/plone/app/search/configure.zcml b/plone/app/search/configure.zcml
index 90f4d45..aa821ab 100644
--- a/plone/app/search/configure.zcml
+++ b/plone/app/search/configure.zcml
@@ -23,7 +23,6 @@
         class=".browser.Search"
         permission="zope2.View"
         for="*"
-        template="search.pt"
         />
 
     <browser:page
@@ -31,7 +30,6 @@
         class=".browser.Search"
         permission="zope2.View"
         for="Products.CMFCore.interfaces.IFolderish"
-        template="updated_search.pt"
         />
 
 </configure>


