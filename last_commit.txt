Repository: plone.protect


Branch: refs/heads/master
Date: 2015-10-06T09:36:51-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.protect/commit/6b99d25c7ab26789ac72637e200c4318cc0f7ef7

play nicer with inline JavaScript

Files changed:
M CHANGES.rst
M plone/protect/auto.py

diff --git a/CHANGES.rst b/CHANGES.rst
index c2b959a..3b79c4b 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,6 +4,9 @@ Changelog
 3.0.11 (unreleased)
 -------------------
 
+- play nicer with inline JavaScript
+  [vangheem]
+
 
 3.0.10 (2015-10-06)
 -------------------
diff --git a/plone/protect/auto.py b/plone/protect/auto.py
index 49c65a6..5eede0a 100644
--- a/plone/protect/auto.py
+++ b/plone/protect/auto.py
@@ -1,6 +1,7 @@
 import itertools
 import logging
 import os
+import re
 import traceback
 from urllib import urlencode
 from urlparse import urlparse
@@ -9,6 +10,7 @@
 from Acquisition import aq_parent
 from Products.CMFCore.utils import getToolByName
 from lxml import etree
+from lxml import html
 from plone.keyring.interfaces import IKeyManager
 from plone.portlets.interfaces import IPortletAssignment
 from plone.protect.authenticator import check
@@ -21,6 +23,7 @@
 from plone.protect.utils import getRootKeyManager
 from plone.protect.utils import safeWrite  # noqa b/w compat import
 from plone.transformchain.interfaces import ITransform
+from repoze.xmliter.serializer import XMLSerializer
 from repoze.xmliter.utils import getHTMLSerializer
 import transaction
 import types
@@ -30,8 +33,8 @@
 from zope.component import getUtility
 from zope.interface import implements, Interface
 
-LOGGER = logging.getLogger('plone.protect')
 
+LOGGER = logging.getLogger('plone.protect')
 
 X_FRAME_OPTIONS = os.environ.get('PLONE_X_FRAME_OPTIONS', 'SAMEORIGIN')
 CSRF_DISABLED = os.environ.get('PLONE_CSRF_DISABLED', 'false') == 'true'
@@ -57,7 +60,10 @@ def __init__(self, published, request):
         self.published = published
         self.request = request
 
-    def parseTree(self, result):
+    def parseTree(self, result, encoding):
+        if isinstance(result, XMLSerializer):
+            return result
+
         # hhmmm, this is kind of taken right out of plone.app.theming
         # maybe this logic(parsing dom) should be someone central?
         contentType = self.request.response.getHeader('Content-Type')
@@ -70,7 +76,16 @@ def parseTree(self, result):
             return None
 
         try:
-            return getHTMLSerializer(result, pretty_print=False)
+            # Fix layouts with CR[+LF] line endings not to lose their heads
+            # (this has been seen with downloaded themes with CR[+LF] endings)
+            iterable = [re.sub('&#13;', '\n', re.sub('&#13;\n', '\n', item))
+                        for item in result if item]
+            result = getHTMLSerializer(
+                iterable, pretty_print=False, encoding=encoding)
+            # Fix XHTML where etree.tostring breaks <![CDATA[
+            if any(['<![CDATA[' in item for item in iterable]):
+                result.serializer = html.tostring
+            return result
         except (TypeError, etree.ParseError):
             # XXX handle something special?
             LOGGER.warn('error parsing dom, failure to add csrf '
@@ -106,7 +121,7 @@ def transformIterable(self, result, encoding):
         if IConfirmView.providedBy(self.request.get('PUBLISHED')):
             # abort it, show the confirmation...
             transaction.abort()
-            return self.transform(result)
+            return self.transform(result, encoding)
 
         # next, check if we're a resource not connected
         # to a ZODB object--no context
@@ -133,7 +148,7 @@ def transformIterable(self, result, encoding):
             return
 
         # finally, let's run the transform
-        return self.transform(result)
+        return self.transform(result, encoding)
 
     def getContext(self):
         published = self.request.get('PUBLISHED')
@@ -231,8 +246,8 @@ def isActionInSite(self, action, current_url):
             return False
         return True
 
-    def transform(self, result):
-        result = self.parseTree(result)
+    def transform(self, result, encoding):
+        result = self.parseTree(result, encoding)
         if result is None:
             return None
         root = result.tree.getroot()


Repository: plone.protect


Branch: refs/heads/master
Date: 2015-10-06T09:37:55-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.protect/commit/ed5b273af29d7376cc93b0564c2e957c3a3e2faf

Prepare plone.protect 3.0.11.

Files changed:
M CHANGES.rst
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 3b79c4b..2aff4d5 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -1,7 +1,7 @@
 Changelog
 =========
 
-3.0.11 (unreleased)
+3.0.11 (2015-10-06)
 -------------------
 
 - play nicer with inline JavaScript
diff --git a/setup.py b/setup.py
index e50de51..ea84afc 100644
--- a/setup.py
+++ b/setup.py
@@ -1,6 +1,6 @@
 from setuptools import setup, find_packages
 
-version = '3.0.11.dev0'
+version = '3.0.11'
 
 setup(
     name='plone.protect',


