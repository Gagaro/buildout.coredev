Repository: Products.CMFPlone
Branch: refs/heads/master
Date: 2015-05-04T20:48:58+02:00
Author: Timo Stollenwerk (tisto) <tisto@plone.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/ff8b3d0bee6be2a4dda9c3dc404c0cc0abfc9896

Make typesToList read metaTypesNotToList from new p.a.registry settings.

Files changed:
M CHANGES.rst
M Products/CMFPlone/tests/robot/test_controlpanel_navigation.robot
M Products/CMFPlone/utils.py

diff --git a/CHANGES.rst b/CHANGES.rst
index ea880bf..5a3126f 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -8,6 +8,9 @@ Changelog
 5.0b2 (unreleased)
 ------------------
 
+- Make typesToList read metaTypesNotToList from new p.a.registry settings.
+  [timo]
+
 - style tweaks to toolbar
   [pbauer]
 
diff --git a/Products/CMFPlone/tests/robot/test_controlpanel_navigation.robot b/Products/CMFPlone/tests/robot/test_controlpanel_navigation.robot
index 70b4a5a..253605f 100644
--- a/Products/CMFPlone/tests/robot/test_controlpanel_navigation.robot
+++ b/Products/CMFPlone/tests/robot/test_controlpanel_navigation.robot
@@ -33,6 +33,7 @@ Scenario: Filter Navigation By Displayed Types in the Navigation Control Panel
     and the navigation control panel
    When I remove 'Document' from the displayed types list
    Then the document 'My Document' does not show up in the navigation
+    and the document 'My Document' does not show up in the sitemap
 
 #Scenario: Filter Navigation By Workflow States in the Navigation Control Panel
 #  Given a logged-in site administrator
@@ -105,3 +106,8 @@ the document '${title}' does not show up in the navigation
   Go to  ${PLONE_URL}
   Wait until page contains  Powered by Plone
   XPath Should Match X Times  //ul[@id='portal-globalnav']/li/a[contains(text(), '${title}')]  0  message=The global navigation should not have contained the item '${title}'
+
+the document '${title}' does not show up in the sitemap
+  Go to  ${PLONE_URL}/sitemap
+  Wait until page contains  Powered by Plone
+  XPath Should Match X Times  //ul[@id='portal-sitemap']/li/a/span[contains(text(), '${title}')]  0  message=The sitemap should not have contained the item '${title}'
diff --git a/Products/CMFPlone/utils.py b/Products/CMFPlone/utils.py
index 5c50e34..2b27988 100644
--- a/Products/CMFPlone/utils.py
+++ b/Products/CMFPlone/utils.py
@@ -234,15 +234,15 @@ def getEmptyTitle(context, translated=True):
 
 
 def typesToList(context):
-    ntp = getToolByName(context, 'portal_properties').navtree_properties
-    ttool = getToolByName(context, 'portal_types')
-    bl = ntp.getProperty('metaTypesNotToList', ())
-    bl_dict = {}
-    for t in bl:
-        bl_dict[t] = 1
-    all_types = ttool.listContentTypes()
-    wl = [t for t in all_types if not t in bl_dict]
-    return wl
+    from zope.component import getUtility
+    from plone.registry.interfaces import IRegistry
+    from Products.CMFPlone.interfaces import INavigationSchema
+    registry = getUtility(IRegistry)
+    navigation_settings = registry.forInterface(
+        INavigationSchema,
+        prefix='plone'
+    )
+    return navigation_settings.displayed_types
 
 
 def normalizeString(text, context=None, encoding=None):


Repository: Products.CMFPlone
Branch: refs/heads/master
Date: 2015-05-04T20:54:03+02:00
Author: Timo Stollenwerk (tisto) <tisto@plone.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/4163aeb7e6ec9f847e19b38a7af6ba490f7ea619

Add issue URL.

Files changed:
M CHANGES.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index 5a3126f..a9b2567 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -9,6 +9,7 @@ Changelog
 ------------------
 
 - Make typesToList read metaTypesNotToList from new p.a.registry settings.
+  This fixes https://github.com/plone/Products.CMFPlone/issues/454.
   [timo]
 
 - style tweaks to toolbar
@@ -74,6 +75,7 @@ Changelog
 - We only support `utf-8` site-encoding at the moment
   [tomgross]
 
+
 5.0b1.post1 (2015-03-27)
 ------------------------
 


Repository: Products.CMFPlone
Branch: refs/heads/master
Date: 2015-05-04T21:06:05+02:00
Author: Timo Stollenwerk (tisto) <tisto@plone.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/e8504b995e526350d5726234053216926cdab662

Add Topic to displayed_types.

Files changed:
M CHANGES.rst
M Products/CMFPlone/interfaces/controlpanel.py
M Products/CMFPlone/tests/testPloneTool.py

diff --git a/CHANGES.rst b/CHANGES.rst
index a9b2567..afcabae 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -8,6 +8,9 @@ Changelog
 5.0b2 (unreleased)
 ------------------
 
+- Add Topic to displayed_types.
+  [timo]
+
 - Make typesToList read metaTypesNotToList from new p.a.registry settings.
   This fixes https://github.com/plone/Products.CMFPlone/issues/454.
   [timo]
diff --git a/Products/CMFPlone/interfaces/controlpanel.py b/Products/CMFPlone/interfaces/controlpanel.py
index 9d42b52..c85ffaf 100644
--- a/Products/CMFPlone/interfaces/controlpanel.py
+++ b/Products/CMFPlone/interfaces/controlpanel.py
@@ -1024,8 +1024,16 @@ class INavigationSchema(Interface):
             u"The content types that should be shown in the navigation and "
             u"site map."),
         required=False,
-        default=('Image', 'File', 'Link', 'News Item', 'Folder', 'Document',
-                 'Event'),
+        default=(
+            'Image',
+            'File',
+            'Link',
+            'News Item',
+            'Folder',
+            'Topic',
+            'Document',
+            'Event'
+        ),
         value_type=schema.Choice(
             source="plone.app.vocabularies.ReallyUserFriendlyTypes"
         ))
diff --git a/Products/CMFPlone/tests/testPloneTool.py b/Products/CMFPlone/tests/testPloneTool.py
index 08c832b..a4e5f1b 100644
--- a/Products/CMFPlone/tests/testPloneTool.py
+++ b/Products/CMFPlone/tests/testPloneTool.py
@@ -101,13 +101,17 @@ def testEditFormatMetadataOfImage(self):
         self.folder.invokeFactory('Image', id='image')
         self.folder.image.edit(file=dummy.Image('foo.zip'))
         self.assertEqual(self.folder.image.Format(), 'application/zip')
-        self.assertEqual(self.folder.image.getImage().content_type,
-                        'application/zip')
+        self.assertEqual(
+            'application/zip',
+            self.folder.image.getImage().content_type
+        )
         # Changing the format should be reflected in content_type property
         self.utils.editMetadata(self.folder.image, format='image/gif')
         self.assertEqual(self.folder.image.Format(), 'image/gif')
-        self.assertEqual(self.folder.image.getImage().content_type,
-                         'image/gif')
+        self.assertEqual(
+            'image/gif',
+            self.folder.image.getImage().content_type
+        )
 
     def testNormalizeStringPunctuation(self):
         # Punctuation and spacing is removed and replaced by '-'


Repository: Products.CMFPlone
Branch: refs/heads/master
Date: 2015-05-04T21:15:22+02:00
Author: Timo Stollenwerk (tisto) <tisto@plone.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/2395b0555bf39452e7e82bc209aa5df03af0a632

Topic shouldn't be in listed types by default.

Files changed:
M CHANGES.rst
M Products/CMFPlone/interfaces/controlpanel.py
M Products/CMFPlone/tests/testPloneTool.py

diff --git a/CHANGES.rst b/CHANGES.rst
index afcabae..a9b2567 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -8,9 +8,6 @@ Changelog
 5.0b2 (unreleased)
 ------------------
 
-- Add Topic to displayed_types.
-  [timo]
-
 - Make typesToList read metaTypesNotToList from new p.a.registry settings.
   This fixes https://github.com/plone/Products.CMFPlone/issues/454.
   [timo]
diff --git a/Products/CMFPlone/interfaces/controlpanel.py b/Products/CMFPlone/interfaces/controlpanel.py
index c85ffaf..a3bd5dd 100644
--- a/Products/CMFPlone/interfaces/controlpanel.py
+++ b/Products/CMFPlone/interfaces/controlpanel.py
@@ -1030,7 +1030,6 @@ class INavigationSchema(Interface):
             'Link',
             'News Item',
             'Folder',
-            'Topic',
             'Document',
             'Event'
         ),
diff --git a/Products/CMFPlone/tests/testPloneTool.py b/Products/CMFPlone/tests/testPloneTool.py
index a4e5f1b..311adbd 100644
--- a/Products/CMFPlone/tests/testPloneTool.py
+++ b/Products/CMFPlone/tests/testPloneTool.py
@@ -148,7 +148,7 @@ def testTypesToList(self):
         # Make sure typesToList() returns the expected types
         wl = self.utils.typesToList()
         self.assertTrue('Folder' in wl)
-        self.assertTrue('Topic' in wl)
+        self.assertTrue('Document' in wl)
         self.assertFalse('ATReferenceCriterion' in wl)
 
     def testGetUserFriendlyTypes(self):


Repository: Products.CMFPlone
Branch: refs/heads/master
Date: 2015-05-04T22:00:31+02:00
Author: Timo Stollenwerk (tisto) <tisto@plone.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/23d6833a6043ed67ec27f6ba90a5726f9b8b31c5

Move imports to the top that do not make tests fail.

Files changed:
M Products/CMFPlone/utils.py

diff --git a/Products/CMFPlone/utils.py b/Products/CMFPlone/utils.py
index 2b27988..446c5e0 100644
--- a/Products/CMFPlone/utils.py
+++ b/Products/CMFPlone/utils.py
@@ -8,11 +8,13 @@
 
 import pkg_resources
 from plone.i18n.normalizer.interfaces import IIDNormalizer
+from plone.registry.interfaces import IRegistry
 from webdav.interfaces import IWriteLock
 
 import zope.interface
 from zope.interface import implementedBy
 from zope.component import getMultiAdapter
+from zope.component import getUtility
 from zope.component import queryMultiAdapter
 from zope.component import queryUtility
 from zope.deprecation import deprecated
@@ -206,6 +208,7 @@ def getSiteEncoding(context):
            ('`getSiteEncoding` is deprecated. Plone only supports UTF-8 '
             'currently. This method always returns "utf-8"'))
 
+
 # XXX portal_utf8 and utf8_portal probably can go away
 def portal_utf8(context, str, errors='strict'):
     # Test
@@ -234,10 +237,8 @@ def getEmptyTitle(context, translated=True):
 
 
 def typesToList(context):
-    from zope.component import getUtility
-    from plone.registry.interfaces import IRegistry
-    from Products.CMFPlone.interfaces import INavigationSchema
     registry = getUtility(IRegistry)
+    from Products.CMFPlone.interfaces import INavigationSchema
     navigation_settings = registry.forInterface(
         INavigationSchema,
         prefix='plone'
@@ -745,4 +746,3 @@ def bodyfinder(text):
     if bodyend == -1:
         return text
     return text[bodystart:bodyend]
-


Repository: Products.CMFPlone
Branch: refs/heads/master
Date: 2015-05-05T09:45:12+02:00
Author: Timo Stollenwerk (tisto) <tisto@plone.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/85493ea90f72bc3dc3d38d42b5b25057df39f361

Merge pull request #485 from plone/fix-454

Make typesToList read metaTypesNotToList from new p.a.registry settings.

Files changed:
M CHANGES.rst
M Products/CMFPlone/interfaces/controlpanel.py
M Products/CMFPlone/tests/robot/test_controlpanel_navigation.robot
M Products/CMFPlone/tests/testPloneTool.py
M Products/CMFPlone/utils.py

diff --git a/CHANGES.rst b/CHANGES.rst
index ea880bf..a9b2567 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -8,6 +8,10 @@ Changelog
 5.0b2 (unreleased)
 ------------------
 
+- Make typesToList read metaTypesNotToList from new p.a.registry settings.
+  This fixes https://github.com/plone/Products.CMFPlone/issues/454.
+  [timo]
+
 - style tweaks to toolbar
   [pbauer]
 
@@ -71,6 +75,7 @@ Changelog
 - We only support `utf-8` site-encoding at the moment
   [tomgross]
 
+
 5.0b1.post1 (2015-03-27)
 ------------------------
 
diff --git a/Products/CMFPlone/interfaces/controlpanel.py b/Products/CMFPlone/interfaces/controlpanel.py
index 9d42b52..a3bd5dd 100644
--- a/Products/CMFPlone/interfaces/controlpanel.py
+++ b/Products/CMFPlone/interfaces/controlpanel.py
@@ -1024,8 +1024,15 @@ class INavigationSchema(Interface):
             u"The content types that should be shown in the navigation and "
             u"site map."),
         required=False,
-        default=('Image', 'File', 'Link', 'News Item', 'Folder', 'Document',
-                 'Event'),
+        default=(
+            'Image',
+            'File',
+            'Link',
+            'News Item',
+            'Folder',
+            'Document',
+            'Event'
+        ),
         value_type=schema.Choice(
             source="plone.app.vocabularies.ReallyUserFriendlyTypes"
         ))
diff --git a/Products/CMFPlone/tests/robot/test_controlpanel_navigation.robot b/Products/CMFPlone/tests/robot/test_controlpanel_navigation.robot
index 70b4a5a..253605f 100644
--- a/Products/CMFPlone/tests/robot/test_controlpanel_navigation.robot
+++ b/Products/CMFPlone/tests/robot/test_controlpanel_navigation.robot
@@ -33,6 +33,7 @@ Scenario: Filter Navigation By Displayed Types in the Navigation Control Panel
     and the navigation control panel
    When I remove 'Document' from the displayed types list
    Then the document 'My Document' does not show up in the navigation
+    and the document 'My Document' does not show up in the sitemap
 
 #Scenario: Filter Navigation By Workflow States in the Navigation Control Panel
 #  Given a logged-in site administrator
@@ -105,3 +106,8 @@ the document '${title}' does not show up in the navigation
   Go to  ${PLONE_URL}
   Wait until page contains  Powered by Plone
   XPath Should Match X Times  //ul[@id='portal-globalnav']/li/a[contains(text(), '${title}')]  0  message=The global navigation should not have contained the item '${title}'
+
+the document '${title}' does not show up in the sitemap
+  Go to  ${PLONE_URL}/sitemap
+  Wait until page contains  Powered by Plone
+  XPath Should Match X Times  //ul[@id='portal-sitemap']/li/a/span[contains(text(), '${title}')]  0  message=The sitemap should not have contained the item '${title}'
diff --git a/Products/CMFPlone/tests/testPloneTool.py b/Products/CMFPlone/tests/testPloneTool.py
index 08c832b..311adbd 100644
--- a/Products/CMFPlone/tests/testPloneTool.py
+++ b/Products/CMFPlone/tests/testPloneTool.py
@@ -101,13 +101,17 @@ def testEditFormatMetadataOfImage(self):
         self.folder.invokeFactory('Image', id='image')
         self.folder.image.edit(file=dummy.Image('foo.zip'))
         self.assertEqual(self.folder.image.Format(), 'application/zip')
-        self.assertEqual(self.folder.image.getImage().content_type,
-                        'application/zip')
+        self.assertEqual(
+            'application/zip',
+            self.folder.image.getImage().content_type
+        )
         # Changing the format should be reflected in content_type property
         self.utils.editMetadata(self.folder.image, format='image/gif')
         self.assertEqual(self.folder.image.Format(), 'image/gif')
-        self.assertEqual(self.folder.image.getImage().content_type,
-                         'image/gif')
+        self.assertEqual(
+            'image/gif',
+            self.folder.image.getImage().content_type
+        )
 
     def testNormalizeStringPunctuation(self):
         # Punctuation and spacing is removed and replaced by '-'
@@ -144,7 +148,7 @@ def testTypesToList(self):
         # Make sure typesToList() returns the expected types
         wl = self.utils.typesToList()
         self.assertTrue('Folder' in wl)
-        self.assertTrue('Topic' in wl)
+        self.assertTrue('Document' in wl)
         self.assertFalse('ATReferenceCriterion' in wl)
 
     def testGetUserFriendlyTypes(self):
diff --git a/Products/CMFPlone/utils.py b/Products/CMFPlone/utils.py
index 5c50e34..446c5e0 100644
--- a/Products/CMFPlone/utils.py
+++ b/Products/CMFPlone/utils.py
@@ -8,11 +8,13 @@
 
 import pkg_resources
 from plone.i18n.normalizer.interfaces import IIDNormalizer
+from plone.registry.interfaces import IRegistry
 from webdav.interfaces import IWriteLock
 
 import zope.interface
 from zope.interface import implementedBy
 from zope.component import getMultiAdapter
+from zope.component import getUtility
 from zope.component import queryMultiAdapter
 from zope.component import queryUtility
 from zope.deprecation import deprecated
@@ -206,6 +208,7 @@ def getSiteEncoding(context):
            ('`getSiteEncoding` is deprecated. Plone only supports UTF-8 '
             'currently. This method always returns "utf-8"'))
 
+
 # XXX portal_utf8 and utf8_portal probably can go away
 def portal_utf8(context, str, errors='strict'):
     # Test
@@ -234,15 +237,13 @@ def getEmptyTitle(context, translated=True):
 
 
 def typesToList(context):
-    ntp = getToolByName(context, 'portal_properties').navtree_properties
-    ttool = getToolByName(context, 'portal_types')
-    bl = ntp.getProperty('metaTypesNotToList', ())
-    bl_dict = {}
-    for t in bl:
-        bl_dict[t] = 1
-    all_types = ttool.listContentTypes()
-    wl = [t for t in all_types if not t in bl_dict]
-    return wl
+    registry = getUtility(IRegistry)
+    from Products.CMFPlone.interfaces import INavigationSchema
+    navigation_settings = registry.forInterface(
+        INavigationSchema,
+        prefix='plone'
+    )
+    return navigation_settings.displayed_types
 
 
 def normalizeString(text, context=None, encoding=None):
@@ -745,4 +746,3 @@ def bodyfinder(text):
     if bodyend == -1:
         return text
     return text[bodystart:bodyend]
-


