Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-09-22T10:03:40-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/9ada0f2a2a4177aaad87347f26d4b511c50852c8

Remove trying to install plone.protect to global site manager
  as that is now handled by plone.protect

Files changed:
M CHANGES.rst
M Products/CMFPlone/setuphandlers.py

diff --git a/CHANGES.rst b/CHANGES.rst
index d918baf..6d23a48 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -8,6 +8,10 @@ Changelog
 5.0rc4 (unreleased)
 -------------------
 
+- Remove trying to install plone.protect to global site manager
+  as that is now handled by plone.protect
+  [vangheem]
+
 - Fix traceback style (closes `#1053`_).
   [rodfersou]
 
diff --git a/Products/CMFPlone/setuphandlers.py b/Products/CMFPlone/setuphandlers.py
index 6a49752..79db103 100644
--- a/Products/CMFPlone/setuphandlers.py
+++ b/Products/CMFPlone/setuphandlers.py
@@ -1,7 +1,6 @@
-from Acquisition import aq_base, aq_parent
+from Acquisition import aq_base
 from Products.CMFCore.utils import getToolByName
 from Products.CMFPlone.factory import _DEFAULT_PROFILE
-from Products.CMFPlone.interfaces import IDateAndTimeSchema
 from Products.CMFPlone.interfaces import IMigrationTool
 from Products.CMFPlone.interfaces.resources import OVERRIDE_RESOURCE_DIRECTORY_NAME
 from Products.CMFQuickInstallerTool.interfaces import INonInstallable
@@ -9,11 +8,8 @@
     import AcceleratedHTTPCacheManager
 from Products.StandardCacheManagers.RAMCacheManager import RAMCacheManager
 from borg.localrole.utils import replace_local_role_manager
-from plone.keyring.interfaces import IKeyManager
-from plone.keyring.keymanager import KeyManager
 from plone.registry.interfaces import IRegistry
 from plone.resource.interfaces import IResourceDirectory
-from zope.component import getSiteManager
 from zope.component import getUtility
 from zope.component import queryUtility
 from zope.component.hooks import getSite
@@ -211,14 +207,6 @@ def importFinalSteps(context):
     addCacheHandlers(site)
     addCacheForResourceRegistry(site)
 
-    # check if zope root has keyring installed for CSRF protection
-    app = aq_parent(site)
-    sm = getSiteManager(app)
-
-    if sm.queryUtility(IKeyManager) is None:
-        obj = KeyManager()
-        sm.registerUtility(aq_base(obj), IKeyManager, '')
-
     first_weekday_setup(context)
     timezone_setup(context)
 


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-09-22T11:08:58-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/230d8abba54cdf4eba0b411c102998324a9763ff

do not need to test this as it is moved to plone.protect

Files changed:
M Products/CMFPlone/tests/testCSRFProtection.py

diff --git a/Products/CMFPlone/tests/testCSRFProtection.py b/Products/CMFPlone/tests/testCSRFProtection.py
index f76f8f1..759b7dc 100644
--- a/Products/CMFPlone/tests/testCSRFProtection.py
+++ b/Products/CMFPlone/tests/testCSRFProtection.py
@@ -1,4 +1,3 @@
-from Acquisition import aq_parent
 from plone.app.testing import TEST_USER_ID
 from plone.app.testing import TEST_USER_NAME
 from plone.app.testing import TEST_USER_PASSWORD
@@ -7,7 +6,6 @@
 from plone.protect.authenticator import AuthenticatorView
 from StringIO import StringIO
 from zope.component import queryUtility
-from zope.component import getSiteManager
 
 
 class AuthenticatorTestCase(PloneTestCase):
@@ -93,14 +91,3 @@ def test_userFolderDelUsers(self):
         self.checkAuthenticator(
             '/acl_users/userFolderDelUsers',
             'names:list=%s' % TEST_USER_ID)
-
-
-class KeyringTestCase(PloneTestCase):
-
-    def afterSetUp(self):
-        self.setRoles(('Manager',))
-
-    def test_zopeRootGetsKeyringInstalled(self):
-        app = aq_parent(self.portal)
-        sm = getSiteManager(app)
-        self.assertTrue(sm.queryUtility(IKeyManager) is not None)


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-09-22T11:17:34-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/3e463d766d537b4e159eee6620aac28a3d7ff4f7

disable csrf protection on robot framework keywords

Files changed:
M Products/CMFPlone/tests/robot/robot_setup.py

diff --git a/Products/CMFPlone/tests/robot/robot_setup.py b/Products/CMFPlone/tests/robot/robot_setup.py
index 3e4d2ed..f0a59ef 100644
--- a/Products/CMFPlone/tests/robot/robot_setup.py
+++ b/Products/CMFPlone/tests/robot/robot_setup.py
@@ -1,5 +1,6 @@
 # -*- coding: utf-8 -*-
 from plone.app.robotframework.remote import RemoteLibrary
+from plone.app.robotframework.utils import disableCSRFProtection
 
 from zope.component import queryUtility
 from plone.registry.interfaces import IRegistry
@@ -12,6 +13,7 @@ class CMFPloneRemoteKeywords(RemoteLibrary):
     """
 
     def the_mail_setup_configured(self):
+        disableCSRFProtection()
         registry = queryUtility(IRegistry)
         if registry is None:
             return
@@ -22,6 +24,7 @@ def the_mail_setup_configured(self):
         mail_settings.email_from_address = 'john@doe.com'
 
     def the_self_registration_enabled(self):
+        disableCSRFProtection()
         registry = queryUtility(IRegistry)
         if registry is None:
             return


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-09-22T18:27:52+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/3c78400cc44de33f9d6cf01c47e4c22c121c01b1

Merge pull request #1063 from plone/plone-protect-integration

Remove trying to install plone.protect to global site manager

Files changed:
M CHANGES.rst
M Products/CMFPlone/setuphandlers.py
M Products/CMFPlone/tests/robot/robot_setup.py
M Products/CMFPlone/tests/testCSRFProtection.py

diff --git a/CHANGES.rst b/CHANGES.rst
index d918baf..6d23a48 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -8,6 +8,10 @@ Changelog
 5.0rc4 (unreleased)
 -------------------
 
+- Remove trying to install plone.protect to global site manager
+  as that is now handled by plone.protect
+  [vangheem]
+
 - Fix traceback style (closes `#1053`_).
   [rodfersou]
 
diff --git a/Products/CMFPlone/setuphandlers.py b/Products/CMFPlone/setuphandlers.py
index 6a49752..79db103 100644
--- a/Products/CMFPlone/setuphandlers.py
+++ b/Products/CMFPlone/setuphandlers.py
@@ -1,7 +1,6 @@
-from Acquisition import aq_base, aq_parent
+from Acquisition import aq_base
 from Products.CMFCore.utils import getToolByName
 from Products.CMFPlone.factory import _DEFAULT_PROFILE
-from Products.CMFPlone.interfaces import IDateAndTimeSchema
 from Products.CMFPlone.interfaces import IMigrationTool
 from Products.CMFPlone.interfaces.resources import OVERRIDE_RESOURCE_DIRECTORY_NAME
 from Products.CMFQuickInstallerTool.interfaces import INonInstallable
@@ -9,11 +8,8 @@
     import AcceleratedHTTPCacheManager
 from Products.StandardCacheManagers.RAMCacheManager import RAMCacheManager
 from borg.localrole.utils import replace_local_role_manager
-from plone.keyring.interfaces import IKeyManager
-from plone.keyring.keymanager import KeyManager
 from plone.registry.interfaces import IRegistry
 from plone.resource.interfaces import IResourceDirectory
-from zope.component import getSiteManager
 from zope.component import getUtility
 from zope.component import queryUtility
 from zope.component.hooks import getSite
@@ -211,14 +207,6 @@ def importFinalSteps(context):
     addCacheHandlers(site)
     addCacheForResourceRegistry(site)
 
-    # check if zope root has keyring installed for CSRF protection
-    app = aq_parent(site)
-    sm = getSiteManager(app)
-
-    if sm.queryUtility(IKeyManager) is None:
-        obj = KeyManager()
-        sm.registerUtility(aq_base(obj), IKeyManager, '')
-
     first_weekday_setup(context)
     timezone_setup(context)
 
diff --git a/Products/CMFPlone/tests/robot/robot_setup.py b/Products/CMFPlone/tests/robot/robot_setup.py
index 3e4d2ed..f0a59ef 100644
--- a/Products/CMFPlone/tests/robot/robot_setup.py
+++ b/Products/CMFPlone/tests/robot/robot_setup.py
@@ -1,5 +1,6 @@
 # -*- coding: utf-8 -*-
 from plone.app.robotframework.remote import RemoteLibrary
+from plone.app.robotframework.utils import disableCSRFProtection
 
 from zope.component import queryUtility
 from plone.registry.interfaces import IRegistry
@@ -12,6 +13,7 @@ class CMFPloneRemoteKeywords(RemoteLibrary):
     """
 
     def the_mail_setup_configured(self):
+        disableCSRFProtection()
         registry = queryUtility(IRegistry)
         if registry is None:
             return
@@ -22,6 +24,7 @@ def the_mail_setup_configured(self):
         mail_settings.email_from_address = 'john@doe.com'
 
     def the_self_registration_enabled(self):
+        disableCSRFProtection()
         registry = queryUtility(IRegistry)
         if registry is None:
             return
diff --git a/Products/CMFPlone/tests/testCSRFProtection.py b/Products/CMFPlone/tests/testCSRFProtection.py
index f76f8f1..759b7dc 100644
--- a/Products/CMFPlone/tests/testCSRFProtection.py
+++ b/Products/CMFPlone/tests/testCSRFProtection.py
@@ -1,4 +1,3 @@
-from Acquisition import aq_parent
 from plone.app.testing import TEST_USER_ID
 from plone.app.testing import TEST_USER_NAME
 from plone.app.testing import TEST_USER_PASSWORD
@@ -7,7 +6,6 @@
 from plone.protect.authenticator import AuthenticatorView
 from StringIO import StringIO
 from zope.component import queryUtility
-from zope.component import getSiteManager
 
 
 class AuthenticatorTestCase(PloneTestCase):
@@ -93,14 +91,3 @@ def test_userFolderDelUsers(self):
         self.checkAuthenticator(
             '/acl_users/userFolderDelUsers',
             'names:list=%s' % TEST_USER_ID)
-
-
-class KeyringTestCase(PloneTestCase):
-
-    def afterSetUp(self):
-        self.setRoles(('Manager',))
-
-    def test_zopeRootGetsKeyringInstalled(self):
-        app = aq_parent(self.portal)
-        sm = getSiteManager(app)
-        self.assertTrue(sm.queryUtility(IKeyManager) is not None)


