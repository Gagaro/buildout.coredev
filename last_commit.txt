Repository: plone.app.content


Branch: refs/heads/master
Date: 2015-08-23T17:20:51+02:00
Author: Ramon Navarro Bosch (bloodbare) <ramon.nb@gmail.com>
Commit: https://github.com/plone/plone.app.content/commit/0b7e40ca468df448eee4749bf8f9ca146f31463b

Adding an extension to add more information on delete confirmation messages

Files changed:
M plone/app/content/browser/actions.py
M plone/app/content/browser/templates/delete_confirmation.pt

diff --git a/plone/app/content/browser/actions.py b/plone/app/content/browser/actions.py
index 90b7fa1..2ce40be 100644
--- a/plone/app/content/browser/actions.py
+++ b/plone/app/content/browser/actions.py
@@ -50,6 +50,13 @@ def view_url(self):
         )
         return context_state.view_url()
 
+    def more_info(self):
+        adapter = queryMultiAdapter(
+            (self.context, self.request), name='delete_confirmation_info')
+        if adapter:
+            return adapter()
+        return ""
+
     @property
     def items_to_delete(self):
         catalog = getToolByName(self.context, 'portal_catalog')
diff --git a/plone/app/content/browser/templates/delete_confirmation.pt b/plone/app/content/browser/templates/delete_confirmation.pt
index 3fb2a56..f9348d6 100644
--- a/plone/app/content/browser/templates/delete_confirmation.pt
+++ b/plone/app/content/browser/templates/delete_confirmation.pt
@@ -40,6 +40,9 @@
         </tal:block>
 
         <div id="content-core">
+            <tal:block replace="structure view/more_info">
+            </tal:block>
+
             <ul>
                 <li tal:content="context/@@plone_context_state/object_title">The item title (ID)</li>
             </ul>


Repository: plone.app.content


Branch: refs/heads/master
Date: 2015-08-23T17:20:51+02:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.app.content/commit/6e985ec4258de51dc4c34b652b113013176429df

do link integrity before deleting

Files changed:
M plone/app/content/browser/contents/delete.py

diff --git a/plone/app/content/browser/contents/delete.py b/plone/app/content/browser/contents/delete.py
index cc9740d..4e844f7 100644
--- a/plone/app/content/browser/contents/delete.py
+++ b/plone/app/content/browser/contents/delete.py
@@ -1,12 +1,16 @@
 # -*- coding: utf-8 -*-
 from AccessControl import Unauthorized
 from AccessControl.Permissions import delete_objects
-from plone.app.content.browser.contents import ContentsBaseAction
-from plone.app.content.interfaces import IStructureAction
+from Products.CMFCore.utils import getToolByName
 from Products.CMFPlone import PloneMessageFactory as _
 from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile
+from plone.app.content.browser.contents import ContentsBaseAction
+from plone.app.content.interfaces import IStructureAction
+from zope.component import getMultiAdapter
+from zope.component.hooks import getSite
 from zope.i18n import translate
 from zope.interface import implementer
+import json
 
 
 @implementer(IStructureAction)
@@ -31,7 +35,8 @@ def get_options(self):
                 'submitText': _('Yes'),
                 'submitContext': 'danger',
                 'template': self.template(),
-                'closeText': _('No')
+                'closeText': _('No'),
+                'dataUrl': self.context.absolute_url() + '/@@fc-delete'
             }
         }
 
@@ -41,6 +46,24 @@ class DeleteActionView(ContentsBaseAction):
     success_msg = _('Successfully delete items')
     failure_msg = _('Failed to delete items')
 
+    def __call__(self):
+        if self.request.form.get('render') == 'yes':
+            confirm_view = getMultiAdapter((getSite(), self.request),
+                                           name='delete_confirmation_info')
+            selection = self.get_selection()
+            catalog = getToolByName(self.context, 'portal_catalog')
+            brains = catalog(UID=selection)
+            for brain in brains:
+                obj = brain.getObject()
+                confirm_view.checkObject(obj)
+            self.request.response.setHeader('Content-Type', 'application/json')
+            return json.dumps({
+                'success': True,
+                'html': confirm_view(True)
+            })
+        else:
+            return super(DeleteActionView, self).__call__()
+
     def action(self, obj):
         parent = obj.aq_inner.aq_parent
         title = self.objectTitle(obj)


Repository: plone.app.content


Branch: refs/heads/master
Date: 2015-08-23T17:20:51+02:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.app.content/commit/86efa8fae169d7cf4f6be5d5588dc827eaad563e

remove sucess attr

Files changed:
M plone/app/content/browser/contents/delete.py

diff --git a/plone/app/content/browser/contents/delete.py b/plone/app/content/browser/contents/delete.py
index 4e844f7..d076f9d 100644
--- a/plone/app/content/browser/contents/delete.py
+++ b/plone/app/content/browser/contents/delete.py
@@ -58,7 +58,6 @@ def __call__(self):
                 confirm_view.checkObject(obj)
             self.request.response.setHeader('Content-Type', 'application/json')
             return json.dumps({
-                'success': True,
                 'html': confirm_view(True)
             })
         else:


Repository: plone.app.content


Branch: refs/heads/master
Date: 2015-08-23T17:20:51+02:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.app.content/commit/f35c654fac6dfb6ff6fc280ade4a91b0fee30363

render html rendered in render view here

Files changed:
M plone/app/content/browser/contents/templates/delete.pt

diff --git a/plone/app/content/browser/contents/templates/delete.pt b/plone/app/content/browser/contents/templates/delete.pt
index 7a241f7..72de33f 100644
--- a/plone/app/content/browser/contents/templates/delete.pt
+++ b/plone/app/content/browser/contents/templates/delete.pt
@@ -1,3 +1,6 @@
 <div i18n:domain="plone">
+  <% if(typeof(html) !== undefined){
+    <%= html %>
+  } %>
   <label i18n:translate="confirm_delete_items">Are you certain you want to delete the selected items?</label>
 </div>
\ No newline at end of file


Repository: plone.app.content


Branch: refs/heads/master
Date: 2015-08-23T17:20:51+02:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.app.content/commit/f7eec540b16910b34aa2b9f0d5f4fc7eab63d843

handle rendering dynamic html, need try catch because undefined error is hard to check for

Files changed:
M plone/app/content/browser/contents/templates/delete.pt

diff --git a/plone/app/content/browser/contents/templates/delete.pt b/plone/app/content/browser/contents/templates/delete.pt
index 72de33f..a864dc7 100644
--- a/plone/app/content/browser/contents/templates/delete.pt
+++ b/plone/app/content/browser/contents/templates/delete.pt
@@ -1,6 +1,6 @@
 <div i18n:domain="plone">
-  <% if(typeof(html) !== undefined){
+  <% try{ %>
     <%= html %>
-  } %>
+  <% }catch(e){} %>
   <label i18n:translate="confirm_delete_items">Are you certain you want to delete the selected items?</label>
 </div>
\ No newline at end of file


Repository: plone.app.content


Branch: refs/heads/master
Date: 2015-08-23T17:20:52+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.content/commit/87616a190fca53543d8928b94339cb3a00bcaf72

adapt to changes in delete_confirmation_info

Files changed:
M plone/app/content/browser/contents/delete.py

diff --git a/plone/app/content/browser/contents/delete.py b/plone/app/content/browser/contents/delete.py
index d076f9d..c8895e9 100644
--- a/plone/app/content/browser/contents/delete.py
+++ b/plone/app/content/browser/contents/delete.py
@@ -53,12 +53,10 @@ def __call__(self):
             selection = self.get_selection()
             catalog = getToolByName(self.context, 'portal_catalog')
             brains = catalog(UID=selection)
-            for brain in brains:
-                obj = brain.getObject()
-                confirm_view.checkObject(obj)
+            items = [i.getObject() for i in brains]
             self.request.response.setHeader('Content-Type', 'application/json')
             return json.dumps({
-                'html': confirm_view(True)
+                'html': confirm_view(items)
             })
         else:
             return super(DeleteActionView, self).__call__()


Repository: plone.app.content


Branch: refs/heads/master
Date: 2015-08-23T17:20:52+02:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.app.content/commit/7cee7c43694e45c230fa6d440747b9ba616635af

return html from delete action by checking value on data first

Files changed:
M plone/app/content/browser/contents/templates/delete.pt

diff --git a/plone/app/content/browser/contents/templates/delete.pt b/plone/app/content/browser/contents/templates/delete.pt
index a864dc7..9a36819 100644
--- a/plone/app/content/browser/contents/templates/delete.pt
+++ b/plone/app/content/browser/contents/templates/delete.pt
@@ -1,6 +1,6 @@
 <div i18n:domain="plone">
   <% try{ %>
-    <%= html %>
+    <%= data.html || '' %>
   <% }catch(e){} %>
   <label i18n:translate="confirm_delete_items">Are you certain you want to delete the selected items?</label>
 </div>
\ No newline at end of file


Repository: plone.app.content


Branch: refs/heads/master
Date: 2015-08-24T13:40:34-05:00
Author: Nathan Van Gheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.app.content/commit/6a28d4ae2790a70a35462d65e0cf67f54d6b7c90

Merge pull request #51 from plone/linkintegrity

Linkintegrity

Files changed:
M plone/app/content/browser/actions.py
M plone/app/content/browser/contents/delete.py
M plone/app/content/browser/contents/templates/delete.pt
M plone/app/content/browser/templates/delete_confirmation.pt

diff --git a/plone/app/content/browser/actions.py b/plone/app/content/browser/actions.py
index 90b7fa1..2ce40be 100644
--- a/plone/app/content/browser/actions.py
+++ b/plone/app/content/browser/actions.py
@@ -50,6 +50,13 @@ def view_url(self):
         )
         return context_state.view_url()
 
+    def more_info(self):
+        adapter = queryMultiAdapter(
+            (self.context, self.request), name='delete_confirmation_info')
+        if adapter:
+            return adapter()
+        return ""
+
     @property
     def items_to_delete(self):
         catalog = getToolByName(self.context, 'portal_catalog')
diff --git a/plone/app/content/browser/contents/delete.py b/plone/app/content/browser/contents/delete.py
index cc9740d..c8895e9 100644
--- a/plone/app/content/browser/contents/delete.py
+++ b/plone/app/content/browser/contents/delete.py
@@ -1,12 +1,16 @@
 # -*- coding: utf-8 -*-
 from AccessControl import Unauthorized
 from AccessControl.Permissions import delete_objects
-from plone.app.content.browser.contents import ContentsBaseAction
-from plone.app.content.interfaces import IStructureAction
+from Products.CMFCore.utils import getToolByName
 from Products.CMFPlone import PloneMessageFactory as _
 from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile
+from plone.app.content.browser.contents import ContentsBaseAction
+from plone.app.content.interfaces import IStructureAction
+from zope.component import getMultiAdapter
+from zope.component.hooks import getSite
 from zope.i18n import translate
 from zope.interface import implementer
+import json
 
 
 @implementer(IStructureAction)
@@ -31,7 +35,8 @@ def get_options(self):
                 'submitText': _('Yes'),
                 'submitContext': 'danger',
                 'template': self.template(),
-                'closeText': _('No')
+                'closeText': _('No'),
+                'dataUrl': self.context.absolute_url() + '/@@fc-delete'
             }
         }
 
@@ -41,6 +46,21 @@ class DeleteActionView(ContentsBaseAction):
     success_msg = _('Successfully delete items')
     failure_msg = _('Failed to delete items')
 
+    def __call__(self):
+        if self.request.form.get('render') == 'yes':
+            confirm_view = getMultiAdapter((getSite(), self.request),
+                                           name='delete_confirmation_info')
+            selection = self.get_selection()
+            catalog = getToolByName(self.context, 'portal_catalog')
+            brains = catalog(UID=selection)
+            items = [i.getObject() for i in brains]
+            self.request.response.setHeader('Content-Type', 'application/json')
+            return json.dumps({
+                'html': confirm_view(items)
+            })
+        else:
+            return super(DeleteActionView, self).__call__()
+
     def action(self, obj):
         parent = obj.aq_inner.aq_parent
         title = self.objectTitle(obj)
diff --git a/plone/app/content/browser/contents/templates/delete.pt b/plone/app/content/browser/contents/templates/delete.pt
index 7a241f7..9a36819 100644
--- a/plone/app/content/browser/contents/templates/delete.pt
+++ b/plone/app/content/browser/contents/templates/delete.pt
@@ -1,3 +1,6 @@
 <div i18n:domain="plone">
+  <% try{ %>
+    <%= data.html || '' %>
+  <% }catch(e){} %>
   <label i18n:translate="confirm_delete_items">Are you certain you want to delete the selected items?</label>
 </div>
\ No newline at end of file
diff --git a/plone/app/content/browser/templates/delete_confirmation.pt b/plone/app/content/browser/templates/delete_confirmation.pt
index 3fb2a56..f9348d6 100644
--- a/plone/app/content/browser/templates/delete_confirmation.pt
+++ b/plone/app/content/browser/templates/delete_confirmation.pt
@@ -40,6 +40,9 @@
         </tal:block>
 
         <div id="content-core">
+            <tal:block replace="structure view/more_info">
+            </tal:block>
+
             <ul>
                 <li tal:content="context/@@plone_context_state/object_title">The item title (ID)</li>
             </ul>


