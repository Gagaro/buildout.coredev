Repository: mockup


Branch: refs/heads/master
Date: 2015-06-29T22:25:07-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/mockup/commit/88fc6ffd7b373c0b7054756128d6934d26a47efa

correctly set href and id for autotoc pattern

Files changed:
M CHANGES.rst
M mockup/patterns/autotoc/pattern.js
M mockup/patterns/tinymce/templates/image.xml
M mockup/patterns/tinymce/templates/link.xml
M mockup/tests/pattern-autotoc-test.js

diff --git a/CHANGES.rst b/CHANGES.rst
index b6b6362..7b63e2c 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,10 @@ Changelog
 2.0.5 (unreleased)
 ------------------
 
-- fix title not being set on images
+- correctly set href and id for autotoc pattern
+  [vangheem]
+
+- fix title not being set on images in tinymce
   [vangheem]
 
 - Improve the upload pattern so it shows useful messages in case of errors
diff --git a/mockup/patterns/autotoc/pattern.js b/mockup/patterns/autotoc/pattern.js
index a59851c..a3f4070 100644
--- a/mockup/patterns/autotoc/pattern.js
+++ b/mockup/patterns/autotoc/pattern.js
@@ -112,16 +112,16 @@ define([
 
       $(self.options.levels, self.$el).each(function(i) {
         var $level = $(this),
-            id = $level.prop('id') ? '#' + $level.prop('id') :
+            id = $level.prop('id') ? $level.prop('id') :
                  $level.parents(self.options.section).prop('id');
         if (!id) {
           id = self.options.IDPrefix + self.name + '-' + i;
-          $level.prop('id', id);
         }
         $('<a/>')
           .appendTo(self.$toc)
           .text($level.text())
-          .prop('href', id)
+          .attr('id', id)
+          .attr('href', '#' + id)
           .addClass(self.options.classLevelPrefixName + self.getLevel($level))
           .on('click', function(e, doScroll) {
             e.stopPropagation();
diff --git a/mockup/patterns/tinymce/templates/image.xml b/mockup/patterns/tinymce/templates/image.xml
index dbe390f..a78a0c4 100644
--- a/mockup/patterns/tinymce/templates/image.xml
+++ b/mockup/patterns/tinymce/templates/image.xml
@@ -6,7 +6,7 @@
     <% } %>
 
     <div class="linkTypes pat-autotoc autotabs"
-         data-pat-autotoc="section:fieldset;levels:legend;">
+         data-pat-autotoc="section:fieldset;levels:legend;IDPrefix:tinymce-autotoc-">
 
         <% if(_.contains(linkTypes, 'image')){ %>
       <fieldset class="linkType image" data-linkType="image">
diff --git a/mockup/patterns/tinymce/templates/link.xml b/mockup/patterns/tinymce/templates/link.xml
index f93d408..a12aadf 100644
--- a/mockup/patterns/tinymce/templates/link.xml
+++ b/mockup/patterns/tinymce/templates/link.xml
@@ -6,7 +6,7 @@
     <% } %>
 
     <div class="linkTypes pat-autotoc autotabs"
-         data-pat-autotoc="section:fieldset;levels:legend;">
+         data-pat-autotoc="section:fieldset;levels:legend;IDPrefix:tinymce-autotoc-">
 
       <fieldset class="linkType internal" data-linkType="internal">
         <legend>Internal</legend>
diff --git a/mockup/tests/pattern-autotoc-test.js b/mockup/tests/pattern-autotoc-test.js
index b52b077..3d6bdcf 100644
--- a/mockup/tests/pattern-autotoc-test.js
+++ b/mockup/tests/pattern-autotoc-test.js
@@ -47,6 +47,11 @@ define([
       expect($('> nav > a.autotoc-level-3', this.$el).size()).to.equal(1);
       expect($('> nav > a.autotoc-level-4', this.$el).size()).to.equal(0);
     });
+    it('sets href and id', function() {
+      Registry.scan(this.$el);
+      expect($('> nav > a:first', this.$el).attr('id')).to.equal('autotoc-item-autotoc-0');
+      expect($('> nav > a:first', this.$el).attr('href')).to.equal('#autotoc-item-autotoc-0');
+    });
     it('can be used as jQuery plugin as well', function () {
       expect($('> nav', this.$el).size()).to.equal(0);
       this.$el.patternAutotoc();


