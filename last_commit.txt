Repository: plone.app.querystring


Branch: refs/heads/master
Date: 2015-08-21T12:30:20-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.app.querystring/commit/3548e08621a5a8fe46d7588c5427008f84cccfc1

add user vocabulary to plone.app.querystring.field.Creator

Files changed:
M plone/app/querystring/profiles/default/registry.xml

diff --git a/plone/app/querystring/profiles/default/registry.xml b/plone/app/querystring/profiles/default/registry.xml
index 4e4f744..ee16aaf 100644
--- a/plone/app/querystring/profiles/default/registry.xml
+++ b/plone/app/querystring/profiles/default/registry.xml
@@ -283,6 +283,7 @@
             <element>plone.app.querystring.operation.selection.any</element>
             <element>plone.app.querystring.operation.string.currentUser</element>
         </value>
+        <value key="vocabulary">plone.app.vocabularies.Users</value>
        <value key="group" i18n:translate="">Metadata</value>
     </records>
 


Repository: plone.app.querystring


Branch: refs/heads/master
Date: 2015-08-21T12:30:20-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.app.querystring/commit/41613f6da7702ad0191c06546548000b2f9fc346

do not need "is" when there is an "any" operator

Files changed:
M plone/app/querystring/profiles/default/registry.xml

diff --git a/plone/app/querystring/profiles/default/registry.xml b/plone/app/querystring/profiles/default/registry.xml
index ee16aaf..bbfc800 100644
--- a/plone/app/querystring/profiles/default/registry.xml
+++ b/plone/app/querystring/profiles/default/registry.xml
@@ -279,7 +279,6 @@
         <value key="enabled">True</value>
         <value key="sortable">True</value>
         <value key="operations">
-            <element>plone.app.querystring.operation.string.is</element>
             <element>plone.app.querystring.operation.selection.any</element>
             <element>plone.app.querystring.operation.string.currentUser</element>
         </value>


Repository: plone.app.querystring


Branch: refs/heads/master
Date: 2015-08-21T12:30:20-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.app.querystring/commit/f7abcaa4846f7aa0b932a71dacb881a852a6dca2

add upgrade

Files changed:
A plone/app/querystring/profiles/upgrades/to_10/registry.xml
M plone/app/querystring/profiles.zcml
M plone/app/querystring/upgrades.py
M plone/app/querystring/upgrades.zcml

diff --git a/plone/app/querystring/profiles.zcml b/plone/app/querystring/profiles.zcml
index be2354a..d93075d 100644
--- a/plone/app/querystring/profiles.zcml
+++ b/plone/app/querystring/profiles.zcml
@@ -65,4 +65,12 @@
         provides="Products.GenericSetup.interfaces.EXTENSION"
         />
 
+    <genericsetup:registerProfile
+        name="upgrade_to_10"
+        title="Querystring Upgrade profile to v10"
+        description=""
+        directory="profiles/upgrades/to_10"
+        provides="Products.GenericSetup.interfaces.EXTENSION"
+        />
+
  </configure>
diff --git a/plone/app/querystring/profiles/upgrades/to_10/registry.xml b/plone/app/querystring/profiles/upgrades/to_10/registry.xml
new file mode 100644
index 0000000..99c882a
--- /dev/null
+++ b/plone/app/querystring/profiles/upgrades/to_10/registry.xml
@@ -0,0 +1,13 @@
+<registry xmlns:i18n="http://xml.zope.org/namespaces/i18n"
+          i18n:domain="plone">
+
+    <records interface="plone.app.querystring.interfaces.IQueryField"
+             prefix="plone.app.querystring.field.Creator">
+        <value key="operations">
+            <element>plone.app.querystring.operation.selection.any</element>
+            <element>plone.app.querystring.operation.string.currentUser</element>
+        </value>
+        <value key="vocabulary">plone.app.vocabularies.Users</value>
+    </records>
+
+</registry>
\ No newline at end of file
diff --git a/plone/app/querystring/upgrades.py b/plone/app/querystring/upgrades.py
index 0fcd2aa..125e0ab 100644
--- a/plone/app/querystring/upgrades.py
+++ b/plone/app/querystring/upgrades.py
@@ -22,7 +22,8 @@ def fix_select_all_existing_collections(context):
 
     indexes_to_fix = [
         u'portal_type',
-        u'review_state'
+        u'review_state',
+        u'Creator'
     ]
     old_operator = u"plone.app.querystring.operation.selection.is"
     new_operator = u"plone.app.querystring.operation.selection.any"
diff --git a/plone/app/querystring/upgrades.zcml b/plone/app/querystring/upgrades.zcml
index 9c87283..ff97324 100644
--- a/plone/app/querystring/upgrades.zcml
+++ b/plone/app/querystring/upgrades.zcml
@@ -87,4 +87,19 @@
 
   </genericsetup:upgradeSteps>
 
+  <genericsetup:upgradeSteps
+      source="9"
+      destination="10"
+      profile="plone.app.querystring:default">
+    <genericsetup:upgradeDepends
+        title="Update Creator"
+        description="Add users vocabulary and remove 'is' operator from plone.app.querystring.field.Creator"
+        import_profile="plone.app.querystring:upgrade_to_10"
+        />
+    <upgradeStep
+        title="Fix existing collections"
+        handler=".upgrades.fix_select_all_existing_collections"
+        />
+  </genericsetup:upgradeSteps>
+
 </configure>


Repository: plone.app.querystring


Branch: refs/heads/master
Date: 2015-08-21T21:42:19+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.querystring/commit/eef2ac063ddc0a1ba91245615ca302edbc8b419a

Migrate Creator string.is to selection.any.

We were migrating from selection.is, but that we never there for Creators.

Files changed:
M plone/app/querystring/upgrades.py

diff --git a/plone/app/querystring/upgrades.py b/plone/app/querystring/upgrades.py
index 125e0ab..8581806 100644
--- a/plone/app/querystring/upgrades.py
+++ b/plone/app/querystring/upgrades.py
@@ -25,9 +25,13 @@ def fix_select_all_existing_collections(context):
         u'review_state',
         u'Creator'
     ]
-    old_operator = u"plone.app.querystring.operation.selection.is"
-    new_operator = u"plone.app.querystring.operation.selection.any"
-
+    operator_mapping = {
+        # old -> new
+        u"plone.app.querystring.operation.selection.is":
+            u"plone.app.querystring.operation.selection.any",
+        u"plone.app.querystring.operation.string.is":
+            u"plone.app.querystring.operation.selection.any",
+    }
     catalog = context.portal_catalog
     brains = catalog.unrestrictedSearchResults(
         portal_type="Collection"
@@ -38,10 +42,11 @@ def fix_select_all_existing_collections(context):
         obj = brain.getObject()
         fixed_querystring = list()
         for querystring in obj.query:
-            if querystring['i'] in indexes_to_fix \
-                    and querystring['o'] == old_operator:
-                querystring['o'] = new_operator
-                changed = True
+            if querystring['i'] in indexes_to_fix:
+                for old_operator, new_operator in operator_mapping.items():
+                    if querystring['o'] == old_operator:
+                        querystring['o'] = new_operator
+                        changed = True
             fixed_querystring.append(querystring)
 
         if changed:


Repository: plone.app.querystring


Branch: refs/heads/master
Date: 2015-08-21T21:43:24+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.querystring/commit/90fa6b166fbbf0ea946c6d1c6d4b32773d7ad2d8

Update metadata.xml to version 10.

Files changed:
M plone/app/querystring/profiles/default/metadata.xml

diff --git a/plone/app/querystring/profiles/default/metadata.xml b/plone/app/querystring/profiles/default/metadata.xml
index dd8af24..ecb0990 100644
--- a/plone/app/querystring/profiles/default/metadata.xml
+++ b/plone/app/querystring/profiles/default/metadata.xml
@@ -1,6 +1,6 @@
 <?xml version="1.0"?>
 <metadata>
-  <version>9</version>
+  <version>10</version>
   <dependencies>
       <dependency>profile-plone.app.registry:default</dependency>
   </dependencies>


Repository: plone.app.querystring


Branch: refs/heads/master
Date: 2015-08-21T22:44:48+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.querystring/commit/244ef1057b7eac87a30078e269c73638c290fe9d

Creator criteria: pur currentUser on top.

Otherwise the Any user selection is first,
and when you switch to currentUser and try to save it,
you get a 'wrong contained type' error.

Unfortunately, the same now happens when you select Any and then
switch back to currentUser.

Files changed:
M plone/app/querystring/profiles/default/registry.xml
M plone/app/querystring/profiles/upgrades/to_10/registry.xml

diff --git a/plone/app/querystring/profiles/default/registry.xml b/plone/app/querystring/profiles/default/registry.xml
index bbfc800..d125372 100644
--- a/plone/app/querystring/profiles/default/registry.xml
+++ b/plone/app/querystring/profiles/default/registry.xml
@@ -279,8 +279,8 @@
         <value key="enabled">True</value>
         <value key="sortable">True</value>
         <value key="operations">
-            <element>plone.app.querystring.operation.selection.any</element>
             <element>plone.app.querystring.operation.string.currentUser</element>
+            <element>plone.app.querystring.operation.selection.any</element>
         </value>
         <value key="vocabulary">plone.app.vocabularies.Users</value>
        <value key="group" i18n:translate="">Metadata</value>
diff --git a/plone/app/querystring/profiles/upgrades/to_10/registry.xml b/plone/app/querystring/profiles/upgrades/to_10/registry.xml
index 99c882a..f4e40e6 100644
--- a/plone/app/querystring/profiles/upgrades/to_10/registry.xml
+++ b/plone/app/querystring/profiles/upgrades/to_10/registry.xml
@@ -4,8 +4,8 @@
     <records interface="plone.app.querystring.interfaces.IQueryField"
              prefix="plone.app.querystring.field.Creator">
         <value key="operations">
-            <element>plone.app.querystring.operation.selection.any</element>
             <element>plone.app.querystring.operation.string.currentUser</element>
+            <element>plone.app.querystring.operation.selection.any</element>
         </value>
         <value key="vocabulary">plone.app.vocabularies.Users</value>
     </records>


Repository: plone.app.querystring


Branch: refs/heads/master
Date: 2015-08-22T00:22:44+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.querystring/commit/338b50ed3cec22670303a02a3d0b06589907f767

Merge pull request #40 from plone/add-user-vocabulary

Add user vocabulary

Files changed:
A plone/app/querystring/profiles/upgrades/to_10/registry.xml
M plone/app/querystring/profiles.zcml
M plone/app/querystring/profiles/default/metadata.xml
M plone/app/querystring/profiles/default/registry.xml
M plone/app/querystring/upgrades.py
M plone/app/querystring/upgrades.zcml

diff --git a/plone/app/querystring/profiles.zcml b/plone/app/querystring/profiles.zcml
index be2354a..d93075d 100644
--- a/plone/app/querystring/profiles.zcml
+++ b/plone/app/querystring/profiles.zcml
@@ -65,4 +65,12 @@
         provides="Products.GenericSetup.interfaces.EXTENSION"
         />
 
+    <genericsetup:registerProfile
+        name="upgrade_to_10"
+        title="Querystring Upgrade profile to v10"
+        description=""
+        directory="profiles/upgrades/to_10"
+        provides="Products.GenericSetup.interfaces.EXTENSION"
+        />
+
  </configure>
diff --git a/plone/app/querystring/profiles/default/metadata.xml b/plone/app/querystring/profiles/default/metadata.xml
index dd8af24..ecb0990 100644
--- a/plone/app/querystring/profiles/default/metadata.xml
+++ b/plone/app/querystring/profiles/default/metadata.xml
@@ -1,6 +1,6 @@
 <?xml version="1.0"?>
 <metadata>
-  <version>9</version>
+  <version>10</version>
   <dependencies>
       <dependency>profile-plone.app.registry:default</dependency>
   </dependencies>
diff --git a/plone/app/querystring/profiles/default/registry.xml b/plone/app/querystring/profiles/default/registry.xml
index 4e4f744..d125372 100644
--- a/plone/app/querystring/profiles/default/registry.xml
+++ b/plone/app/querystring/profiles/default/registry.xml
@@ -279,10 +279,10 @@
         <value key="enabled">True</value>
         <value key="sortable">True</value>
         <value key="operations">
-            <element>plone.app.querystring.operation.string.is</element>
-            <element>plone.app.querystring.operation.selection.any</element>
             <element>plone.app.querystring.operation.string.currentUser</element>
+            <element>plone.app.querystring.operation.selection.any</element>
         </value>
+        <value key="vocabulary">plone.app.vocabularies.Users</value>
        <value key="group" i18n:translate="">Metadata</value>
     </records>
 
diff --git a/plone/app/querystring/profiles/upgrades/to_10/registry.xml b/plone/app/querystring/profiles/upgrades/to_10/registry.xml
new file mode 100644
index 0000000..f4e40e6
--- /dev/null
+++ b/plone/app/querystring/profiles/upgrades/to_10/registry.xml
@@ -0,0 +1,13 @@
+<registry xmlns:i18n="http://xml.zope.org/namespaces/i18n"
+          i18n:domain="plone">
+
+    <records interface="plone.app.querystring.interfaces.IQueryField"
+             prefix="plone.app.querystring.field.Creator">
+        <value key="operations">
+            <element>plone.app.querystring.operation.string.currentUser</element>
+            <element>plone.app.querystring.operation.selection.any</element>
+        </value>
+        <value key="vocabulary">plone.app.vocabularies.Users</value>
+    </records>
+
+</registry>
\ No newline at end of file
diff --git a/plone/app/querystring/upgrades.py b/plone/app/querystring/upgrades.py
index 0fcd2aa..8581806 100644
--- a/plone/app/querystring/upgrades.py
+++ b/plone/app/querystring/upgrades.py
@@ -22,11 +22,16 @@ def fix_select_all_existing_collections(context):
 
     indexes_to_fix = [
         u'portal_type',
-        u'review_state'
+        u'review_state',
+        u'Creator'
     ]
-    old_operator = u"plone.app.querystring.operation.selection.is"
-    new_operator = u"plone.app.querystring.operation.selection.any"
-
+    operator_mapping = {
+        # old -> new
+        u"plone.app.querystring.operation.selection.is":
+            u"plone.app.querystring.operation.selection.any",
+        u"plone.app.querystring.operation.string.is":
+            u"plone.app.querystring.operation.selection.any",
+    }
     catalog = context.portal_catalog
     brains = catalog.unrestrictedSearchResults(
         portal_type="Collection"
@@ -37,10 +42,11 @@ def fix_select_all_existing_collections(context):
         obj = brain.getObject()
         fixed_querystring = list()
         for querystring in obj.query:
-            if querystring['i'] in indexes_to_fix \
-                    and querystring['o'] == old_operator:
-                querystring['o'] = new_operator
-                changed = True
+            if querystring['i'] in indexes_to_fix:
+                for old_operator, new_operator in operator_mapping.items():
+                    if querystring['o'] == old_operator:
+                        querystring['o'] = new_operator
+                        changed = True
             fixed_querystring.append(querystring)
 
         if changed:
diff --git a/plone/app/querystring/upgrades.zcml b/plone/app/querystring/upgrades.zcml
index 9c87283..ff97324 100644
--- a/plone/app/querystring/upgrades.zcml
+++ b/plone/app/querystring/upgrades.zcml
@@ -87,4 +87,19 @@
 
   </genericsetup:upgradeSteps>
 
+  <genericsetup:upgradeSteps
+      source="9"
+      destination="10"
+      profile="plone.app.querystring:default">
+    <genericsetup:upgradeDepends
+        title="Update Creator"
+        description="Add users vocabulary and remove 'is' operator from plone.app.querystring.field.Creator"
+        import_profile="plone.app.querystring:upgrade_to_10"
+        />
+    <upgradeStep
+        title="Fix existing collections"
+        handler=".upgrades.fix_select_all_existing_collections"
+        />
+  </genericsetup:upgradeSteps>
+
 </configure>


