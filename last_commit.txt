Repository: plone.app.theming
Branch: refs/heads/master
Date: 2015-03-21T23:58:58+01:00
Author: Johannes Raggam (thet) <raggam-nl@adm.at>
Commit: https://github.com/plone/plone.app.theming/commit/7f0932da539f570d470c4968e59934324cdbc98f

Change deprecated import of zope.site.hooks.getSite to zope.component.hooks.getSite.

Files changed:
M docs/HISTORY.rst
M src/plone/app/theming/browser/mapper.py
M src/plone/app/theming/transform.py

diff --git a/docs/HISTORY.rst b/docs/HISTORY.rst
index 6aa7435..d268593 100644
--- a/docs/HISTORY.rst
+++ b/docs/HISTORY.rst
@@ -4,6 +4,10 @@ Changelog
 1.3.0 (unreleased)
 ------------------
 
+- Change deprecated import of ``zope.site.hooks.getSite`` to
+  ``zope.component.hooks.getSite``.
+  [thet]
+
 - Add an error log if the subrequest failed (probably a relative xi:include)
   instead of silently returning None (and so having a xi:include returning
   nothing).
diff --git a/src/plone/app/theming/browser/mapper.py b/src/plone/app/theming/browser/mapper.py
index 78b4db4..8793671 100644
--- a/src/plone/app/theming/browser/mapper.py
+++ b/src/plone/app/theming/browser/mapper.py
@@ -11,7 +11,7 @@
 from zope.component import getMultiAdapter
 from zope.component import getUtility
 
-from zope.site.hooks import getSite
+from zope.component.hooks import getSite
 from zope.publisher.browser import BrowserView
 
 from repoze.xmliter.utils import getHTMLSerializer
diff --git a/src/plone/app/theming/transform.py b/src/plone/app/theming/transform.py
index bf5b933..0073705 100644
--- a/src/plone/app/theming/transform.py
+++ b/src/plone/app/theming/transform.py
@@ -8,7 +8,7 @@
 from zope.interface import implements, Interface
 from zope.component import adapts
 from zope.component import queryUtility
-from zope.site.hooks import getSite
+from zope.component.hooks import getSite
 
 from plone.registry.interfaces import IRegistry
 from plone.transformchain.interfaces import ITransform


Repository: plone.app.theming
Branch: refs/heads/master
Date: 2015-03-22T00:56:42+01:00
Author: Johannes Raggam (thet) <raggam-nl@adm.at>
Commit: https://github.com/plone/plone.app.theming/commit/8b74fd430443e34111727ff00222688334dd754b

Patch the ZMI only for available ZMI pages.

Files changed:
M docs/HISTORY.rst
M src/plone/app/theming/zmi.py

diff --git a/docs/HISTORY.rst b/docs/HISTORY.rst
index d268593..ffe6c22 100644
--- a/docs/HISTORY.rst
+++ b/docs/HISTORY.rst
@@ -4,6 +4,9 @@ Changelog
 1.3.0 (unreleased)
 ------------------
 
+- Patch the ZMI only for available ZMI pages.
+  [thet]
+
 - Change deprecated import of ``zope.site.hooks.getSite`` to
   ``zope.component.hooks.getSite``.
   [thet]
diff --git a/src/plone/app/theming/zmi.py b/src/plone/app/theming/zmi.py
index e5a79a3..4d768a9 100644
--- a/src/plone/app/theming/zmi.py
+++ b/src/plone/app/theming/zmi.py
@@ -35,11 +35,13 @@ def wrapped(self, *args, **kw):
 def patch_zmi():
     from App.Management import Navigation
     for name in NO_THEME_DTML:
-        dtml = getattr(Navigation, name)
-        dtml.__class__ = NoThemeDTMLFile
+        dtml = getattr(Navigation, name, None)
+        if dtml:
+            dtml.__class__ = NoThemeDTMLFile
 
     from App.ApplicationManager import ApplicationManager
-    ApplicationManager.manage_shutdown = disable_theming(
-        ApplicationManager.manage_shutdown)
+    if getattr(ApplicationManager, 'manage_shutdown', False):
+        ApplicationManager.manage_shutdown = disable_theming(
+            ApplicationManager.manage_shutdown)
 
     LOGGER.debug('Patched Zope Management Interface to disable theming.')


