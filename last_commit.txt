Repository: plone.app.caching
Branch: refs/heads/1.1.x
Date: 2015-06-09T23:56:26-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.app.caching/commit/6c4f9df91c30a5b16a08c78edcd4d3c40f566ca4

backport fixes from 1.2 branch

Files changed:
M CHANGES.rst
M plone/app/caching/browser/controlpanel.py
M plone/app/caching/purge.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 9b03207..de243c3 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,14 @@ Changelog
 1.1.10 (unreleased)
 ~~~~~~~~~~~~~~~~~~~
 
-- Nothing changed yet.
+- correctly create purge paths for root of site, prevent double slashes
+  and the empty root of site(no trailing slash) not getting a purge
+  path generated
+  [vangheem]
+
+- Fix the portalPath used in the controlpanel for manual purging URL's.
+  This bug resulted in rarely doing all the purging required.
+  [puittenbroek]
 
 
 1.1.9 (2015-04-30)
diff --git a/plone/app/caching/browser/controlpanel.py b/plone/app/caching/browser/controlpanel.py
index 1337c1e..987ddca 100644
--- a/plone/app/caching/browser/controlpanel.py
+++ b/plone/app/caching/browser/controlpanel.py
@@ -542,7 +542,7 @@ def purge(url):
 
         portal_url = getToolByName(self.context, 'portal_url')
         portal = portal_url.getPortalObject()
-        portalPath = '/'.join(portal.getPhysicalPath())
+        portalPath = portal.getPhysicalPath()
 
         proxies = self.purgingSettings.cachingProxies
 
diff --git a/plone/app/caching/purge.py b/plone/app/caching/purge.py
index 9d1c112..ebcab5a 100644
--- a/plone/app/caching/purge.py
+++ b/plone/app/caching/purge.py
@@ -68,9 +68,20 @@ def getRelativePaths(self):
             if parentDefaultView == self.context.getId():
                 parentPrefix = '/' + parent.virtual_url_path()
                 paths.append(parentPrefix)
-                paths.append(parentPrefix  + '/')
-                paths.append(parentPrefix  + '/view')
-
+                if parentPrefix == '/':
+                    # special handling for site root since parentPrefix
+                    # does not make sense in that case.
+                    # Additionally, empty site roots were not getting
+                    # purge paths /VirtualHostBase/http/site.com:80/site1/VirtualHostRoot/_vh_site1/
+                    # was getting generated but not
+                    # /VirtualHostBase/http/site.com:80/site1/VirtualHostRoot/_vh_site1
+                    # which would translate to http://site.come/ getting invalidated
+                    # but not http://site.come
+                    paths.append('')
+                    paths.append('/view')
+                else:
+                    paths.append(parentPrefix + '/')
+                    paths.append(parentPrefix + '/view')
         return paths
 
     def getAbsolutePaths(self):


