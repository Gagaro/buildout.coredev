Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-09-06T12:17:59+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/7263f0b6c77ea7f3ae9d4026c3a7f4179cee7e83

Turn robots.txt into a browser-view, fix link to sitemap.xml.gz, allow editing in site-controlpanel. Fixes https://github.com/plone/Products.CMFPlone/issues/604

Files changed:
A Products/CMFPlone/browser/robots.py
A Products/CMFPlone/tests/test_robots_txt.py
M CHANGES.rst
M Products/CMFPlone/browser/configure.zcml
M Products/CMFPlone/interfaces/controlpanel.py
D Products/CMFPlone/skins/plone_templates/robots.txt

diff --git a/CHANGES.rst b/CHANGES.rst
index afcbc42..7400f34 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -8,11 +8,16 @@ Changelog
 5.0b5 (unreleased)
 ------------------
 
+- Turn robots.txt into a browser-view, fix link to sitemap.xml.gz, allow
+  editing in site-controlpanel.
+  Fixes https://github.com/plone/Products.CMFPlone/issues/604
+  [pbauer]
+
 - Remove history_form, history_comparison templates.
   Remove now-empty plone_forms skins folder.
   [esteele]
 
-- Remove no-longer-used images from portal_images. 
+- Remove no-longer-used images from portal_images.
   [esteele]
 
 - Typo in delete modal configuration caused submission redirection errors
diff --git a/Products/CMFPlone/browser/configure.zcml b/Products/CMFPlone/browser/configure.zcml
index fbbca1c..10dc8c0 100644
--- a/Products/CMFPlone/browser/configure.zcml
+++ b/Products/CMFPlone/browser/configure.zcml
@@ -161,6 +161,13 @@
             factory=".navtree.SitemapNavtreeStrategy"
             provides="plone.app.layout.navigation.interfaces.INavtreeStrategy" />
 
+  <browser:page
+      for="*"
+      name="robots.txt"
+      class=".robots.Robots"
+      permission="zope.Public"
+      />
+
   <!-- Useful for cross domain iframe proxying -->
   <browser:resource
       file="static/blank.html"
diff --git a/Products/CMFPlone/browser/robots.py b/Products/CMFPlone/browser/robots.py
new file mode 100644
index 0000000..17646cf
--- /dev/null
+++ b/Products/CMFPlone/browser/robots.py
@@ -0,0 +1,27 @@
+# -*- coding: utf-8 -*-
+from Products.CMFPlone.interfaces.controlpanel import ISiteSchema
+from Products.Five.browser import BrowserView
+from plone.registry.interfaces import IRegistry
+from zope.component import getUtility
+from zope.component import getMultiAdapter
+
+
+class Robots(BrowserView):
+    """Returns a robots.txt.
+
+    It is ediable ttw in /@@site-controlpanel or by setting a different
+    using a registry.xml with a line such as:
+    <record name="plone.robots_txt">
+        <value>User-agent: *
+    Disallow: /
+        </value>
+    </record>
+    """
+
+    def __call__(self):
+        portal_state = getMultiAdapter(
+            (self.context, self.request), name='plone_portal_state')
+        portal_url = portal_state.portal_url()
+        registry = getUtility(IRegistry)
+        settings = registry.forInterface(ISiteSchema, prefix="plone")
+        return settings.robots_txt.format(portal_url=portal_url)
diff --git a/Products/CMFPlone/interfaces/controlpanel.py b/Products/CMFPlone/interfaces/controlpanel.py
index da7f3d4..a10045d 100644
--- a/Products/CMFPlone/interfaces/controlpanel.py
+++ b/Products/CMFPlone/interfaces/controlpanel.py
@@ -10,6 +10,31 @@
 from zope.schema.vocabulary import SimpleVocabulary
 import json
 
+ROBOTS_TXT = u"""Sitemap: {portal_url}/sitemap.xml.gz
+
+# Define access-restrictions for robots/spiders
+# http://www.robotstxt.org/wc/norobots.html
+
+
+
+# By default we allow robots to access all areas of our site
+# already accessible to anonymous users
+
+User-agent: *
+Disallow:
+
+
+
+# Add Googlebot-specific syntax extension to exclude forms
+# that are repeated for each piece of content in the site
+# the wildcard is only supported by Googlebot
+# http://www.google.com/support/webmasters/bin/answer.py?answer=40367&ctx=sibling
+
+User-Agent: Googlebot
+Disallow: /*sendto_form$
+Disallow: /*folder_factories$
+"""
+
 
 class IControlPanel(IPloneBaseTool):
     """ Interface for the ControlPanel """
@@ -987,6 +1012,20 @@ class ISiteSchema(ILockSettings):
         required=False,
     )
 
+    robots_txt = schema.SourceText(
+        title=_("robots.txt"),
+        description=_(
+            u"help_robots_txt",
+            default=u"robots.txt is read by search-engines to "
+                    u"determine how to index your site. "
+                    u"For details see <a href='http://www.robotstxt.org'>"
+                    u"http://www.robotstxt.org</a>. "
+                    u"'{portal_url}' is replaced by the sites url."),
+        default=ROBOTS_TXT,
+        required=False,
+    )
+
+
 class IDateAndTimeSchema(Interface):
     """Controlpanel settings for date and time related settings.
     """
diff --git a/Products/CMFPlone/skins/plone_templates/robots.txt b/Products/CMFPlone/skins/plone_templates/robots.txt
deleted file mode 100644
index 0edfaee..0000000
--- a/Products/CMFPlone/skins/plone_templates/robots.txt
+++ /dev/null
@@ -1,23 +0,0 @@
-Sitemap: /sitemap.xml.gz
-
-# Define access-restrictions for robots/spiders
-# http://www.robotstxt.org/wc/norobots.html
-
-
-
-# By default we allow robots to access all areas of our site 
-# already accessible to anonymous users
-
-User-agent: *
-Disallow:
-
-
-
-# Add Googlebot-specific syntax extension to exclude forms 
-# that are repeated for each piece of content in the site 
-# the wildcard is only supported by Googlebot
-# http://www.google.com/support/webmasters/bin/answer.py?answer=40367&ctx=sibling
-
-User-Agent: Googlebot
-Disallow: /*sendto_form$
-Disallow: /*folder_factories$
\ No newline at end of file
diff --git a/Products/CMFPlone/tests/test_robots_txt.py b/Products/CMFPlone/tests/test_robots_txt.py
new file mode 100644
index 0000000..49cb31e
--- /dev/null
+++ b/Products/CMFPlone/tests/test_robots_txt.py
@@ -0,0 +1,24 @@
+# -*- coding: utf-8 -*-
+from Products.CMFPlone.interfaces import ISiteSchema
+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING
+from plone.registry.interfaces import IRegistry
+from zope.component import getUtility
+import unittest2 as unittest
+
+
+class RobotsTxtFunctionalTest(unittest.TestCase):
+    """Test robots.txt."""
+
+    layer = PRODUCTS_CMFPLONE_INTEGRATION_TESTING
+
+    def setUp(self):
+        self.portal = self.layer['portal']
+
+    def test_robots_view(self):
+        registry = getUtility(IRegistry)
+        settings = registry.forInterface(ISiteSchema, prefix='plone')
+        self.assertIn('{portal_url}/sitemap.xml.gz', settings.robots_txt)
+        view = self.portal.restrictedTraverse('robots.txt')
+        self.assertIn('http://nohost/plone/sitemap.xml.gz', view())
+        settings.robots_txt = u"Dummy"
+        self.assertEqual(u"Dummy", view())


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-09-06T13:02:40+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.CMFPlone/commit/aeaa06b45e3f4a4facce9ffea3bcac464355fc2d

fix test that used robots.txt

Files changed:
M Products/CMFPlone/tests/test_defaultpage.py

diff --git a/Products/CMFPlone/tests/test_defaultpage.py b/Products/CMFPlone/tests/test_defaultpage.py
index daab269..44355fd 100644
--- a/Products/CMFPlone/tests/test_defaultpage.py
+++ b/Products/CMFPlone/tests/test_defaultpage.py
@@ -102,10 +102,10 @@ def test_get_default_page_step_3_2(self):
         self.assertEqual('d1', get_default_page(self.folder))
 
         # fetch from i.e. portal_skins by acquisition
-        # robots.txt is in portal_skins/plone_templates and so available
+        # test_rendering.pt is in portal_skins/plone_templates and so available
         # by acquisition
-        self.folder.default_page = 'robots.txt'
-        self.assertEqual('robots.txt', get_default_page(self.folder))
+        self.folder.default_page = 'test_rendering'
+        self.assertEqual('test_rendering', get_default_page(self.folder))
 
     def test_get_default_page_step_4(self):
         # 4. Else, look up the property default_page in site_properties for


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-09-06T15:01:36-05:00
Author: Nathan Van Gheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/53e51470aee063650cc484c2a845cfd617077602

Merge pull request #868 from plone/robots_txt

Fix robots.txt

Files changed:
A Products/CMFPlone/browser/robots.py
A Products/CMFPlone/tests/test_robots_txt.py
M CHANGES.rst
M Products/CMFPlone/browser/configure.zcml
M Products/CMFPlone/interfaces/controlpanel.py
M Products/CMFPlone/tests/test_defaultpage.py
D Products/CMFPlone/skins/plone_templates/robots.txt

diff --git a/CHANGES.rst b/CHANGES.rst
index afcbc42..7400f34 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -8,11 +8,16 @@ Changelog
 5.0b5 (unreleased)
 ------------------
 
+- Turn robots.txt into a browser-view, fix link to sitemap.xml.gz, allow
+  editing in site-controlpanel.
+  Fixes https://github.com/plone/Products.CMFPlone/issues/604
+  [pbauer]
+
 - Remove history_form, history_comparison templates.
   Remove now-empty plone_forms skins folder.
   [esteele]
 
-- Remove no-longer-used images from portal_images. 
+- Remove no-longer-used images from portal_images.
   [esteele]
 
 - Typo in delete modal configuration caused submission redirection errors
diff --git a/Products/CMFPlone/browser/configure.zcml b/Products/CMFPlone/browser/configure.zcml
index fbbca1c..10dc8c0 100644
--- a/Products/CMFPlone/browser/configure.zcml
+++ b/Products/CMFPlone/browser/configure.zcml
@@ -161,6 +161,13 @@
             factory=".navtree.SitemapNavtreeStrategy"
             provides="plone.app.layout.navigation.interfaces.INavtreeStrategy" />
 
+  <browser:page
+      for="*"
+      name="robots.txt"
+      class=".robots.Robots"
+      permission="zope.Public"
+      />
+
   <!-- Useful for cross domain iframe proxying -->
   <browser:resource
       file="static/blank.html"
diff --git a/Products/CMFPlone/browser/robots.py b/Products/CMFPlone/browser/robots.py
new file mode 100644
index 0000000..17646cf
--- /dev/null
+++ b/Products/CMFPlone/browser/robots.py
@@ -0,0 +1,27 @@
+# -*- coding: utf-8 -*-
+from Products.CMFPlone.interfaces.controlpanel import ISiteSchema
+from Products.Five.browser import BrowserView
+from plone.registry.interfaces import IRegistry
+from zope.component import getUtility
+from zope.component import getMultiAdapter
+
+
+class Robots(BrowserView):
+    """Returns a robots.txt.
+
+    It is ediable ttw in /@@site-controlpanel or by setting a different
+    using a registry.xml with a line such as:
+    <record name="plone.robots_txt">
+        <value>User-agent: *
+    Disallow: /
+        </value>
+    </record>
+    """
+
+    def __call__(self):
+        portal_state = getMultiAdapter(
+            (self.context, self.request), name='plone_portal_state')
+        portal_url = portal_state.portal_url()
+        registry = getUtility(IRegistry)
+        settings = registry.forInterface(ISiteSchema, prefix="plone")
+        return settings.robots_txt.format(portal_url=portal_url)
diff --git a/Products/CMFPlone/interfaces/controlpanel.py b/Products/CMFPlone/interfaces/controlpanel.py
index da7f3d4..a10045d 100644
--- a/Products/CMFPlone/interfaces/controlpanel.py
+++ b/Products/CMFPlone/interfaces/controlpanel.py
@@ -10,6 +10,31 @@
 from zope.schema.vocabulary import SimpleVocabulary
 import json
 
+ROBOTS_TXT = u"""Sitemap: {portal_url}/sitemap.xml.gz
+
+# Define access-restrictions for robots/spiders
+# http://www.robotstxt.org/wc/norobots.html
+
+
+
+# By default we allow robots to access all areas of our site
+# already accessible to anonymous users
+
+User-agent: *
+Disallow:
+
+
+
+# Add Googlebot-specific syntax extension to exclude forms
+# that are repeated for each piece of content in the site
+# the wildcard is only supported by Googlebot
+# http://www.google.com/support/webmasters/bin/answer.py?answer=40367&ctx=sibling
+
+User-Agent: Googlebot
+Disallow: /*sendto_form$
+Disallow: /*folder_factories$
+"""
+
 
 class IControlPanel(IPloneBaseTool):
     """ Interface for the ControlPanel """
@@ -987,6 +1012,20 @@ class ISiteSchema(ILockSettings):
         required=False,
     )
 
+    robots_txt = schema.SourceText(
+        title=_("robots.txt"),
+        description=_(
+            u"help_robots_txt",
+            default=u"robots.txt is read by search-engines to "
+                    u"determine how to index your site. "
+                    u"For details see <a href='http://www.robotstxt.org'>"
+                    u"http://www.robotstxt.org</a>. "
+                    u"'{portal_url}' is replaced by the sites url."),
+        default=ROBOTS_TXT,
+        required=False,
+    )
+
+
 class IDateAndTimeSchema(Interface):
     """Controlpanel settings for date and time related settings.
     """
diff --git a/Products/CMFPlone/skins/plone_templates/robots.txt b/Products/CMFPlone/skins/plone_templates/robots.txt
deleted file mode 100644
index 0edfaee..0000000
--- a/Products/CMFPlone/skins/plone_templates/robots.txt
+++ /dev/null
@@ -1,23 +0,0 @@
-Sitemap: /sitemap.xml.gz
-
-# Define access-restrictions for robots/spiders
-# http://www.robotstxt.org/wc/norobots.html
-
-
-
-# By default we allow robots to access all areas of our site 
-# already accessible to anonymous users
-
-User-agent: *
-Disallow:
-
-
-
-# Add Googlebot-specific syntax extension to exclude forms 
-# that are repeated for each piece of content in the site 
-# the wildcard is only supported by Googlebot
-# http://www.google.com/support/webmasters/bin/answer.py?answer=40367&ctx=sibling
-
-User-Agent: Googlebot
-Disallow: /*sendto_form$
-Disallow: /*folder_factories$
\ No newline at end of file
diff --git a/Products/CMFPlone/tests/test_defaultpage.py b/Products/CMFPlone/tests/test_defaultpage.py
index daab269..44355fd 100644
--- a/Products/CMFPlone/tests/test_defaultpage.py
+++ b/Products/CMFPlone/tests/test_defaultpage.py
@@ -102,10 +102,10 @@ def test_get_default_page_step_3_2(self):
         self.assertEqual('d1', get_default_page(self.folder))
 
         # fetch from i.e. portal_skins by acquisition
-        # robots.txt is in portal_skins/plone_templates and so available
+        # test_rendering.pt is in portal_skins/plone_templates and so available
         # by acquisition
-        self.folder.default_page = 'robots.txt'
-        self.assertEqual('robots.txt', get_default_page(self.folder))
+        self.folder.default_page = 'test_rendering'
+        self.assertEqual('test_rendering', get_default_page(self.folder))
 
     def test_get_default_page_step_4(self):
         # 4. Else, look up the property default_page in site_properties for
diff --git a/Products/CMFPlone/tests/test_robots_txt.py b/Products/CMFPlone/tests/test_robots_txt.py
new file mode 100644
index 0000000..49cb31e
--- /dev/null
+++ b/Products/CMFPlone/tests/test_robots_txt.py
@@ -0,0 +1,24 @@
+# -*- coding: utf-8 -*-
+from Products.CMFPlone.interfaces import ISiteSchema
+from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING
+from plone.registry.interfaces import IRegistry
+from zope.component import getUtility
+import unittest2 as unittest
+
+
+class RobotsTxtFunctionalTest(unittest.TestCase):
+    """Test robots.txt."""
+
+    layer = PRODUCTS_CMFPLONE_INTEGRATION_TESTING
+
+    def setUp(self):
+        self.portal = self.layer['portal']
+
+    def test_robots_view(self):
+        registry = getUtility(IRegistry)
+        settings = registry.forInterface(ISiteSchema, prefix='plone')
+        self.assertIn('{portal_url}/sitemap.xml.gz', settings.robots_txt)
+        view = self.portal.restrictedTraverse('robots.txt')
+        self.assertIn('http://nohost/plone/sitemap.xml.gz', view())
+        settings.robots_txt = u"Dummy"
+        self.assertEqual(u"Dummy", view())


