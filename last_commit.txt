Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2015-09-16T16:43:09+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/Products.ATContentTypes/commit/da75776edf7f8dd5de422d746e9839bb81a81f84

Move redirect_links to the registry.

Files changed:
M CHANGES.txt
M Products/ATContentTypes/skins/ATContentTypes/link_redirect_view.py
M Products/ATContentTypes/skins/ATContentTypes/link_view.pt

diff --git a/CHANGES.txt b/CHANGES.txt
index e15884a..492a1cd 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -4,8 +4,8 @@ Changelog
 2.2.7 (unreleased)
 ------------------
 
-- Nothing changed yet.
-
+- Pull value for link_redirect setting from the configuration registry.
+  [esteele]
 
 2.2.6 (2015-07-18)
 ------------------
diff --git a/Products/ATContentTypes/skins/ATContentTypes/link_redirect_view.py b/Products/ATContentTypes/skins/ATContentTypes/link_redirect_view.py
index 449c3fd..0cc5a54 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/link_redirect_view.py
+++ b/Products/ATContentTypes/skins/ATContentTypes/link_redirect_view.py
@@ -14,10 +14,9 @@
 
 from Products.CMFCore.utils import getToolByName
 
-ptool = getToolByName(context, 'portal_properties')
 mtool = getToolByName(context, 'portal_membership')
 
-redirect_links = getattr(ptool.site_properties, 'redirect_links', False)
+redirect_links = context.portal_registry['plone.redirect_links']
 can_edit = mtool.checkPermission('Modify portal content', context)
 
 if redirect_links and not can_edit:
diff --git a/Products/ATContentTypes/skins/ATContentTypes/link_view.pt b/Products/ATContentTypes/skins/ATContentTypes/link_view.pt
index b56d98f..8cca1ba 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/link_view.pt
+++ b/Products/ATContentTypes/skins/ATContentTypes/link_view.pt
@@ -10,7 +10,7 @@
 
     <metal:header fill-slot="global_statusmessage">
         <div class="portalMessage info"
-            tal:define="redirect_links context/portal_properties/site_properties/redirect_links|nothing"
+            tal:define="redirect_links python:context.portal_registry['plone.redirect_links']"
             tal:condition="python: redirect_links and checkPermission('Modify portal content', context)">
             <strong i18n:translate="">Info</strong>
             <span tal:omit-tag=""


Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2015-09-17T18:57:18+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/Products.ATContentTypes/commit/5d85050aab0caece1fe0e698b05cec685a001cf5

Use registry lookup for types_use_view_action_in_listings

Files changed:
M CHANGES.txt
M Products/ATContentTypes/browser/nextprevious.py
M Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
M Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt

diff --git a/CHANGES.txt b/CHANGES.txt
index 492a1cd..035e0f0 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -4,7 +4,8 @@ Changelog
 2.2.7 (unreleased)
 ------------------
 
-- Pull value for link_redirect setting from the configuration registry.
+- Pull value for link_redirect, types_view_action_in_listings
+  settings from the configuration registry.
   [esteele]
 
 2.2.6 (2015-07-18)
diff --git a/Products/ATContentTypes/browser/nextprevious.py b/Products/ATContentTypes/browser/nextprevious.py
index ea4c7bf..23abe22 100644
--- a/Products/ATContentTypes/browser/nextprevious.py
+++ b/Products/ATContentTypes/browser/nextprevious.py
@@ -1,10 +1,12 @@
 from zope.interface import implements
 from zope.component import adapts
+from zope.component import getUtility
 
 from plone.app.layout.nextprevious.interfaces import INextPreviousProvider
 from Products.ATContentTypes.interfaces.folder import IATFolder
 
 from plone.memoize.instance import memoize
+from plone.registry.interfaces import IRegistry
 
 from Acquisition import aq_base
 from Products.CMFCore.utils import getToolByName
@@ -20,9 +22,9 @@ class ATFolderNextPrevious(object):
 
     def __init__(self, context):
         self.context = context
-
-        sp = getToolByName(self.context, 'portal_properties').site_properties
-        self.view_action_types = sp.getProperty('typesUseViewActionInListings', ())
+        registry = getUtility(IRegistry)
+        self.view_action_types = registry.get(
+            'plone.types_view_action_in_listings', [])
 
     def getNextItem(self, obj):
         relatives = self.itemRelatives(obj.getId())
diff --git a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
index 5ac55b5..77e7e9a 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
+++ b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
@@ -5,7 +5,7 @@
          xmlns:i18n="http://xml.zope.org/namespaces/i18n"
          filename="report.pdf"
          tal:define="portal python:here.portal_url.getPortalObject();
-                     use_view_action here/portal_properties/site_properties/typesUseViewActionInListings;
+                     use_view_action python:context.portal_registry.get('plone.types_view_action_in_listings', []);
                      toLocalizedTime nocall:here/toLocalizedTime;">
 
   <title tal:content="here/title | nothing">Default Topic</title>
diff --git a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt
index 134cd1e..8cab666 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt
+++ b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt
@@ -27,7 +27,7 @@
                   tal:attributes="action here_url">
             
                 <metal:listing define-macro="folder_listing"
-                               tal:define="use_view_action site_properties/typesUseViewActionInListings|python:();">
+                               tal:define="use_view_action python:context.portal_registry.get('plone.types_view_action_in_listings', []);">
 
                     <div class="visualClear" id="clear-space-before-navigation"><!-- --></div>
 


Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2015-09-17T19:01:38+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/Products.ATContentTypes/commit/e3edb41b49b03fef5ab959c9ccadeb7602797307

Use registry lookup for types_use_view_action_in_listings

Files changed:
M Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt

diff --git a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt
index e586ae2..3295151 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt
+++ b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt
@@ -14,7 +14,7 @@
 
         <metal:listingmacro define-macro="listing">
         <tal:topiccontents define="topicContents python:here.queryCatalog(batch=True);
-                                   use_view_action site_properties/typesUseViewActionInListings|python:();
+                                   use_view_action python:context.portal_registry.get('plone.types_view_action_in_listings', []);
                                    batch topicContents;"
                            on-error="python:request.RESPONSE.redirect(context.absolute_url())">
 


Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2015-09-18T09:48:26+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/Products.ATContentTypes/commit/a7030dcf619d0785e1e7040cca1a129341ce673d

Fix registry id

Files changed:
M Products/ATContentTypes/browser/nextprevious.py
M Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
M Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt
M Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt

diff --git a/Products/ATContentTypes/browser/nextprevious.py b/Products/ATContentTypes/browser/nextprevious.py
index 23abe22..66ea985 100644
--- a/Products/ATContentTypes/browser/nextprevious.py
+++ b/Products/ATContentTypes/browser/nextprevious.py
@@ -24,7 +24,7 @@ def __init__(self, context):
         self.context = context
         registry = getUtility(IRegistry)
         self.view_action_types = registry.get(
-            'plone.types_view_action_in_listings', [])
+            'plone.types_use_view_action_in_listings', [])
 
     def getNextItem(self, obj):
         relatives = self.itemRelatives(obj.getId())
diff --git a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
index 77e7e9a..73e2286 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
+++ b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
@@ -5,7 +5,7 @@
          xmlns:i18n="http://xml.zope.org/namespaces/i18n"
          filename="report.pdf"
          tal:define="portal python:here.portal_url.getPortalObject();
-                     use_view_action python:context.portal_registry.get('plone.types_view_action_in_listings', []);
+                     use_view_action python:context.portal_registry.get('plone.types_use_view_action_in_listings', []);
                      toLocalizedTime nocall:here/toLocalizedTime;">
 
   <title tal:content="here/title | nothing">Default Topic</title>
diff --git a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt
index 8cab666..1287028 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt
+++ b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt
@@ -27,7 +27,7 @@
                   tal:attributes="action here_url">
             
                 <metal:listing define-macro="folder_listing"
-                               tal:define="use_view_action python:context.portal_registry.get('plone.types_view_action_in_listings', []);">
+                               tal:define="use_view_action python:context.portal_registry.get('plone.types_use_view_action_in_listings', []);">
 
                     <div class="visualClear" id="clear-space-before-navigation"><!-- --></div>
 
diff --git a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt
index 3295151..70c528b 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt
+++ b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt
@@ -14,7 +14,7 @@
 
         <metal:listingmacro define-macro="listing">
         <tal:topiccontents define="topicContents python:here.queryCatalog(batch=True);
-                                   use_view_action python:context.portal_registry.get('plone.types_view_action_in_listings', []);
+                                   use_view_action python:context.portal_registry.get('plone.types_use_view_action_in_listings', []);
                                    batch topicContents;"
                            on-error="python:request.RESPONSE.redirect(context.absolute_url())">
 


Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2015-09-19T07:37:45+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.ATContentTypes/commit/152c338d85d0b5e67445d9288a36d831ea0e2d50

do not set obsolete site-property default_page_types

Files changed:
D Products/ATContentTypes/profiles/default/propertiestool.xml

diff --git a/Products/ATContentTypes/profiles/default/propertiestool.xml b/Products/ATContentTypes/profiles/default/propertiestool.xml
deleted file mode 100644
index b9f4db1..0000000
--- a/Products/ATContentTypes/profiles/default/propertiestool.xml
+++ /dev/null
@@ -1,11 +0,0 @@
-<?xml version="1.0" encoding="UTF-8"?>
-<object name="portal_properties" meta_type="Plone Properties Tool">
- <object name="site_properties" meta_type="Plone Property Sheet">
-  <property name="default_page_types" type="lines" purge="False">
-   <element value="Document"/>
-   <element value="Event"/>
-   <element value="News Item"/>
-   <element value="Topic"/>
-  </property>
- </object>
-</object>


Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2015-09-19T11:49:15+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.ATContentTypes/commit/618ebd91c330c973d9f6d98ef2cce3982218d862

search_results_description_length is now in registry and ellipsis is gone

Files changed:
M Products/ATContentTypes/skins/ATContentTypes/formatCatalogMetadata.py
M Products/ATContentTypes/tests/test_skinScripts.py

diff --git a/Products/ATContentTypes/skins/ATContentTypes/formatCatalogMetadata.py b/Products/ATContentTypes/skins/ATContentTypes/formatCatalogMetadata.py
index 12449eb..585a25c 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/formatCatalogMetadata.py
+++ b/Products/ATContentTypes/skins/ATContentTypes/formatCatalogMetadata.py
@@ -54,14 +54,9 @@
     value = str(value)
 
 pt = context.portal_properties
-site_props = getattr(pt, 'site_properties', None)
-if site_props is not None:
-    max_length = site_props.getProperty(
-        'search_results_description_length', 160)
-    ellipsis = site_props.getProperty('ellipsis', '...')
-else:
-    max_length = 160
-    ellipsis = '...'
+registry = context.portal_registry
+max_length = registry['plone.search_results_description_length']
+ellipsis = '...'
 if len(value) < max_length:
     return value
 else:
diff --git a/Products/ATContentTypes/tests/test_skinScripts.py b/Products/ATContentTypes/tests/test_skinScripts.py
index 2736d74..6f4a418 100644
--- a/Products/ATContentTypes/tests/test_skinScripts.py
+++ b/Products/ATContentTypes/tests/test_skinScripts.py
@@ -39,9 +39,9 @@ def testFormatString(self):
         self.assertEqual(self.script('fkj dsh ekjhsdf kjer'), 'fkj dsh ekjhsdf kjer')
 
     def testFormatTruncates(self):
-        self.portal.portal_properties.site_properties.manage_changeProperties(
-                            search_results_description_length=12, ellipsis='???')
-        self.assertEqual(self.script('fkj dsh ekjhsdf kjer'), 'fkj dsh ekjh???')
+        registry = self.portal.portal_registry
+        registry['plone.search_results_description_length'] = 12
+        self.assertEqual(self.script('fkj dsh ekjhsdf kjer'), 'fkj dsh ekjh...')
 
     def testFormatStrange(self):
         self.assertEqual(self.script(None), '')


Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2015-09-19T20:14:25+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/Products.ATContentTypes/commit/957f45ea2f112b9f268ba6e75226299a19bc8225

Move redirect_links to the registry.

Files changed:
M CHANGES.txt
M Products/ATContentTypes/skins/ATContentTypes/link_redirect_view.py
M Products/ATContentTypes/skins/ATContentTypes/link_view.pt

diff --git a/CHANGES.txt b/CHANGES.txt
index e15884a..492a1cd 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -4,8 +4,8 @@ Changelog
 2.2.7 (unreleased)
 ------------------
 
-- Nothing changed yet.
-
+- Pull value for link_redirect setting from the configuration registry.
+  [esteele]
 
 2.2.6 (2015-07-18)
 ------------------
diff --git a/Products/ATContentTypes/skins/ATContentTypes/link_redirect_view.py b/Products/ATContentTypes/skins/ATContentTypes/link_redirect_view.py
index 449c3fd..0cc5a54 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/link_redirect_view.py
+++ b/Products/ATContentTypes/skins/ATContentTypes/link_redirect_view.py
@@ -14,10 +14,9 @@
 
 from Products.CMFCore.utils import getToolByName
 
-ptool = getToolByName(context, 'portal_properties')
 mtool = getToolByName(context, 'portal_membership')
 
-redirect_links = getattr(ptool.site_properties, 'redirect_links', False)
+redirect_links = context.portal_registry['plone.redirect_links']
 can_edit = mtool.checkPermission('Modify portal content', context)
 
 if redirect_links and not can_edit:
diff --git a/Products/ATContentTypes/skins/ATContentTypes/link_view.pt b/Products/ATContentTypes/skins/ATContentTypes/link_view.pt
index b56d98f..8cca1ba 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/link_view.pt
+++ b/Products/ATContentTypes/skins/ATContentTypes/link_view.pt
@@ -10,7 +10,7 @@
 
     <metal:header fill-slot="global_statusmessage">
         <div class="portalMessage info"
-            tal:define="redirect_links context/portal_properties/site_properties/redirect_links|nothing"
+            tal:define="redirect_links python:context.portal_registry['plone.redirect_links']"
             tal:condition="python: redirect_links and checkPermission('Modify portal content', context)">
             <strong i18n:translate="">Info</strong>
             <span tal:omit-tag=""


Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2015-09-19T20:14:25+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/Products.ATContentTypes/commit/5e4607168f16bd85a5405c72213584da8603ad0a

Use registry lookup for types_use_view_action_in_listings

Files changed:
M CHANGES.txt
M Products/ATContentTypes/browser/nextprevious.py
M Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
M Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt

diff --git a/CHANGES.txt b/CHANGES.txt
index 492a1cd..035e0f0 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -4,7 +4,8 @@ Changelog
 2.2.7 (unreleased)
 ------------------
 
-- Pull value for link_redirect setting from the configuration registry.
+- Pull value for link_redirect, types_view_action_in_listings
+  settings from the configuration registry.
   [esteele]
 
 2.2.6 (2015-07-18)
diff --git a/Products/ATContentTypes/browser/nextprevious.py b/Products/ATContentTypes/browser/nextprevious.py
index ea4c7bf..23abe22 100644
--- a/Products/ATContentTypes/browser/nextprevious.py
+++ b/Products/ATContentTypes/browser/nextprevious.py
@@ -1,10 +1,12 @@
 from zope.interface import implements
 from zope.component import adapts
+from zope.component import getUtility
 
 from plone.app.layout.nextprevious.interfaces import INextPreviousProvider
 from Products.ATContentTypes.interfaces.folder import IATFolder
 
 from plone.memoize.instance import memoize
+from plone.registry.interfaces import IRegistry
 
 from Acquisition import aq_base
 from Products.CMFCore.utils import getToolByName
@@ -20,9 +22,9 @@ class ATFolderNextPrevious(object):
 
     def __init__(self, context):
         self.context = context
-
-        sp = getToolByName(self.context, 'portal_properties').site_properties
-        self.view_action_types = sp.getProperty('typesUseViewActionInListings', ())
+        registry = getUtility(IRegistry)
+        self.view_action_types = registry.get(
+            'plone.types_view_action_in_listings', [])
 
     def getNextItem(self, obj):
         relatives = self.itemRelatives(obj.getId())
diff --git a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
index 5ac55b5..77e7e9a 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
+++ b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
@@ -5,7 +5,7 @@
          xmlns:i18n="http://xml.zope.org/namespaces/i18n"
          filename="report.pdf"
          tal:define="portal python:here.portal_url.getPortalObject();
-                     use_view_action here/portal_properties/site_properties/typesUseViewActionInListings;
+                     use_view_action python:context.portal_registry.get('plone.types_view_action_in_listings', []);
                      toLocalizedTime nocall:here/toLocalizedTime;">
 
   <title tal:content="here/title | nothing">Default Topic</title>
diff --git a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt
index 134cd1e..8cab666 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt
+++ b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt
@@ -27,7 +27,7 @@
                   tal:attributes="action here_url">
             
                 <metal:listing define-macro="folder_listing"
-                               tal:define="use_view_action site_properties/typesUseViewActionInListings|python:();">
+                               tal:define="use_view_action python:context.portal_registry.get('plone.types_view_action_in_listings', []);">
 
                     <div class="visualClear" id="clear-space-before-navigation"><!-- --></div>
 


Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2015-09-19T20:14:25+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/Products.ATContentTypes/commit/bea22d61732b4bcbd8f6138bd196ed9a720b6002

Use registry lookup for types_use_view_action_in_listings

Files changed:
M Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt

diff --git a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt
index e586ae2..3295151 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt
+++ b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt
@@ -14,7 +14,7 @@
 
         <metal:listingmacro define-macro="listing">
         <tal:topiccontents define="topicContents python:here.queryCatalog(batch=True);
-                                   use_view_action site_properties/typesUseViewActionInListings|python:();
+                                   use_view_action python:context.portal_registry.get('plone.types_view_action_in_listings', []);
                                    batch topicContents;"
                            on-error="python:request.RESPONSE.redirect(context.absolute_url())">
 


Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2015-09-19T20:14:25+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/Products.ATContentTypes/commit/634a62e867314ac02e050572be75adedf557003b

Fix registry id

Files changed:
M Products/ATContentTypes/browser/nextprevious.py
M Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
M Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt
M Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt

diff --git a/Products/ATContentTypes/browser/nextprevious.py b/Products/ATContentTypes/browser/nextprevious.py
index 23abe22..66ea985 100644
--- a/Products/ATContentTypes/browser/nextprevious.py
+++ b/Products/ATContentTypes/browser/nextprevious.py
@@ -24,7 +24,7 @@ def __init__(self, context):
         self.context = context
         registry = getUtility(IRegistry)
         self.view_action_types = registry.get(
-            'plone.types_view_action_in_listings', [])
+            'plone.types_use_view_action_in_listings', [])
 
     def getNextItem(self, obj):
         relatives = self.itemRelatives(obj.getId())
diff --git a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
index 77e7e9a..73e2286 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
+++ b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
@@ -5,7 +5,7 @@
          xmlns:i18n="http://xml.zope.org/namespaces/i18n"
          filename="report.pdf"
          tal:define="portal python:here.portal_url.getPortalObject();
-                     use_view_action python:context.portal_registry.get('plone.types_view_action_in_listings', []);
+                     use_view_action python:context.portal_registry.get('plone.types_use_view_action_in_listings', []);
                      toLocalizedTime nocall:here/toLocalizedTime;">
 
   <title tal:content="here/title | nothing">Default Topic</title>
diff --git a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt
index 8cab666..1287028 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt
+++ b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt
@@ -27,7 +27,7 @@
                   tal:attributes="action here_url">
             
                 <metal:listing define-macro="folder_listing"
-                               tal:define="use_view_action python:context.portal_registry.get('plone.types_view_action_in_listings', []);">
+                               tal:define="use_view_action python:context.portal_registry.get('plone.types_use_view_action_in_listings', []);">
 
                     <div class="visualClear" id="clear-space-before-navigation"><!-- --></div>
 
diff --git a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt
index 3295151..70c528b 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt
+++ b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt
@@ -14,7 +14,7 @@
 
         <metal:listingmacro define-macro="listing">
         <tal:topiccontents define="topicContents python:here.queryCatalog(batch=True);
-                                   use_view_action python:context.portal_registry.get('plone.types_view_action_in_listings', []);
+                                   use_view_action python:context.portal_registry.get('plone.types_use_view_action_in_listings', []);
                                    batch topicContents;"
                            on-error="python:request.RESPONSE.redirect(context.absolute_url())">
 


Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2015-09-19T20:14:25+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.ATContentTypes/commit/92e8e3a3176f47e558c9f443fe3bb014307c9832

do not set obsolete site-property default_page_types

Files changed:
D Products/ATContentTypes/profiles/default/propertiestool.xml

diff --git a/Products/ATContentTypes/profiles/default/propertiestool.xml b/Products/ATContentTypes/profiles/default/propertiestool.xml
deleted file mode 100644
index b9f4db1..0000000
--- a/Products/ATContentTypes/profiles/default/propertiestool.xml
+++ /dev/null
@@ -1,11 +0,0 @@
-<?xml version="1.0" encoding="UTF-8"?>
-<object name="portal_properties" meta_type="Plone Properties Tool">
- <object name="site_properties" meta_type="Plone Property Sheet">
-  <property name="default_page_types" type="lines" purge="False">
-   <element value="Document"/>
-   <element value="Event"/>
-   <element value="News Item"/>
-   <element value="Topic"/>
-  </property>
- </object>
-</object>


Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2015-09-19T20:14:25+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.ATContentTypes/commit/a9acfc3b6694ffe82aac0eb334b54f95759f2eb9

search_results_description_length is now in registry and ellipsis is gone

Files changed:
M Products/ATContentTypes/skins/ATContentTypes/formatCatalogMetadata.py
M Products/ATContentTypes/tests/test_skinScripts.py

diff --git a/Products/ATContentTypes/skins/ATContentTypes/formatCatalogMetadata.py b/Products/ATContentTypes/skins/ATContentTypes/formatCatalogMetadata.py
index 12449eb..585a25c 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/formatCatalogMetadata.py
+++ b/Products/ATContentTypes/skins/ATContentTypes/formatCatalogMetadata.py
@@ -54,14 +54,9 @@
     value = str(value)
 
 pt = context.portal_properties
-site_props = getattr(pt, 'site_properties', None)
-if site_props is not None:
-    max_length = site_props.getProperty(
-        'search_results_description_length', 160)
-    ellipsis = site_props.getProperty('ellipsis', '...')
-else:
-    max_length = 160
-    ellipsis = '...'
+registry = context.portal_registry
+max_length = registry['plone.search_results_description_length']
+ellipsis = '...'
 if len(value) < max_length:
     return value
 else:
diff --git a/Products/ATContentTypes/tests/test_skinScripts.py b/Products/ATContentTypes/tests/test_skinScripts.py
index 2736d74..6f4a418 100644
--- a/Products/ATContentTypes/tests/test_skinScripts.py
+++ b/Products/ATContentTypes/tests/test_skinScripts.py
@@ -39,9 +39,9 @@ def testFormatString(self):
         self.assertEqual(self.script('fkj dsh ekjhsdf kjer'), 'fkj dsh ekjhsdf kjer')
 
     def testFormatTruncates(self):
-        self.portal.portal_properties.site_properties.manage_changeProperties(
-                            search_results_description_length=12, ellipsis='???')
-        self.assertEqual(self.script('fkj dsh ekjhsdf kjer'), 'fkj dsh ekjh???')
+        registry = self.portal.portal_registry
+        registry['plone.search_results_description_length'] = 12
+        self.assertEqual(self.script('fkj dsh ekjhsdf kjer'), 'fkj dsh ekjh...')
 
     def testFormatStrange(self):
         self.assertEqual(self.script(None), '')


Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2015-09-19T23:57:33+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/Products.ATContentTypes/commit/1ea9c646140a6202bf20d0ed3c068a838f9001c7

Merge remote-tracking branch 'remotes/origin/portal-properties-cleanup' into portal-properties-cleanup

Files changed:




Repository: Products.ATContentTypes


Branch: refs/heads/master
Date: 2015-09-20T17:28:33+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/Products.ATContentTypes/commit/81b101d0f6d0a921fd2d8777aab77c50c5919522

Merge pull request #23 from plone/portal-properties-cleanup

Portal properties cleanup

Files changed:
M CHANGES.txt
M Products/ATContentTypes/browser/nextprevious.py
M Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
M Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt
M Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt
M Products/ATContentTypes/skins/ATContentTypes/formatCatalogMetadata.py
M Products/ATContentTypes/skins/ATContentTypes/link_redirect_view.py
M Products/ATContentTypes/skins/ATContentTypes/link_view.pt
M Products/ATContentTypes/tests/test_skinScripts.py
D Products/ATContentTypes/profiles/default/propertiestool.xml

diff --git a/CHANGES.txt b/CHANGES.txt
index e15884a..035e0f0 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -4,8 +4,9 @@ Changelog
 2.2.7 (unreleased)
 ------------------
 
-- Nothing changed yet.
-
+- Pull value for link_redirect, types_view_action_in_listings
+  settings from the configuration registry.
+  [esteele]
 
 2.2.6 (2015-07-18)
 ------------------
diff --git a/Products/ATContentTypes/browser/nextprevious.py b/Products/ATContentTypes/browser/nextprevious.py
index ea4c7bf..66ea985 100644
--- a/Products/ATContentTypes/browser/nextprevious.py
+++ b/Products/ATContentTypes/browser/nextprevious.py
@@ -1,10 +1,12 @@
 from zope.interface import implements
 from zope.component import adapts
+from zope.component import getUtility
 
 from plone.app.layout.nextprevious.interfaces import INextPreviousProvider
 from Products.ATContentTypes.interfaces.folder import IATFolder
 
 from plone.memoize.instance import memoize
+from plone.registry.interfaces import IRegistry
 
 from Acquisition import aq_base
 from Products.CMFCore.utils import getToolByName
@@ -20,9 +22,9 @@ class ATFolderNextPrevious(object):
 
     def __init__(self, context):
         self.context = context
-
-        sp = getToolByName(self.context, 'portal_properties').site_properties
-        self.view_action_types = sp.getProperty('typesUseViewActionInListings', ())
+        registry = getUtility(IRegistry)
+        self.view_action_types = registry.get(
+            'plone.types_use_view_action_in_listings', [])
 
     def getNextItem(self, obj):
         relatives = self.itemRelatives(obj.getId())
diff --git a/Products/ATContentTypes/profiles/default/propertiestool.xml b/Products/ATContentTypes/profiles/default/propertiestool.xml
deleted file mode 100644
index b9f4db1..0000000
--- a/Products/ATContentTypes/profiles/default/propertiestool.xml
+++ /dev/null
@@ -1,11 +0,0 @@
-<?xml version="1.0" encoding="UTF-8"?>
-<object name="portal_properties" meta_type="Plone Properties Tool">
- <object name="site_properties" meta_type="Plone Property Sheet">
-  <property name="default_page_types" type="lines" purge="False">
-   <element value="Document"/>
-   <element value="Event"/>
-   <element value="News Item"/>
-   <element value="Topic"/>
-  </property>
- </object>
-</object>
diff --git a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
index 5ac55b5..73e2286 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
+++ b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_pdf.pt
@@ -5,7 +5,7 @@
          xmlns:i18n="http://xml.zope.org/namespaces/i18n"
          filename="report.pdf"
          tal:define="portal python:here.portal_url.getPortalObject();
-                     use_view_action here/portal_properties/site_properties/typesUseViewActionInListings;
+                     use_view_action python:context.portal_registry.get('plone.types_use_view_action_in_listings', []);
                      toLocalizedTime nocall:here/toLocalizedTime;">
 
   <title tal:content="here/title | nothing">Default Topic</title>
diff --git a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt
index 134cd1e..1287028 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt
+++ b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_subtopics.pt
@@ -27,7 +27,7 @@
                   tal:attributes="action here_url">
             
                 <metal:listing define-macro="folder_listing"
-                               tal:define="use_view_action site_properties/typesUseViewActionInListings|python:();">
+                               tal:define="use_view_action python:context.portal_registry.get('plone.types_use_view_action_in_listings', []);">
 
                     <div class="visualClear" id="clear-space-before-navigation"><!-- --></div>
 
diff --git a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt
index e586ae2..70c528b 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt
+++ b/Products/ATContentTypes/skins/ATContentTypes/atct_topic_view.pt
@@ -14,7 +14,7 @@
 
         <metal:listingmacro define-macro="listing">
         <tal:topiccontents define="topicContents python:here.queryCatalog(batch=True);
-                                   use_view_action site_properties/typesUseViewActionInListings|python:();
+                                   use_view_action python:context.portal_registry.get('plone.types_use_view_action_in_listings', []);
                                    batch topicContents;"
                            on-error="python:request.RESPONSE.redirect(context.absolute_url())">
 
diff --git a/Products/ATContentTypes/skins/ATContentTypes/formatCatalogMetadata.py b/Products/ATContentTypes/skins/ATContentTypes/formatCatalogMetadata.py
index 12449eb..585a25c 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/formatCatalogMetadata.py
+++ b/Products/ATContentTypes/skins/ATContentTypes/formatCatalogMetadata.py
@@ -54,14 +54,9 @@
     value = str(value)
 
 pt = context.portal_properties
-site_props = getattr(pt, 'site_properties', None)
-if site_props is not None:
-    max_length = site_props.getProperty(
-        'search_results_description_length', 160)
-    ellipsis = site_props.getProperty('ellipsis', '...')
-else:
-    max_length = 160
-    ellipsis = '...'
+registry = context.portal_registry
+max_length = registry['plone.search_results_description_length']
+ellipsis = '...'
 if len(value) < max_length:
     return value
 else:
diff --git a/Products/ATContentTypes/skins/ATContentTypes/link_redirect_view.py b/Products/ATContentTypes/skins/ATContentTypes/link_redirect_view.py
index 449c3fd..0cc5a54 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/link_redirect_view.py
+++ b/Products/ATContentTypes/skins/ATContentTypes/link_redirect_view.py
@@ -14,10 +14,9 @@
 
 from Products.CMFCore.utils import getToolByName
 
-ptool = getToolByName(context, 'portal_properties')
 mtool = getToolByName(context, 'portal_membership')
 
-redirect_links = getattr(ptool.site_properties, 'redirect_links', False)
+redirect_links = context.portal_registry['plone.redirect_links']
 can_edit = mtool.checkPermission('Modify portal content', context)
 
 if redirect_links and not can_edit:
diff --git a/Products/ATContentTypes/skins/ATContentTypes/link_view.pt b/Products/ATContentTypes/skins/ATContentTypes/link_view.pt
index b56d98f..8cca1ba 100644
--- a/Products/ATContentTypes/skins/ATContentTypes/link_view.pt
+++ b/Products/ATContentTypes/skins/ATContentTypes/link_view.pt
@@ -10,7 +10,7 @@
 
     <metal:header fill-slot="global_statusmessage">
         <div class="portalMessage info"
-            tal:define="redirect_links context/portal_properties/site_properties/redirect_links|nothing"
+            tal:define="redirect_links python:context.portal_registry['plone.redirect_links']"
             tal:condition="python: redirect_links and checkPermission('Modify portal content', context)">
             <strong i18n:translate="">Info</strong>
             <span tal:omit-tag=""
diff --git a/Products/ATContentTypes/tests/test_skinScripts.py b/Products/ATContentTypes/tests/test_skinScripts.py
index 2736d74..6f4a418 100644
--- a/Products/ATContentTypes/tests/test_skinScripts.py
+++ b/Products/ATContentTypes/tests/test_skinScripts.py
@@ -39,9 +39,9 @@ def testFormatString(self):
         self.assertEqual(self.script('fkj dsh ekjhsdf kjer'), 'fkj dsh ekjhsdf kjer')
 
     def testFormatTruncates(self):
-        self.portal.portal_properties.site_properties.manage_changeProperties(
-                            search_results_description_length=12, ellipsis='???')
-        self.assertEqual(self.script('fkj dsh ekjhsdf kjer'), 'fkj dsh ekjh???')
+        registry = self.portal.portal_registry
+        registry['plone.search_results_description_length'] = 12
+        self.assertEqual(self.script('fkj dsh ekjhsdf kjer'), 'fkj dsh ekjh...')
 
     def testFormatStrange(self):
         self.assertEqual(self.script(None), '')


