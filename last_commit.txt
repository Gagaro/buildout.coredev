Repository: Products.CMFPlone


Branch: refs/heads/4.3.x
Date: 2015-09-28T15:08:55+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/d1bc251b5ccdd3f4a991aa4544d2d4bc2cc1677e

Purge profile upgrade versions from when applying our default profile.

This signals that nothing has been installed yet, so depencies will
get reapplied instead of possibly upgraded.  This could cause problems
mostly in tests.

Closes #1041 for Plone 4.3.  Backported from 5.0.

Files changed:
M Products/CMFPlone/setuphandlers.py
M docs/CHANGES.rst

diff --git a/Products/CMFPlone/setuphandlers.py b/Products/CMFPlone/setuphandlers.py
index 6908127..c72632a 100644
--- a/Products/CMFPlone/setuphandlers.py
+++ b/Products/CMFPlone/setuphandlers.py
@@ -374,6 +374,14 @@ def setupPortalContent(p):
             assignable.setBlacklistStatus('content_type', True)
 
 
+def purgeProfileVersions(portal):
+    """
+    Purge profile dependency versions.
+    """
+    setup = getToolByName(portal, 'portal_setup')
+    setup._profile_upgrade_versions = {}
+
+
 def setProfileVersion(portal):
     """
     Set profile version.
@@ -445,6 +453,21 @@ def importFinalSteps(context):
     if context.readDataFile('plone-final.txt') is None:
         return
     site = context.getSite()
+
+    # Unset all profile upgrade versions in portal_setup.  Our default
+    # profile should only be applied when creating a new site, so this
+    # list of versions should be empty.  But some tests apply it too.
+    # This should not be done as it should not be needed.  The profile
+    # is a base profile, which means all import steps are run in purge
+    # mode.  So for example an extra workflow added by
+    # plone.app.discussion is purged.  When plone.app.discussion is
+    # still in the list of profile upgrade versions, with the default
+    # dependency strategy it will not be reapplied again, which leaves
+    # you with a site that misses stuff.  So: when applying our
+    # default profile, start with a clean slate in these versions.
+    purgeProfileVersions(site)
+
+    # Set out default profile version.
     setProfileVersion(site)
 
     # Install our dependencies
diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index 66ab14d..d30287b 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -8,7 +8,12 @@ Changelog
 4.3.8 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- Purge profile upgrade versions from portal_setup when applying our
+  default CMFPlone:plone profile.  This signals that nothing has been
+  installed yet, so depencies will get reapplied instead of possibly
+  upgraded.  This could cause problems mostly in tests.  Closes
+  `#1041`_.
+  [maurits]
 
 
 4.3.7 (2015-09-27)
@@ -597,3 +602,5 @@ Changelog
 - Use configuration registry to override translation of date format,
   or fall back to ISO style as last resort. Fixes http://dev.plone.org/ticket/11171
   [kleist]
+
+.. _`#1041`: https://github.com/plone/Products.CMFPlone/issues/1041


Repository: Products.CMFPlone


Branch: refs/heads/4.3.x
Date: 2015-09-28T15:10:54+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/184d7d3c39b21bd5cca6ec3be154eea85e29ac15

Let plone-final import step also depend on the workflow step.

Otherwise the plone-final step installs plone.app.discussion with an
extra workflow, and then our own workflow step throws it away again.

Closes #1041 for Plone 4.3.  Backported from 5.0.

Files changed:
M Products/CMFPlone/exportimport/configure.zcml
M docs/CHANGES.rst

diff --git a/Products/CMFPlone/exportimport/configure.zcml b/Products/CMFPlone/exportimport/configure.zcml
index 9ed90ec..de25568 100644
--- a/Products/CMFPlone/exportimport/configure.zcml
+++ b/Products/CMFPlone/exportimport/configure.zcml
@@ -89,6 +89,7 @@
    <depends name="viewlets" />
    <depends name="controlpanel" />
    <depends name="propertiestool" />
+   <depends name="workflow" />
   </genericsetup:importStep>
 
   <genericsetup:importStep
diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index d30287b..bd2b5a5 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -8,6 +8,12 @@ Changelog
 4.3.8 (unreleased)
 ------------------
 
+- Let plone-final import step also depend on the workflow step.
+  Otherwise the plone-final step installs plone.app.discussion with an
+  extra workflow, and then our own workflow step throws it away again.
+  Closes `#1041`_.
+  [maurits]
+
 - Purge profile upgrade versions from portal_setup when applying our
   default CMFPlone:plone profile.  This signals that nothing has been
   installed yet, so depencies will get reapplied instead of possibly


