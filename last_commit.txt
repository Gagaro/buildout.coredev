Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-06-26T14:32:03-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/b807876e3e7185a024f3d1f5e18fca3685848a41

better formatting of config.js

Files changed:
M CHANGES.rst
M Products/CMFPlone/resources/browser/configjs.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 84dbe13..d16f58a 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -8,6 +8,9 @@ Changelog
 5.0b3 (unreleased)
 ------------------
 
+- better formatting of config.js
+  [vangheem]
+
 - Upload pattern uses the baseUrl to compute the upload URL, so this should
   always be the site root and not the current context
   [frapell]
diff --git a/Products/CMFPlone/resources/browser/configjs.py b/Products/CMFPlone/resources/browser/configjs.py
index 013e660..753d764 100644
--- a/Products/CMFPlone/resources/browser/configjs.py
+++ b/Products/CMFPlone/resources/browser/configjs.py
@@ -4,17 +4,10 @@
 from zope.component import getMultiAdapter
 from zope.component import getUtility
 import re
+import json
 
 
-configjs = """requirejs.config({
-    baseUrl: '%s',
-    paths: %s,
-    shim: %s,
-    optimize: 'uglify',
-    wrapShim: true
-});
-
-"""
+configjs = """requirejs.config(%s);"""
 
 
 class RequireJsView(BrowserView):
@@ -69,19 +62,18 @@ def get_requirejs_config(self):
                 paths[name + '-url'] = src
         return (self.base_url(), paths, shims)
 
-    def get_requirejs_config_str(self):
-        base, paths, shims = self.get_requirejs_config()
-        shims_str = str(shims).replace('\'deps\'', 'deps').replace(
-            '\'exports\'', 'exports').replace(
-            '\'init\': \'', 'init: ').replace('}\'}', '}}')
-        return (self.base_url(), str(paths), shims_str)
-
 
 class ConfigJsView(RequireJsView):
     """ config.js for requirejs for script rendering. """
 
     def __call__(self):
-        (baseUrl, paths, shims) = self.get_requirejs_config_str()
+        (baseUrl, paths, shims) = self.get_requirejs_config()
         self.request.response.setHeader("Content-Type",
                                         "application/javascript")
-        return configjs % (baseUrl, paths, shims)
+        return configjs % json.dumps({
+            'baseUrl': baseUrl,
+            'paths': paths,
+            'shim': shims,
+            'optimize': 'uglify',
+            'wrapShim': True
+        }, indent=4)


