Repository: plone.app.event


Branch: refs/heads/master
Date: 2015-10-17T00:48:20+03:00
Author: Johannes Raggam (thet) <raggam-nl@adm.at>
Commit: https://github.com/plone/plone.app.event/commit/861b609a11c2f4f4c185d32aaa399c32fadc4727

Fix the occurrences calculation to reliably return an Event instead of Occurrence object for the originating event. There was a bug introduced by a newer pytz version.

Files changed:
M CHANGES.rst
M plone/app/event/recurrence.py

diff --git a/CHANGES.rst b/CHANGES.rst
index d38f3b1..05e67d8 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,10 @@ Changelog
 2.0.4 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- Fix the occurrences calculation to reliably return an Event instead of
+  Occurrence object for the originating event. There was a bug introduced by a
+  newer pytz version.
+  [thet]
 
 
 2.0.3 (2015-09-27)
diff --git a/plone/app/event/recurrence.py b/plone/app/event/recurrence.py
index 69b7dc4..ddcd410 100644
--- a/plone/app/event/recurrence.py
+++ b/plone/app/event/recurrence.py
@@ -9,6 +9,7 @@
 from plone.event.interfaces import IRecurrenceSupport
 from plone.event.recurrence import recurrence_sequence_ical
 from plone.event.utils import is_same_day
+from plone.event.utils import pydt
 from plone.namedfile.interfaces import IImageScaleTraversable
 from plone.namedfile.scaling import ImageScaling
 from zope.component import adapter
@@ -66,7 +67,7 @@ def occurrences(self, range_start=None, range_end=None):
         # but doing it for backwards compatibility as views/templates
         # still rely on acquisition-wrapped objects.
         def get_obj(start):
-            if event.start.replace(microsecond=0) == start:
+            if pydt(event.start.replace(microsecond=0)) == start:
                 # If the occurrence date is the same as the event object, the
                 # occurrence is the event itself. return it as such.
                 # Dates from recurrence_sequence_ical are explicitly without


Repository: plone.app.event


Branch: refs/heads/master
Date: 2015-10-17T00:48:32+03:00
Author: Johannes Raggam (thet) <raggam-nl@adm.at>
Commit: https://github.com/plone/plone.app.event/commit/00a5c89a3a8c9c06d0d33ff988f6d42f3771c18f

remove unused import and sort case insensitive

Files changed:
M plone/app/event/tests/test_recurrence.py

diff --git a/plone/app/event/tests/test_recurrence.py b/plone/app/event/tests/test_recurrence.py
index 35b7d44..8f36cf8 100644
--- a/plone/app/event/tests/test_recurrence.py
+++ b/plone/app/event/tests/test_recurrence.py
@@ -1,30 +1,28 @@
+from mock import Mock
 from OFS.SimpleItem import SimpleItem
-from plone.app.event.base import RET_MODE_ACCESSORS
 from plone.app.event.base import get_events
+from plone.app.event.base import RET_MODE_ACCESSORS
 from plone.app.event.dx.traverser import OccurrenceTraverser
 from plone.app.event.recurrence import Occurrence
+from plone.app.event.testing import PAEvent_INTEGRATION_TESTING
 from plone.app.event.testing import PAEventDX_FUNCTIONAL_TESTING
 from plone.app.event.testing import PAEventDX_INTEGRATION_TESTING
-from plone.app.event.testing import PAEvent_INTEGRATION_TESTING
 from plone.app.event.testing import set_browserlayer
 from plone.app.event.testing import set_env_timezone
 from plone.app.event.testing import set_timezone
 from plone.app.event.tests.base_setup import AbstractSampleDataEvents
 from plone.app.event.tests.base_setup import patched_now
-from plone.app.testing import TEST_USER_ID, TEST_USER_PASSWORD
 from plone.app.testing import setRoles
+from plone.app.testing import TEST_USER_ID, TEST_USER_PASSWORD
 from plone.dexterity.utils import createContentInContainer
 from plone.event.interfaces import IEvent
 from plone.event.interfaces import IEventAccessor
 from plone.event.interfaces import IEventRecurrence
 from plone.event.interfaces import IOccurrence
 from plone.event.interfaces import IRecurrenceSupport
-from plone.namedfile.interfaces import IImageScaleTraversable
 from plone.testing.z2 import Browser
 from zope.interface import alsoProvides
 from zope.publisher.interfaces.browser import IBrowserView
-from mock import Mock
-
 import datetime
 import pytz
 import transaction


