Repository: plone.app.vocabularies
Branch: refs/heads/master
Date: 2015-03-30T16:11:07+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.vocabularies/commit/b22545ee6bb1b7bd0f81485bbf6e9851a8583cf9

Fix issue when using plone.app.vocabularies.Users in a single-choice-field

Files changed:
M CHANGES.rst
M plone/app/vocabularies/users.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 5861946..e6d7a9c 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,8 @@ Changelog
 2.1.17 (unreleased)
 -------------------
 
-- Nothing changed yet.
+- Fix issue with missing context in plone.app.vocabularies.Users.
+  [pbauer]
 
 
 2.1.16 (2014-09-07)
diff --git a/plone/app/vocabularies/users.py b/plone/app/vocabularies/users.py
index 659ebdc..835ef0e 100644
--- a/plone/app/vocabularies/users.py
+++ b/plone/app/vocabularies/users.py
@@ -1,18 +1,15 @@
+# -*- coding: utf-8 -*-
+from Products.CMFCore.utils import getToolByName
+from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile
+from plone.app.vocabularies import SlicableVocabulary
 from zope.browser.interfaces import ITerms
-from zope.interface import directlyProvides
+from zope.component.hooks import getSite
+from zope.formlib.interfaces import ISourceQueryView
 from zope.interface import implements, classProvides
 from zope.schema.interfaces import ISource, IContextSourceBinder
-from zope.schema.interfaces import IVocabularyTokenized
 from zope.schema.interfaces import IVocabularyFactory
 from zope.schema.vocabulary import SimpleTerm
 
-from zope.formlib.interfaces import ISourceQueryView
-
-from Products.CMFCore.utils import getToolByName
-from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile
-
-from plone.app.vocabularies import SlicableVocabulary
-
 
 class UsersSource(object):
     """
@@ -109,8 +106,11 @@ class UsersFactory(object):
     implements(IVocabularyFactory)
 
     def __call__(self, context, query=''):
+        if context is None:
+            context = getSite()
         users = getToolByName(context, "acl_users")
-        return UsersVocabulary.fromItems(users.searchUsers(fullname=query), context)
+        return UsersVocabulary.fromItems(
+            users.searchUsers(fullname=query), context)
 
 
 class UsersSourceQueryView(object):


Repository: plone.app.vocabularies
Branch: refs/heads/master
Date: 2015-03-31T10:57:25+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.vocabularies/commit/ecdea695dea956cf99c1c2a958a1af5af836f07f

Merge pull request #12 from plone/missing-context

Fix issue with missing context

Files changed:
M CHANGES.rst
M plone/app/vocabularies/users.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 5861946..e6d7a9c 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,8 @@ Changelog
 2.1.17 (unreleased)
 -------------------
 
-- Nothing changed yet.
+- Fix issue with missing context in plone.app.vocabularies.Users.
+  [pbauer]
 
 
 2.1.16 (2014-09-07)
diff --git a/plone/app/vocabularies/users.py b/plone/app/vocabularies/users.py
index 659ebdc..835ef0e 100644
--- a/plone/app/vocabularies/users.py
+++ b/plone/app/vocabularies/users.py
@@ -1,18 +1,15 @@
+# -*- coding: utf-8 -*-
+from Products.CMFCore.utils import getToolByName
+from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile
+from plone.app.vocabularies import SlicableVocabulary
 from zope.browser.interfaces import ITerms
-from zope.interface import directlyProvides
+from zope.component.hooks import getSite
+from zope.formlib.interfaces import ISourceQueryView
 from zope.interface import implements, classProvides
 from zope.schema.interfaces import ISource, IContextSourceBinder
-from zope.schema.interfaces import IVocabularyTokenized
 from zope.schema.interfaces import IVocabularyFactory
 from zope.schema.vocabulary import SimpleTerm
 
-from zope.formlib.interfaces import ISourceQueryView
-
-from Products.CMFCore.utils import getToolByName
-from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile
-
-from plone.app.vocabularies import SlicableVocabulary
-
 
 class UsersSource(object):
     """
@@ -109,8 +106,11 @@ class UsersFactory(object):
     implements(IVocabularyFactory)
 
     def __call__(self, context, query=''):
+        if context is None:
+            context = getSite()
         users = getToolByName(context, "acl_users")
-        return UsersVocabulary.fromItems(users.searchUsers(fullname=query), context)
+        return UsersVocabulary.fromItems(
+            users.searchUsers(fullname=query), context)
 
 
 class UsersSourceQueryView(object):


