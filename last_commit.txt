Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-09-17T19:19:50+03:00
Author: ichim-david (ichim-david) <ichim.david@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/c8844143769bb81ed09542b1ac5d9f72622190b7

Refs #950 fix missing personal toolbar on expanded horizontal menu:

- Add content views from right to left to options subset until
  personal toolbar fits on the same line as the other menus
- Cleaned hideElements of duplicated selectors
- Take into consideration that you could go from a width that can't
  fit the toolbar to a view that is even smaller.
  This happens when using a Samsung galaxy 10 resolution of 1280x800.
  On german translation both resolutions can't display fully the toolbar
  however on the smaller size we need to hide even more items as such
  moving also the content views and not only the content menus

Files changed:
M Products/CMFPlone/static/patterns/toolbar/src/toolbar.js

diff --git a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
index 67ea3d5..7ed3812 100644
--- a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
+++ b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
@@ -216,43 +216,69 @@ define([
         expanded: that.state.expanded
       }), {path: '/'});
     },
+    moveViewsToSubset: function($container, $views, $subset) {
+      var i, $content_view, length = $views.length - 1;
+      if ($container.offset().top !== 0) {
+        for (i = length; length >= 0; length -= 1) {
+          $content_view = $views.eq(i);
+          $content_view.hide().clone(true, true).appendTo($subset).show();
+          if ($container.offset().top === 0) {
+            break;
+          }
+        }
+      }
+    },
     hideElements: function(){
+      var that = this;
       if(this.state.left){
         // only when on top
         return;
       }
       var w = $('.plone-toolbar-container').width(),
           wtc = $('.plone-toolbar-logo').width();
-      $( ".plone-toolbar-main > li" ).each(function() {
-        wtc += $(this).width();
+      var $plone_toolbar_main =  $( ".plone-toolbar-main");
+      var $toolbar_menus = $plone_toolbar_main.find("> li" );
+      $toolbar_menus.each(function() {
+          wtc += $(this).width();
       });
-
-      $('#personal-bar-container > li').each(function() {
+      var $pers_bar_container = $('#personal-bar-container');
+      $pers_bar_container.find('> li').each(function() {
         wtc += $(this).width();
       });
-      wtc -= $('#plone-toolbar-more-options').width();
+      var $toolbar_more_options = $('#plone-toolbar-more-options');
+      wtc -= $toolbar_more_options.width();
+      var $content_menus = $toolbar_menus.filter($('[id^="plone-contentmenu-"]'));
+      var $content_views = $toolbar_menus.filter($('[id^="contentview-"]'));
       if (w < wtc) {
-        if (!($('#plone-toolbar-more-options').length)) {
-          $('[id^="plone-contentmenu-"]').hide();
-          $('.plone-toolbar-main').append('<li id="plone-toolbar-more-options"><a href="#"><span class="icon-moreOptions" aria-hidden="true"></span><span>' + _t('More') + '</span><span class="plone-toolbar-caret"></span></a></li>');
-          $('#personal-bar-container').after('<ul id="plone-toolbar-more-subset" style="display: none"></ul>');
-          // we want only the list items with id that contains plone-contentmenu and not the children links
-          // of these lists therefore we iterate only over the list elements
-          $("li[id^=plone-contentmenu-]").each(function() {
-            $(this).clone(true, true).appendTo( "#plone-toolbar-more-subset" );
-            $('[id^=plone-contentmenu-]', '#plone-toolbar-more-subset').show();
-          });
-          $('#plone-toolbar-more-options a').on('click', function(event){
-            event.preventDefault();
-            $('#plone-toolbar-more-subset').toggle();
-          });
+        if (!($toolbar_more_options.length)) {
+          (function(){
+            $content_menus.hide();
+            $toolbar_more_options = $('<li id="plone-toolbar-more-options"><a href="#"><span class="icon-moreOptions" aria-hidden="true"></span><span>' + _t('More') + '</span><span class="plone-toolbar-caret"></span></a></li>');
+            $plone_toolbar_main.append($toolbar_more_options);
+            var $toolbar_more_subset = $('<ul id="plone-toolbar-more-subset" style="display: none"></ul>');
+            $pers_bar_container.after($toolbar_more_subset);
+            // we want only the list items with id that contains plone-contentmenu and not the children links
+            // of these lists therefore we iterate only over the list elements
+            $content_menus.each(function() {
+              $(this).clone(true, true).show().appendTo($toolbar_more_subset);
+            });
+
+            that.moveViewsToSubset($pers_bar_container, $content_views, $toolbar_more_subset);
+
+            $toolbar_more_options.find('a').on('click', function(event){
+              event.preventDefault();
+              $toolbar_more_subset.toggle();
+            });
+          })();
         }
       } else {
-        $('[id^="plone-contentmenu-"]').show();
-        $('#plone-toolbar-more-options').remove();
+        $toolbar_more_options.remove();
         $('#plone-toolbar-more-subset').remove();
+        $plone_toolbar_main.children().show();
+      }
+      if ($pers_bar_container.offset().top !== 0) {
+        that.moveViewsToSubset($pers_bar_container, $content_views, $("#plone-toolbar-more-subset"));
       }
-
     },
     init: function () {
       var that = this;
@@ -306,7 +332,7 @@ define([
           that.setupMobile();
         }
       });
-    },
+    }
 
   });
 


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-09-17T19:19:50+03:00
Author: ichim-david (ichim-david) <ichim.david@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/874855dbfdf841fff1f83d9862df1506facf70a4

Refs #950 cleaned the following for toolbar pattern:

- moveViewsToSubset now has a clearer condition name for the moving
  of the view to the subset
- run the hideElements action when clicking on the toobar logo to
  expand the toolbar. If it needs to resize it will, otherwise nothing
  will happen

Files changed:
M Products/CMFPlone/static/patterns/toolbar/src/toolbar.js

diff --git a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
index 7ed3812..d71cad6 100644
--- a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
+++ b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
@@ -106,6 +106,7 @@ define([
             $('body').addClass(that.options.classNames.topExpanded);
             $('body').removeClass(that.options.classNames.topDefault);
           }
+          that.hideElements();
         }
       });
 
@@ -218,7 +219,8 @@ define([
     },
     moveViewsToSubset: function($container, $views, $subset) {
       var i, $content_view, length = $views.length - 1;
-      if ($container.offset().top !== 0) {
+      var view_should_move = $container.offset().top !== 0;
+      if (view_should_move) {
         for (i = length; length >= 0; length -= 1) {
           $content_view = $views.eq(i);
           $content_view.hide().clone(true, true).appendTo($subset).show();
@@ -276,6 +278,8 @@ define([
         $('#plone-toolbar-more-subset').remove();
         $plone_toolbar_main.children().show();
       }
+      // check if the personal toolbar is not offseted if there isn't enough space
+      // and we already have the plone-toolbar-more-options added to the page.
       if ($pers_bar_container.offset().top !== 0) {
         that.moveViewsToSubset($pers_bar_container, $content_views, $("#plone-toolbar-more-subset"));
       }


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-09-17T19:19:50+03:00
Author: ichim-david (ichim-david) <ichim.david@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/4fd7ee0c504470f982251d7807253c6b645d93ba

Refs #950; fix the moving of views when zooming:

- jQuery offset returns strange results when zooming as appose
  to normal offsetTop which we use to calculate whether the
  personal toolbar is moved
- Move only the views that are not already hidden avoiding thus
  duplications if there is more than one view to move to the more
  section

Files changed:
M Products/CMFPlone/static/patterns/toolbar/src/toolbar.js

diff --git a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
index d71cad6..41afc89 100644
--- a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
+++ b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
@@ -218,13 +218,19 @@ define([
       }), {path: '/'});
     },
     moveViewsToSubset: function($container, $views, $subset) {
-      var i, $content_view, length = $views.length - 1;
-      var view_should_move = $container.offset().top !== 0;
+      var i, $content_view,
+          container = $container[0],
+          length = $views.length - 1;
+
+      var view_should_move = container.offsetTop !== 0;
       if (view_should_move) {
         for (i = length; length >= 0; length -= 1) {
           $content_view = $views.eq(i);
+          if ($content_view.is(":hidden")) {
+            continue;
+          }
           $content_view.hide().clone(true, true).appendTo($subset).show();
-          if ($container.offset().top === 0) {
+          if ($container.offsetTop === 0) {
             break;
           }
         }
@@ -280,7 +286,7 @@ define([
       }
       // check if the personal toolbar is not offseted if there isn't enough space
       // and we already have the plone-toolbar-more-options added to the page.
-      if ($pers_bar_container.offset().top !== 0) {
+      if ($pers_bar_container[0].offsetTop !== 0) {
         that.moveViewsToSubset($pers_bar_container, $content_views, $("#plone-toolbar-more-subset"));
       }
     },


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-09-17T19:19:50+03:00
Author: ichim-david (ichim-david) <ichim.david@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/e64115c3d53584198a06b82cb735de188d0654f2

Refs #950 fixed the following toolbar bugs:

- Properly set the active class on the toolbar menu list item when
  clicking on the more link
- Fixed case where the more button lost it's active class when clicking
  on the children content menus.
- Clicking on the body now hides also the opened more sublist
- Fixed a case where the more sublist remained opened even when you were
  clicking on the white portal-header area because the nav bar expands
  in height to fit the sublist even though it's black styling remains
  at 50px
- Fixed an issue where clicking on the sublist content menus removed the
  active class from the more link

Files changed:
M Products/CMFPlone/static/patterns/toolbar/src/toolbar.js

diff --git a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
index 41afc89..db8f493 100644
--- a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
+++ b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
@@ -114,25 +114,43 @@ define([
         event.stopImmediatePropagation();
       });
 
-      // active
+      // content menu activated
       $('nav > ul > li', that.$container).has( 'a .plone-toolbar-caret' ).off('click').on('click', function(event) {
+        var $this = $(this);
+        var active_class = that.options.classNames.active;
         event.preventDefault();
         event.stopPropagation();
-        var hasClass = $(this).hasClass(that.options.classNames.active);
-        // always close existing
-        $('nav li', that.$container).removeClass(that.options.classNames.active);
+        var hasClass = $this.hasClass(active_class);
+        var $more_subset = $this.parent("#plone-toolbar-more-subset");
+        if ($more_subset.length) {
+          // close only the content menus from the subset, keeping the toolbar more list active
+          $more_subset.find('li').filter('[id*="contentmenu-"]').removeClass(active_class);
+        }
+        else {
+          // close existing opened contentmenus
+          $('nav li', that.$container).removeClass(active_class);
+        }
         $('nav li > ul', $(this)).css({'margin-top': ''}); // unset this so we get fly-in affect
         if (!hasClass) {
           // open current selected if not already open
-          $(this).addClass(that.options.classNames.active);
-          that.padPulloutContent($(this));
+          $this.addClass(active_class);
+          that.padPulloutContent($this);
         }
       });
 
       $('body').on('click', function(event) {
-        if (!($(this).parent(that.options.containerSelector).length > 0)) {
+        var $el = that.$container.find(event.target);
+        // we need to check if the target isn't the nav which can be
+        // triggered if we click on the portal-header and plone-toolbar-more-subset
+        // is visible which enlarges the nav. In this case we want to hide the
+        // active lists because the user assumes that he targeted an element outside
+        // the edit-bar
+        if (!$el.length || $el.prop("tagName") === "NAV") {
           $('nav > ul > li', that.$container).each(function(key, element){
             $(element).removeClass(that.options.classNames.active);
+            // we need to close the more subset as well not just the content-menus
+            // when we click on the body area
+            $("#plone-toolbar-more-subset").hide();
           });
         }
       });
@@ -274,8 +292,11 @@ define([
             that.moveViewsToSubset($pers_bar_container, $content_views, $toolbar_more_subset);
 
             $toolbar_more_options.find('a').on('click', function(event){
-              event.preventDefault();
+              var $more_list = $(this).parent();
+              // properly toggle active class for toolbar_more list item
+              $more_list.toggleClass('active', $toolbar_more_subset.is(":hidden"));
               $toolbar_more_subset.toggle();
+              event.preventDefault();
             });
           })();
         }


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-09-17T19:19:51+03:00
Author: ichim-david (ichim-david) <ichim.david@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/cbea5d67b94e17dcaa24142e4555389aca6665d8

Refs #950; fixed the following toolbar issues:

- Menus are now closed when switching from expanded to contracted
  and back
- Clicking the personal bar link now closes the subset menu as well
- Fixed the position of the subset menus when collapsed by removing
  the hardcoded value of 105px from toolbar.plone.less

Files changed:
M Products/CMFPlone/static/patterns/toolbar/src/css/toolbar.plone.less
M Products/CMFPlone/static/patterns/toolbar/src/toolbar.js

diff --git a/Products/CMFPlone/static/patterns/toolbar/src/css/toolbar.plone.less b/Products/CMFPlone/static/patterns/toolbar/src/css/toolbar.plone.less
index ec17f58..65060e2 100644
--- a/Products/CMFPlone/static/patterns/toolbar/src/css/toolbar.plone.less
+++ b/Products/CMFPlone/static/patterns/toolbar/src/css/toolbar.plone.less
@@ -331,12 +331,10 @@ body.userrole-authenticated {
         overflow-y: auto;
         height: 0;
     }
-    #plone-toolbar-more-subset > li ul {
-        top: 105px;
-    }
     nav > ul li.active ul {
         height: inherit;
         max-height: 1000px; // trick to activate transition
+        top: auto;
     }
     li.active > a:after {
         border-bottom: 10px solid #2a2a2a;
diff --git a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
index db8f493..214d0bf 100644
--- a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
+++ b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
@@ -106,8 +106,8 @@ define([
             $('body').addClass(that.options.classNames.topExpanded);
             $('body').removeClass(that.options.classNames.topDefault);
           }
-          that.hideElements();
         }
+        that.hideElements();
       });
 
       $('nav > ul > li li', that.$container).off('click').on('click', function(event) {
@@ -128,7 +128,10 @@ define([
         }
         else {
           // close existing opened contentmenus
-          $('nav li', that.$container).removeClass(active_class);
+          $('.' + active_class, that.$container).removeClass(active_class);
+          // we need to close the more subset as well not just the content-menus
+          // when we click on the personal bar
+          $("#plone-toolbar-more-subset").hide();
         }
         $('nav li > ul', $(this)).css({'margin-top': ''}); // unset this so we get fly-in affect
         if (!hasClass) {
@@ -290,8 +293,11 @@ define([
             });
 
             that.moveViewsToSubset($pers_bar_container, $content_views, $toolbar_more_subset);
-
+            var active_class = that.options.classNames.active;
             $toolbar_more_options.find('a').on('click', function(event){
+              // close existing opened contentmenus
+              $('.' + active_class, that.$container).removeClass(active_class);
+
               var $more_list = $(this).parent();
               // properly toggle active class for toolbar_more list item
               $more_list.toggleClass('active', $toolbar_more_subset.is(":hidden"));


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-09-17T19:34:06+03:00
Author: ichim-david (ichim-david) <ichim.david@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/6053718d2469c60e2fb90eef6ea9b5ca24d8604a

Refs #950; fix condition for adding views to subset

Files changed:
M Products/CMFPlone/static/patterns/toolbar/src/toolbar.js

diff --git a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
index 214d0bf..127c616 100644
--- a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
+++ b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
@@ -251,7 +251,7 @@ define([
             continue;
           }
           $content_view.hide().clone(true, true).appendTo($subset).show();
-          if ($container.offsetTop === 0) {
+          if (container.offsetTop === 0) {
             break;
           }
         }


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-09-17T19:37:03+03:00
Author: ichim-david (ichim-david) <ichim.david@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/2fe86b4ec4ec9a16ddd17e92ad64fca91a28443e

Refs #950; move hiding of more-subset out of list loop

Files changed:
M Products/CMFPlone/static/patterns/toolbar/src/toolbar.js

diff --git a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
index 127c616..53eff03 100644
--- a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
+++ b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
@@ -151,10 +151,10 @@ define([
         if (!$el.length || $el.prop("tagName") === "NAV") {
           $('nav > ul > li', that.$container).each(function(key, element){
             $(element).removeClass(that.options.classNames.active);
-            // we need to close the more subset as well not just the content-menus
-            // when we click on the body area
-            $("#plone-toolbar-more-subset").hide();
           });
+          // we need to close the more subset as well not just the content-menus
+          // when we click on the body area
+          $("#plone-toolbar-more-subset").hide();
         }
       });
       that.setHeight();


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-09-17T19:49:23+03:00
Author: ichim-david (ichim-david) <ichim.david@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/783ff837571039bb26f4aa5f7efa5eb0f976d55f

Refs #950 remove jQuery call from filter to avoid extra search

Files changed:
M Products/CMFPlone/static/patterns/toolbar/src/toolbar.js

diff --git a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
index 53eff03..036b895 100644
--- a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
+++ b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
@@ -276,8 +276,8 @@ define([
       });
       var $toolbar_more_options = $('#plone-toolbar-more-options');
       wtc -= $toolbar_more_options.width();
-      var $content_menus = $toolbar_menus.filter($('[id^="plone-contentmenu-"]'));
-      var $content_views = $toolbar_menus.filter($('[id^="contentview-"]'));
+      var $content_menus = $toolbar_menus.filter('[id^="plone-contentmenu-"]');
+      var $content_views = $toolbar_menus.filter('[id^="contentview-"]');
       if (w < wtc) {
         if (!($toolbar_more_options.length)) {
           (function(){


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-09-17T19:52:36+03:00
Author: ichim-david (ichim-david) <ichim.david@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/ba6d7f5cebf90f76d842aa2fcef9083d3851d534

Refs #950 rename moveViewsToSubset to cloneViewsIntoSubset which describes better the use of the method

Files changed:
M Products/CMFPlone/static/patterns/toolbar/src/toolbar.js

diff --git a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
index 036b895..561907d 100644
--- a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
+++ b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
@@ -238,7 +238,7 @@ define([
         expanded: that.state.expanded
       }), {path: '/'});
     },
-    moveViewsToSubset: function($container, $views, $subset) {
+    cloneViewsIntoSubset: function($container, $views, $subset) {
       var i, $content_view,
           container = $container[0],
           length = $views.length - 1;
@@ -292,7 +292,7 @@ define([
               $(this).clone(true, true).show().appendTo($toolbar_more_subset);
             });
 
-            that.moveViewsToSubset($pers_bar_container, $content_views, $toolbar_more_subset);
+            that.cloneViewsIntoSubset($pers_bar_container, $content_views, $toolbar_more_subset);
             var active_class = that.options.classNames.active;
             $toolbar_more_options.find('a').on('click', function(event){
               // close existing opened contentmenus
@@ -314,7 +314,7 @@ define([
       // check if the personal toolbar is not offseted if there isn't enough space
       // and we already have the plone-toolbar-more-options added to the page.
       if ($pers_bar_container[0].offsetTop !== 0) {
-        that.moveViewsToSubset($pers_bar_container, $content_views, $("#plone-toolbar-more-subset"));
+        that.cloneViewsIntoSubset($pers_bar_container, $content_views, $("#plone-toolbar-more-subset"));
       }
     },
     init: function () {


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-09-17T21:31:31+03:00
Author: ichim-david (ichim-david) <ichim.david@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/d836a779ad9d89444772edafcafaba057ecd7142

Refs #950 added Changes.rst entry

Files changed:
M CHANGES.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index 68c1bf4..03fdc4d 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -8,6 +8,9 @@ Changelog
 5.0rc3 (unreleased)
 -------------------
 
+- Fix #950: Missing personal toolbar when expanding the horizontal toolbar
+  [ichim-david]
+
 - Make sure portal_actions are imported before default portlets. Fixes #1015
   [vangheem]
 


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-09-17T19:32:18+01:00
Author: ichim-david (ichim-david) <ichim.david@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/c5a1795fc509517264c41e192d5593c52aaa6292

Merge pull request #1009 from plone/fix950

Fix950 Missing personal toolbar

Files changed:
M CHANGES.rst
M Products/CMFPlone/static/patterns/toolbar/src/css/toolbar.plone.less
M Products/CMFPlone/static/patterns/toolbar/src/toolbar.js

diff --git a/CHANGES.rst b/CHANGES.rst
index 68c1bf4..03fdc4d 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -8,6 +8,9 @@ Changelog
 5.0rc3 (unreleased)
 -------------------
 
+- Fix #950: Missing personal toolbar when expanding the horizontal toolbar
+  [ichim-david]
+
 - Make sure portal_actions are imported before default portlets. Fixes #1015
   [vangheem]
 
diff --git a/Products/CMFPlone/static/patterns/toolbar/src/css/toolbar.plone.less b/Products/CMFPlone/static/patterns/toolbar/src/css/toolbar.plone.less
index ec17f58..65060e2 100644
--- a/Products/CMFPlone/static/patterns/toolbar/src/css/toolbar.plone.less
+++ b/Products/CMFPlone/static/patterns/toolbar/src/css/toolbar.plone.less
@@ -331,12 +331,10 @@ body.userrole-authenticated {
         overflow-y: auto;
         height: 0;
     }
-    #plone-toolbar-more-subset > li ul {
-        top: 105px;
-    }
     nav > ul li.active ul {
         height: inherit;
         max-height: 1000px; // trick to activate transition
+        top: auto;
     }
     li.active > a:after {
         border-bottom: 10px solid #2a2a2a;
diff --git a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
index 67ea3d5..561907d 100644
--- a/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
+++ b/Products/CMFPlone/static/patterns/toolbar/src/toolbar.js
@@ -107,32 +107,54 @@ define([
             $('body').removeClass(that.options.classNames.topDefault);
           }
         }
+        that.hideElements();
       });
 
       $('nav > ul > li li', that.$container).off('click').on('click', function(event) {
         event.stopImmediatePropagation();
       });
 
-      // active
+      // content menu activated
       $('nav > ul > li', that.$container).has( 'a .plone-toolbar-caret' ).off('click').on('click', function(event) {
+        var $this = $(this);
+        var active_class = that.options.classNames.active;
         event.preventDefault();
         event.stopPropagation();
-        var hasClass = $(this).hasClass(that.options.classNames.active);
-        // always close existing
-        $('nav li', that.$container).removeClass(that.options.classNames.active);
+        var hasClass = $this.hasClass(active_class);
+        var $more_subset = $this.parent("#plone-toolbar-more-subset");
+        if ($more_subset.length) {
+          // close only the content menus from the subset, keeping the toolbar more list active
+          $more_subset.find('li').filter('[id*="contentmenu-"]').removeClass(active_class);
+        }
+        else {
+          // close existing opened contentmenus
+          $('.' + active_class, that.$container).removeClass(active_class);
+          // we need to close the more subset as well not just the content-menus
+          // when we click on the personal bar
+          $("#plone-toolbar-more-subset").hide();
+        }
         $('nav li > ul', $(this)).css({'margin-top': ''}); // unset this so we get fly-in affect
         if (!hasClass) {
           // open current selected if not already open
-          $(this).addClass(that.options.classNames.active);
-          that.padPulloutContent($(this));
+          $this.addClass(active_class);
+          that.padPulloutContent($this);
         }
       });
 
       $('body').on('click', function(event) {
-        if (!($(this).parent(that.options.containerSelector).length > 0)) {
+        var $el = that.$container.find(event.target);
+        // we need to check if the target isn't the nav which can be
+        // triggered if we click on the portal-header and plone-toolbar-more-subset
+        // is visible which enlarges the nav. In this case we want to hide the
+        // active lists because the user assumes that he targeted an element outside
+        // the edit-bar
+        if (!$el.length || $el.prop("tagName") === "NAV") {
           $('nav > ul > li', that.$container).each(function(key, element){
             $(element).removeClass(that.options.classNames.active);
           });
+          // we need to close the more subset as well not just the content-menus
+          // when we click on the body area
+          $("#plone-toolbar-more-subset").hide();
         }
       });
       that.setHeight();
@@ -216,43 +238,84 @@ define([
         expanded: that.state.expanded
       }), {path: '/'});
     },
+    cloneViewsIntoSubset: function($container, $views, $subset) {
+      var i, $content_view,
+          container = $container[0],
+          length = $views.length - 1;
+
+      var view_should_move = container.offsetTop !== 0;
+      if (view_should_move) {
+        for (i = length; length >= 0; length -= 1) {
+          $content_view = $views.eq(i);
+          if ($content_view.is(":hidden")) {
+            continue;
+          }
+          $content_view.hide().clone(true, true).appendTo($subset).show();
+          if (container.offsetTop === 0) {
+            break;
+          }
+        }
+      }
+    },
     hideElements: function(){
+      var that = this;
       if(this.state.left){
         // only when on top
         return;
       }
       var w = $('.plone-toolbar-container').width(),
           wtc = $('.plone-toolbar-logo').width();
-      $( ".plone-toolbar-main > li" ).each(function() {
-        wtc += $(this).width();
+      var $plone_toolbar_main =  $( ".plone-toolbar-main");
+      var $toolbar_menus = $plone_toolbar_main.find("> li" );
+      $toolbar_menus.each(function() {
+          wtc += $(this).width();
       });
-
-      $('#personal-bar-container > li').each(function() {
+      var $pers_bar_container = $('#personal-bar-container');
+      $pers_bar_container.find('> li').each(function() {
         wtc += $(this).width();
       });
-      wtc -= $('#plone-toolbar-more-options').width();
+      var $toolbar_more_options = $('#plone-toolbar-more-options');
+      wtc -= $toolbar_more_options.width();
+      var $content_menus = $toolbar_menus.filter('[id^="plone-contentmenu-"]');
+      var $content_views = $toolbar_menus.filter('[id^="contentview-"]');
       if (w < wtc) {
-        if (!($('#plone-toolbar-more-options').length)) {
-          $('[id^="plone-contentmenu-"]').hide();
-          $('.plone-toolbar-main').append('<li id="plone-toolbar-more-options"><a href="#"><span class="icon-moreOptions" aria-hidden="true"></span><span>' + _t('More') + '</span><span class="plone-toolbar-caret"></span></a></li>');
-          $('#personal-bar-container').after('<ul id="plone-toolbar-more-subset" style="display: none"></ul>');
-          // we want only the list items with id that contains plone-contentmenu and not the children links
-          // of these lists therefore we iterate only over the list elements
-          $("li[id^=plone-contentmenu-]").each(function() {
-            $(this).clone(true, true).appendTo( "#plone-toolbar-more-subset" );
-            $('[id^=plone-contentmenu-]', '#plone-toolbar-more-subset').show();
-          });
-          $('#plone-toolbar-more-options a').on('click', function(event){
-            event.preventDefault();
-            $('#plone-toolbar-more-subset').toggle();
-          });
+        if (!($toolbar_more_options.length)) {
+          (function(){
+            $content_menus.hide();
+            $toolbar_more_options = $('<li id="plone-toolbar-more-options"><a href="#"><span class="icon-moreOptions" aria-hidden="true"></span><span>' + _t('More') + '</span><span class="plone-toolbar-caret"></span></a></li>');
+            $plone_toolbar_main.append($toolbar_more_options);
+            var $toolbar_more_subset = $('<ul id="plone-toolbar-more-subset" style="display: none"></ul>');
+            $pers_bar_container.after($toolbar_more_subset);
+            // we want only the list items with id that contains plone-contentmenu and not the children links
+            // of these lists therefore we iterate only over the list elements
+            $content_menus.each(function() {
+              $(this).clone(true, true).show().appendTo($toolbar_more_subset);
+            });
+
+            that.cloneViewsIntoSubset($pers_bar_container, $content_views, $toolbar_more_subset);
+            var active_class = that.options.classNames.active;
+            $toolbar_more_options.find('a').on('click', function(event){
+              // close existing opened contentmenus
+              $('.' + active_class, that.$container).removeClass(active_class);
+
+              var $more_list = $(this).parent();
+              // properly toggle active class for toolbar_more list item
+              $more_list.toggleClass('active', $toolbar_more_subset.is(":hidden"));
+              $toolbar_more_subset.toggle();
+              event.preventDefault();
+            });
+          })();
         }
       } else {
-        $('[id^="plone-contentmenu-"]').show();
-        $('#plone-toolbar-more-options').remove();
+        $toolbar_more_options.remove();
         $('#plone-toolbar-more-subset').remove();
+        $plone_toolbar_main.children().show();
+      }
+      // check if the personal toolbar is not offseted if there isn't enough space
+      // and we already have the plone-toolbar-more-options added to the page.
+      if ($pers_bar_container[0].offsetTop !== 0) {
+        that.cloneViewsIntoSubset($pers_bar_container, $content_views, $("#plone-toolbar-more-subset"));
       }
-
     },
     init: function () {
       var that = this;
@@ -306,7 +369,7 @@ define([
           that.setupMobile();
         }
       });
-    },
+    }
 
   });
 


