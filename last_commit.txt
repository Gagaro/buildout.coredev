Repository: plone.app.content


Branch: refs/heads/master
Date: 2015-07-27T18:52:58+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.content/commit/e4868229cb12d610b389c1117e7cfa2a24be14c5

Do not setDefaultPage in rename handler, there is already an subscriber doing so in Products.CMFDynamicViewFTI.

Files changed:
M CHANGES.rst
M plone/app/content/browser/actions.py

diff --git a/CHANGES.rst b/CHANGES.rst
index dc2081b..702be62 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,6 +4,10 @@ Changelog
 3.0.8 (unreleased)
 ------------------
 
+- Do not setDefaultPage in rename handler, there is already an subscriber that
+  do so in `Products.CMFDynamicViewFTI`.
+  [jensens]
+
 - Do not clear clipboard when pasting content
   [vangheem]
 
diff --git a/plone/app/content/browser/actions.py b/plone/app/content/browser/actions.py
index 30d130e..0c1f94e 100644
--- a/plone/app/content/browser/actions.py
+++ b/plone/app/content/browser/actions.py
@@ -143,13 +143,18 @@ def handle_rename(self, action):
         newid = data['new_id']
         newid = INameChooser(parent).chooseName(newid, self.context)
 
-        context_state = getMultiAdapter(
-            (self.context, self.request), name='plone_context_state')
-        if context_state.is_default_page():
-            parent.setDefaultPage(newid)
         # Requires cmf.ModifyPortalContent permission
         self.context.title = data['new_title']
+
         # Requires zope2.CopyOrMove permission
+
+        # manage_renameObjects fires 3 events:
+        # 1. ObjectWillBeMovedEvent before anything happens
+        # 2. ObjectMovedEvent directly after rename
+        # 3. zope.container.contained.notifyContainerModified directly after 2
+        # for 2+3 there are subscribers in Products.CMFDynamicViewFTI
+        # responsible to change (2) or unset (3) the default_page.
+
         parent.manage_renameObjects([oldid, ], [str(newid), ])
 
         transaction.savepoint(optimistic=True)


Repository: plone.app.content


Branch: refs/heads/master
Date: 2015-07-27T19:41:42+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.content/commit/84781e35678e1e539b216e3fc5375f1ba4cecf80

Merge pull request #46 from plone/clean-setDefaultPage

Do not setDefaultPage in rename handler, there is already an subscribâ€¦

Files changed:
M CHANGES.rst
M plone/app/content/browser/actions.py

diff --git a/CHANGES.rst b/CHANGES.rst
index dc2081b..702be62 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,6 +4,10 @@ Changelog
 3.0.8 (unreleased)
 ------------------
 
+- Do not setDefaultPage in rename handler, there is already an subscriber that
+  do so in `Products.CMFDynamicViewFTI`.
+  [jensens]
+
 - Do not clear clipboard when pasting content
   [vangheem]
 
diff --git a/plone/app/content/browser/actions.py b/plone/app/content/browser/actions.py
index 30d130e..0c1f94e 100644
--- a/plone/app/content/browser/actions.py
+++ b/plone/app/content/browser/actions.py
@@ -143,13 +143,18 @@ def handle_rename(self, action):
         newid = data['new_id']
         newid = INameChooser(parent).chooseName(newid, self.context)
 
-        context_state = getMultiAdapter(
-            (self.context, self.request), name='plone_context_state')
-        if context_state.is_default_page():
-            parent.setDefaultPage(newid)
         # Requires cmf.ModifyPortalContent permission
         self.context.title = data['new_title']
+
         # Requires zope2.CopyOrMove permission
+
+        # manage_renameObjects fires 3 events:
+        # 1. ObjectWillBeMovedEvent before anything happens
+        # 2. ObjectMovedEvent directly after rename
+        # 3. zope.container.contained.notifyContainerModified directly after 2
+        # for 2+3 there are subscribers in Products.CMFDynamicViewFTI
+        # responsible to change (2) or unset (3) the default_page.
+
         parent.manage_renameObjects([oldid, ], [str(newid), ])
 
         transaction.savepoint(optimistic=True)


