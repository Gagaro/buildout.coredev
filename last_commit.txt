Repository: diazo
Branch: refs/heads/master
Date: 2015-03-24T16:09:03-07:00
Author: Laurence Rowe (lrowe) <laurence@lrowe.co.uk>
Commit: https://github.com/plone/diazo/commit/af4f585ff51b31f155f4480e8da1e2d4049f807b

Python 3 compatibility for test failure reporting and output to stdout.

Files changed:
M lib/diazo/tests/test_diazo.py
M lib/diazo/utils.py

diff --git a/lib/diazo/tests/test_diazo.py b/lib/diazo/tests/test_diazo.py
index cf26659..41c29d2 100644
--- a/lib/diazo/tests/test_diazo.py
+++ b/lib/diazo/tests/test_diazo.py
@@ -7,7 +7,7 @@
 import os
 import sys
 import difflib
-from io import BytesIO
+from io import BytesIO, StringIO
 import unittest
 import configparser
 import pkg_resources
@@ -137,9 +137,9 @@ def testAll(self):
 
         # Read the whole thing to strip off xhtml namespace.
         # If we had xslt 2.0 then we could use xpath-default-namespace.
-        self.themed_string = bytes(result)
+        self.themed_string = str(result)
         self.themed_content = etree.ElementTree(
-            file=BytesIO(self.themed_string), parser=etree.HTMLParser())
+            file=StringIO(self.themed_string), parser=etree.HTMLParser())
 
         # remove the extra meta content type
 
diff --git a/lib/diazo/utils.py b/lib/diazo/utils.py
index 8fd4802..deb7d35 100644
--- a/lib/diazo/utils.py
+++ b/lib/diazo/utils.py
@@ -4,7 +4,12 @@
 
 from lxml import etree
 from optparse import OptionParser
-from six import string_types, integer_types
+from six import string_types, integer_types, PY3
+
+if PY3:
+    stdout = sys.stdout.buffer
+else:
+    stdout = sys.stdout
 
 strparam = etree.XSLT.strparam
 
@@ -109,7 +114,7 @@ def _createOptionParser(usage):
     parser = OptionParser(usage=usage)
     parser.add_option("-o", "--output", metavar="output.xsl",
                       help="Output filename (instead of stdout)",
-                      dest="output", default=sys.stdout)
+                      dest="output", default=stdout)
     parser.add_option("-p", "--pretty-print", action="store_true",
                       help="Pretty print output (may alter rendering in "
                            "browser)",


