Repository: plone.dexterity


Branch: refs/heads/master
Date: 2015-07-28T00:06:12+02:00
Author: Roel Bruggink (jaroel) <roel@jaroel.nl>
Commit: https://github.com/plone/plone.dexterity/commit/c64e7379b592a6ebed9f61dcec7e29ed83c650a9

Check add_permission.

Files changed:
M CHANGES.rst
M plone/dexterity/content.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 3a8eb6a..85132ff 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,6 +4,9 @@ Changelog
 2.3.3 (unreleased)
 ------------------
 
+- Check add_permission before checking constrains. Refs #37
+  [jaroel]
+
 - Remove obsolete css-class and text from statusmessages.
   [pbauer]
 
diff --git a/plone/dexterity/content.py b/plone/dexterity/content.py
index 59e97c8..feff70e 100644
--- a/plone/dexterity/content.py
+++ b/plone/dexterity/content.py
@@ -726,6 +726,12 @@ def invokeFactory(self, type_name, id, RESPONSE=None, *args, **kw):
         constrains = IConstrainTypes(self, None)
 
         if constrains:
+            # Do permission check before constrain checking so we'll get
+            # an Unauthorized over a ValueError.
+            fti = queryUtility(ITypeInformation, name=type_name)
+            if fti is not None and not fti.isConstructionAllowed(self):
+                raise Unauthorized('Cannot create %s' % fti.getId())
+
             allowed_ids = [
                 fti.getId() for fti in constrains.allowedContentTypes()
             ]


Repository: plone.dexterity


Branch: refs/heads/master
Date: 2015-07-28T10:50:10+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.dexterity/commit/1b75485c7873c79970c6d125063a59aed710c7ff

Merge pull request #38 from plone/37-check-permission-before-invokefactory

Check add_permission before checking type constrains

Files changed:
M CHANGES.rst
M plone/dexterity/content.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 3a8eb6a..85132ff 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,6 +4,9 @@ Changelog
 2.3.3 (unreleased)
 ------------------
 
+- Check add_permission before checking constrains. Refs #37
+  [jaroel]
+
 - Remove obsolete css-class and text from statusmessages.
   [pbauer]
 
diff --git a/plone/dexterity/content.py b/plone/dexterity/content.py
index 59e97c8..feff70e 100644
--- a/plone/dexterity/content.py
+++ b/plone/dexterity/content.py
@@ -726,6 +726,12 @@ def invokeFactory(self, type_name, id, RESPONSE=None, *args, **kw):
         constrains = IConstrainTypes(self, None)
 
         if constrains:
+            # Do permission check before constrain checking so we'll get
+            # an Unauthorized over a ValueError.
+            fti = queryUtility(ITypeInformation, name=type_name)
+            if fti is not None and not fti.isConstructionAllowed(self):
+                raise Unauthorized('Cannot create %s' % fti.getId())
+
             allowed_ids = [
                 fti.getId() for fti in constrains.allowedContentTypes()
             ]


