Repository: plone.app.users


Branch: refs/heads/master
Date: 2015-10-18T11:25:37+03:00
Author: Eric BREHAULT (ebrehault) <ebrehault@gmail.com>
Commit: https://github.com/plone/plone.app.users/commit/5adb2160c98cb17cf062292e273b3fa3fccc30cb

Fix #50: do not force forms attr to In User Profile at import

Files changed:
M CHANGES.rst
M plone/app/users/profiles/default/userschema.xml
M plone/app/users/setuphandlers.py
M plone/app/users/tests/test_exportimport.py
M plone/app/users/tests/test_schema_types.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 2c450b3..101c375 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,8 @@ CHANGES
 2.3.2 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- Do not force "In User Profile" when importing a schema from a GS profile
+  [ebrehault]
 
 
 2.3.1 (2015-08-22)
diff --git a/plone/app/users/profiles/default/userschema.xml b/plone/app/users/profiles/default/userschema.xml
index 84fed1b..4e3db91 100644
--- a/plone/app/users/profiles/default/userschema.xml
+++ b/plone/app/users/profiles/default/userschema.xml
@@ -1,23 +1,27 @@
 <model xmlns="http://namespaces.plone.org/supermodel/schema"
        xmlns:form="http://namespaces.plone.org/supermodel/form"
+       xmlns:users="http://namespaces.plone.org/supermodel/users"
        xmlns:i18n="http://xml.zope.org/namespaces/i18n"
        i18n:domain="plone">
   <schema name="member-fields">
-    <field name="home_page" type="zope.schema.URI">
+    <field name="home_page" type="zope.schema.URI"
+      users:forms="In User Profile">
       <description i18n:translate="help_homepage">
           The URL for your external home page, if you have one.
       </description>
       <required>False</required>
       <title i18n:translate="label_homepage">Home page</title>
     </field>
-    <field name="description" type="zope.schema.Text">
+    <field name="description" type="zope.schema.Text"
+      users:forms="In User Profile">
       <description i18n:translate="help_biography">
           A short overview of who you are and what you do. Will be displayed on your author page, linked from the items you create.
       </description>
       <required>False</required>
       <title i18n:translate="label_biography">Biography</title>
     </field>
-    <field name="location" type="zope.schema.TextLine">
+    <field name="location" type="zope.schema.TextLine"
+      users:forms="In User Profile">
       <description i18n:translate="help_location">
           Your location - either city and country - or in a company setting, where your office is located.
       </description>
@@ -26,7 +30,8 @@
     </field>
     <field name="portrait"
            type="plone.namedfile.field.NamedBlobImage"
-           form:widget="plone.app.users.schema.PortraitFieldWidget">
+           form:widget="plone.app.users.schema.PortraitFieldWidget"
+           users:forms="In User Profile">
       <description i18n:translate="help_portrait">
           To add or change the portrait: click the "Browse" button; select a picture of yourself. Recommended image size is 75 pixels wide by 100 pixels tall.
       </description>
diff --git a/plone/app/users/setuphandlers.py b/plone/app/users/setuphandlers.py
index 53a824d..719a3f2 100644
--- a/plone/app/users/setuphandlers.py
+++ b/plone/app/users/setuphandlers.py
@@ -12,16 +12,7 @@ def import_schema(context):
     data = context.readDataFile(FILE)
     if data is None:
         return
-    model = ttw.load_ttw_schema(data)
-    smodel = ttw.serialize_ttw_schema(model)
-
-    # put imported field in user profile form by default
-    ttw.set_schema(smodel)
-    schema = ttw.get_ttw_edited_schema()
-    for field_id in schema:
-        schema[field_id].forms_selection = [u'In User Profile', ]
-    new_model = ttw.serialize_ttw_schema(schema)
-    ttw.applySchema(new_model)
+    ttw.applySchema(data)
 
     logger.info('Imported schema')
 
diff --git a/plone/app/users/tests/test_exportimport.py b/plone/app/users/tests/test_exportimport.py
index 40a2335..80a6eb2 100644
--- a/plone/app/users/tests/test_exportimport.py
+++ b/plone/app/users/tests/test_exportimport.py
@@ -48,22 +48,22 @@ def afterSetUp(self):
       <required>False</required>
       <title i18n:translate="label_portrait">Portrait</title>
     </field>
-    <field name="birthdate" type="zope.schema.Date">
+    <field name="birthdate" type="zope.schema.Date" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Birthdate</title>
     </field>
-    <field name="another_date" type="zope.schema.Datetime">
+    <field name="another_date" type="zope.schema.Datetime" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Another date</title>
     </field>
-    <field name="age" type="zope.schema.Int">
+    <field name="age" type="zope.schema.Int" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Age</title>
     </field>
-    <field name="department" type="zope.schema.Choice">
+    <field name="department" type="zope.schema.Choice" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Department</title>
@@ -73,7 +73,7 @@ def afterSetUp(self):
         <element>HR</element>
       </values>
     </field>
-    <field name="skills" type="zope.schema.Set">
+    <field name="skills" type="zope.schema.Set" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Skills</title>
@@ -84,12 +84,12 @@ def afterSetUp(self):
         </values>
       </value_type>
     </field>
-    <field name="pi" type="zope.schema.Float">
+    <field name="pi" type="zope.schema.Float" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Pi</title>
     </field>
-    <field name="vegetarian" type="zope.schema.Bool">
+    <field name="vegetarian" type="zope.schema.Bool" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Vegetarian</title>
diff --git a/plone/app/users/tests/test_schema_types.py b/plone/app/users/tests/test_schema_types.py
index 30d0832..03b2ca9 100644
--- a/plone/app/users/tests/test_schema_types.py
+++ b/plone/app/users/tests/test_schema_types.py
@@ -47,22 +47,22 @@ def afterSetUp(self):
       <required>False</required>
       <title i18n:translate="label_portrait">Portrait</title>
     </field>
-    <field name="birthdate" type="zope.schema.Date">
+    <field name="birthdate" type="zope.schema.Date" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Birthdate</title>
     </field>
-    <field name="another_date" type="zope.schema.Datetime">
+    <field name="another_date" type="zope.schema.Datetime" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Another date</title>
     </field>
-    <field name="age" type="zope.schema.Int">
+    <field name="age" type="zope.schema.Int" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Age</title>
     </field>
-    <field name="department" type="zope.schema.Choice">
+    <field name="department" type="zope.schema.Choice" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Department</title>
@@ -72,7 +72,7 @@ def afterSetUp(self):
         <element>HR</element>
       </values>
     </field>
-    <field name="skills" type="zope.schema.Set">
+    <field name="skills" type="zope.schema.Set" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Skills</title>
@@ -83,12 +83,12 @@ def afterSetUp(self):
         </values>
       </value_type>
     </field>
-    <field name="pi" type="zope.schema.Float">
+    <field name="pi" type="zope.schema.Float" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Pi</title>
     </field>
-    <field name="vegetarian" type="zope.schema.Bool">
+    <field name="vegetarian" type="zope.schema.Bool" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Vegetarian</title>


Repository: plone.app.users


Branch: refs/heads/master
Date: 2015-10-18T13:03:28+03:00
Author: Eric BREHAULT (ebrehault) <ebrehault@gmail.com>
Commit: https://github.com/plone/plone.app.users/commit/a231642e4fd2dbfd971c746864331a58a89520d0

Merge pull request #51 from plone/ebr-fix-setuphandler

Fix #50: do not force forms attr to In User Profile at import

Files changed:
M CHANGES.rst
M plone/app/users/profiles/default/userschema.xml
M plone/app/users/setuphandlers.py
M plone/app/users/tests/test_exportimport.py
M plone/app/users/tests/test_schema_types.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 2c450b3..101c375 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,8 @@ CHANGES
 2.3.2 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- Do not force "In User Profile" when importing a schema from a GS profile
+  [ebrehault]
 
 
 2.3.1 (2015-08-22)
diff --git a/plone/app/users/profiles/default/userschema.xml b/plone/app/users/profiles/default/userschema.xml
index 84fed1b..4e3db91 100644
--- a/plone/app/users/profiles/default/userschema.xml
+++ b/plone/app/users/profiles/default/userschema.xml
@@ -1,23 +1,27 @@
 <model xmlns="http://namespaces.plone.org/supermodel/schema"
        xmlns:form="http://namespaces.plone.org/supermodel/form"
+       xmlns:users="http://namespaces.plone.org/supermodel/users"
        xmlns:i18n="http://xml.zope.org/namespaces/i18n"
        i18n:domain="plone">
   <schema name="member-fields">
-    <field name="home_page" type="zope.schema.URI">
+    <field name="home_page" type="zope.schema.URI"
+      users:forms="In User Profile">
       <description i18n:translate="help_homepage">
           The URL for your external home page, if you have one.
       </description>
       <required>False</required>
       <title i18n:translate="label_homepage">Home page</title>
     </field>
-    <field name="description" type="zope.schema.Text">
+    <field name="description" type="zope.schema.Text"
+      users:forms="In User Profile">
       <description i18n:translate="help_biography">
           A short overview of who you are and what you do. Will be displayed on your author page, linked from the items you create.
       </description>
       <required>False</required>
       <title i18n:translate="label_biography">Biography</title>
     </field>
-    <field name="location" type="zope.schema.TextLine">
+    <field name="location" type="zope.schema.TextLine"
+      users:forms="In User Profile">
       <description i18n:translate="help_location">
           Your location - either city and country - or in a company setting, where your office is located.
       </description>
@@ -26,7 +30,8 @@
     </field>
     <field name="portrait"
            type="plone.namedfile.field.NamedBlobImage"
-           form:widget="plone.app.users.schema.PortraitFieldWidget">
+           form:widget="plone.app.users.schema.PortraitFieldWidget"
+           users:forms="In User Profile">
       <description i18n:translate="help_portrait">
           To add or change the portrait: click the "Browse" button; select a picture of yourself. Recommended image size is 75 pixels wide by 100 pixels tall.
       </description>
diff --git a/plone/app/users/setuphandlers.py b/plone/app/users/setuphandlers.py
index 53a824d..719a3f2 100644
--- a/plone/app/users/setuphandlers.py
+++ b/plone/app/users/setuphandlers.py
@@ -12,16 +12,7 @@ def import_schema(context):
     data = context.readDataFile(FILE)
     if data is None:
         return
-    model = ttw.load_ttw_schema(data)
-    smodel = ttw.serialize_ttw_schema(model)
-
-    # put imported field in user profile form by default
-    ttw.set_schema(smodel)
-    schema = ttw.get_ttw_edited_schema()
-    for field_id in schema:
-        schema[field_id].forms_selection = [u'In User Profile', ]
-    new_model = ttw.serialize_ttw_schema(schema)
-    ttw.applySchema(new_model)
+    ttw.applySchema(data)
 
     logger.info('Imported schema')
 
diff --git a/plone/app/users/tests/test_exportimport.py b/plone/app/users/tests/test_exportimport.py
index 40a2335..80a6eb2 100644
--- a/plone/app/users/tests/test_exportimport.py
+++ b/plone/app/users/tests/test_exportimport.py
@@ -48,22 +48,22 @@ def afterSetUp(self):
       <required>False</required>
       <title i18n:translate="label_portrait">Portrait</title>
     </field>
-    <field name="birthdate" type="zope.schema.Date">
+    <field name="birthdate" type="zope.schema.Date" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Birthdate</title>
     </field>
-    <field name="another_date" type="zope.schema.Datetime">
+    <field name="another_date" type="zope.schema.Datetime" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Another date</title>
     </field>
-    <field name="age" type="zope.schema.Int">
+    <field name="age" type="zope.schema.Int" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Age</title>
     </field>
-    <field name="department" type="zope.schema.Choice">
+    <field name="department" type="zope.schema.Choice" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Department</title>
@@ -73,7 +73,7 @@ def afterSetUp(self):
         <element>HR</element>
       </values>
     </field>
-    <field name="skills" type="zope.schema.Set">
+    <field name="skills" type="zope.schema.Set" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Skills</title>
@@ -84,12 +84,12 @@ def afterSetUp(self):
         </values>
       </value_type>
     </field>
-    <field name="pi" type="zope.schema.Float">
+    <field name="pi" type="zope.schema.Float" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Pi</title>
     </field>
-    <field name="vegetarian" type="zope.schema.Bool">
+    <field name="vegetarian" type="zope.schema.Bool" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Vegetarian</title>
diff --git a/plone/app/users/tests/test_schema_types.py b/plone/app/users/tests/test_schema_types.py
index 30d0832..03b2ca9 100644
--- a/plone/app/users/tests/test_schema_types.py
+++ b/plone/app/users/tests/test_schema_types.py
@@ -47,22 +47,22 @@ def afterSetUp(self):
       <required>False</required>
       <title i18n:translate="label_portrait">Portrait</title>
     </field>
-    <field name="birthdate" type="zope.schema.Date">
+    <field name="birthdate" type="zope.schema.Date" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Birthdate</title>
     </field>
-    <field name="another_date" type="zope.schema.Datetime">
+    <field name="another_date" type="zope.schema.Datetime" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Another date</title>
     </field>
-    <field name="age" type="zope.schema.Int">
+    <field name="age" type="zope.schema.Int" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Age</title>
     </field>
-    <field name="department" type="zope.schema.Choice">
+    <field name="department" type="zope.schema.Choice" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Department</title>
@@ -72,7 +72,7 @@ def afterSetUp(self):
         <element>HR</element>
       </values>
     </field>
-    <field name="skills" type="zope.schema.Set">
+    <field name="skills" type="zope.schema.Set" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Skills</title>
@@ -83,12 +83,12 @@ def afterSetUp(self):
         </values>
       </value_type>
     </field>
-    <field name="pi" type="zope.schema.Float">
+    <field name="pi" type="zope.schema.Float" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Pi</title>
     </field>
-    <field name="vegetarian" type="zope.schema.Bool">
+    <field name="vegetarian" type="zope.schema.Bool" users:forms="In User Profile">
       <description/>
       <required>False</required>
       <title>Vegetarian</title>


