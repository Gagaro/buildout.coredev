Repository: Products.CMFPlone
Branch: refs/heads/4.3.x
Date: 2015-03-20T13:16:59+10:00
Author: David\ Beitey (davidjb) <david@davidjb.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/49ceeb80acd8243d80ac4af0aa08527301011f22

Set msg_type when sending forgotten password emails

Conflicts:
	CHANGES.rst

Files changed:
M Products/CMFPlone/RegistrationTool.py
M docs/CHANGES.rst

diff --git a/Products/CMFPlone/RegistrationTool.py b/Products/CMFPlone/RegistrationTool.py
index cc69171..dfaa67c 100644
--- a/Products/CMFPlone/RegistrationTool.py
+++ b/Products/CMFPlone/RegistrationTool.py
@@ -365,10 +365,12 @@ def mailPassword(self, login, REQUEST, immediate=False):
         subject = message_obj['Subject']
         m_to = message_obj['To']
         m_from = message_obj['From']
+        msg_type = message_obj.get('Content-Type', 'text/plain')
         host = getToolByName(self, 'MailHost')
         try:
             host.send(mail_text, m_to, m_from, subject=subject,
-                      charset=encoding, immediate=immediate)
+                      charset=encoding, immediate=immediate,
+                      msg_type=msg_type)
         except SMTPRecipientsRefused:
             # Don't disclose email address on failure
             raise SMTPRecipientsRefused(
diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index 8ff990e..ae349a6 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -8,6 +8,10 @@ Changelog
 4.3.5 (unreleased)
 ------------------
 
+- Pass mail ``Content-Type`` to mailhost when sending forgotten password
+  emails.
+  [davidjb]
+
 - Fix: If a user "deletes" the same item twice (ex.: having two different tabs 
   open and not realising it's already been deleted) any higher level item with 
   the same short name will be deleted without trace. 


Repository: Products.CMFPlone
Branch: refs/heads/4.3.x
Date: 2015-03-23T12:24:08+10:00
Author: David\ Beitey (davidjb) <david@davidjb.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/8006e80283ee2c76c44bec79de1da2ca90d18337

Pass email encoding to forgotten password email template

Conflicts:
	CHANGES.rst

Files changed:
M Products/CMFPlone/RegistrationTool.py
M docs/CHANGES.rst

diff --git a/Products/CMFPlone/RegistrationTool.py b/Products/CMFPlone/RegistrationTool.py
index dfaa67c..079765c 100644
--- a/Products/CMFPlone/RegistrationTool.py
+++ b/Products/CMFPlone/RegistrationTool.py
@@ -406,10 +406,11 @@ def registeredNotify(self, new_member_id):
         # Rather than have the template try to use the mailhost, we will
         # render the message ourselves and send it from here (where we
         # don't need to worry about 'UseMailHost' permissions).
+        encoding = getUtility(ISiteRoot).getProperty('email_charset', 'utf-8')
         mail_text = self.registered_notify_template(
-            self, self.REQUEST, member=member, reset=reset, email=email)
+            self, self.REQUEST, member=member, reset=reset, email=email,
+            charset=encoding)
 
-        encoding = getUtility(ISiteRoot).getProperty('email_charset', 'utf-8')
         # The mail headers are not properly encoded we need to extract
         # them and let MailHost manage the encoding.
         if isinstance(mail_text, unicode):
diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index ae349a6..3ba80a7 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -8,6 +8,9 @@ Changelog
 4.3.5 (unreleased)
 ------------------
 
+- Pass email encoding to forgotten password email template.
+  [davidjb]
+
 - Pass mail ``Content-Type`` to mailhost when sending forgotten password
   emails.
   [davidjb]


Repository: Products.CMFPlone
Branch: refs/heads/4.3.x
Date: 2015-03-23T12:24:10+10:00
Author: David\ Beitey (davidjb) <david@davidjb.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/70fa0da33d6a242e7cb6c0d0e3f60839ca3560d1

Add tests for changing email encoding on registration/forgotten password emails

Conflicts:
	CHANGES.rst

Files changed:
M Products/CMFPlone/tests/testRegistrationTool.py
M docs/CHANGES.rst

diff --git a/Products/CMFPlone/tests/testRegistrationTool.py b/Products/CMFPlone/tests/testRegistrationTool.py
index 0bd9a52..3dbb51f 100644
--- a/Products/CMFPlone/tests/testRegistrationTool.py
+++ b/Products/CMFPlone/tests/testRegistrationTool.py
@@ -1,7 +1,7 @@
 import unittest
 
 from email import message_from_string
-from zope.component import getSiteManager
+from zope.component import getSiteManager, getUtility
 from Products.CMFPlone.tests import PloneTestCase
 
 from AccessControl import Unauthorized
@@ -121,6 +121,8 @@ def testRegisteredNotify(self):
         self.portal.setTitle('T\xc3\xa4st Portal')
         self.portal.email_from_name = 'T\xc3\xa4st Admin'
         self.portal.email_from_address = 'bar@baz.com'
+
+        # Notify the registered user
         self.registration.registeredNotify(member_id)
         self.assertEqual(len(mails.messages), 1)
         msg = message_from_string(mails.messages[0])
@@ -135,6 +137,31 @@ def testRegisteredNotify(self):
         # And a Quoted Printable encoded body
         self.assertTrue('T=C3=A4st Admin' in msg.get_payload())
 
+    def testRegisteredNotifyEncoding(self):
+        mails = self.portal.MailHost = MockMailHost('MailHost')
+        sm = getSiteManager(self.portal)
+        sm.unregisterUtility(provided=IMailHost)
+        sm.registerUtility(mails, IMailHost)
+        # Register a user
+        self.registration.addMember(member_id, 'secret',
+                          properties={'username': member_id,
+                                      'email': 'foo@bar.com'})
+        # Set the portal email info
+        self.portal.setTitle('Test Portal')
+        self.portal.email_from_name = 'Test Admin'
+        self.portal.email_from_address = 'bar@baz.com'
+
+        # Set the portal email encoding
+        self.portal.email_charset = 'us-ascii'
+
+        # Notify the registered user
+        self.registration.registeredNotify(member_id)
+        self.assertEqual(len(mails.messages), 1)
+        msg = message_from_string(mails.messages[0])
+
+        # Ensure charset (and thus Content-Type) were set via template
+        self.assertEqual(msg['Content-Type'], 'text/plain; charset="us-ascii"')
+
     def testMailPassword(self):
         # tests email sending for password emails
         # First install a fake mailhost utility
@@ -150,6 +177,7 @@ def testMailPassword(self):
         self.portal.setTitle('T\xc3\xa4st Portal')
         self.portal.email_from_name = 'T\xc3\xa4st Admin'
         self.portal.email_from_address = 'bar@baz.com'
+
         from zope.publisher.browser import TestRequest
         self.registration.mailPassword(member_id, TestRequest())
         self.assertEqual(len(mails.messages), 1)
@@ -164,6 +192,33 @@ def testMailPassword(self):
         # And a Quoted Printable encoded body
         self.assertTrue('T=C3=A4st Porta' in msg.get_payload())
 
+    def testMailPasswordEncoding(self):
+        # tests email sending for password emails
+        # First install a fake mailhost utility
+        mails = self.portal.MailHost = MockMailHost('MailHost')
+        sm = getSiteManager(self.portal)
+        sm.unregisterUtility(provided=IMailHost)
+        sm.registerUtility(mails, IMailHost)
+        # Register a user
+        self.registration.addMember(member_id, 'secret',
+                          properties={'username': member_id,
+                                      'email': 'foo@bar.com'})
+        # Set the portal email info
+        self.portal.setTitle('Test Portal')
+        self.portal.email_from_name = 'Test Admin'
+        self.portal.email_from_address = 'bar@baz.com'
+
+        # Set the portal email encoding
+        self.portal.email_charset = 'us-ascii'
+
+        from zope.publisher.browser import TestRequest
+        self.registration.mailPassword(member_id, TestRequest())
+        self.assertEqual(len(mails.messages), 1)
+        msg = message_from_string(mails.messages[0])
+
+        # Ensure charset (and thus Content-Type) were set via template
+        self.assertEqual(msg['Content-Type'], 'text/plain; charset="us-ascii"')
+
 
 class TestPasswordGeneration(PloneTestCase.PloneTestCase):
 
diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index 3ba80a7..ee9d25a 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -8,6 +8,10 @@ Changelog
 4.3.5 (unreleased)
 ------------------
 
+- Add tests for configuring encoding of user registration or
+  forgotten password emails.
+  [davidjb]
+
 - Pass email encoding to forgotten password email template.
   [davidjb]
 


