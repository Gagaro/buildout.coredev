Repository: Products.CMFEditions


Branch: refs/heads/master
Date: 2015-08-12T14:49:33+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFEditions/commit/3fcb68efe5c23850e9828952dd5751c7325d203d

Do not call ndiff unless there is no html_diff.

Current releases of CMFDiffTool (until 2.1 and 3.0.1) can give a
UnicodeDecodeError in ndiff, so it helps when we do not call it
unnecessarily.

Also, both html_diff and ndiff were called more often than needed,
which is now fixed.

Files changed:
M CHANGES.rst
M Products/CMFEditions/browser/diff.pt

diff --git a/CHANGES.rst b/CHANGES.rst
index b89696d..c9dc90b 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,8 +4,8 @@ Changelog
 2.2.14 (unreleased)
 -------------------
 
-- Fixed possible UnicodeEncodeError by removing strange unicode space
-  from template.  Fixes
+- Do not call ndiff unless there is no html_diff.  Removed strange
+  unicode space from template.  Related to
   https://github.com/plone/Products.CMFPlone/issues/820
   [maurits]
 
diff --git a/Products/CMFEditions/browser/diff.pt b/Products/CMFEditions/browser/diff.pt
index c24f36c..ef596dd 100644
--- a/Products/CMFEditions/browser/diff.pt
+++ b/Products/CMFEditions/browser/diff.pt
@@ -123,22 +123,29 @@
 
                 <div class="fieldDiff code-diff"
                      style="display: none"
-                     tal:define="has_html_diff diff/html_diff|nothing;
-                                 has_ndiff diff/ndiff|nothing">
-                  <pre tal:condition="exists:diff/html_diff"
-                       tal:content="structure python:diff.html_diff(wrapcolumn=80)">
+                     tal:define="exists_html_diff exists:diff/html_diff;
+                                 html_diff python:diff.html_diff(wrapcolumn=80) if exists_html_diff else '';
+                                 has_html_diff python:bool(html_diff)">
+                  <pre tal:condition="has_html_diff"
+                       tal:content="structure html_diff">
                     HTML formatted differences
                   </pre>
 
-                  <pre class="fieldDiff code-diff"
-                       tal:condition="python:not has_html_diff and has_ndiff"
-                       tal:content="diff/ndiff">
-                    ndiff formatted differences
-                  </pre>
-                  <p class="fieldDiff"
-                     tal:condition="python:not has_html_diff and not has_ndiff">
-                    This field has no code difference view.
-                  </p>
+                  <tal:block condition="not:has_html_diff">
+                    <tal:block define="exists_ndiff exists:diff/ndiff;
+                                       ndiff python:diff.ndiff() if exists_ndiff else '';
+                                       has_ndiff python:bool(ndiff)">
+                      <pre class="fieldDiff code-diff"
+                           tal:condition="has_ndiff"
+                           tal:content="ndiff">
+                        ndiff formatted differences
+                      </pre>
+                      <p class="fieldDiff"
+                         tal:condition="not:has_ndiff">
+                        This field has no code difference view.
+                      </p>
+                    </tal:block>
+                  </tal:block>
                 </div>
               </fieldset>
 


