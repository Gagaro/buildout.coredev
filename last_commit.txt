Repository: plone.app.contenttypes
Branch: refs/heads/master
Date: 2015-03-13T09:52:41+01:00
Author: Johannes Raggam (thet) <raggam-nl@adm.at>
Commit: https://github.com/plone/plone.app.contenttypes/commit/0940e31a2a8b22da6a849cadc4ae2c45a2509306

In the listing view, don't repeat on the article tag, which makes it impossible to override this structure. Instead, repeat on a unrendered tal tag and move the article tag within.

Files changed:
M docs/CHANGES.rst
M plone/app/contenttypes/browser/folder.py
M plone/app/contenttypes/browser/templates/listing.pt
M plone/app/contenttypes/browser/templates/listing_summary.pt

diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index 502a6b8..041021b 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -4,6 +4,11 @@ Changelog
 1.2 (unreleased)
 ----------------
 
+- In the listing view, don't repeat on the ``article`` tag, which makes it
+  impossible to override this structure. Instead, repeat on a unrendered
+  ``tal`` tag and move the article tag within.
+  [thet]
+
 - Don't try to show IContentLeadImage images, if theree none. Use the "mini"
   scale as default scale for IContentLeadImage.
   [thet]
diff --git a/plone/app/contenttypes/browser/folder.py b/plone/app/contenttypes/browser/folder.py
index 8fcf386..2de8505 100644
--- a/plone/app/contenttypes/browser/folder.py
+++ b/plone/app/contenttypes/browser/folder.py
@@ -152,7 +152,15 @@ def tabular_fielddata(self, item, fieldname):
             'value': value
         }
 
+    def has_image(self, obj):
+        if getattr(obj, 'getObject', False):
+            obj = obj.getObject()
+        img = getattr(aq_base(obj), 'image', None)
+        return True if img else False
+
     def is_event(self, obj):
+        if getattr(obj, 'getObject', False):
+            obj = obj.getObject()
         return IEvent.providedBy(obj)
 
     def formatted_date(self, item):
diff --git a/plone/app/contenttypes/browser/templates/listing.pt b/plone/app/contenttypes/browser/templates/listing.pt
index 5ec5a92..b21f554 100644
--- a/plone/app/contenttypes/browser/templates/listing.pt
+++ b/plone/app/contenttypes/browser/templates/listing.pt
@@ -21,8 +21,8 @@
   <metal:listingmacro define-macro="listing">
     <tal:results define="batch view/batch">
       <tal:listing condition="batch">
-        <div metal:define-slot="entries">
-          <article tal:repeat="item batch" metal:define-macro="entries">
+        <div class="entries" metal:define-slot="entries">
+          <tal:repeat repeat="item batch" metal:define-macro="entries">
             <tal:block tal:define="obj item/getObject;
                 item_url item/getURL;
                 item_id item/getId;
@@ -36,71 +36,74 @@
                 item_wf_state item/review_state;
                 item_wf_state_class python:'state-' + view.normalizeString(item_wf_state);
                 item_creator item/Creator;
-                item_link python:item_type in view.use_view_action and item_url+'/view' or item_url">
+                item_link python:item_type in view.use_view_action and item_url+'/view' or item_url;
+                item_has_image python:view.has_image(obj);
+                item_is_event python:view.is_event(obj)">
               <metal:block define-slot="entry">
-                <header metal:define-macro="listitem" tal:attributes="class python:item_type == 'Event' and 'vevent' or ''">
-                  <span class="summary">
-                    <a tal:attributes="href item_link;
-                                       class string:$item_type_class $item_wf_state_class url;
-                                       title item_type"
-                        tal:content="item_title">
-                      Item Title
-                    </a>
-                  </span>
-
-                  <metal:block metal:define-macro="document_byline">
-                    <span class="documentByLine">
-                      <tal:event condition="python:view.is_event(obj)">
-                        <tal:date tal:replace="structure python:view.formatted_date(obj)"/>
-                        <span tal:condition="item/location" i18n:translate="label_event_byline_location">&mdash;
-                          <span tal:content="string:${item/location}" class="location" i18n:name="location">Oslo</span>,
-                        </span>
-                      </tal:event>
-                      <tal:byline condition="view/show_about">
-                        &mdash;
-                        <tal:name tal:condition="item_creator"
-                            tal:define="author python:view.pas_member.info(item_creator);
-                                        creator_short_form author/username;
-                                        creator_long_form string:?author=${author/username};
-                                        creator_is_openid python:'/' in creator_short_form;
-                                        creator_id python:(creator_short_form, creator_long_form)[creator_is_openid];">
-                        <span i18n:translate="label_by_author">
-                          by
-                          <a tal:attributes="href string:${view/navigation_root_url}/author/${item_creator}"
-                              tal:content="author/name_or_id"
-                              tal:omit-tag="not:author"
-                              i18n:name="author">
-                            Bob Dobalina
-                          </a>
-                        </span>
-                        </tal:name>
+                <article class="entry">
+                  <header metal:define-macro="listitem" tal:attributes="class python:'vevent' if item_is_event else None">
+                    <span class="summary">
+                      <a tal:attributes="href item_link;
+                                         class string:$item_type_class $item_wf_state_class url;
+                                         title item_type"
+                          tal:content="item_title">
+                        Item Title
+                      </a>
+                    </span>
 
-                        <tal:modified condition="python: item_type != 'Event'">
+                    <metal:block metal:define-macro="document_byline">
+                      <span class="documentByLine">
+                        <tal:event condition="item_is_event">
+                          <tal:date tal:replace="structure python:view.formatted_date(obj)"/>
+                          <span tal:condition="item/location" i18n:translate="label_event_byline_location">&mdash;
+                            <span tal:content="string:${item/location}" class="location" i18n:name="location">Oslo</span>,
+                          </span>
+                        </tal:event>
+                        <tal:byline condition="view/show_about">
                           &mdash;
-                          <tal:mod i18n:translate="box_last_modified">last modified</tal:mod>
-                          <span tal:replace="python:view.toLocalizedTime(item_modified,long_format=1)">
-                            August 16, 2001 at 23:35:59
+                          <tal:name tal:condition="item_creator"
+                              tal:define="author python:view.pas_member.info(item_creator);
+                                          creator_short_form author/username;
+                                          creator_long_form string:?author=${author/username};
+                                          creator_is_openid python:'/' in creator_short_form;
+                                          creator_id python:(creator_short_form, creator_long_form)[creator_is_openid];">
+                          <span i18n:translate="label_by_author">
+                            by
+                            <a tal:attributes="href string:${view/navigation_root_url}/author/${item_creator}"
+                                tal:content="author/name_or_id"
+                                tal:omit-tag="not:author"
+                                i18n:name="author">
+                              Bob Dobalina
+                            </a>
                           </span>
-                        </tal:modified>
+                          </tal:name>
 
-                        <metal:description define-slot="description_slot">
-                          <tal:comment replace="nothing">
-                            Place custom listing info for custom types here
-                          </tal:comment>
-                        </metal:description>
-                      </tal:byline>
-                    </span>
-                  </metal:block>
-                </header>
+                          <tal:modified condition="python: item_type != 'Event'">
+                            &mdash;
+                            <tal:mod i18n:translate="box_last_modified">last modified</tal:mod>
+                            <span tal:replace="python:view.toLocalizedTime(item_modified,long_format=1)">
+                              August 16, 2001 at 23:35:59
+                            </span>
+                          </tal:modified>
 
-                <p class="description discreet"
-                    tal:condition="item_description"
-                    tal:content="item_description">
-                  description
-                </p>
+                          <metal:description define-slot="description_slot">
+                            <tal:comment replace="nothing">
+                              Place custom listing info for custom types here
+                            </tal:comment>
+                          </metal:description>
+                        </tal:byline>
+                      </span>
+                    </metal:block>
+                  </header>
+                  <p class="description discreet"
+                      tal:condition="item_description"
+                      tal:content="item_description">
+                    description
+                  </p>
+                </article>
               </metal:block>
             </tal:block>
-          </article>
+          </tal:repeat>
         </div>
 
         <div metal:use-macro="context/batch_macros/macros/navigation" />
diff --git a/plone/app/contenttypes/browser/templates/listing_summary.pt b/plone/app/contenttypes/browser/templates/listing_summary.pt
index f02a961..a4455e4 100644
--- a/plone/app/contenttypes/browser/templates/listing_summary.pt
+++ b/plone/app/contenttypes/browser/templates/listing_summary.pt
@@ -14,17 +14,15 @@
     <metal:block use-macro="context/@@listing_view/macros/entries">
       <metal:entry fill-slot="entry">
 
-        <div class="tileItem visualIEFloatFix" tal:define="obj item/getObject">
+        <article class="tileItem visualIEFloatFix" tal:define="obj item/getObject">
 
-          <a tal:condition="python:getattr(obj.aq_explicit, 'image', None)"
-              tal:attributes="href item_link">
-            <div class="tileImage">
-              <img src="" alt=""
-                  tal:define="scales obj/@@images;
-                              scale python:scales.scale('image', 'thumb')"
+          <div class="tileImage" tal:condition="item_has_image">
+            <a tal:attributes="href item_link">
+              <img tal:define="scales obj/@@images;
+                               scale python:scales.scale('image', 'thumb')"
                   tal:replace="structure python:scale and scale.tag(css_class='tileImage') or None" />
-            </div>
-          </a>
+            </a>
+          </div>
 
           <h2 class="tileHeadline" metal:define-macro="listitem">
             <a class="summary url"
@@ -52,7 +50,7 @@
 
           <div class="visualClear"><!-- --></div>
 
-        </div>
+        </article>
 
       </metal:entry>
     </metal:block>


