Repository: Products.CMFPlone


Branch: refs/heads/4.3.x
Date: 2015-10-12T21:34:36+03:00
Author: Nathan Van Gheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/e56026f544afab1c16213b2d6a4542698acdab92

fix syndication settings to not write on read

Files changed:
M Products/CMFPlone/browser/syndication/settings.py
M docs/CHANGES.rst

diff --git a/Products/CMFPlone/browser/syndication/settings.py b/Products/CMFPlone/browser/syndication/settings.py
index 182c6b1..611da06 100644
--- a/Products/CMFPlone/browser/syndication/settings.py
+++ b/Products/CMFPlone/browser/syndication/settings.py
@@ -17,22 +17,34 @@ class FeedSettings(object):
 
     def __init__(self, context):
         self.context = context
-        annotations = IAnnotations(context)
+        self.annotations = IAnnotations(context)
+        self.needs_saving = False
 
-        self._metadata = annotations.get(FEED_SETTINGS_KEY, None)
+        self._metadata = self.annotations.get(FEED_SETTINGS_KEY, None)
         if self._metadata is None:
             self._metadata = PersistentDict()
-            annotations[FEED_SETTINGS_KEY] = self._metadata
+            self.needs_saving = True
 
         registry = getUtility(IRegistry)
         self.site_settings = registry.forInterface(ISiteSyndicationSettings,
                                                    check=False)
 
+    def _set(self):
+        """
+        what are we doing here you might ask?
+        well, this causes us to write on read so only set on annotation
+        if we need to
+        """
+        if self.needs_saving:
+            self.annotations[FEED_SETTINGS_KEY] = self._metadata
+
     def __setattr__(self, name, value):
-        if name in ('context', '_metadata', 'site_settings'):
+        if name in ('context', '_metadata', 'site_settings', 'annotations',
+                    'needs_saving'):
             self.__dict__[name] = value
         else:
             self._metadata[name] = value
+            self._set()
 
     def __getattr__(self, name):
         default = None
diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index bd2b5a5..999a4d2 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -58,6 +58,8 @@ Changelog
 - Release Plone 4.3.6 to correct some version incompatibilities in 4.3.5. No upgrades to run.
   [esteele]
 
+- fix syndication settings to not write on read
+  [vangheem]
 
 4.3.5 (2015-05-13)
 ------------------


Repository: Products.CMFPlone


Branch: refs/heads/4.3.x
Date: 2015-10-14T10:21:09-05:00
Author: Nathan Van Gheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/9dcab4b3c02e983a629c3e8842a3a3bb9dbac19e

Merge pull request #1147 from derFreitag/write-on-read

fix syndication settings to not write on read

Files changed:
M Products/CMFPlone/browser/syndication/settings.py
M docs/CHANGES.rst

diff --git a/Products/CMFPlone/browser/syndication/settings.py b/Products/CMFPlone/browser/syndication/settings.py
index 182c6b1..611da06 100644
--- a/Products/CMFPlone/browser/syndication/settings.py
+++ b/Products/CMFPlone/browser/syndication/settings.py
@@ -17,22 +17,34 @@ class FeedSettings(object):
 
     def __init__(self, context):
         self.context = context
-        annotations = IAnnotations(context)
+        self.annotations = IAnnotations(context)
+        self.needs_saving = False
 
-        self._metadata = annotations.get(FEED_SETTINGS_KEY, None)
+        self._metadata = self.annotations.get(FEED_SETTINGS_KEY, None)
         if self._metadata is None:
             self._metadata = PersistentDict()
-            annotations[FEED_SETTINGS_KEY] = self._metadata
+            self.needs_saving = True
 
         registry = getUtility(IRegistry)
         self.site_settings = registry.forInterface(ISiteSyndicationSettings,
                                                    check=False)
 
+    def _set(self):
+        """
+        what are we doing here you might ask?
+        well, this causes us to write on read so only set on annotation
+        if we need to
+        """
+        if self.needs_saving:
+            self.annotations[FEED_SETTINGS_KEY] = self._metadata
+
     def __setattr__(self, name, value):
-        if name in ('context', '_metadata', 'site_settings'):
+        if name in ('context', '_metadata', 'site_settings', 'annotations',
+                    'needs_saving'):
             self.__dict__[name] = value
         else:
             self._metadata[name] = value
+            self._set()
 
     def __getattr__(self, name):
         default = None
diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index bd2b5a5..999a4d2 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -58,6 +58,8 @@ Changelog
 - Release Plone 4.3.6 to correct some version incompatibilities in 4.3.5. No upgrades to run.
   [esteele]
 
+- fix syndication settings to not write on read
+  [vangheem]
 
 4.3.5 (2015-05-13)
 ------------------


