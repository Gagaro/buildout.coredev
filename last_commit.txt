Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2015-07-23T12:01:39+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.contenttypes/commit/63598e0162af6e18ec19b0ff98c8c66c4c26d419

update changelog

Files changed:
M CHANGES.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index d940784..d55e89c 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,6 +4,16 @@ Changelog
 1.2b4 (unreleased)
 ------------------
 
+- Add convenience-view @@export_all_relations to export all relations.
+  [pbauer]
+
+- Add method link_items that allows to link any kind of item (AT/DX) with any
+  kind of relationship.
+  [pbauer]
+
+- New implementation of reference-migrations.
+  [pbauer]
+
 - Fix i18n on custom_migration view.
   [vincentfretin]
 


Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2015-07-23T12:02:11+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.contenttypes/commit/dc6d29b825539e0cd745e7452ccab2b7c0402dd8

small cleanup of link_items

Files changed:
M plone/app/contenttypes/migration/utils.py

diff --git a/plone/app/contenttypes/migration/utils.py b/plone/app/contenttypes/migration/utils.py
index 8159a6d..17841ae 100644
--- a/plone/app/contenttypes/migration/utils.py
+++ b/plone/app/contenttypes/migration/utils.py
@@ -21,6 +21,8 @@
 from plone.app.contenttypes.utils import DEFAULT_TYPES
 from plone.app.discussion.conversation import ANNOTATION_KEY as DISCUSSION_KEY
 from plone.app.discussion.interfaces import IConversation
+from plone.app.linkintegrity.handlers import modifiedArchetype
+from plone.app.linkintegrity.handlers import modifiedDexterity
 from plone.app.linkintegrity.handlers import referencedRelationship
 from plone.app.uuid.utils import uuidToObject
 from plone.contentrules.engine.interfaces import IRuleAssignmentManager
@@ -334,7 +336,7 @@ def link_items(
     arbitrary relations.
     """
     # relations from AT to DX and from DX to AT are only possible through
-    # the refernceable-behavior:
+    # the referenceable-behavior:
     # plone.app.referenceablebehavior.referenceable.IReferenceable
     drop_msg = """Dropping reference from %s to %s since
     plone.app.referenceablebehavior is not enabled!"""
@@ -343,18 +345,6 @@ def link_items(
         # Thou shalt not relate to yourself.
         return
 
-    if relationship is referencedRelationship:
-        # 'relatesTo' is the relationship for linkintegrity-relations.
-        # Linkintegrity-relations should automatically be (re)created by
-        # plone.app.linkintegrity.handlers.modifiedDexterity or
-        # plone.app.linkintegrity.handlers.modifiedArchetype
-        # when the ObjectModifiedEvent is thrown.
-        # TODO: This needs to be tested though!!!
-        #
-        # Also: linkintegrity until now uses the reference_catalog which is
-        # only available is Archetypes is installed.
-        return
-
     # if fieldname != 'relatedItems':
         # 'relatedItems' is the default field for AT and DX
         # See plone.app.relationfield.behavior.IRelatedItems for DX and
@@ -378,6 +368,20 @@ def link_items(
     else:
         target_type = 'AT'
 
+    if relationship is referencedRelationship:
+        # 'relatesTo' is the relationship for linkintegrity-relations.
+        # Linkintegrity-relations should automatically be (re)created by
+        # plone.app.linkintegrity.handlers.modifiedDexterity or
+        # plone.app.linkintegrity.handlers.modifiedArchetype
+        # when a ObjectModifiedEvent is thrown.
+        # These relations are only created if the source has a richtext-field
+        # with a link to the target and should not be created manually.
+        if source_type is 'AT':
+            modifiedArchetype(source_obj, None)
+        if source_type is 'DX':
+            modifiedDexterity(source_obj, None)
+        return
+
     if source_type is 'AT':
         # If there is any Archetypes-content there is also the
         # reference_catalog and the uid_catalog.


