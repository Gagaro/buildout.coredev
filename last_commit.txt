Repository: plone.protect


Branch: refs/heads/master
Date: 2015-10-08T14:23:36-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.protect/commit/a11a94b3475584e12f6daa3b5d118f0b570278a1

Handle TypeError caused by getToolByName on an
  invalid context

Files changed:
M CHANGES.rst
M plone/protect/auto.py

diff --git a/CHANGES.rst b/CHANGES.rst
index f7b291a..b722378 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,6 +4,10 @@ Changelog
 3.0.14 (unreleased)
 -------------------
 
+- Handle TypeError caused by getToolByName on an
+  invalid context
+  [vangheem]
+
 - You can opt out of clickjacking protection by setting the
   environment variable ``PLONE_X_FRAME_OPTIONS`` to an empty string.
   [maurits]
diff --git a/plone/protect/auto.py b/plone/protect/auto.py
index 27f4c32..85ee976 100644
--- a/plone/protect/auto.py
+++ b/plone/protect/auto.py
@@ -32,6 +32,11 @@
 from zope.component import getUtility
 from zope.interface import implements, Interface
 
+try:
+    from zope.component.hooks import getSite
+except:
+    from zope.app.component.hooks import getSite
+
 
 LOGGER = logging.getLogger('plone.protect')
 
@@ -126,9 +131,13 @@ def transformIterable(self, result, encoding):
         if not context:
             return
 
-        tool = getToolByName(context, 'portal_url', None)
-        if tool:
-            self.site = tool.getPortalObject()
+        try:
+            tool = getToolByName(context, 'portal_url', None)
+            if tool:
+                self.site = tool.getPortalObject()
+        except TypeError:
+            self.site = getSite()
+
         try:
             self.key_manager = getUtility(IKeyManager)
         except ComponentLookupError:


