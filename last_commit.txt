Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2015-09-20T17:26:21+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.contenttypes/commit/677da2e76a90d1adfcb0d8136f6b374d94d9fe66

Move portal_properties settings to configuration registry

commit 40759516d880a882e7c2c667872f84129d0e63c7
Author: Philip Bauer &lt;bauer@starzel.de&gt;
Date:   Sat Sep 19 07:38:56 2015 +0200

    do not set obsolete site-property default_page_types

commit 06a84ce1e79e8c0d3f72c88f6f8616ff5b39b8c7
Author: esteele &lt;eric@esteele.net&gt;
Date:   Fri Sep 18 09:49:45 2015 +0200

    Fix registry id

commit 103822ceda33ab60142bd2780d209f6b9b3bd6cd
Author: esteele &lt;eric@esteele.net&gt;
Date:   Thu Sep 17 18:30:57 2015 +0200

    Use registry lookup for types_use_view_action_in_listings

commit 301faa4d39bf85d1ef9a0fa69d0c28255d2500d1
Author: esteele &lt;eric@esteele.net&gt;
Date:   Wed Sep 16 16:41:14 2015 +0200

    Move redirect_links to the registry.

Files changed:
M CHANGES.rst
M plone/app/contenttypes/browser/folder.py
M plone/app/contenttypes/browser/full_view.py
M plone/app/contenttypes/browser/link_redirect_view.py
M plone/app/contenttypes/browser/templates/link.pt
D plone/app/contenttypes/profiles/default/propertiestool.xml

diff --git a/CHANGES.rst b/CHANGES.rst
index a4201ec..284f3d9 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -24,6 +24,10 @@ Changelog
 
 - Fixed the summary_view styling
   [sneridagh]
+- redirect_links property has moved to the configuration registry.
+- redirect_links, types_view_action_in_listings properies have moved to the
+  configuration registry.
+  [esteele]
 
 
 1.2.2 (2015-09-15)
diff --git a/plone/app/contenttypes/browser/folder.py b/plone/app/contenttypes/browser/folder.py
index 82f2694..b53d411 100644
--- a/plone/app/contenttypes/browser/folder.py
+++ b/plone/app/contenttypes/browser/folder.py
@@ -94,9 +94,8 @@ def navigation_root_url(self):
 
     @property
     def use_view_action(self):
-        site_props = self.context.restrictedTraverse(
-            'portal_properties').site_properties
-        return getattr(site_props, 'typesUseViewActionInListings', ())
+        registry = getUtility(IRegistry)
+        return registry.get('plone.types_use_view_action_in_listings', [])
 
     @property
     def show_about(self):
diff --git a/plone/app/contenttypes/browser/full_view.py b/plone/app/contenttypes/browser/full_view.py
index 46f9741..178b318 100644
--- a/plone/app/contenttypes/browser/full_view.py
+++ b/plone/app/contenttypes/browser/full_view.py
@@ -1,6 +1,7 @@
 # -*- coding: utf-8 -*-
+from zope.component import getUtility
+from plone.registry.interfaces import IRegistry
 from Products.Five.browser import BrowserView
-from Products.CMFCore.utils import getToolByName
 from zope.publisher.interfaces.browser import IBrowserView
 
 
@@ -31,6 +32,7 @@ def item_macros(self):
     def item_url(self):
         context = self.context
         url = context.absolute_url()
-        props = getToolByName(context, 'portal_properties')
-        use_view_action = props.site_properties.typesUseViewActionInListings
+        registry = getUtility(IRegistry)
+        use_view_action = registry.get(
+            'plone.types_use_view_action_in_listings', [])
         return self.item_type in use_view_action and '%s/view' % url or url
diff --git a/plone/app/contenttypes/browser/link_redirect_view.py b/plone/app/contenttypes/browser/link_redirect_view.py
index adb74a1..cbda1e1 100644
--- a/plone/app/contenttypes/browser/link_redirect_view.py
+++ b/plone/app/contenttypes/browser/link_redirect_view.py
@@ -1,8 +1,11 @@
 # -*- coding: utf-8 -*-
+from zope.component import getUtility
 from Products.CMFCore.utils import getToolByName
+from Products.CMFPlone.interfaces import ITypesSchema
 from Products.Five.browser import BrowserView
 from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile
 from plone.app.contenttypes.utils import replace_link_variables_by_paths
+from plone.registry.interfaces import IRegistry
 
 
 # links starting with these URL scheme should not be redirected to
@@ -35,18 +38,16 @@ def _url_uses_scheme(self, schemes, url=None):
     def __call__(self):
         """Redirect to the Link target URL, if and only if:
          - redirect_links property is enabled in
-           portal_properties/site_properties
+           configuration registry
          - the link is of a redirectable type (no mailto:, etc)
          - AND current user doesn't have permission to edit the Link"""
         context = self.context
-        ptool = getToolByName(context, 'portal_properties')
         mtool = getToolByName(context, 'portal_membership')
 
-        redirect_links = getattr(
-            ptool.site_properties,
-            'redirect_links',
-            False
-        )
+        registry = getUtility(IRegistry)
+        settings = registry.forInterface(ITypesSchema, prefix="plone")
+        redirect_links = settings.redirect_links
+
         can_edit = mtool.checkPermission('Modify portal content', context)
         redirect_links = redirect_links\
             and not self._url_uses_scheme(NON_REDIRECTABLE_URL_SCHEMES)
diff --git a/plone/app/contenttypes/browser/templates/link.pt b/plone/app/contenttypes/browser/templates/link.pt
index c5752e4..865f86b 100644
--- a/plone/app/contenttypes/browser/templates/link.pt
+++ b/plone/app/contenttypes/browser/templates/link.pt
@@ -9,7 +9,7 @@
 
 <metal:header fill-slot="header">
   <div class="portalMessage info"
-      tal:define="redirect_links context/portal_properties/site_properties/redirect_links|nothing;"
+      tal:define="redirect_links python:context.portal_registry['plone.redirect_links']"
       tal:condition="python: redirect_links and checkPermission('Modify portal content', context)">
     <strong i18n:translate="">Info</strong>
     <span tal:omit-tag=""
diff --git a/plone/app/contenttypes/profiles/default/propertiestool.xml b/plone/app/contenttypes/profiles/default/propertiestool.xml
deleted file mode 100644
index 4442935..0000000
--- a/plone/app/contenttypes/profiles/default/propertiestool.xml
+++ /dev/null
@@ -1,11 +0,0 @@
-<?xml version="1.0" encoding="UTF-8"?>
-<object name="portal_properties" meta_type="Plone Properties Tool">
- <object name="site_properties" meta_type="Plone Property Sheet">
-  <property name="default_page_types" type="lines" purge="False">
-   <element value="Document"/>
-   <element value="Event"/>
-   <element value="News Item"/>
-   <element value="Collection"/>
-  </property>
- </object>
-</object>


