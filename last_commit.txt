Repository: plone.app.portlets


Branch: refs/heads/master
Date: 2015-09-18T15:02:20+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.portlets/commit/5f8a560e74f16181715d144b47db160714136abf

Revert "Be defensive in lookups so that unmigrated sites aren't broken."

This reverts commit 25b7e732e5ff974f9d311cf92c7d73c70cbc9743.

Files changed:
M plone/app/portlets/portlets/navigation.py

diff --git a/plone/app/portlets/portlets/navigation.py b/plone/app/portlets/portlets/navigation.py
index 04abfc7..50c1b51 100644
--- a/plone/app/portlets/portlets/navigation.py
+++ b/plone/app/portlets/portlets/navigation.py
@@ -366,9 +366,13 @@ def __init__(self, context, portlet):
 
         # Filter on workflow states, if enabled
         registry = getUtility(IRegistry)
-        if registry.get('plone.filter_on_workflow', False):
-            query['review_state'] = registry.get(
-                'plone.workflow_states_to_show', ())
+        navigation_settings = registry.forInterface(
+            INavigationSchema,
+            prefix="plone"
+        )
+        if navigation_settings.filter_on_workflow:
+            query['review_state'] = navigation_settings.workflow_states_to_show
+
         self.query = query
 
     def __call__(self):


Repository: plone.app.portlets


Branch: refs/heads/master
Date: 2015-09-18T15:02:47+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.portlets/commit/a184268f8a9efb1664c1e06b9ab4866c84776d96

Revert "Fix registry id"

This reverts commit 55629bb57158cc224565bb17a774dc4c01e9a940.

# Conflicts:
#	plone/app/portlets/tests/test_actions_portlet.py

Files changed:
M plone/app/portlets/tests/test_actions_portlet.py

diff --git a/plone/app/portlets/tests/test_actions_portlet.py b/plone/app/portlets/tests/test_actions_portlet.py
index 0743190..7186291 100644
--- a/plone/app/portlets/tests/test_actions_portlet.py
+++ b/plone/app/portlets/tests/test_actions_portlet.py
@@ -130,7 +130,7 @@ def test_render_woicon(self):
         self.failUnless(first['icon'] is None, "We should not have an icon")
         return
 
-    def test_multiple_portlets(self):
+    def test_muptiple_portlets(self):
         """This test ensures that we can add more than one action portlet on
         the same page with different action categories and show_icons option
         and those portlets will work as they are intended to work.


Repository: plone.app.portlets


Branch: refs/heads/master
Date: 2015-09-18T15:03:04+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.portlets/commit/0ccc93a063725429030b19d47cec658cacbddf7e

Revert "remove references to ids_not_to_list"

This reverts commit c18cfda55d956f0c47ec0ba820cfb8281f6a8824.

Files changed:
M plone/app/portlets/tests/test_navigation_portlet.py

diff --git a/plone/app/portlets/tests/test_navigation_portlet.py b/plone/app/portlets/tests/test_navigation_portlet.py
index 255e742..3717d75 100644
--- a/plone/app/portlets/tests/test_navigation_portlet.py
+++ b/plone/app/portlets/tests/test_navigation_portlet.py
@@ -178,6 +178,33 @@ def testShowAllParentsOverridesNavTreeExcludesItemsWithExcludeProperty(self):
                 break
         self.assertTrue(found)
 
+    def testNavTreeExcludesItemsInIdsNotToList(self):
+        # Make sure that items whose ids are in the idsNotToList navTree
+        # property are not included
+        ntp=self.portal.portal_properties.navtree_properties
+        ntp.manage_changeProperties(idsNotToList=['folder2'])
+        view = self.renderer(self.portal.folder1.doc11)
+        tree = view.getNavTree()
+        self.assertTrue(tree)
+        for c in tree['children']:
+            if c['item'].getPath() == '/plone/folder2':
+                self.fail()
+
+    def testShowAllParentsOverridesNavTreeExcludesItemsInIdsNotToList(self):
+        # Make sure that items whose ids are in the idsNotToList navTree
+        # property are not included
+        ntp=self.portal.portal_properties.navtree_properties
+        ntp.manage_changeProperties(idsNotToList=['folder2'], showAllParents=True)
+        view = self.renderer(self.portal.folder2.doc21)
+        tree = view.getNavTree()
+        self.assertTrue(tree)
+        found = False
+        for c in tree['children']:
+            if c['item'].getPath() == '/plone/folder2':
+                found = True
+                break
+        self.assertTrue(found)
+
     def testNavTreeExcludesDefaultPage(self):
         # Make sure that items which are the default page are excluded
         self.portal.folder2.setDefaultPage('doc21')


Repository: plone.app.portlets


Branch: refs/heads/master
Date: 2015-09-18T15:03:12+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.portlets/commit/f118d1cd50c11d241b62a5aaab9a22c8e79fad3a

Revert "Fix test to use registry for 'root' setting"

This reverts commit ccf256132e2ca62b4020aa0a41fee5d89da081ce.

Files changed:
M plone/app/portlets/tests/test_navigation_portlet.py

diff --git a/plone/app/portlets/tests/test_navigation_portlet.py b/plone/app/portlets/tests/test_navigation_portlet.py
index 3717d75..4068ffb 100644
--- a/plone/app/portlets/tests/test_navigation_portlet.py
+++ b/plone/app/portlets/tests/test_navigation_portlet.py
@@ -384,8 +384,8 @@ def testRootDoesNotExist(self):
         self.assertEqual(len(tree['children']), 6)
 
     def testAboveRoot(self):
-        registry = getUtility(IRegistry)
-        registry['plone.root'] = u'/folder2'
+        ntp=self.portal.portal_properties.navtree_properties
+        ntp.manage_changeProperties(root='/folder2')
         view = self.renderer(self.portal)
         tree = view.getNavTree()
         self.assertTrue(tree)


