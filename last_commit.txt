Repository: plone.app.dexterity


Branch: refs/heads/master
Date: 2015-10-22T15:25:39+02:00
Author: Gil Forcada (gforcada) <gforcada@gnome.org>
Commit: https://github.com/plone/plone.app.dexterity/commit/a5e1748825d036800651db63a369e14ffa835028

One letter variables are always a bad idea

'b' is doubly bad as it gets masked by pdb's own 'b' command.

Files changed:
M plone/app/dexterity/upgrades/to2001.py

diff --git a/plone/app/dexterity/upgrades/to2001.py b/plone/app/dexterity/upgrades/to2001.py
index dc60d51..4e4ccaa 100644
--- a/plone/app/dexterity/upgrades/to2001.py
+++ b/plone/app/dexterity/upgrades/to2001.py
@@ -8,8 +8,8 @@
 def add_missing_uuids(context):
     catalog = getToolByName(context, 'portal_catalog')
     query = {'object_provides': IDexterityContent.__identifier__}
-    for b in catalog.unrestrictedSearchResults(query):
-        ob = b.getObject()
+    for brain in catalog.unrestrictedSearchResults(query):
+        ob = brain.getObject()
         if IUUID(ob, None) is None:
             addAttributeUUID(ob, None)
             ob.reindexObject(idxs=['UID'])


Repository: plone.app.dexterity


Branch: refs/heads/master
Date: 2015-10-22T15:25:39+02:00
Author: Gil Forcada Codinachs (gforcada) <gil.forcada@freitag.de>
Commit: https://github.com/plone/plone.app.dexterity/commit/5347f9118baca03505c86f7906a32285228f6ff9

Avoid re-adding the UUID

If an object already has a UID value on the catalog there is no need to add it again.

In cases where *LOTS* of objects get returned by the catalog call it can dramatically impact the upgrade.

Files changed:
M plone/app/dexterity/upgrades/to2001.py

diff --git a/plone/app/dexterity/upgrades/to2001.py b/plone/app/dexterity/upgrades/to2001.py
index 4e4ccaa..c37ac1d 100644
--- a/plone/app/dexterity/upgrades/to2001.py
+++ b/plone/app/dexterity/upgrades/to2001.py
@@ -9,6 +9,8 @@ def add_missing_uuids(context):
     catalog = getToolByName(context, 'portal_catalog')
     query = {'object_provides': IDexterityContent.__identifier__}
     for brain in catalog.unrestrictedSearchResults(query):
+        if getattr(brain, 'UID', None) is not None:
+            continue
         ob = brain.getObject()
         if IUUID(ob, None) is None:
             addAttributeUUID(ob, None)


Repository: plone.app.dexterity


Branch: refs/heads/master
Date: 2015-10-22T15:25:39+02:00
Author: Gil Forcada (gforcada) <gforcada@gnome.org>
Commit: https://github.com/plone/plone.app.dexterity/commit/b6ff8837f409998aeed7be1e5082105a055ca780

Fix test

Files changed:
M plone/app/dexterity/tests/test_upgrades.py

diff --git a/plone/app/dexterity/tests/test_upgrades.py b/plone/app/dexterity/tests/test_upgrades.py
index fb0ecdf..c6851a0 100644
--- a/plone/app/dexterity/tests/test_upgrades.py
+++ b/plone/app/dexterity/tests/test_upgrades.py
@@ -23,6 +23,8 @@ def test_add_missing_uuids(self):
         )
         setattr(page, ATTRIBUTE_NAME, None)
         self.assertTrue(IUUID(page, None) is None)
+        # reindex to remove the UUID it got when the page was created
+        page.reindexObject(idxs=['UID'])
 
         # run the migration
         add_missing_uuids(self.layer['portal'])


Repository: plone.app.dexterity


Branch: refs/heads/master
Date: 2015-10-22T15:26:43+02:00
Author: Gil Forcada (gforcada) <gforcada@gnome.org>
Commit: https://github.com/plone/plone.app.dexterity/commit/4ee32a437f4e12783edc0330e6f964dffc20a0fa

Update CHANGES.rst

Files changed:
M CHANGES.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index 0fddacb..3717369 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -21,6 +21,8 @@ Changelog
 - Update Brazil translations
   [claytonc]
 
+- Avoid re-adding the UUID on an upgrade step.
+  [gforcada]
 
 2.1.14 (2015-09-21)
 -------------------


Repository: plone.app.dexterity


Branch: refs/heads/master
Date: 2015-10-23T10:42:55+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.dexterity/commit/b3670c0cc4a4d76bc364d4b34245905ea5eb1796

Merge pull request #189 from plone/gforcada-avoid-reindex

Avoid re-adding the UUID

Files changed:
M CHANGES.rst
M plone/app/dexterity/tests/test_upgrades.py
M plone/app/dexterity/upgrades/to2001.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 0fddacb..3717369 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -21,6 +21,8 @@ Changelog
 - Update Brazil translations
   [claytonc]
 
+- Avoid re-adding the UUID on an upgrade step.
+  [gforcada]
 
 2.1.14 (2015-09-21)
 -------------------
diff --git a/plone/app/dexterity/tests/test_upgrades.py b/plone/app/dexterity/tests/test_upgrades.py
index fb0ecdf..c6851a0 100644
--- a/plone/app/dexterity/tests/test_upgrades.py
+++ b/plone/app/dexterity/tests/test_upgrades.py
@@ -23,6 +23,8 @@ def test_add_missing_uuids(self):
         )
         setattr(page, ATTRIBUTE_NAME, None)
         self.assertTrue(IUUID(page, None) is None)
+        # reindex to remove the UUID it got when the page was created
+        page.reindexObject(idxs=['UID'])
 
         # run the migration
         add_missing_uuids(self.layer['portal'])
diff --git a/plone/app/dexterity/upgrades/to2001.py b/plone/app/dexterity/upgrades/to2001.py
index dc60d51..c37ac1d 100644
--- a/plone/app/dexterity/upgrades/to2001.py
+++ b/plone/app/dexterity/upgrades/to2001.py
@@ -8,8 +8,10 @@
 def add_missing_uuids(context):
     catalog = getToolByName(context, 'portal_catalog')
     query = {'object_provides': IDexterityContent.__identifier__}
-    for b in catalog.unrestrictedSearchResults(query):
-        ob = b.getObject()
+    for brain in catalog.unrestrictedSearchResults(query):
+        if getattr(brain, 'UID', None) is not None:
+            continue
+        ob = brain.getObject()
         if IUUID(ob, None) is None:
             addAttributeUUID(ob, None)
             ob.reindexObject(idxs=['UID'])


