Repository: plone.app.querystring


Branch: refs/heads/master
Date: 2015-09-04T12:31:01+02:00
Author: Peter Mathis (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/plone.app.querystring/commit/90c4b9b2134b5839eb3c7395b4e9bba01223898d

add before/after relative date query

see #45

Files changed:
A plone/app/querystring/profiles/upgrades/to_11/registry.xml
M CHANGES.rst
M plone/app/querystring/hiddenprofiles.py
M plone/app/querystring/profiles.zcml
M plone/app/querystring/profiles/default/metadata.xml
M plone/app/querystring/profiles/default/registry.xml
M plone/app/querystring/queryparser.py
M plone/app/querystring/tests/testQueryParser.py
M plone/app/querystring/upgrades.zcml

diff --git a/CHANGES.rst b/CHANGES.rst
index 8029e85..83ea82a 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,8 @@ Changelog
 1.3.7 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- Add "before/after N days" functionality
+  [petschki]
 
 
 1.3.6 (2015-08-24)
diff --git a/plone/app/querystring/hiddenprofiles.py b/plone/app/querystring/hiddenprofiles.py
index 00a2c3a..53c16da 100644
--- a/plone/app/querystring/hiddenprofiles.py
+++ b/plone/app/querystring/hiddenprofiles.py
@@ -21,4 +21,6 @@ def getNonInstallableProfiles(self):
             'plone.app.querystring:upgrade_to_7',
             'plone.app.querystring:upgrade_to_8',
             'plone.app.querystring:upgrade_to_9',
+            'plone.app.querystring:upgrade_to_10',
+            'plone.app.querystring:upgrade_to_11',
         ]
diff --git a/plone/app/querystring/profiles.zcml b/plone/app/querystring/profiles.zcml
index d93075d..558d035 100644
--- a/plone/app/querystring/profiles.zcml
+++ b/plone/app/querystring/profiles.zcml
@@ -73,4 +73,12 @@
         provides="Products.GenericSetup.interfaces.EXTENSION"
         />
 
+    <genericsetup:registerProfile
+        name="upgrade_to_11"
+        title="Querystring Upgrade profile to v11"
+        description=""
+        directory="profiles/upgrades/to_11"
+        provides="Products.GenericSetup.interfaces.EXTENSION"
+        />
+
  </configure>
diff --git a/plone/app/querystring/profiles/default/metadata.xml b/plone/app/querystring/profiles/default/metadata.xml
index ecb0990..66c4f1f 100644
--- a/plone/app/querystring/profiles/default/metadata.xml
+++ b/plone/app/querystring/profiles/default/metadata.xml
@@ -1,6 +1,6 @@
 <?xml version="1.0"?>
 <metadata>
-  <version>10</version>
+  <version>11</version>
   <dependencies>
       <dependency>profile-plone.app.registry:default</dependency>
   </dependencies>
diff --git a/plone/app/querystring/profiles/default/registry.xml b/plone/app/querystring/profiles/default/registry.xml
index d125372..028bc88 100644
--- a/plone/app/querystring/profiles/default/registry.xml
+++ b/plone/app/querystring/profiles/default/registry.xml
@@ -107,6 +107,22 @@
     </records>
 
     <records interface="plone.app.querystring.interfaces.IQueryOperation"
+             prefix="plone.app.querystring.operation.date.beforeRelativeDate">
+        <value key="title" i18n:translate="">Before relative Date</value>
+        <value key="description" i18n:translate="">Before N days in the past</value>
+        <value key="operation">plone.app.querystring.queryparser._beforeRelativeDate</value>
+        <value key="widget">RelativeDateWidget</value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryOperation"
+             prefix="plone.app.querystring.operation.date.afterRelativeDate">
+        <value key="title" i18n:translate="">After relative Date</value>
+        <value key="description" i18n:translate="">After N days in the future</value>
+        <value key="operation">plone.app.querystring.queryparser._afterRelativeDate</value>
+        <value key="widget">RelativeDateWidget</value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryOperation"
              prefix="plone.app.querystring.operation.list.contains">
         <value key="title" i18n:translate="">Contains</value>
         <value key="description"></value>
@@ -268,6 +284,8 @@
            <element>plone.app.querystring.operation.date.today</element>
            <element>plone.app.querystring.operation.date.beforeToday</element>
            <element>plone.app.querystring.operation.date.afterToday</element>
+           <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+           <element>plone.app.querystring.operation.date.afterRelativeDate</element>
        </value>
        <value key="group" i18n:translate="">Dates</value>
     </records>
@@ -313,6 +331,8 @@
             <element>plone.app.querystring.operation.date.today</element>
             <element>plone.app.querystring.operation.date.beforeToday</element>
             <element>plone.app.querystring.operation.date.afterToday</element>
+            <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+            <element>plone.app.querystring.operation.date.afterRelativeDate</element>
         </value>
        <value key="group" i18n:translate="">Dates</value>
     </records>
@@ -343,6 +363,8 @@
             <element>plone.app.querystring.operation.date.today</element>
             <element>plone.app.querystring.operation.date.beforeToday</element>
             <element>plone.app.querystring.operation.date.afterToday</element>
+            <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+            <element>plone.app.querystring.operation.date.afterRelativeDate</element>
         </value>
        <value key="group" i18n:translate="">Dates</value>
     </records>
@@ -414,6 +436,8 @@
             <element>plone.app.querystring.operation.date.today</element>
             <element>plone.app.querystring.operation.date.beforeToday</element>
             <element>plone.app.querystring.operation.date.afterToday</element>
+            <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+            <element>plone.app.querystring.operation.date.afterRelativeDate</element>
         </value>
        <value key="group" i18n:translate="">Dates</value>
     </records>
@@ -433,6 +457,8 @@
             <element>plone.app.querystring.operation.date.today</element>
             <element>plone.app.querystring.operation.date.beforeToday</element>
             <element>plone.app.querystring.operation.date.afterToday</element>
+            <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+            <element>plone.app.querystring.operation.date.afterRelativeDate</element>
         </value>
        <value key="group" i18n:translate="">Dates</value>
     </records>
@@ -516,6 +542,8 @@
             <element>plone.app.querystring.operation.date.today</element>
             <element>plone.app.querystring.operation.date.beforeToday</element>
             <element>plone.app.querystring.operation.date.afterToday</element>
+            <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+            <element>plone.app.querystring.operation.date.afterRelativeDate</element>
         </value>
        <value key="group" i18n:translate="">Dates</value>
     </records>
diff --git a/plone/app/querystring/profiles/upgrades/to_11/registry.xml b/plone/app/querystring/profiles/upgrades/to_11/registry.xml
new file mode 100644
index 0000000..4f230a0
--- /dev/null
+++ b/plone/app/querystring/profiles/upgrades/to_11/registry.xml
@@ -0,0 +1,68 @@
+<registry xmlns:i18n="http://xml.zope.org/namespaces/i18n"
+          i18n:domain="plone">
+
+    <records interface="plone.app.querystring.interfaces.IQueryOperation"
+             prefix="plone.app.querystring.operation.date.beforeRelativeDate">
+        <value key="title" i18n:translate="">Before relative Date</value>
+        <value key="description" i18n:translate="">Before N days in the past</value>
+        <value key="operation">plone.app.querystring.queryparser._beforeRelativeDate</value>
+        <value key="widget">RelativeDateWidget</value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryOperation"
+             prefix="plone.app.querystring.operation.date.afterRelativeDate">
+        <value key="title" i18n:translate="">After relative Date</value>
+        <value key="description" i18n:translate="">After N days in the future</value>
+        <value key="operation">plone.app.querystring.queryparser._afterRelativeDate</value>
+        <value key="widget">RelativeDateWidget</value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryField"
+             prefix="plone.app.querystring.field.created">
+       <value key="operations" purge="false">
+           <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+           <element>plone.app.querystring.operation.date.afterRelativeDate</element>
+       </value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryField"
+             prefix="plone.app.querystring.field.modified">
+       <value key="operations" purge="false">
+           <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+           <element>plone.app.querystring.operation.date.afterRelativeDate</element>
+       </value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryField"
+             prefix="plone.app.querystring.field.start">
+       <value key="operations" purge="false">
+           <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+           <element>plone.app.querystring.operation.date.afterRelativeDate</element>
+       </value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryField"
+             prefix="plone.app.querystring.field.end">
+       <value key="operations" purge="false">
+           <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+           <element>plone.app.querystring.operation.date.afterRelativeDate</element>
+       </value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryField"
+             prefix="plone.app.querystring.field.effective">
+       <value key="operations" purge="false">
+           <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+           <element>plone.app.querystring.operation.date.afterRelativeDate</element>
+       </value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryField"
+             prefix="plone.app.querystring.field.expires">
+       <value key="operations" purge="false">
+           <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+           <element>plone.app.querystring.operation.date.afterRelativeDate</element>
+       </value>
+    </records>
+
+</registry>
\ No newline at end of file
diff --git a/plone/app/querystring/queryparser.py b/plone/app/querystring/queryparser.py
index 3a67ed0..a77841c 100644
--- a/plone/app/querystring/queryparser.py
+++ b/plone/app/querystring/queryparser.py
@@ -248,6 +248,28 @@ def _beforeToday(context, row):
     return _lessThan(context, row)
 
 
+def _beforeRelativeDate(context, row):
+    try:
+        values = int(row.values)
+    except ValueError:
+        values = 0
+    row = Row(index=row.index,
+              operator=row.operator,
+              values=DateTime().earliestTime() - values)
+    return _lessThan(context, row)
+
+
+def _afterRelativeDate(context, row):
+    try:
+        values = int(row.values)
+    except ValueError:
+        values = 0
+    row = Row(index=row.index,
+              operator=row.operator,
+              values=DateTime().earliestTime() + values)
+    return _largerThan(context, row)
+
+
 def _pathByRoot(root, context, row):
     values = row.values
     depth = None
diff --git a/plone/app/querystring/tests/testQueryParser.py b/plone/app/querystring/tests/testQueryParser.py
index 0773261..8fd0663 100644
--- a/plone/app/querystring/tests/testQueryParser.py
+++ b/plone/app/querystring/tests/testQueryParser.py
@@ -413,6 +413,32 @@ def test__moreThanRelativeDate(self):
         parsed = queryparser._moreThanRelativeDate(MockSite(), data)
         self.assertEqual(parsed, expected)
 
+    def test__beforeRelativeDate(self):
+        days = 365
+        now = DateTime()
+        mydate = now.earliestTime() - days
+        expected = {'modified': {'query': mydate, 'range': 'max'}}
+        data = Row(
+            index='modified',
+            operator='_beforeRelativeDate',
+            values=days
+        )
+        parsed = queryparser._beforeRelativeDate(MockSite(), data)
+        self.assertEqual(parsed, expected)
+
+    def test__afterRelativeDate(self):
+        days = 2
+        now = DateTime()
+        mydate = now.earliestTime() + days
+        expected = {'effective': {'query': mydate, 'range': 'min'}}
+        data = Row(
+            index='effective',
+            operator='_afterRelativeDate',
+            values=days
+        )
+        parsed = queryparser._afterRelativeDate(MockSite(), data)
+        self.assertEqual(parsed, expected)
+
     def test__today(self):
         now = DateTime()
         expected_dates = [now.earliestTime(), now.latestTime()]
diff --git a/plone/app/querystring/upgrades.zcml b/plone/app/querystring/upgrades.zcml
index ff97324..6eb85bc 100644
--- a/plone/app/querystring/upgrades.zcml
+++ b/plone/app/querystring/upgrades.zcml
@@ -102,4 +102,14 @@
         />
   </genericsetup:upgradeSteps>
 
+  <genericsetup:upgradeSteps
+      source="10"
+      destination="11"
+      profile="plone.app.querystring:default">
+    <genericsetup:upgradeDepends
+        title="Add new 'before/after relative Date' operation"
+        import_profile="plone.app.querystring:upgrade_to_11"
+        />
+  </genericsetup:upgradeSteps>
+
 </configure>


Repository: plone.app.querystring


Branch: refs/heads/master
Date: 2015-09-18T19:00:22+02:00
Author: Peter Mathis (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/plone.app.querystring/commit/7854816c5e5f766d65b8a58ef40c0c799da6606f

Merge branch 'master' into issue_45

Files changed:
M CHANGES.rst
M plone/app/querystring/registryreader.py
M setup.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 83ea82a..778cddd 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -1,12 +1,22 @@
 Changelog
 =========
 
-1.3.7 (unreleased)
+1.3.8 (unreleased)
 ------------------
 
 - Add "before/after N days" functionality
   [petschki]
 
+- Fixed Sortable Indexes to not return ZCTextIndex type indexes.
+  [winstonf88]
+
+
+1.3.7 (2015-09-11)
+------------------
+
+- Fix vocabularies sorting
+  [ebrehault]
+
 
 1.3.6 (2015-08-24)
 ------------------
diff --git a/plone/app/querystring/registryreader.py b/plone/app/querystring/registryreader.py
index 8060a2f..3a49c28 100644
--- a/plone/app/querystring/registryreader.py
+++ b/plone/app/querystring/registryreader.py
@@ -1,6 +1,9 @@
 from .interfaces import IQuerystringRegistryReader
 from operator import attrgetter
+from Products.CMFCore.utils import getToolByName
+from Products.ZCTextIndex.interfaces import IZCTextIndex
 from zope.component import queryUtility
+from zope.component.hooks import getSite
 from zope.globalrequest import getRequest
 from zope.i18n import translate
 from zope.i18nmessageid import Message
@@ -102,9 +105,11 @@ def mapOperations(self, values):
 
     def mapSortableIndexes(self, values):
         """Map sortable indexes"""
+        catalog = getToolByName(getSite(), 'portal_catalog')._catalog
         sortables = {}
         for key, field in values.get('%s.field' % self.prefix).iteritems():
-            if field['sortable']:
+            if field['sortable'] and \
+               not IZCTextIndex.providedBy(catalog.getIndex(key)):
                 sortables[key] = values.get('%s.field.%s' % (self.prefix, key))
         values['sortable'] = sortables
         return values
diff --git a/setup.py b/setup.py
index c51a4f5..417bbda 100644
--- a/setup.py
+++ b/setup.py
@@ -1,6 +1,6 @@
 from setuptools import setup, find_packages
 
-version = '1.3.7.dev0'
+version = '1.3.8.dev0'
 
 long_description = open("README.rst").read() + "\n"
 long_description += open("CHANGES.rst").read()


Repository: plone.app.querystring


Branch: refs/heads/master
Date: 2015-09-19T15:19:13+02:00
Author: Gil Forcada Codinachs (gforcada) <gil.forcada@freitag.de>
Commit: https://github.com/plone/plone.app.querystring/commit/e0e14d2a4a568cecbcc14c635626431616759526

Merge pull request #46 from plone/issue_45

add before/after relative date query

Files changed:
A plone/app/querystring/profiles/upgrades/to_11/registry.xml
M CHANGES.rst
M plone/app/querystring/hiddenprofiles.py
M plone/app/querystring/profiles.zcml
M plone/app/querystring/profiles/default/metadata.xml
M plone/app/querystring/profiles/default/registry.xml
M plone/app/querystring/queryparser.py
M plone/app/querystring/tests/testQueryParser.py
M plone/app/querystring/upgrades.zcml

diff --git a/CHANGES.rst b/CHANGES.rst
index da49dba..778cddd 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,6 +4,9 @@ Changelog
 1.3.8 (unreleased)
 ------------------
 
+- Add "before/after N days" functionality
+  [petschki]
+
 - Fixed Sortable Indexes to not return ZCTextIndex type indexes.
   [winstonf88]
 
diff --git a/plone/app/querystring/hiddenprofiles.py b/plone/app/querystring/hiddenprofiles.py
index 00a2c3a..53c16da 100644
--- a/plone/app/querystring/hiddenprofiles.py
+++ b/plone/app/querystring/hiddenprofiles.py
@@ -21,4 +21,6 @@ def getNonInstallableProfiles(self):
             'plone.app.querystring:upgrade_to_7',
             'plone.app.querystring:upgrade_to_8',
             'plone.app.querystring:upgrade_to_9',
+            'plone.app.querystring:upgrade_to_10',
+            'plone.app.querystring:upgrade_to_11',
         ]
diff --git a/plone/app/querystring/profiles.zcml b/plone/app/querystring/profiles.zcml
index d93075d..558d035 100644
--- a/plone/app/querystring/profiles.zcml
+++ b/plone/app/querystring/profiles.zcml
@@ -73,4 +73,12 @@
         provides="Products.GenericSetup.interfaces.EXTENSION"
         />
 
+    <genericsetup:registerProfile
+        name="upgrade_to_11"
+        title="Querystring Upgrade profile to v11"
+        description=""
+        directory="profiles/upgrades/to_11"
+        provides="Products.GenericSetup.interfaces.EXTENSION"
+        />
+
  </configure>
diff --git a/plone/app/querystring/profiles/default/metadata.xml b/plone/app/querystring/profiles/default/metadata.xml
index ecb0990..66c4f1f 100644
--- a/plone/app/querystring/profiles/default/metadata.xml
+++ b/plone/app/querystring/profiles/default/metadata.xml
@@ -1,6 +1,6 @@
 <?xml version="1.0"?>
 <metadata>
-  <version>10</version>
+  <version>11</version>
   <dependencies>
       <dependency>profile-plone.app.registry:default</dependency>
   </dependencies>
diff --git a/plone/app/querystring/profiles/default/registry.xml b/plone/app/querystring/profiles/default/registry.xml
index d125372..028bc88 100644
--- a/plone/app/querystring/profiles/default/registry.xml
+++ b/plone/app/querystring/profiles/default/registry.xml
@@ -107,6 +107,22 @@
     </records>
 
     <records interface="plone.app.querystring.interfaces.IQueryOperation"
+             prefix="plone.app.querystring.operation.date.beforeRelativeDate">
+        <value key="title" i18n:translate="">Before relative Date</value>
+        <value key="description" i18n:translate="">Before N days in the past</value>
+        <value key="operation">plone.app.querystring.queryparser._beforeRelativeDate</value>
+        <value key="widget">RelativeDateWidget</value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryOperation"
+             prefix="plone.app.querystring.operation.date.afterRelativeDate">
+        <value key="title" i18n:translate="">After relative Date</value>
+        <value key="description" i18n:translate="">After N days in the future</value>
+        <value key="operation">plone.app.querystring.queryparser._afterRelativeDate</value>
+        <value key="widget">RelativeDateWidget</value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryOperation"
              prefix="plone.app.querystring.operation.list.contains">
         <value key="title" i18n:translate="">Contains</value>
         <value key="description"></value>
@@ -268,6 +284,8 @@
            <element>plone.app.querystring.operation.date.today</element>
            <element>plone.app.querystring.operation.date.beforeToday</element>
            <element>plone.app.querystring.operation.date.afterToday</element>
+           <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+           <element>plone.app.querystring.operation.date.afterRelativeDate</element>
        </value>
        <value key="group" i18n:translate="">Dates</value>
     </records>
@@ -313,6 +331,8 @@
             <element>plone.app.querystring.operation.date.today</element>
             <element>plone.app.querystring.operation.date.beforeToday</element>
             <element>plone.app.querystring.operation.date.afterToday</element>
+            <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+            <element>plone.app.querystring.operation.date.afterRelativeDate</element>
         </value>
        <value key="group" i18n:translate="">Dates</value>
     </records>
@@ -343,6 +363,8 @@
             <element>plone.app.querystring.operation.date.today</element>
             <element>plone.app.querystring.operation.date.beforeToday</element>
             <element>plone.app.querystring.operation.date.afterToday</element>
+            <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+            <element>plone.app.querystring.operation.date.afterRelativeDate</element>
         </value>
        <value key="group" i18n:translate="">Dates</value>
     </records>
@@ -414,6 +436,8 @@
             <element>plone.app.querystring.operation.date.today</element>
             <element>plone.app.querystring.operation.date.beforeToday</element>
             <element>plone.app.querystring.operation.date.afterToday</element>
+            <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+            <element>plone.app.querystring.operation.date.afterRelativeDate</element>
         </value>
        <value key="group" i18n:translate="">Dates</value>
     </records>
@@ -433,6 +457,8 @@
             <element>plone.app.querystring.operation.date.today</element>
             <element>plone.app.querystring.operation.date.beforeToday</element>
             <element>plone.app.querystring.operation.date.afterToday</element>
+            <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+            <element>plone.app.querystring.operation.date.afterRelativeDate</element>
         </value>
        <value key="group" i18n:translate="">Dates</value>
     </records>
@@ -516,6 +542,8 @@
             <element>plone.app.querystring.operation.date.today</element>
             <element>plone.app.querystring.operation.date.beforeToday</element>
             <element>plone.app.querystring.operation.date.afterToday</element>
+            <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+            <element>plone.app.querystring.operation.date.afterRelativeDate</element>
         </value>
        <value key="group" i18n:translate="">Dates</value>
     </records>
diff --git a/plone/app/querystring/profiles/upgrades/to_11/registry.xml b/plone/app/querystring/profiles/upgrades/to_11/registry.xml
new file mode 100644
index 0000000..4f230a0
--- /dev/null
+++ b/plone/app/querystring/profiles/upgrades/to_11/registry.xml
@@ -0,0 +1,68 @@
+<registry xmlns:i18n="http://xml.zope.org/namespaces/i18n"
+          i18n:domain="plone">
+
+    <records interface="plone.app.querystring.interfaces.IQueryOperation"
+             prefix="plone.app.querystring.operation.date.beforeRelativeDate">
+        <value key="title" i18n:translate="">Before relative Date</value>
+        <value key="description" i18n:translate="">Before N days in the past</value>
+        <value key="operation">plone.app.querystring.queryparser._beforeRelativeDate</value>
+        <value key="widget">RelativeDateWidget</value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryOperation"
+             prefix="plone.app.querystring.operation.date.afterRelativeDate">
+        <value key="title" i18n:translate="">After relative Date</value>
+        <value key="description" i18n:translate="">After N days in the future</value>
+        <value key="operation">plone.app.querystring.queryparser._afterRelativeDate</value>
+        <value key="widget">RelativeDateWidget</value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryField"
+             prefix="plone.app.querystring.field.created">
+       <value key="operations" purge="false">
+           <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+           <element>plone.app.querystring.operation.date.afterRelativeDate</element>
+       </value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryField"
+             prefix="plone.app.querystring.field.modified">
+       <value key="operations" purge="false">
+           <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+           <element>plone.app.querystring.operation.date.afterRelativeDate</element>
+       </value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryField"
+             prefix="plone.app.querystring.field.start">
+       <value key="operations" purge="false">
+           <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+           <element>plone.app.querystring.operation.date.afterRelativeDate</element>
+       </value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryField"
+             prefix="plone.app.querystring.field.end">
+       <value key="operations" purge="false">
+           <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+           <element>plone.app.querystring.operation.date.afterRelativeDate</element>
+       </value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryField"
+             prefix="plone.app.querystring.field.effective">
+       <value key="operations" purge="false">
+           <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+           <element>plone.app.querystring.operation.date.afterRelativeDate</element>
+       </value>
+    </records>
+
+    <records interface="plone.app.querystring.interfaces.IQueryField"
+             prefix="plone.app.querystring.field.expires">
+       <value key="operations" purge="false">
+           <element>plone.app.querystring.operation.date.beforeRelativeDate</element>
+           <element>plone.app.querystring.operation.date.afterRelativeDate</element>
+       </value>
+    </records>
+
+</registry>
\ No newline at end of file
diff --git a/plone/app/querystring/queryparser.py b/plone/app/querystring/queryparser.py
index 3a67ed0..a77841c 100644
--- a/plone/app/querystring/queryparser.py
+++ b/plone/app/querystring/queryparser.py
@@ -248,6 +248,28 @@ def _beforeToday(context, row):
     return _lessThan(context, row)
 
 
+def _beforeRelativeDate(context, row):
+    try:
+        values = int(row.values)
+    except ValueError:
+        values = 0
+    row = Row(index=row.index,
+              operator=row.operator,
+              values=DateTime().earliestTime() - values)
+    return _lessThan(context, row)
+
+
+def _afterRelativeDate(context, row):
+    try:
+        values = int(row.values)
+    except ValueError:
+        values = 0
+    row = Row(index=row.index,
+              operator=row.operator,
+              values=DateTime().earliestTime() + values)
+    return _largerThan(context, row)
+
+
 def _pathByRoot(root, context, row):
     values = row.values
     depth = None
diff --git a/plone/app/querystring/tests/testQueryParser.py b/plone/app/querystring/tests/testQueryParser.py
index 0773261..8fd0663 100644
--- a/plone/app/querystring/tests/testQueryParser.py
+++ b/plone/app/querystring/tests/testQueryParser.py
@@ -413,6 +413,32 @@ def test__moreThanRelativeDate(self):
         parsed = queryparser._moreThanRelativeDate(MockSite(), data)
         self.assertEqual(parsed, expected)
 
+    def test__beforeRelativeDate(self):
+        days = 365
+        now = DateTime()
+        mydate = now.earliestTime() - days
+        expected = {'modified': {'query': mydate, 'range': 'max'}}
+        data = Row(
+            index='modified',
+            operator='_beforeRelativeDate',
+            values=days
+        )
+        parsed = queryparser._beforeRelativeDate(MockSite(), data)
+        self.assertEqual(parsed, expected)
+
+    def test__afterRelativeDate(self):
+        days = 2
+        now = DateTime()
+        mydate = now.earliestTime() + days
+        expected = {'effective': {'query': mydate, 'range': 'min'}}
+        data = Row(
+            index='effective',
+            operator='_afterRelativeDate',
+            values=days
+        )
+        parsed = queryparser._afterRelativeDate(MockSite(), data)
+        self.assertEqual(parsed, expected)
+
     def test__today(self):
         now = DateTime()
         expected_dates = [now.earliestTime(), now.latestTime()]
diff --git a/plone/app/querystring/upgrades.zcml b/plone/app/querystring/upgrades.zcml
index ff97324..6eb85bc 100644
--- a/plone/app/querystring/upgrades.zcml
+++ b/plone/app/querystring/upgrades.zcml
@@ -102,4 +102,14 @@
         />
   </genericsetup:upgradeSteps>
 
+  <genericsetup:upgradeSteps
+      source="10"
+      destination="11"
+      profile="plone.app.querystring:default">
+    <genericsetup:upgradeDepends
+        title="Add new 'before/after relative Date' operation"
+        import_profile="plone.app.querystring:upgrade_to_11"
+        />
+  </genericsetup:upgradeSteps>
+
 </configure>


