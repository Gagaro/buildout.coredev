Repository: plone.app.caching
Branch: refs/heads/master
Date: 2015-06-04T13:53:02-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.app.caching/commit/23e261193e20c6846fea73fca995b78f51aa1793

make control panel work for both plone 4 and plone 5 with tabs closes https://github.com/plone/Products.CMFPlone/issues/540

Files changed:
M CHANGES.rst
M plone/app/caching/browser/controlpanel.pt
M plone/app/caching/browser/controlpanel.py
M plone/app/caching/browser/import.pt
M plone/app/caching/browser/purge.pt
M plone/app/caching/browser/ramcache.pt

diff --git a/CHANGES.rst b/CHANGES.rst
index bedfc3f..adbd90a 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,8 @@ Changelog
 1.2.4 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- make control panel work for both plone 4 and plone 5 with tabs
+  [vangheem]
 
 
 1.2.3 (2015-05-04)
diff --git a/plone/app/caching/browser/controlpanel.pt b/plone/app/caching/browser/controlpanel.pt
index a33c20c..d1f541c 100644
--- a/plone/app/caching/browser/controlpanel.pt
+++ b/plone/app/caching/browser/controlpanel.pt
@@ -14,6 +14,7 @@
 (function($) {
 
     $().ready(function() {
+    debugger;
         $('a.editGlobalOperationParameters, a.editRulesetOperationParameters').prepOverlay({
             subtype: 'ajax',
             filter: '#content>*:not(div.configlet),dl.portalMessage.error,dl.portalMessage.info',
@@ -26,37 +27,6 @@
 })(jQuery);
 </script>
 
-      <div id="region-content" class="documentEditable">
-
-        <div id="edit-bar">
-            <ul class="contentViews" id="content-views">
-              <li class="selected">
-                <a href=""
-                   tal:attributes="href string:${portal_url}/@@caching-controlpanel"
-                   i18n:translate="label_settings">Change settings</a>
-              </li>
-              <li>
-                <a href=""
-                   tal:attributes="href string:${portal_url}/@@caching-controlpanel-import"
-                   i18n:translate="label_import">Import settings</a>
-              </li>
-              <li tal:condition="view/purgingEnabled">
-                <a href=""
-                   tal:attributes="href string:${portal_url}/@@caching-controlpanel-purge"
-                   i18n:translate="label_purging">Purge caching proxy</a>
-              </li>
-              <li>
-                <a href=""
-                   tal:attributes="href string:${portal_url}/@@caching-controlpanel-ramcache"
-                   i18n:translate="label_ramcache">RAM cache</a>
-              </li>
-            </ul>
-        </div>
-
-        <div class="contentActions">
-          &#160;
-        </div>
-
         <div class="documentContent" id="content">
             <a name="documentContent"></a>
 
@@ -94,9 +64,32 @@
                 <form
                     name="settings"
                     method="post"
-                    class="enableFormTabbing enableUnloadProtection"
+                    class="enableUnloadProtection autotabs"
                     tal:attributes="action request/URL"
                     tal:define="errors view/errors">
+                    <ul class="formTabs autotoc-nav">
+                        <li class="formTab firstFormTab">
+                            <a href=""
+                               class="active selected"
+                               tal:attributes="href string:${portal_url}/@@caching-controlpanel"
+                               i18n:translate="label_settings">Change settings</a>
+                          </li>
+                          <li class="formTab">
+                            <a href=""
+                               tal:attributes="href string:${portal_url}/@@caching-controlpanel-import"
+                               i18n:translate="label_import">Import settings</a>
+                          </li>
+                          <li tal:condition="view/purgingEnabled" class="formTab">
+                            <a href=""
+                               tal:attributes="href string:${portal_url}/@@caching-controlpanel-purge"
+                               i18n:translate="label_purging">Purge caching proxy</a>
+                          </li>
+                          <li class="formTab lastFormTab">
+                            <a href=""
+                               tal:attributes="href string:${portal_url}/@@caching-controlpanel-ramcache"
+                               i18n:translate="label_ramcache">RAM cache</a>
+                          </li>
+                    </ul>
 
                     <!-- Field set: global settings -->
                     <fieldset id="fieldset-global-settings">
@@ -669,7 +662,6 @@
             </div>
         </div>
     </div>
-</div>
 
 </body>
 </html>
diff --git a/plone/app/caching/browser/controlpanel.py b/plone/app/caching/browser/controlpanel.py
index 22cee2c..4e72de8 100644
--- a/plone/app/caching/browser/controlpanel.py
+++ b/plone/app/caching/browser/controlpanel.py
@@ -155,34 +155,35 @@ def update(self):
             if 'form.button.Save' in self.request.form:
                 self.processSave()
             elif 'form.button.Cancel' in self.request.form:
-                self.request.response.redirect("%s/plone_control_panel" % self.context.absolute_url())
+                self.request.response.redirect(
+                    "%s/plone_control_panel" % self.context.absolute_url())
 
     def processSave(self):
 
         form = self.request.form
 
         # Form data
-        enabled            = form.get('enabled', False)
-        enableCompression  = form.get('enableCompression', False)
-        contentTypesMap    = form.get('contenttypes', {})
-        templatesMap       = form.get('templates', {})
-        operations         = form.get('operations', {})
-
-        purgingEnabled     = form.get('purgingEnabled', False)
-        cachingProxies     = tuple(form.get('cachingProxies', ()))
+        enabled = form.get('enabled', False)
+        enableCompression = form.get('enableCompression', False)
+        contentTypesMap = form.get('contenttypes', {})
+        templatesMap = form.get('templates', {})
+        operations = form.get('operations', {})
+
+        purgingEnabled = form.get('purgingEnabled', False)
+        cachingProxies = tuple(form.get('cachingProxies', ()))
         purgedContentTypes = tuple(form.get('purgedContentTypes', ()))
-        virtualHosting     = form.get('virtualHosting', False)
-        domains            = tuple(form.get('domains', ()))
+        virtualHosting = form.get('virtualHosting', False)
+        domains = tuple(form.get('domains', ()))
 
-        ramCacheMaxEntries      = form.get('ramCacheMaxEntries', None)
-        ramCacheMaxAge          = form.get('ramCacheMaxAge', None)
+        ramCacheMaxEntries = form.get('ramCacheMaxEntries', None)
+        ramCacheMaxAge = form.get('ramCacheMaxAge', None)
         ramCacheCleanupInterval = form.get('ramCacheCleanupInterval', None)
 
         # Settings
 
-        operationMapping          = {}
+        operationMapping = {}
         contentTypeRulesetMapping = {}
-        templateRulesetMapping    = {}
+        templateRulesetMapping = {}
 
         # Process mappings and validate
 
@@ -191,10 +192,10 @@ def processSave(self):
             if not ruleset or not operation:
                 continue
 
-            if isinstance(ruleset, unicode): # should be ASCII
+            if isinstance(ruleset, unicode):  # should be ASCII
                 ruleset = ruleset.encode('utf-8')
 
-            if isinstance(operation, unicode): # should be ASCII
+            if isinstance(operation, unicode):  # should be ASCII
                 operation = operation.encode('utf-8')
 
             ruleset = ruleset.replace('-', '.')
@@ -205,7 +206,7 @@ def processSave(self):
             if not ruleset:
                 continue
 
-            if isinstance(ruleset, unicode): # should be ASCII
+            if isinstance(ruleset, unicode):  # should be ASCII
                 ruleset = ruleset.encode('utf-8')
 
             ruleset = ruleset.replace('-', '.')
@@ -215,14 +216,15 @@ def processSave(self):
                 if not contentType:
                     continue
 
-                if isinstance(contentType, unicode): # should be ASCII
+                if isinstance(contentType, unicode):  # should be ASCII
                     contentType = contentType.encode('utf-8')
 
                 if contentType in contentTypeRulesetMapping:
                     self.errors.setdefault('contenttypes', {})[ruleset] = \
                         _(u"Content type ${contentType} is already mapped to the rule ${ruleset}.",
-                            mapping={'contentType': self.contentTypesLookup.get(contentType, {}).get('title', contentType),
-                                     'ruleset': contentTypeRulesetMapping[contentType]})
+                            mapping={
+                                'contentType': self.contentTypesLookup.get(contentType, {}).get('title', contentType),  # noqa
+                                'ruleset': contentTypeRulesetMapping[contentType]})
                 else:
                     contentTypeRulesetMapping[contentType] = ruleset
 
@@ -231,7 +233,7 @@ def processSave(self):
             if not ruleset:
                 continue
 
-            if isinstance(ruleset, unicode): # should be ASCII
+            if isinstance(ruleset, unicode):  # should be ASCII
                 ruleset = ruleset.encode('utf-8')
 
             ruleset = ruleset.replace('-', '.')
@@ -243,14 +245,15 @@ def processSave(self):
                 if not template:
                     continue
 
-                if isinstance(template, unicode): # should be ASCII
+                if isinstance(template, unicode):  # should be ASCII
                     template = template.encode('utf-8')
 
                 if template in templateRulesetMapping:
                     self.errors.setdefault('templates', {})[ruleset] = \
                         _(u"Template ${template} is already mapped to the rule ${ruleset}.",
-                            mapping={'template': template,
-                                      'ruleset': templateRulesetMapping[template]})
+                            mapping={
+                                'template': template,
+                                'ruleset': templateRulesetMapping[template]})
                 else:
                     templateRulesetMapping[template] = ruleset
 
@@ -258,7 +261,7 @@ def processSave(self):
 
         for cachingProxy in cachingProxies:
             if not _isuri(cachingProxy):
-                self.errors['cachingProxies'] = _(u"Invalid URL: ${url}", mapping={'url': cachingProxy})
+                self.errors['cachingProxies'] = _(u"Invalid URL: ${url}", mapping={'url': cachingProxy})  # noqa
 
         for domain in domains:
             if not _isuri(domain):
@@ -313,9 +316,7 @@ def processSave(self):
 
         IStatusMessage(self.request).addStatusMessage(_(u"Changes saved."), "info")
 
-
     # Rule types - used as the index column
-
     @property
     @memoize
     def ruleTypes(self):
@@ -325,7 +326,7 @@ def ruleTypes(self):
                               title=type_.title or type_.name,
                               description=type_.description,
                               safeName=type_.name.replace('.', '-')))
-        types.sort(lambda x,y: cmp(x['title'], y['title']))
+        types.sort(lambda x, y: cmp(x['title'], y['title']))
         return types
 
     # Safe access to the main mappings, which may be None - we want to treat
@@ -335,28 +336,22 @@ def ruleTypes(self):
     @property
     def operationMapping(self):
         return dict(
-            [
-                (k.replace('.', '-'), v,)
-                    for k, v in (self.settings.operationMapping or {}).items()
-            ]
+            [(k.replace('.', '-'), v,)
+             for k, v in (self.settings.operationMapping or {}).items()]
         )
 
     @property
     def templateMapping(self):
         return dict(
-            [
-                (k, v.replace('.', '-'),)
-                    for k, v in (self.ploneSettings.templateRulesetMapping or {}).items()
-            ]
+            [(k, v.replace('.', '-'),)
+             for k, v in (self.ploneSettings.templateRulesetMapping or {}).items()]
         )
 
     @property
     def contentTypeMapping(self):
         return dict(
-            [
-                (k, v.replace('.', '-'),)
-                    for k, v in (self.ploneSettings.contentTypeRulesetMapping or {}).items()
-            ]
+            [(k, v.replace('.', '-'),)
+             for k, v in (self.ploneSettings.contentTypeRulesetMapping or {}).items()]
         )
 
     # Type lookups (for accessing settings)
@@ -393,7 +388,7 @@ def contentTypesLookup(self):
     @memoize
     def operationTypes(self):
         operations = [v for k, v in self.operationTypesLookup.items()]
-        operations.sort(lambda x,y: (cmp(x['sort'], y['sort']) or cmp(x['title'], y['title'])))
+        operations.sort(lambda x, y: (cmp(x['sort'], y['sort']) or cmp(x['title'], y['title'])))
         return operations
 
     @property
@@ -406,7 +401,7 @@ def contentTypes(self):
                 description=info['description']
             ) for name, info in self.contentTypesLookup.items()
         ]
-        types.sort(lambda x,y: cmp(x['title'], y['title']))
+        types.sort(lambda x, y: cmp(x['title'], y['title']))
         return types
 
     # We store template and content type mappings as template -> ruleset and
@@ -486,8 +481,8 @@ def processImport(self):
 
         # Create a snapshot
         if snapshot:
-            snapshotId = "plone.app.caching.beforeimport.%s" % \
-                            datetime.datetime.now().isoformat().replace(':', '.')
+            snapshotId = "plone.app.caching.beforeimport.%s" % (
+                datetime.datetime.now().isoformat().replace(':', '.'))
             portal_setup.createSnapshot(snapshotId)
 
         # Import the new profile
@@ -500,7 +495,7 @@ def processImport(self):
     def profiles(self):
         portal_setup = getToolByName(self.context, 'portal_setup')
         return [profile for profile in portal_setup.listProfileInfo(ICacheProfiles)
-                  if profile.get('type', BASE) == EXTENSION and profile.get('for') is not None]
+                if profile.get('type', BASE) == EXTENSION and profile.get('for') is not None]
 
 
 class Purge(BaseView):
@@ -549,10 +544,10 @@ def purge(url):
         proxies = self.purgingSettings.cachingProxies
 
         for inputURL in urls:
-            if not inputURL.startswith(serverURL): # not in the site
-                if '://' in inputURL: # Full URL?
+            if not inputURL.startswith(serverURL):  # not in the site
+                if '://' in inputURL:  # Full URL?
                     purge(inputURL)
-                else:                 # Path?
+                else:                  # Path?
                     for newURL in getURLsToPurge(inputURL, proxies):
                         purge(newURL)
                 continue
diff --git a/plone/app/caching/browser/import.pt b/plone/app/caching/browser/import.pt
index 6d62174..b481fff 100644
--- a/plone/app/caching/browser/import.pt
+++ b/plone/app/caching/browser/import.pt
@@ -10,37 +10,6 @@
 
 <div metal:fill-slot="prefs_configlet_content">
 
-      <div id="region-content" class="documentEditable">
-
-        <div id="edit-bar">
-            <ul class="contentViews" id="content-views">
-              <li>
-                <a href=""
-                   tal:attributes="href string:${portal_url}/@@caching-controlpanel"
-                   i18n:translate="label_settings">Change settings</a>
-              </li>
-              <li class="selected">
-                <a href=""
-                   tal:attributes="href string:${portal_url}/@@caching-controlpanel-import"
-                   i18n:translate="label_import">Import settings</a>
-              </li>
-              <li tal:condition="view/purgingEnabled">
-                <a href=""
-                   tal:attributes="href string:${portal_url}/@@caching-controlpanel-purge"
-                   i18n:translate="label_purging">Purge caching proxy</a>
-              </li>
-              <li>
-                <a href=""
-                   tal:attributes="href string:${portal_url}/@@caching-controlpanel-ramcache"
-                   i18n:translate="label_ramcache">RAM cache</a>
-              </li>
-            </ul>
-        </div>
-
-        <div class="contentActions">
-          &#160;
-        </div>
-
         <div class="documentContent" id="content">
             <a name="documentContent"></a>
 
@@ -68,7 +37,31 @@
                 </p>
 
                 <form name="profiles" tal:attributes="action request/URL" method="post"
+                    class="enableUnloadProtection autotabs"
                     tal:define="errors view/errors">
+                    <ul class="formTabs autotoc-nav">
+                        <li class="formTab firstFormTab">
+                            <a href=""
+                               tal:attributes="href string:${portal_url}/@@caching-controlpanel"
+                               i18n:translate="label_settings">Change settings</a>
+                          </li>
+                          <li class="formTab">
+                            <a href=""
+                               class="active selected"
+                               tal:attributes="href string:${portal_url}/@@caching-controlpanel-import"
+                               i18n:translate="label_import">Import settings</a>
+                          </li>
+                          <li tal:condition="view/purgingEnabled" class="formTab">
+                            <a href=""
+                               tal:attributes="href string:${portal_url}/@@caching-controlpanel-purge"
+                               i18n:translate="label_purging">Purge caching proxy</a>
+                          </li>
+                          <li class="formTab lastFormTab">
+                            <a href=""
+                               tal:attributes="href string:${portal_url}/@@caching-controlpanel-ramcache"
+                               i18n:translate="label_ramcache">RAM cache</a>
+                          </li>
+                    </ul>
 
                     <div class="field">
 
@@ -132,7 +125,6 @@
             </div>
         </div>
     </div>
-</div>
 
 </body>
 </html>
diff --git a/plone/app/caching/browser/purge.pt b/plone/app/caching/browser/purge.pt
index 0e63933..728443f 100644
--- a/plone/app/caching/browser/purge.pt
+++ b/plone/app/caching/browser/purge.pt
@@ -10,37 +10,6 @@
 
 <div metal:fill-slot="prefs_configlet_content">
 
-      <div id="region-content" class="documentEditable">
-
-        <div id="edit-bar">
-            <ul class="contentViews" id="content-views">
-              <li>
-                <a href=""
-                   tal:attributes="href string:${portal_url}/@@caching-controlpanel"
-                   i18n:translate="label_settings">Change settings</a>
-              </li>
-              <li>
-                <a href=""
-                   tal:attributes="href string:${portal_url}/@@caching-controlpanel-import"
-                   i18n:translate="label_import">Import settings</a>
-              </li>
-              <li class="selected">
-                <a href=""
-                   tal:attributes="href string:${portal_url}/@@caching-controlpanel-purge"
-                   i18n:translate="label_purging">Purge caching proxy</a>
-              </li>
-              <li>
-                <a href=""
-                   tal:attributes="href string:${portal_url}/@@caching-controlpanel-ramcache"
-                   i18n:translate="label_ramcache">RAM cache</a>
-              </li>
-            </ul>
-        </div>
-
-        <div class="contentActions">
-          &#160;
-        </div>
-
         <div class="documentContent" id="content">
             <a name="documentContent"></a>
 
@@ -80,7 +49,31 @@
                 </div>
 
                 <form name="purge" tal:attributes="action string:${request/URL}" method="post"
+                    class="enableUnloadProtection autotabs"
                     tal:define="errors view/errors">
+                    <ul class="formTabs autotoc-nav">
+                        <li class="formTab firstFormTab">
+                            <a href=""
+                               tal:attributes="href string:${portal_url}/@@caching-controlpanel"
+                               i18n:translate="label_settings">Change settings</a>
+                          </li>
+                          <li class="formTab">
+                            <a href=""
+                               tal:attributes="href string:${portal_url}/@@caching-controlpanel-import"
+                               i18n:translate="label_import">Import settings</a>
+                          </li>
+                          <li tal:condition="view/purgingEnabled" class="formTab">
+                            <a href=""
+                               class="active selected"
+                               tal:attributes="href string:${portal_url}/@@caching-controlpanel-purge"
+                               i18n:translate="label_purging">Purge caching proxy</a>
+                          </li>
+                          <li class="formTab lastFormTab">
+                            <a href=""
+                               tal:attributes="href string:${portal_url}/@@caching-controlpanel-ramcache"
+                               i18n:translate="label_ramcache">RAM cache</a>
+                          </li>
+                    </ul>
 
                     <div tal:define="error errors/urls | nothing"
                          tal:attributes="class python:'field error' if error else 'field'">
@@ -135,7 +128,6 @@
                 </form>
             </div>
         </div>
-    </div>
 
 </div>
 </body>
diff --git a/plone/app/caching/browser/ramcache.pt b/plone/app/caching/browser/ramcache.pt
index 68beab3..cff74cd 100644
--- a/plone/app/caching/browser/ramcache.pt
+++ b/plone/app/caching/browser/ramcache.pt
@@ -9,38 +9,6 @@
 <body>
 
 <div metal:fill-slot="prefs_configlet_content">
-
-      <div id="region-content" class="documentEditable">
-
-        <div id="edit-bar">
-            <ul class="contentViews" id="content-views">
-              <li>
-                <a href=""
-                   tal:attributes="href string:${portal_url}/@@caching-controlpanel"
-                   i18n:translate="label_settings">Change settings</a>
-              </li>
-              <li>
-                <a href=""
-                   tal:attributes="href string:${portal_url}/@@caching-controlpanel-import"
-                   i18n:translate="label_import">Import settings</a>
-              </li>
-              <li tal:condition="view/purgingEnabled">
-                <a href=""
-                   tal:attributes="href string:${portal_url}/@@caching-controlpanel-purge"
-                   i18n:translate="label_purging">Purge caching proxy</a>
-              </li>
-              <li class="selected">
-                <a href=""
-                   tal:attributes="href string:${portal_url}/@@caching-controlpanel-ramcache"
-                   i18n:translate="label_ramcache">RAM cache</a>
-              </li>
-            </ul>
-        </div>
-
-        <div class="contentActions">
-          &#160;
-        </div>
-
         <div class="documentContent" id="content">
             <a name="documentContent"></a>
 
@@ -66,29 +34,53 @@
                     clear the cache if you suspect there are stale items there.
                 </p>
 
-                <table tal:define="stats view/ramCache/getStatistics"
-                       class="listing nosort" summary="RAM cache statistics"
-                       i18n:attributes="summary heading_ramcache_stats;">
-                  <thead>
-                    <th i18n:translate="label_cache_key">Key</th>
-                    <th i18n:translate="label_cache_hits">Hits</th>
-                    <th i18n:translate="label_cache_misses">Misses</th>
-                    <th i18n:translate="label_cache_size_bytes">Size (bytes)</th>
-                    <th i18n:translate="label_cache_entries">Entries</th>
-                  </thead>
-                  <tbody>
-                    <tr tal:repeat="data stats">
-                      <td><span tal:content="data/path">&nbsp;</span></td>
-                      <td><span tal:content="data/hits">&nbsp;</span></td>
-                      <td><span tal:content="data/misses">&nbsp;</span></td>
-                      <td><span tal:content="data/size">&nbsp;</span></td>
-                      <td><span tal:content="data/entries">&nbsp;</span></td>
-                    </tr>
-                  </tbody>
-                </table>
-
                 <form name="purge" tal:attributes="action string:${request/URL}" method="post"
+                    class="enableUnloadProtection autotabs"
                     tal:define="errors view/errors">
+                    <ul class="formTabs autotoc-nav">
+                        <li class="formTab firstFormTab">
+                            <a href=""
+                               tal:attributes="href string:${portal_url}/@@caching-controlpanel"
+                               i18n:translate="label_settings">Change settings</a>
+                          </li>
+                          <li class="formTab">
+                            <a href=""
+                               tal:attributes="href string:${portal_url}/@@caching-controlpanel-import"
+                               i18n:translate="label_import">Import settings</a>
+                          </li>
+                          <li tal:condition="view/purgingEnabled" class="formTab">
+                            <a href=""
+                               tal:attributes="href string:${portal_url}/@@caching-controlpanel-purge"
+                               i18n:translate="label_purging">Purge caching proxy</a>
+                          </li>
+                          <li class="formTab lastFormTab">
+                            <a href=""
+                               class="active selected"
+                               tal:attributes="href string:${portal_url}/@@caching-controlpanel-ramcache"
+                               i18n:translate="label_ramcache">RAM cache</a>
+                          </li>
+                    </ul>
+
+                  <table tal:define="stats view/ramCache/getStatistics"
+                         class="listing nosort" summary="RAM cache statistics"
+                         i18n:attributes="summary heading_ramcache_stats;">
+                    <thead>
+                      <th i18n:translate="label_cache_key">Key</th>
+                      <th i18n:translate="label_cache_hits">Hits</th>
+                      <th i18n:translate="label_cache_misses">Misses</th>
+                      <th i18n:translate="label_cache_size_bytes">Size (bytes)</th>
+                      <th i18n:translate="label_cache_entries">Entries</th>
+                    </thead>
+                    <tbody>
+                      <tr tal:repeat="data stats">
+                        <td><span tal:content="data/path">&nbsp;</span></td>
+                        <td><span tal:content="data/hits">&nbsp;</span></td>
+                        <td><span tal:content="data/misses">&nbsp;</span></td>
+                        <td><span tal:content="data/size">&nbsp;</span></td>
+                        <td><span tal:content="data/entries">&nbsp;</span></td>
+                      </tr>
+                    </tbody>
+                  </table>
 
                     <div class="formControls">
                         <input
@@ -104,7 +96,6 @@
                 </form>
             </div>
         </div>
-    </div>
 
 </div>
 </body>


