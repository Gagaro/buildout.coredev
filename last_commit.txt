Repository: plone.app.content
Branch: refs/heads/master
Date: 2015-02-09T07:58:29-06:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.app.content/commit/65d32843fa66e723afaab91e44d3faf9d7661568

handle missing values in json responses fixes #374

Files changed:
M plone/app/content/browser/folder.py

diff --git a/plone/app/content/browser/folder.py b/plone/app/content/browser/folder.py
index 1ed6303..8ff1de7 100644
--- a/plone/app/content/browser/folder.py
+++ b/plone/app/content/browser/folder.py
@@ -27,13 +27,24 @@
 
 import json
 import transaction
+import Missing
 
 try:
-    from plone.app.widgets.browser.file import TUS_ENABLED
+    from plone.app.content.browser.file import TUS_ENABLED
 except ImportError:
     TUS_ENABLED = False
 
 
+def custom_json_handler(obj):
+    if obj == Missing.Value:
+        return None
+    return obj
+
+
+def dumps(data):
+    return json.dumps(data, default=custom_json_handler)
+
+
 class FolderContentsView(BrowserView):
     implements(IFolderContentsView)
 
@@ -119,7 +130,7 @@ def __call__(self):
                 'useTus': TUS_ENABLED
             }
         }
-        self.options = json.dumps(options)
+        self.options = dumps(options)
         return super(FolderContentsView, self).__call__()
 
 
@@ -143,7 +154,7 @@ def protect(self):
 
     def json(self, data):
         self.request.response.setHeader("Content-Type", "application/json")
-        return json.dumps(data)
+        return dumps(data)
 
     def get_selection(self):
         selection = self.request.form.get('selection', '[]')
@@ -560,8 +571,7 @@ def __call__(self):
                 if key == 'path':
                     val = val[len(base_path):]
                 item[key] = val
-
-        return json.dumps({
+        return dumps({
             'addButtons': factories_menu,
             'defaultPage': self.context.getDefaultPage(),
             'breadcrumbs': [c for c in reversed(crumbs)],


