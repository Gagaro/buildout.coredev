Repository: plone.app.robotframework


Branch: refs/heads/master
Date: 2015-10-10T12:57:18+03:00
Author: Asko Soukka (datakurre) <asko.soukka@iki.fi>
Commit: https://github.com/plone/plone.app.robotframework/commit/6525233a8f59f8e3b5dca2cb85f5b37f4838cd33

Add option to stop server in a lazy manner to re-use server within the same process

Files changed:
M src/plone/app/robotframework/server.py

diff --git a/src/plone/app/robotframework/server.py b/src/plone/app/robotframework/server.py
index 4dc8608..b6b6fa4 100644
--- a/src/plone/app/robotframework/server.py
+++ b/src/plone/app/robotframework/server.py
@@ -209,8 +209,11 @@ def end_test(self, name, attrs):
 
 class Zope2Server:
 
+    stop_zope_server_lazy = False  # trigger lazy Zope2Server shutdown
+    stop_zope_server_layer = None  # sticky layer for lazy shutdown
+
     def __init__(self):
-        self.zope_layer = None
+        self.zope_layer = self.stop_zope_server_layer
         self.extra_layers = {}
 
     def _import_layer(self, layer_dotted_name):
@@ -255,7 +258,12 @@ def prune_zope_server(self):
         self.zope_layer = None
 
     def stop_zope_server(self):
-        tear_down()
+        if not self.stop_zope_server_lazy:
+            tear_down()
+        else:
+            # With lazy stop, the layer is saved to enable Zope2Server re-use
+            # within the same process, until tear_down is called explicitly.
+            Zope2Server.stop_zope_server_layer = self.zope_layer
         self.zope_layer = None
 
     def zodb_setup(self, layer_dotted_name=None):
@@ -349,3 +357,33 @@ def remote_zodb_setup(self, layer_dotted_name):
 
     def remote_zodb_teardown(self, layer_dotted_name):
         Zope2Server().zodb_teardown(layer_dotted_name)
+
+
+class LazyStop:
+    """Robot Framework listener for enabling lazy Zope2Server shutdown with
+    normal Robot Framework test runner. Can be used to keep Zope2Server
+    running between otherwise independent test suites with matching layer.
+
+    Usage: pybot --listener plone.app.robotframework.LazyStop
+
+    """
+    ROBOT_LISTENER_API_VERSION = 2
+
+    def __init__(self):
+        Zope2Server.stop_zope_server_lazy = True
+
+    def close(self):
+        tear_down()
+
+
+def setup(app):
+    """Sphinx extension hook for enabling lazy Zope2Server shutdown with with
+    ``sphinxcontrib-robotframework`` embedded test suites. Can be used to keep
+    Zope2Server running between otherwise independent test suites with matching
+    layer.
+
+    Usage: extensions = ['plone.app.robotframework.server']
+
+    """
+    Zope2Server.stop_zope_server_lazy = True
+    app.connect('build-finished', lambda app, exception: tear_down())


Repository: plone.app.robotframework


Branch: refs/heads/master
Date: 2015-10-10T13:08:42+03:00
Author: Asko Soukka (datakurre) <asko.soukka@iki.fi>
Commit: https://github.com/plone/plone.app.robotframework/commit/c47b6b4a53ef5e1763c2a0a77ab24a21e105de83

Update changelog

Files changed:
M CHANGES.txt

diff --git a/CHANGES.txt b/CHANGES.txt
index b67c906..ac95cc8 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -4,8 +4,12 @@ Changelog
 0.9.13 (unreleased)
 -------------------
 
-- Nothing changed yet.
-
+- Add support for lazy sandbox-server (Zope2Server) shutdown with
+  ``pybot --listener plone.app.framework.server.LazyStop`` or with
+  Sphinx extension ``plone.app.robotframeworks.server`` to allow
+  sequential Sphinx documents to share the same server for screenshots
+  generation
+  [datakurre]
 
 0.9.12 (2015-09-27)
 -------------------


Repository: plone.app.robotframework


Branch: refs/heads/master
Date: 2015-10-10T13:16:03+03:00
Author: Asko Soukka (datakurre) <asko.soukka@iki.fi>
Commit: https://github.com/plone/plone.app.robotframework/commit/6e6dcea428db3d89ee38e3a0651ac5077d425dae

Merge pull request #47 from plone/datakurre-stop-server-lazy

Add support for lazy sandbox-server (Zope2Server) shutdown

Files changed:
M CHANGES.txt
M src/plone/app/robotframework/server.py

diff --git a/CHANGES.txt b/CHANGES.txt
index b67c906..ac95cc8 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -4,8 +4,12 @@ Changelog
 0.9.13 (unreleased)
 -------------------
 
-- Nothing changed yet.
-
+- Add support for lazy sandbox-server (Zope2Server) shutdown with
+  ``pybot --listener plone.app.framework.server.LazyStop`` or with
+  Sphinx extension ``plone.app.robotframeworks.server`` to allow
+  sequential Sphinx documents to share the same server for screenshots
+  generation
+  [datakurre]
 
 0.9.12 (2015-09-27)
 -------------------
diff --git a/src/plone/app/robotframework/server.py b/src/plone/app/robotframework/server.py
index 4dc8608..b6b6fa4 100644
--- a/src/plone/app/robotframework/server.py
+++ b/src/plone/app/robotframework/server.py
@@ -209,8 +209,11 @@ def end_test(self, name, attrs):
 
 class Zope2Server:
 
+    stop_zope_server_lazy = False  # trigger lazy Zope2Server shutdown
+    stop_zope_server_layer = None  # sticky layer for lazy shutdown
+
     def __init__(self):
-        self.zope_layer = None
+        self.zope_layer = self.stop_zope_server_layer
         self.extra_layers = {}
 
     def _import_layer(self, layer_dotted_name):
@@ -255,7 +258,12 @@ def prune_zope_server(self):
         self.zope_layer = None
 
     def stop_zope_server(self):
-        tear_down()
+        if not self.stop_zope_server_lazy:
+            tear_down()
+        else:
+            # With lazy stop, the layer is saved to enable Zope2Server re-use
+            # within the same process, until tear_down is called explicitly.
+            Zope2Server.stop_zope_server_layer = self.zope_layer
         self.zope_layer = None
 
     def zodb_setup(self, layer_dotted_name=None):
@@ -349,3 +357,33 @@ def remote_zodb_setup(self, layer_dotted_name):
 
     def remote_zodb_teardown(self, layer_dotted_name):
         Zope2Server().zodb_teardown(layer_dotted_name)
+
+
+class LazyStop:
+    """Robot Framework listener for enabling lazy Zope2Server shutdown with
+    normal Robot Framework test runner. Can be used to keep Zope2Server
+    running between otherwise independent test suites with matching layer.
+
+    Usage: pybot --listener plone.app.robotframework.LazyStop
+
+    """
+    ROBOT_LISTENER_API_VERSION = 2
+
+    def __init__(self):
+        Zope2Server.stop_zope_server_lazy = True
+
+    def close(self):
+        tear_down()
+
+
+def setup(app):
+    """Sphinx extension hook for enabling lazy Zope2Server shutdown with with
+    ``sphinxcontrib-robotframework`` embedded test suites. Can be used to keep
+    Zope2Server running between otherwise independent test suites with matching
+    layer.
+
+    Usage: extensions = ['plone.app.robotframework.server']
+
+    """
+    Zope2Server.stop_zope_server_lazy = True
+    app.connect('build-finished', lambda app, exception: tear_down())


