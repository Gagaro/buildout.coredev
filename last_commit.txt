Repository: plone.app.contenttypes
Branch: refs/heads/master
Date: 2015-03-31T23:11:35+02:00
Author: Johannes Raggam (thet) <raggam-nl@adm.at>
Commit: https://github.com/plone/plone.app.contenttypes/commit/07c0bfc2e5c7f62701fa2dbd0923c0dc6a301573

Fix test_warning_for_uneditable_content to work with recent browser layer changes in plone.app.z3cform.

Files changed:
M docs/CHANGES.rst
M plone/app/contenttypes/profiles/default/metadata.xml
M plone/app/contenttypes/tests/test_migration.py

diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index d7910f8..02cdf38 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -4,6 +4,10 @@ Changelog
 1.2a8 (unreleased)
 ------------------
 
+- Fix ``test_warning_for_uneditable_content`` to work with recent browser layer
+  changes in ``plone.app.z3cform``.
+  [thet]
+
 - Update image_view_fullscreen.pt for mobile friendliness.
   [fulv]
 
diff --git a/plone/app/contenttypes/profiles/default/metadata.xml b/plone/app/contenttypes/profiles/default/metadata.xml
index 34377bc..b687208 100644
--- a/plone/app/contenttypes/profiles/default/metadata.xml
+++ b/plone/app/contenttypes/profiles/default/metadata.xml
@@ -5,6 +5,7 @@
   <dependency>profile-plone.app.event:default</dependency>
   <dependency>profile-plone.app.relationfield:default</dependency>
   <dependency>profile-plone.app.versioningbehavior:default</dependency>
+  <dependency>profile-plone.app.z3cform:default</dependency>
   <!-- XXX: For some reason the p.a.d gs workflow is not applied correctly. -->
   <dependency>profile-plone.app.discussion:default</dependency>
  </dependencies>
diff --git a/plone/app/contenttypes/tests/test_migration.py b/plone/app/contenttypes/tests/test_migration.py
index a12d21f..e3fb428 100644
--- a/plone/app/contenttypes/tests/test_migration.py
+++ b/plone/app/contenttypes/tests/test_migration.py
@@ -3,29 +3,29 @@
 from five.intid.intid import IntIds
 from five.intid.site import addUtility
 from lxml import etree
-from plone.app.contenttypes.testing import \
-    PLONE_APP_CONTENTTYPES_FUNCTIONAL_TESTING
-from plone.app.contenttypes.testing import \
-    PLONE_APP_CONTENTTYPES_MIGRATION_TESTING
+from plone.app.contenttypes.migration.utils import add_portlet
+from plone.app.contenttypes.testing import PLONE_APP_CONTENTTYPES_FUNCTIONAL_TESTING  # noqa
+from plone.app.contenttypes.testing import PLONE_APP_CONTENTTYPES_MIGRATION_TESTING  # noqa
 from plone.app.contenttypes.testing import set_browserlayer
 from plone.app.testing import SITE_OWNER_NAME
 from plone.app.testing import SITE_OWNER_PASSWORD
 from plone.app.testing import applyProfile
 from plone.app.testing import login
-from plone.dexterity.interfaces import IDexterityContent
+from plone.app.z3cform.interfaces import IPloneFormLayer
 from plone.dexterity.content import Container
+from plone.dexterity.interfaces import IDexterityContent
 from plone.event.interfaces import IEventAccessor
 from plone.testing.z2 import Browser
 from zope.annotation.interfaces import IAnnotations
 from zope.component import getMultiAdapter
 from zope.component import getSiteManager
 from zope.component import getUtility
+from zope.interface import alsoProvides
 from zope.intid.interfaces import IIntIds
 from zope.schema.interfaces import IVocabularyFactory
 import os.path
 import time
 import unittest2 as unittest
-from plone.app.contenttypes.migration.utils import add_portlet
 
 
 class MigrateFromATContentTypesTest(unittest.TestCase):
@@ -1200,6 +1200,11 @@ def test_warning_for_uneditable_content(self):
         at_document = self.portal['document']
         at_newsitem = self.portal['newsitem']
         applyProfile(self.portal, 'plone.app.contenttypes:default')
+        # At this point plone.app.z3cform is installed including it's browser
+        # layer. But we have to annotate the request to provide it, since the
+        # request was constructed before. Otherwise, @@view cannot be render
+        # it's IRichText widget.
+        alsoProvides(self.request, IPloneFormLayer)
         at_document_view = at_document.restrictedTraverse('')
         self.assertTrue(
             'http://nohost/plone/@@atct_migrator' in at_document_view()


