Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-18T11:37:52+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/48dda7aa8806ebc9b7d24b7dee52a5df55bd6a2b

Migrate mark_special_links property to registry

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 6f8fbd6..963b170 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -461,6 +461,7 @@ def to50rc3(context):
             portal._delProperty(p)
 
     properties_to_migrate = ['external_links_open_new_window',
+							 'mark_special_links',
                              'calendar_starting_year',
                              'calendar_future_years_available']
     for p in properties_to_migrate:


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-18T11:38:44+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/2728e67de31f02d12d22590e249bbcf3b23665d9

Import ILinkSchema on upgrade.

Files changed:
M plone/app/upgrade/v50/profiles/to_rc3/registry.xml

diff --git a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
index 3019d95..f5b0436 100644
--- a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
+++ b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
@@ -1,7 +1,11 @@
 <?xml version="1.0"?>
 <registry>
-    <records prefix="plone.resources/resource-plone-app-discussion-stylesheets"
+  <records interface="Products.CMFPlone.interfaces.ISiteSchema"
+           prefix="plone" />
+  <records interface="Products.CMFPlone.interfaces.ILinkSchema"
+           prefix="plone" />
+  <records prefix="plone.resources/resource-plone-app-discussion-stylesheets"
         interface='Products.CMFPlone.interfaces.IResourceRegistry'
         remove="True">
-    </records>
-</registry>
+  </records>
+</registry>
\ No newline at end of file


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-18T11:38:44+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/fb45a9fdc1cf535cd8c2f714ba2673201514bb33

Handle string values for boolean fields

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 963b170..23a1c7a 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -467,6 +467,10 @@ def to50rc3(context):
     for p in properties_to_migrate:
         if site_properties.hasProperty(p):
             value = site_properties.getProperty(p)
+            if value == 'true':
+                value = True
+            elif value == 'false':
+                value = False
             try:
                 registry['plone.%s' % p] = value
                 site_properties._delProperty(p)


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-18T11:39:09+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/02c0334ae73dcec6961e04f826f02c91c5a46b15

Migrate typesLinkToFolderContentsInFC to registry.

Files changed:
M plone/app/upgrade/v50/betas.py
M plone/app/upgrade/v50/profiles/to_rc3/registry.xml

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 23a1c7a..ad1073d 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -476,3 +476,8 @@ def to50rc3(context):
                 site_properties._delProperty(p)
             except KeyError:
                 logger.warn('could not upgrade %s property' % p)
+
+    if site_properties.hasProperty('typesLinkToFolderContentsInFC'):
+        value = site_properties.getProperty('typesLinkToFolderContentsInFC')
+        registry['plone.types_link_to_folder_contents'] = tuple(value)
+        site_properties._delProperty('typesLinkToFolderContentsInFC')
diff --git a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
index f5b0436..a93db11 100644
--- a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
+++ b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
@@ -4,6 +4,8 @@
            prefix="plone" />
   <records interface="Products.CMFPlone.interfaces.ILinkSchema"
            prefix="plone" />
+  <records interface="Products.CMFPlone.interfaces.ITypesSchema"
+           prefix="plone" />
   <records prefix="plone.resources/resource-plone-app-discussion-stylesheets"
         interface='Products.CMFPlone.interfaces.IResourceRegistry'
         remove="True">


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-18T11:40:01+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/46a0ba9ee6a99d1b750e985c88002c8a793472d8

Move redirect_links to the registry.

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index ad1073d..c201229 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -463,7 +463,8 @@ def to50rc3(context):
     properties_to_migrate = ['external_links_open_new_window',
 							 'mark_special_links',
                              'calendar_starting_year',
-                             'calendar_future_years_available']
+                             'calendar_future_years_available',
+							 'redirect_links']
     for p in properties_to_migrate:
         if site_properties.hasProperty(p):
             value = site_properties.getProperty(p)


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-18T11:40:31+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/bb4deb617c2ca74c4ebf75e78cd870da48a3cfc9

upgrade navigation registry

Files changed:
M plone/app/upgrade/v50/profiles/to_rc3/registry.xml

diff --git a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
index a93db11..87c358f 100644
--- a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
+++ b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
@@ -4,6 +4,8 @@
            prefix="plone" />
   <records interface="Products.CMFPlone.interfaces.ILinkSchema"
            prefix="plone" />
+  <records interface="Products.CMFPlone.interfaces.INavigationSchema"
+           prefix="plone" />
   <records interface="Products.CMFPlone.interfaces.ITypesSchema"
            prefix="plone" />
   <records prefix="plone.resources/resource-plone-app-discussion-stylesheets"


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-18T11:40:31+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/7b639a833fcc06f9c10ddd4eede2e20f82bd57a0

migrate navtree root prop

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index c201229..fb62820 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -1,21 +1,21 @@
 # -*- coding: utf-8 -*-
-import logging
-
+from plone.app.linkintegrity.upgrades import migrate_linkintegrity_relations
+from plone.app.upgrade.utils import loadMigrationProfile
+from plone.registry.interfaces import IRegistry
 from Products.CMFCore.interfaces import ISiteRoot
 from Products.CMFCore.utils import getToolByName
 from Products.CMFPlone.interfaces import ILanguageSchema
 from Products.CMFPlone.interfaces import IMailSchema
 from Products.CMFPlone.interfaces import IMarkupSchema
+from Products.CMFPlone.interfaces import INavigationSchema
 from Products.CMFPlone.interfaces import ISearchSchema
 from Products.CMFPlone.interfaces import ISecuritySchema
 from Products.CMFPlone.interfaces import ISiteSchema
 from Products.CMFPlone.interfaces import IUserGroupsSettingsSchema
 from Products.CMFPlone.interfaces.controlpanel import IImagingSchema
-from plone.app.linkintegrity.upgrades import migrate_linkintegrity_relations
-from plone.app.upgrade.utils import loadMigrationProfile
-from plone.registry.interfaces import IRegistry
 from zope.component import getUtility
 from zope.component.hooks import getSite
+import logging
 
 
 logger = logging.getLogger('plone.app.upgrade')
@@ -445,6 +445,28 @@ def to50rc2(context):
         site_properties._delProperty('allow_external_login_sites')
 
 
+def upgrade_navigation_controlpanel_settings_2(context):
+    """Copy navigation control panel settings from portal properties into the
+       new registry.
+       only missing values not migrated before
+    """
+    # get the old site properties
+    portal_properties = getToolByName(context, "portal_properties")
+    navigation_properties = portal_properties.navtree_properties
+    # get the new registry
+    registry = getUtility(IRegistry)
+    try:
+        settings = registry.forInterface(
+            INavigationSchema,
+            prefix='plone',
+        )
+    except KeyError:
+        return
+
+    settings.root = navigation_properties.getProperty('root')
+    navigation_properties._delProperty('root')
+
+
 def to50rc3(context):
     """5.0rc2 -> 5.0rc3"""
     loadMigrationProfile(context, 'profile-plone.app.upgrade.v50:to50rc3')
@@ -482,3 +504,7 @@ def to50rc3(context):
         value = site_properties.getProperty('typesLinkToFolderContentsInFC')
         registry['plone.types_link_to_folder_contents'] = tuple(value)
         site_properties._delProperty('typesLinkToFolderContentsInFC')
+
+    # migrate navtree properties
+    upgrade_navigation_controlpanel_settings_2(context)
+


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-18T11:40:31+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/b86f0b27b6f8c4a2d0e0f3b0efcac698ef1ff3d0

These values should be lists.

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index fb62820..5af85cc 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -502,7 +502,7 @@ def to50rc3(context):
 
     if site_properties.hasProperty('typesLinkToFolderContentsInFC'):
         value = site_properties.getProperty('typesLinkToFolderContentsInFC')
-        registry['plone.types_link_to_folder_contents'] = tuple(value)
+        registry['plone.types_link_to_folder_contents'] = list(value)
         site_properties._delProperty('typesLinkToFolderContentsInFC')
 
     # migrate navtree properties


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-18T11:40:31+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/dd5f7bc0c01e7b234f324eaa3a5575667c3ea466

more attributes to migrate

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 5af85cc..c4b9694 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -463,7 +463,18 @@ def upgrade_navigation_controlpanel_settings_2(context):
     except KeyError:
         return
 
-    settings.root = navigation_properties.getProperty('root')
+    navigation_properties._delProperty('idsNotToList')
+
+    settings.sort_tabs_on = navigation_properties.getProperty(
+        'sortAttribute'
+    ).decode('utf8')
+    navigation_properties._delProperty('sortAttribute')
+
+    desc = navigation_properties.getProperty('sortOrder') == 'desc'
+    settings.sort_tabs_reversed = desc
+    navigation_properties._delProperty('sortOrder')
+
+    settings.root = navigation_properties.getProperty('root').decode('utf8')
     navigation_properties._delProperty('root')
 
 
@@ -507,4 +518,3 @@ def to50rc3(context):
 
     # migrate navtree properties
     upgrade_navigation_controlpanel_settings_2(context)
-


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-18T11:40:31+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/c1078799ca88b7a96b928ff2ff269d30b7781fb2

use correct values

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index c4b9694..e419aa2 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -470,8 +470,8 @@ def upgrade_navigation_controlpanel_settings_2(context):
     ).decode('utf8')
     navigation_properties._delProperty('sortAttribute')
 
-    desc = navigation_properties.getProperty('sortOrder') == 'desc'
-    settings.sort_tabs_reversed = desc
+    order = navigation_properties.getProperty('sortOrder', None)
+    settings.sort_tabs_reversed = order in ['descending', 'reverse']
     navigation_properties._delProperty('sortOrder')
 
     settings.root = navigation_properties.getProperty('root').decode('utf8')


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-18T11:40:31+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/4027b410e4c646baa17ab0acab58409d633f9a63

Handle unicode values.

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index e419aa2..f9a7f18 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -513,8 +513,10 @@ def to50rc3(context):
 
     if site_properties.hasProperty('typesLinkToFolderContentsInFC'):
         value = site_properties.getProperty('typesLinkToFolderContentsInFC')
-        registry['plone.types_link_to_folder_contents'] = list(value)
+        value = [unicode(a) for a in value]
+        registry['plone.types_link_to_folder_contents'] = value
         site_properties._delProperty('typesLinkToFolderContentsInFC')
 
     # migrate navtree properties
     upgrade_navigation_controlpanel_settings_2(context)
+


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-18T11:40:32+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/445261fe531b3456babfc3516c05288ea9d5514d

Handle missing values.

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index f9a7f18..5685d20 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -471,11 +471,14 @@ def upgrade_navigation_controlpanel_settings_2(context):
     navigation_properties._delProperty('sortAttribute')
 
     order = navigation_properties.getProperty('sortOrder', None)
-    settings.sort_tabs_reversed = order in ['descending', 'reverse']
-    navigation_properties._delProperty('sortOrder')
-
-    settings.root = navigation_properties.getProperty('root').decode('utf8')
-    navigation_properties._delProperty('root')
+    if order is not None:
+        settings.sort_tabs_reversed = order in ['descending', 'reverse']
+        navigation_properties._delProperty('sortOrder')
+
+    root = navigation_properties.getProperty('root', None)
+    if root is not None:
+        settings.root = root.decode('utf8')
+        navigation_properties._delProperty('root')
 
 
 def to50rc3(context):


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-18T11:40:32+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/6806b809fbc692a333a97c3d7529549e4b938e07

Rework property value removal to account for Plone 5 removing the property entirely

Files changed:
M plone/app/upgrade/v40/betas.py
M plone/app/upgrade/v40/profiles/to_beta4/propertiestool.xml

diff --git a/plone/app/upgrade/v40/betas.py b/plone/app/upgrade/v40/betas.py
index 9eb3d5a..5035480 100644
--- a/plone/app/upgrade/v40/betas.py
+++ b/plone/app/upgrade/v40/betas.py
@@ -91,6 +91,14 @@ def beta3_beta4(context):
     """
     loadMigrationProfile(context, 'profile-plone.app.upgrade.v40:4beta3-4beta4')
 
+    pprop = getToolByName(context, 'portal_properties')
+    site_properties = pprop.site_properties
+    if site_properties.hasProperty('typesLinkToFolderContentsInFC'):
+        value = site_properties.getProperty('typesLinkToFolderContentsInFC')
+        if 'Large Plone Folder' in value:
+            value.remove('Large Plone Folder')
+        site_properties.setProperty('typesLinkToFolderContentsInFC', value)
+
 
 def removeLargePloneFolder(context):
     """Complete removal of Large Plone Folder
diff --git a/plone/app/upgrade/v40/profiles/to_beta4/propertiestool.xml b/plone/app/upgrade/v40/profiles/to_beta4/propertiestool.xml
index 9da5e65..045c480 100644
--- a/plone/app/upgrade/v40/profiles/to_beta4/propertiestool.xml
+++ b/plone/app/upgrade/v40/profiles/to_beta4/propertiestool.xml
@@ -5,9 +5,4 @@
    <element value="Large Plone Folder" remove="True"/>
   </property>
  </object>
- <object name="site_properties" meta_type="Plone Property Sheet">
-  <property name="typesLinkToFolderContentsInFC" purge="False">
-   <element value="Large Plone Folder" remove="True"/>
-  </property>
- </object>
 </object>


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-18T11:40:32+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/4e5cf9ef00a2716f5896ee64ff34d86dd7444b73

Handle capitalized boolean strings.

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 5685d20..cfd2bc5 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -504,9 +504,9 @@ def to50rc3(context):
     for p in properties_to_migrate:
         if site_properties.hasProperty(p):
             value = site_properties.getProperty(p)
-            if value == 'true':
+            if value.lower() == 'true':
                 value = True
-            elif value == 'false':
+            elif value.lower() == 'false':
                 value = False
             try:
                 registry['plone.%s' % p] = value


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-18T14:54:22+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/9739de9244cf81682485ae4e29c8f11060d3aee5

Only try to convert strings.

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index cfd2bc5..e08bcbe 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -497,17 +497,18 @@ def to50rc3(context):
             portal._delProperty(p)
 
     properties_to_migrate = ['external_links_open_new_window',
-							 'mark_special_links',
+                             'mark_special_links',
                              'calendar_starting_year',
                              'calendar_future_years_available',
-							 'redirect_links']
+                             'redirect_links']
     for p in properties_to_migrate:
         if site_properties.hasProperty(p):
             value = site_properties.getProperty(p)
-            if value.lower() == 'true':
-                value = True
-            elif value.lower() == 'false':
-                value = False
+            if isinstance(value, basestring):
+                if value.lower() == 'true':
+                    value = True
+                elif value.lower() == 'false':
+                    value = False
             try:
                 registry['plone.%s' % p] = value
                 site_properties._delProperty(p)


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-18T15:16:46+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/8d7d1e81ccba8cf0cacbdc9a43c4322359047f9a

Migrate sitemapDepth

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index e08bcbe..dd467ff 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -500,7 +500,8 @@ def to50rc3(context):
                              'mark_special_links',
                              'calendar_starting_year',
                              'calendar_future_years_available',
-                             'redirect_links']
+                             'redirect_links',
+                             '']
     for p in properties_to_migrate:
         if site_properties.hasProperty(p):
             value = site_properties.getProperty(p)
@@ -515,6 +516,11 @@ def to50rc3(context):
             except KeyError:
                 logger.warn('could not upgrade %s property' % p)
 
+    if site_properties.hasProperty('sitemapDepth'):
+        value = site_properties.getProperty('sitemapDepth')
+        registry['plone.sitemap_depth'] = value
+        site_properties._delProperty('sitemapDepth')
+
     if site_properties.hasProperty('typesLinkToFolderContentsInFC'):
         value = site_properties.getProperty('typesLinkToFolderContentsInFC')
         value = [unicode(a) for a in value]


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-18T15:25:13+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/a1a093a14f4774a36f6696945310b25467e5657c

Remove currentFolderOnlyInNavtree

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index dd467ff..487c128 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -490,7 +490,8 @@ def to50rc3(context):
     site_properties = pprop['site_properties']
     registry = getUtility(IRegistry)
 
-    site_properties_to_remove = ['invalid_ids']
+    site_properties_to_remove = ['invalid_ids', 
+                                 'currentFolderOnlyInNavtree']
 
     for p in site_properties_to_remove:
         if portal.hasProperty(p):
@@ -500,8 +501,7 @@ def to50rc3(context):
                              'mark_special_links',
                              'calendar_starting_year',
                              'calendar_future_years_available',
-                             'redirect_links',
-                             '']
+                             'redirect_links']
     for p in properties_to_migrate:
         if site_properties.hasProperty(p):
             value = site_properties.getProperty(p)


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-18T15:59:56+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/a1c00f7162dc12aab2a7b5613ab6ff0383a5aaf8

move default_page_types to registry

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 487c128..116c972 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -490,7 +490,7 @@ def to50rc3(context):
     site_properties = pprop['site_properties']
     registry = getUtility(IRegistry)
 
-    site_properties_to_remove = ['invalid_ids', 
+    site_properties_to_remove = ['invalid_ids',
                                  'currentFolderOnlyInNavtree']
 
     for p in site_properties_to_remove:
@@ -501,7 +501,8 @@ def to50rc3(context):
                              'mark_special_links',
                              'calendar_starting_year',
                              'calendar_future_years_available',
-                             'redirect_links']
+                             'redirect_links',
+                             'default_page_types']
     for p in properties_to_migrate:
         if site_properties.hasProperty(p):
             value = site_properties.getProperty(p)


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-18T23:40:50+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/8ea3746ac7bdc6fed27d4bbe6b123a862fb2f859

fixes in portal-properties migration

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 116c972..6fd517a 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -13,6 +13,7 @@
 from Products.CMFPlone.interfaces import ISiteSchema
 from Products.CMFPlone.interfaces import IUserGroupsSettingsSchema
 from Products.CMFPlone.interfaces.controlpanel import IImagingSchema
+from Products.CMFPlone.utils import safe_unicode
 from zope.component import getUtility
 from zope.component.hooks import getSite
 import logging
@@ -463,12 +464,13 @@ def upgrade_navigation_controlpanel_settings_2(context):
     except KeyError:
         return
 
-    navigation_properties._delProperty('idsNotToList')
+    if navigation_properties.hasProperty('idsNotToList'):
+        navigation_properties._delProperty('idsNotToList')
 
-    settings.sort_tabs_on = navigation_properties.getProperty(
-        'sortAttribute'
-    ).decode('utf8')
-    navigation_properties._delProperty('sortAttribute')
+    if navigation_properties.hasProperty('sortAttribute'):
+        settings.sort_tabs_on = navigation_properties.getProperty(
+            'sortAttribute').decode('utf8')
+        navigation_properties._delProperty('sortAttribute')
 
     order = navigation_properties.getProperty('sortOrder', None)
     if order is not None:
@@ -501,8 +503,7 @@ def to50rc3(context):
                              'mark_special_links',
                              'calendar_starting_year',
                              'calendar_future_years_available',
-                             'redirect_links',
-                             'default_page_types']
+                             'redirect_links']
     for p in properties_to_migrate:
         if site_properties.hasProperty(p):
             value = site_properties.getProperty(p)
@@ -517,6 +518,11 @@ def to50rc3(context):
             except KeyError:
                 logger.warn('could not upgrade %s property' % p)
 
+    if site_properties.hasProperty('default_page_types'):
+        value = site_properties.getProperty('default_page_types')
+        registry['plone.default_page_types'] = [safe_unicode(i) for i in value]
+        site_properties._delProperty('default_page_types')
+
     if site_properties.hasProperty('sitemapDepth'):
         value = site_properties.getProperty('sitemapDepth')
         registry['plone.sitemap_depth'] = value


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T00:02:20+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/c5b5123fec0a2a97613aa787fd262933a5ab6393

Remove from site_properties, no portal_properties

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 6fd517a..4048cf7 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -494,10 +494,13 @@ def to50rc3(context):
 
     site_properties_to_remove = ['invalid_ids',
                                  'currentFolderOnlyInNavtree']
+    site_properties_to_remove = ['invalid_ids']
 
     for p in site_properties_to_remove:
         if portal.hasProperty(p):
             portal._delProperty(p)
+        if site_properties.hasProperty(p):
+            site_properties._delProperty(p)
 
     properties_to_migrate = ['external_links_open_new_window',
                              'mark_special_links',


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T00:02:20+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/85963250bd6ccc6567908288026b62d0cce810e1

Use safe_unicode

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 4048cf7..1ab2b26 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -533,7 +533,7 @@ def to50rc3(context):
 
     if site_properties.hasProperty('typesLinkToFolderContentsInFC'):
         value = site_properties.getProperty('typesLinkToFolderContentsInFC')
-        value = [unicode(a) for a in value]
+        value = [safe_unicode(a) for a in value]
         registry['plone.types_link_to_folder_contents'] = value
         site_properties._delProperty('typesLinkToFolderContentsInFC')
 


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T00:03:19+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/5e535c5aea6a03ab07f04a365635fcb29e29f1fb

Migrate default_page

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 1ab2b26..f5a5c16 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -497,8 +497,6 @@ def to50rc3(context):
     site_properties_to_remove = ['invalid_ids']
 
     for p in site_properties_to_remove:
-        if portal.hasProperty(p):
-            portal._delProperty(p)
         if site_properties.hasProperty(p):
             site_properties._delProperty(p)
 
@@ -531,11 +529,19 @@ def to50rc3(context):
         registry['plone.sitemap_depth'] = value
         site_properties._delProperty('sitemapDepth')
 
-    if site_properties.hasProperty('typesLinkToFolderContentsInFC'):
-        value = site_properties.getProperty('typesLinkToFolderContentsInFC')
-        value = [safe_unicode(a) for a in value]
-        registry['plone.types_link_to_folder_contents'] = value
-        site_properties._delProperty('typesLinkToFolderContentsInFC')
+    def _migrate_list(original_id, new_id=None):
+        if new_id is None:
+            new_id = original_id
+        if site_properties.hasProperty(original_id):
+            value = site_properties.getProperty(original_id)
+            value = [safe_unicode(a) for a in value]
+            registry['plone.%s' % new_id] = value
+            site_properties._delProperty(original_id)
+
+    _migrate_list('typesLinkToFolderContentsInFC',
+                  'types_use_view_action_in_listings')
+    _migrate_list('default_page')
+
 
     # migrate navtree properties
     upgrade_navigation_controlpanel_settings_2(context)


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T00:03:50+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/0f76b78244b5f88e072c78685134a46af5e61d9d

Move nav property upgrades into their own method

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index f5a5c16..d57f593 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -482,6 +482,21 @@ def upgrade_navigation_controlpanel_settings_2(context):
         settings.root = root.decode('utf8')
         navigation_properties._delProperty('root')
 
+    if navigation_properties.hasProperty('sitemapDepth'):
+        value = navigation_properties.getProperty('sitemapDepth')
+        registry['plone.sitemap_depth'] = value
+        navigation_properties._delProperty('sitemapDepth')
+
+    properties_to_remove = ['idsNotToList',
+                            'currentFolderOnlyInNavtree',
+                            'includeTop',
+                            'topLevel',
+                            'bottomLevel']
+
+    for p in properties_to_remove:
+        if navigation_properties.hasProperty(p):
+            navigation_properties._delProperty(p)
+
 
 def to50rc3(context):
     """5.0rc2 -> 5.0rc3"""
@@ -492,8 +507,6 @@ def to50rc3(context):
     site_properties = pprop['site_properties']
     registry = getUtility(IRegistry)
 
-    site_properties_to_remove = ['invalid_ids',
-                                 'currentFolderOnlyInNavtree']
     site_properties_to_remove = ['invalid_ids']
 
     for p in site_properties_to_remove:


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T00:40:13+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/2f0e8d31048d848373dbd6aafcf4efd2c2cef3d1

Remove showAllParents

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index d57f593..3c1e598 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -491,7 +491,8 @@ def upgrade_navigation_controlpanel_settings_2(context):
                             'currentFolderOnlyInNavtree',
                             'includeTop',
                             'topLevel',
-                            'bottomLevel']
+                            'bottomLevel',
+                            'showAllParents']
 
     for p in properties_to_remove:
         if navigation_properties.hasProperty(p):


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T11:48:36+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/6d894fd77dab25207dd00adc73f62d398c9ac09c

remove ellipsis

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 3c1e598..b96f435 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -508,7 +508,7 @@ def to50rc3(context):
     site_properties = pprop['site_properties']
     registry = getUtility(IRegistry)
 
-    site_properties_to_remove = ['invalid_ids']
+    site_properties_to_remove = ['invalid_ids', 'ellipsis']
 
     for p in site_properties_to_remove:
         if site_properties.hasProperty(p):


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T15:29:21+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/e30fc454c59b6f30b13532ba19d4c43b2ced5392

Move default_charset to the registry

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index b96f435..733d90e 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -538,6 +538,11 @@ def to50rc3(context):
         registry['plone.default_page_types'] = [safe_unicode(i) for i in value]
         site_properties._delProperty('default_page_types')
 
+    if site_properties.hasProperty('default_charset'):
+        value = site_properties.getProperty('default_charset')
+        registry['plone.default_charset'] = safe_unicode(value)
+        site_properties._delProperty('default_charset')
+
     if site_properties.hasProperty('sitemapDepth'):
         value = site_properties.getProperty('sitemapDepth')
         registry['plone.sitemap_depth'] = value


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T15:40:17+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/d7768fbd515380145a3f51c05082539e49bdde06

migrate parentMetaTypesNotToQuery to registry (as parent_types_not_to_query)

Files changed:
M plone/app/upgrade/v40/betas.py
M plone/app/upgrade/v40/tests.py
M plone/app/upgrade/v50/betas.py
D plone/app/upgrade/v40/profiles/to_beta4/propertiestool.xml

diff --git a/plone/app/upgrade/v40/betas.py b/plone/app/upgrade/v40/betas.py
index 5035480..fae8fd7 100644
--- a/plone/app/upgrade/v40/betas.py
+++ b/plone/app/upgrade/v40/betas.py
@@ -99,6 +99,13 @@ def beta3_beta4(context):
             value.remove('Large Plone Folder')
         site_properties.setProperty('typesLinkToFolderContentsInFC', value)
 
+    navtree_properties = pprop.navtree_properties
+    if navtree_properties.hasProperty('parentMetaTypesNotToQuery'):
+        value = navtree_properties.getProperty('parentMetaTypesNotToQuery')
+        if 'Large Plone Folder' in value:
+            value.remove('Large Plone Folder')
+        navtree_properties.setProperty('parentMetaTypesNotToQuery', value)
+
 
 def removeLargePloneFolder(context):
     """Complete removal of Large Plone Folder
diff --git a/plone/app/upgrade/v40/profiles/to_beta4/propertiestool.xml b/plone/app/upgrade/v40/profiles/to_beta4/propertiestool.xml
deleted file mode 100644
index 045c480..0000000
--- a/plone/app/upgrade/v40/profiles/to_beta4/propertiestool.xml
+++ /dev/null
@@ -1,8 +0,0 @@
-<?xml version="1.0"?>
-<object name="portal_properties" meta_type="Plone Properties Tool">
- <object name="navtree_properties" meta_type="Plone Property Sheet">
-  <property name="parentMetaTypesNotToQuery" purge="False">
-   <element value="Large Plone Folder" remove="True"/>
-  </property>
- </object>
-</object>
diff --git a/plone/app/upgrade/v40/tests.py b/plone/app/upgrade/v40/tests.py
index 42b7bb0..4ad4651 100644
--- a/plone/app/upgrade/v40/tests.py
+++ b/plone/app/upgrade/v40/tests.py
@@ -554,6 +554,8 @@ def testRemoveLargePloneFolder(self):
         # re-create pre-migration settings
         ptool = self.portal.portal_properties
         nav_props = ptool.navtree_properties
+        if not nav_props.hasProperty('parentMetaTypesNotToQuery'):
+            return
         l = list(nav_props.parentMetaTypesNotToQuery)
         nav_props.parentMetaTypesNotToQuery = l + ['Large Plone Folder']
         site_props = ptool.site_properties
diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 733d90e..40e4708 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -560,6 +560,7 @@ def _migrate_list(original_id, new_id=None):
     _migrate_list('typesLinkToFolderContentsInFC',
                   'types_use_view_action_in_listings')
     _migrate_list('default_page')
+    _migrate_list('parentMetaTypesNotToQuery', 'parent_types_not_to_query')
 
 
     # migrate navtree properties


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T15:44:00+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/606cb2c3f3c918133e64d715cce11025796a7f54

Migrate portal.email_charset

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 40e4708..5cd7c1f 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -508,6 +508,9 @@ def to50rc3(context):
     site_properties = pprop['site_properties']
     registry = getUtility(IRegistry)
 
+    if hasattr(portal, 'email_charset'):
+        registry['plone.email_charset'] = portal.email_charset
+
     site_properties_to_remove = ['invalid_ids', 'ellipsis']
 
     for p in site_properties_to_remove:


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T16:50:12+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/02b42f98246158e924732550481857813396fe18

allowRolesToAddKeywords -&gt; roles_allowed_to_add_keywords

Files changed:
M plone/app/upgrade/v40/betas.py
M plone/app/upgrade/v42/betas.py
M plone/app/upgrade/v42/tests.py
M plone/app/upgrade/v50/betas.py
D plone/app/upgrade/v42/profiles/to_beta1/propertiestool.xml

diff --git a/plone/app/upgrade/v40/betas.py b/plone/app/upgrade/v40/betas.py
index fae8fd7..aa8bbe9 100644
--- a/plone/app/upgrade/v40/betas.py
+++ b/plone/app/upgrade/v40/betas.py
@@ -97,14 +97,14 @@ def beta3_beta4(context):
         value = site_properties.getProperty('typesLinkToFolderContentsInFC')
         if 'Large Plone Folder' in value:
             value.remove('Large Plone Folder')
-        site_properties.setProperty('typesLinkToFolderContentsInFC', value)
+            site_properties.typesLinkToFolderContentsInFC = value
 
     navtree_properties = pprop.navtree_properties
     if navtree_properties.hasProperty('parentMetaTypesNotToQuery'):
         value = navtree_properties.getProperty('parentMetaTypesNotToQuery')
         if 'Large Plone Folder' in value:
             value.remove('Large Plone Folder')
-        navtree_properties.setProperty('parentMetaTypesNotToQuery', value)
+            navtree_properties.parentMetaTypesNotToQuery = value
 
 
 def removeLargePloneFolder(context):
diff --git a/plone/app/upgrade/v42/betas.py b/plone/app/upgrade/v42/betas.py
index de21118..5645643 100644
--- a/plone/app/upgrade/v42/betas.py
+++ b/plone/app/upgrade/v42/betas.py
@@ -34,6 +34,14 @@ def to42beta1(context):
     """4.2a2 -> 4.2b1
     """
     loadMigrationProfile(context, 'profile-plone.app.upgrade.v42:to42beta1')
+    pprop = getToolByName(context, 'portal_properties')
+    site_properties = pprop.site_properties
+    if site_properties.hasProperty('allowRolesToAddKeywords'):
+        value = site_properties.getProperty('allowRolesToAddKeywords')
+        if 'Site Administrator' not in value:
+            value = list(value)
+            value.append('Site Administrator')
+            site_properties.allowRolesToAddKeywords = tuple(value)
 
 
 def to42beta1_owner_tuples(context):
diff --git a/plone/app/upgrade/v42/profiles/to_beta1/propertiestool.xml b/plone/app/upgrade/v42/profiles/to_beta1/propertiestool.xml
deleted file mode 100644
index 768c75d..0000000
--- a/plone/app/upgrade/v42/profiles/to_beta1/propertiestool.xml
+++ /dev/null
@@ -1,8 +0,0 @@
-<?xml version="1.0"?>
-<object name="portal_properties" meta_type="Plone Properties Tool">
-  <object name="site_properties" meta_type="Plone Property Sheet">
-    <property name="allowRolesToAddKeywords" type="lines" purge="False">
-      <element value="Site Administrator"/>
-    </property>
-  </object>
-</object>
\ No newline at end of file
diff --git a/plone/app/upgrade/v42/tests.py b/plone/app/upgrade/v42/tests.py
index 0ff501e..e21bccb 100644
--- a/plone/app/upgrade/v42/tests.py
+++ b/plone/app/upgrade/v42/tests.py
@@ -14,6 +14,8 @@ def testProfile(self):
     def testAddSiteAdminToKeywordRoles(self):
         ptool = self.portal.portal_properties
         site_props = ptool.site_properties
+        if not site_props.hasProperty('allowRolesToAddKeywords'):
+            return
         site_props.allowRolesToAddKeywords = ('Manager', 'Reviewer')
         loadMigrationProfile(self.portal, self.profile)
         roles = site_props.allowRolesToAddKeywords
diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 5cd7c1f..5bf9c53 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -564,8 +564,7 @@ def _migrate_list(original_id, new_id=None):
                   'types_use_view_action_in_listings')
     _migrate_list('default_page')
     _migrate_list('parentMetaTypesNotToQuery', 'parent_types_not_to_query')
-
+    _migrate_list('allowRolesToAddKeywords', 'roles_allowed_to_add_keywords')
 
     # migrate navtree properties
     upgrade_navigation_controlpanel_settings_2(context)
-


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T17:01:59+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/070fc6f79aeb49127b1258efcf8003da1e78c1c6

Add plone.app.iterate upgrades.

Files changed:
M plone/app/upgrade/v50/betas.py
M plone/app/upgrade/v50/profiles/to_rc3/registry.xml

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 5bf9c53..e07fea3 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -508,8 +508,9 @@ def to50rc3(context):
     site_properties = pprop['site_properties']
     registry = getUtility(IRegistry)
 
-    if hasattr(portal, 'email_charset'):
+    if portal.hasProperty('email_charset'):
         registry['plone.email_charset'] = portal.email_charset
+        portal._delProperty('email_charset')
 
     site_properties_to_remove = ['invalid_ids', 'ellipsis']
 
@@ -521,7 +522,9 @@ def to50rc3(context):
                              'mark_special_links',
                              'calendar_starting_year',
                              'calendar_future_years_available',
-                             'redirect_links']
+                             'redirect_links',
+                             'enable_checkout_workflow'
+                             ]
     for p in properties_to_migrate:
         if site_properties.hasProperty(p):
             value = site_properties.getProperty(p)
@@ -536,6 +539,13 @@ def to50rc3(context):
             except KeyError:
                 logger.warn('could not upgrade %s property' % p)
 
+    if site_properties.hasProperty('checkout_workflow_policy'):
+        value = site_properties.getProperty('checkout_workflow_policy')
+        from plone.app.iterate.interfaces import IIterateSchema
+        settings = registry.forInterface(IIterateSchema)
+        settings.checkout_workflow_policy = safe_unicode(value)
+        site_properties._delProperty('checkout_workflow_policy')
+
     if site_properties.hasProperty('default_page_types'):
         value = site_properties.getProperty('default_page_types')
         registry['plone.default_page_types'] = [safe_unicode(i) for i in value]
diff --git a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
index 87c358f..a70f560 100644
--- a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
+++ b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
@@ -8,6 +8,8 @@
            prefix="plone" />
   <records interface="Products.CMFPlone.interfaces.ITypesSchema"
            prefix="plone" />
+  <records interface="plone.app.iterate.interfaces.IIterateSchema"
+           prefix="plone" />
   <records prefix="plone.resources/resource-plone-app-discussion-stylesheets"
         interface='Products.CMFPlone.interfaces.IResourceRegistry'
         remove="True">


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T18:03:08+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/62e89a904ab7440237ec2f90fe3e2fab1f7e13cc

Add iterate schema

Files changed:
M plone/app/upgrade/v50/profiles/to_rc3/registry.xml

diff --git a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
index a70f560..12af84e 100644
--- a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
+++ b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
@@ -8,7 +8,7 @@
            prefix="plone" />
   <records interface="Products.CMFPlone.interfaces.ITypesSchema"
            prefix="plone" />
-  <records interface="plone.app.iterate.interfaces.IIterateSchema"
+  <records interface="plone.app.iterate.interfaces.IIterateSettings"
            prefix="plone" />
   <records prefix="plone.resources/resource-plone-app-discussion-stylesheets"
         interface='Products.CMFPlone.interfaces.IResourceRegistry'


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T18:25:54+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/6d8a3ffbce9f3d10433c2b7e7b84537f1c04d230

This is an ascii field now, no need to safe_unicode

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index e07fea3..55953e1 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -523,7 +523,8 @@ def to50rc3(context):
                              'calendar_starting_year',
                              'calendar_future_years_available',
                              'redirect_links',
-                             'enable_checkout_workflow'
+                             'enable_checkout_workflow',
+                             'default_charset'
                              ]
     for p in properties_to_migrate:
         if site_properties.hasProperty(p):
@@ -551,11 +552,6 @@ def to50rc3(context):
         registry['plone.default_page_types'] = [safe_unicode(i) for i in value]
         site_properties._delProperty('default_page_types')
 
-    if site_properties.hasProperty('default_charset'):
-        value = site_properties.getProperty('default_charset')
-        registry['plone.default_charset'] = safe_unicode(value)
-        site_properties._delProperty('default_charset')
-
     if site_properties.hasProperty('sitemapDepth'):
         value = site_properties.getProperty('sitemapDepth')
         registry['plone.sitemap_depth'] = value


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:05+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/db4b99085f7142ffd1ec9fc7c4455c1f1c218fc3

Migrate mark_special_links property to registry

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 6f8fbd6..963b170 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -461,6 +461,7 @@ def to50rc3(context):
             portal._delProperty(p)
 
     properties_to_migrate = ['external_links_open_new_window',
+							 'mark_special_links',
                              'calendar_starting_year',
                              'calendar_future_years_available']
     for p in properties_to_migrate:


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:05+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/9df59963760ba76448fb31b9ae4298ff379e52b9

Import ILinkSchema on upgrade.

Files changed:
M plone/app/upgrade/v50/profiles/to_rc3/registry.xml

diff --git a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
index 3019d95..f5b0436 100644
--- a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
+++ b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
@@ -1,7 +1,11 @@
 <?xml version="1.0"?>
 <registry>
-    <records prefix="plone.resources/resource-plone-app-discussion-stylesheets"
+  <records interface="Products.CMFPlone.interfaces.ISiteSchema"
+           prefix="plone" />
+  <records interface="Products.CMFPlone.interfaces.ILinkSchema"
+           prefix="plone" />
+  <records prefix="plone.resources/resource-plone-app-discussion-stylesheets"
         interface='Products.CMFPlone.interfaces.IResourceRegistry'
         remove="True">
-    </records>
-</registry>
+  </records>
+</registry>
\ No newline at end of file


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:05+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/1729a2eb9909bf53acea39ae2c1aeeb23010d221

Handle string values for boolean fields

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 963b170..23a1c7a 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -467,6 +467,10 @@ def to50rc3(context):
     for p in properties_to_migrate:
         if site_properties.hasProperty(p):
             value = site_properties.getProperty(p)
+            if value == 'true':
+                value = True
+            elif value == 'false':
+                value = False
             try:
                 registry['plone.%s' % p] = value
                 site_properties._delProperty(p)


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:06+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/e442ca28009be51fc68428498af2a07982816ff9

Migrate typesLinkToFolderContentsInFC to registry.

Files changed:
M plone/app/upgrade/v50/betas.py
M plone/app/upgrade/v50/profiles/to_rc3/registry.xml

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 23a1c7a..ad1073d 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -476,3 +476,8 @@ def to50rc3(context):
                 site_properties._delProperty(p)
             except KeyError:
                 logger.warn('could not upgrade %s property' % p)
+
+    if site_properties.hasProperty('typesLinkToFolderContentsInFC'):
+        value = site_properties.getProperty('typesLinkToFolderContentsInFC')
+        registry['plone.types_link_to_folder_contents'] = tuple(value)
+        site_properties._delProperty('typesLinkToFolderContentsInFC')
diff --git a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
index f5b0436..a93db11 100644
--- a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
+++ b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
@@ -4,6 +4,8 @@
            prefix="plone" />
   <records interface="Products.CMFPlone.interfaces.ILinkSchema"
            prefix="plone" />
+  <records interface="Products.CMFPlone.interfaces.ITypesSchema"
+           prefix="plone" />
   <records prefix="plone.resources/resource-plone-app-discussion-stylesheets"
         interface='Products.CMFPlone.interfaces.IResourceRegistry'
         remove="True">


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:06+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/c5d81a182abe47ed5cf9a17b660a5f0f40343f83

Move redirect_links to the registry.

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index ad1073d..c201229 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -463,7 +463,8 @@ def to50rc3(context):
     properties_to_migrate = ['external_links_open_new_window',
 							 'mark_special_links',
                              'calendar_starting_year',
-                             'calendar_future_years_available']
+                             'calendar_future_years_available',
+							 'redirect_links']
     for p in properties_to_migrate:
         if site_properties.hasProperty(p):
             value = site_properties.getProperty(p)


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:06+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/b0a32dcefa362d5ed69749d5926710a971a001ca

upgrade navigation registry

Files changed:
M plone/app/upgrade/v50/profiles/to_rc3/registry.xml

diff --git a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
index a93db11..87c358f 100644
--- a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
+++ b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
@@ -4,6 +4,8 @@
            prefix="plone" />
   <records interface="Products.CMFPlone.interfaces.ILinkSchema"
            prefix="plone" />
+  <records interface="Products.CMFPlone.interfaces.INavigationSchema"
+           prefix="plone" />
   <records interface="Products.CMFPlone.interfaces.ITypesSchema"
            prefix="plone" />
   <records prefix="plone.resources/resource-plone-app-discussion-stylesheets"


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:06+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/6cb09e2d5bf8921031ca4a947cc6f05c97787c84

migrate navtree root prop

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index c201229..fb62820 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -1,21 +1,21 @@
 # -*- coding: utf-8 -*-
-import logging
-
+from plone.app.linkintegrity.upgrades import migrate_linkintegrity_relations
+from plone.app.upgrade.utils import loadMigrationProfile
+from plone.registry.interfaces import IRegistry
 from Products.CMFCore.interfaces import ISiteRoot
 from Products.CMFCore.utils import getToolByName
 from Products.CMFPlone.interfaces import ILanguageSchema
 from Products.CMFPlone.interfaces import IMailSchema
 from Products.CMFPlone.interfaces import IMarkupSchema
+from Products.CMFPlone.interfaces import INavigationSchema
 from Products.CMFPlone.interfaces import ISearchSchema
 from Products.CMFPlone.interfaces import ISecuritySchema
 from Products.CMFPlone.interfaces import ISiteSchema
 from Products.CMFPlone.interfaces import IUserGroupsSettingsSchema
 from Products.CMFPlone.interfaces.controlpanel import IImagingSchema
-from plone.app.linkintegrity.upgrades import migrate_linkintegrity_relations
-from plone.app.upgrade.utils import loadMigrationProfile
-from plone.registry.interfaces import IRegistry
 from zope.component import getUtility
 from zope.component.hooks import getSite
+import logging
 
 
 logger = logging.getLogger('plone.app.upgrade')
@@ -445,6 +445,28 @@ def to50rc2(context):
         site_properties._delProperty('allow_external_login_sites')
 
 
+def upgrade_navigation_controlpanel_settings_2(context):
+    """Copy navigation control panel settings from portal properties into the
+       new registry.
+       only missing values not migrated before
+    """
+    # get the old site properties
+    portal_properties = getToolByName(context, "portal_properties")
+    navigation_properties = portal_properties.navtree_properties
+    # get the new registry
+    registry = getUtility(IRegistry)
+    try:
+        settings = registry.forInterface(
+            INavigationSchema,
+            prefix='plone',
+        )
+    except KeyError:
+        return
+
+    settings.root = navigation_properties.getProperty('root')
+    navigation_properties._delProperty('root')
+
+
 def to50rc3(context):
     """5.0rc2 -> 5.0rc3"""
     loadMigrationProfile(context, 'profile-plone.app.upgrade.v50:to50rc3')
@@ -482,3 +504,7 @@ def to50rc3(context):
         value = site_properties.getProperty('typesLinkToFolderContentsInFC')
         registry['plone.types_link_to_folder_contents'] = tuple(value)
         site_properties._delProperty('typesLinkToFolderContentsInFC')
+
+    # migrate navtree properties
+    upgrade_navigation_controlpanel_settings_2(context)
+


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:06+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/fb5672d7b6ef108a6871d8db40b71b64cfda20a1

These values should be lists.

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index fb62820..5af85cc 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -502,7 +502,7 @@ def to50rc3(context):
 
     if site_properties.hasProperty('typesLinkToFolderContentsInFC'):
         value = site_properties.getProperty('typesLinkToFolderContentsInFC')
-        registry['plone.types_link_to_folder_contents'] = tuple(value)
+        registry['plone.types_link_to_folder_contents'] = list(value)
         site_properties._delProperty('typesLinkToFolderContentsInFC')
 
     # migrate navtree properties


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:06+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/b6401152c39eaa980a9f4630e35ab84733caeb96

more attributes to migrate

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 5af85cc..c4b9694 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -463,7 +463,18 @@ def upgrade_navigation_controlpanel_settings_2(context):
     except KeyError:
         return
 
-    settings.root = navigation_properties.getProperty('root')
+    navigation_properties._delProperty('idsNotToList')
+
+    settings.sort_tabs_on = navigation_properties.getProperty(
+        'sortAttribute'
+    ).decode('utf8')
+    navigation_properties._delProperty('sortAttribute')
+
+    desc = navigation_properties.getProperty('sortOrder') == 'desc'
+    settings.sort_tabs_reversed = desc
+    navigation_properties._delProperty('sortOrder')
+
+    settings.root = navigation_properties.getProperty('root').decode('utf8')
     navigation_properties._delProperty('root')
 
 
@@ -507,4 +518,3 @@ def to50rc3(context):
 
     # migrate navtree properties
     upgrade_navigation_controlpanel_settings_2(context)
-


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:06+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/8bf6f2000d17d7ed91d360e356b48c2f2343a2af

use correct values

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index c4b9694..e419aa2 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -470,8 +470,8 @@ def upgrade_navigation_controlpanel_settings_2(context):
     ).decode('utf8')
     navigation_properties._delProperty('sortAttribute')
 
-    desc = navigation_properties.getProperty('sortOrder') == 'desc'
-    settings.sort_tabs_reversed = desc
+    order = navigation_properties.getProperty('sortOrder', None)
+    settings.sort_tabs_reversed = order in ['descending', 'reverse']
     navigation_properties._delProperty('sortOrder')
 
     settings.root = navigation_properties.getProperty('root').decode('utf8')


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:06+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/cf689aa59617bf8116ddea8958f9f3163528d40d

Handle unicode values.

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index e419aa2..f9a7f18 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -513,8 +513,10 @@ def to50rc3(context):
 
     if site_properties.hasProperty('typesLinkToFolderContentsInFC'):
         value = site_properties.getProperty('typesLinkToFolderContentsInFC')
-        registry['plone.types_link_to_folder_contents'] = list(value)
+        value = [unicode(a) for a in value]
+        registry['plone.types_link_to_folder_contents'] = value
         site_properties._delProperty('typesLinkToFolderContentsInFC')
 
     # migrate navtree properties
     upgrade_navigation_controlpanel_settings_2(context)
+


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:06+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/ffdca1c6480dc20a3d8ea7ce5b71712301c8920d

Handle missing values.

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index f9a7f18..5685d20 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -471,11 +471,14 @@ def upgrade_navigation_controlpanel_settings_2(context):
     navigation_properties._delProperty('sortAttribute')
 
     order = navigation_properties.getProperty('sortOrder', None)
-    settings.sort_tabs_reversed = order in ['descending', 'reverse']
-    navigation_properties._delProperty('sortOrder')
-
-    settings.root = navigation_properties.getProperty('root').decode('utf8')
-    navigation_properties._delProperty('root')
+    if order is not None:
+        settings.sort_tabs_reversed = order in ['descending', 'reverse']
+        navigation_properties._delProperty('sortOrder')
+
+    root = navigation_properties.getProperty('root', None)
+    if root is not None:
+        settings.root = root.decode('utf8')
+        navigation_properties._delProperty('root')
 
 
 def to50rc3(context):


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:06+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/9a3c1185c8edc4ca013d1db91ef85aea999776fa

Rework property value removal to account for Plone 5 removing the property entirely

Files changed:
M plone/app/upgrade/v40/betas.py
M plone/app/upgrade/v40/profiles/to_beta4/propertiestool.xml

diff --git a/plone/app/upgrade/v40/betas.py b/plone/app/upgrade/v40/betas.py
index 9eb3d5a..5035480 100644
--- a/plone/app/upgrade/v40/betas.py
+++ b/plone/app/upgrade/v40/betas.py
@@ -91,6 +91,14 @@ def beta3_beta4(context):
     """
     loadMigrationProfile(context, 'profile-plone.app.upgrade.v40:4beta3-4beta4')
 
+    pprop = getToolByName(context, 'portal_properties')
+    site_properties = pprop.site_properties
+    if site_properties.hasProperty('typesLinkToFolderContentsInFC'):
+        value = site_properties.getProperty('typesLinkToFolderContentsInFC')
+        if 'Large Plone Folder' in value:
+            value.remove('Large Plone Folder')
+        site_properties.setProperty('typesLinkToFolderContentsInFC', value)
+
 
 def removeLargePloneFolder(context):
     """Complete removal of Large Plone Folder
diff --git a/plone/app/upgrade/v40/profiles/to_beta4/propertiestool.xml b/plone/app/upgrade/v40/profiles/to_beta4/propertiestool.xml
index 9da5e65..045c480 100644
--- a/plone/app/upgrade/v40/profiles/to_beta4/propertiestool.xml
+++ b/plone/app/upgrade/v40/profiles/to_beta4/propertiestool.xml
@@ -5,9 +5,4 @@
    <element value="Large Plone Folder" remove="True"/>
   </property>
  </object>
- <object name="site_properties" meta_type="Plone Property Sheet">
-  <property name="typesLinkToFolderContentsInFC" purge="False">
-   <element value="Large Plone Folder" remove="True"/>
-  </property>
- </object>
 </object>


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:07+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/55698b810723b1636bec1fc7cd290c9c68119ab0

Handle capitalized boolean strings.

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 5685d20..cfd2bc5 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -504,9 +504,9 @@ def to50rc3(context):
     for p in properties_to_migrate:
         if site_properties.hasProperty(p):
             value = site_properties.getProperty(p)
-            if value == 'true':
+            if value.lower() == 'true':
                 value = True
-            elif value == 'false':
+            elif value.lower() == 'false':
                 value = False
             try:
                 registry['plone.%s' % p] = value


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:07+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/328e6c86d2ea361be8218962901589809a3e34e9

Only try to convert strings.

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index cfd2bc5..e08bcbe 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -497,17 +497,18 @@ def to50rc3(context):
             portal._delProperty(p)
 
     properties_to_migrate = ['external_links_open_new_window',
-							 'mark_special_links',
+                             'mark_special_links',
                              'calendar_starting_year',
                              'calendar_future_years_available',
-							 'redirect_links']
+                             'redirect_links']
     for p in properties_to_migrate:
         if site_properties.hasProperty(p):
             value = site_properties.getProperty(p)
-            if value.lower() == 'true':
-                value = True
-            elif value.lower() == 'false':
-                value = False
+            if isinstance(value, basestring):
+                if value.lower() == 'true':
+                    value = True
+                elif value.lower() == 'false':
+                    value = False
             try:
                 registry['plone.%s' % p] = value
                 site_properties._delProperty(p)


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:07+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/dbff05f83d8651ffeabb4bf634180b5af2b705d6

Migrate sitemapDepth

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index e08bcbe..dd467ff 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -500,7 +500,8 @@ def to50rc3(context):
                              'mark_special_links',
                              'calendar_starting_year',
                              'calendar_future_years_available',
-                             'redirect_links']
+                             'redirect_links',
+                             '']
     for p in properties_to_migrate:
         if site_properties.hasProperty(p):
             value = site_properties.getProperty(p)
@@ -515,6 +516,11 @@ def to50rc3(context):
             except KeyError:
                 logger.warn('could not upgrade %s property' % p)
 
+    if site_properties.hasProperty('sitemapDepth'):
+        value = site_properties.getProperty('sitemapDepth')
+        registry['plone.sitemap_depth'] = value
+        site_properties._delProperty('sitemapDepth')
+
     if site_properties.hasProperty('typesLinkToFolderContentsInFC'):
         value = site_properties.getProperty('typesLinkToFolderContentsInFC')
         value = [unicode(a) for a in value]


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:07+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/612f648aa077b2e7870030d1036cd08312caf11a

Remove currentFolderOnlyInNavtree

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index dd467ff..487c128 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -490,7 +490,8 @@ def to50rc3(context):
     site_properties = pprop['site_properties']
     registry = getUtility(IRegistry)
 
-    site_properties_to_remove = ['invalid_ids']
+    site_properties_to_remove = ['invalid_ids', 
+                                 'currentFolderOnlyInNavtree']
 
     for p in site_properties_to_remove:
         if portal.hasProperty(p):
@@ -500,8 +501,7 @@ def to50rc3(context):
                              'mark_special_links',
                              'calendar_starting_year',
                              'calendar_future_years_available',
-                             'redirect_links',
-                             '']
+                             'redirect_links']
     for p in properties_to_migrate:
         if site_properties.hasProperty(p):
             value = site_properties.getProperty(p)


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:07+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/5738837416e53cebe9d6f6f1db0fab98ab84d796

move default_page_types to registry

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 487c128..116c972 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -490,7 +490,7 @@ def to50rc3(context):
     site_properties = pprop['site_properties']
     registry = getUtility(IRegistry)
 
-    site_properties_to_remove = ['invalid_ids', 
+    site_properties_to_remove = ['invalid_ids',
                                  'currentFolderOnlyInNavtree']
 
     for p in site_properties_to_remove:
@@ -501,7 +501,8 @@ def to50rc3(context):
                              'mark_special_links',
                              'calendar_starting_year',
                              'calendar_future_years_available',
-                             'redirect_links']
+                             'redirect_links',
+                             'default_page_types']
     for p in properties_to_migrate:
         if site_properties.hasProperty(p):
             value = site_properties.getProperty(p)


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:07+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/5f908f4f7b8903f70088d976b0925a95cdbac781

fixes in portal-properties migration

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 116c972..6fd517a 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -13,6 +13,7 @@
 from Products.CMFPlone.interfaces import ISiteSchema
 from Products.CMFPlone.interfaces import IUserGroupsSettingsSchema
 from Products.CMFPlone.interfaces.controlpanel import IImagingSchema
+from Products.CMFPlone.utils import safe_unicode
 from zope.component import getUtility
 from zope.component.hooks import getSite
 import logging
@@ -463,12 +464,13 @@ def upgrade_navigation_controlpanel_settings_2(context):
     except KeyError:
         return
 
-    navigation_properties._delProperty('idsNotToList')
+    if navigation_properties.hasProperty('idsNotToList'):
+        navigation_properties._delProperty('idsNotToList')
 
-    settings.sort_tabs_on = navigation_properties.getProperty(
-        'sortAttribute'
-    ).decode('utf8')
-    navigation_properties._delProperty('sortAttribute')
+    if navigation_properties.hasProperty('sortAttribute'):
+        settings.sort_tabs_on = navigation_properties.getProperty(
+            'sortAttribute').decode('utf8')
+        navigation_properties._delProperty('sortAttribute')
 
     order = navigation_properties.getProperty('sortOrder', None)
     if order is not None:
@@ -501,8 +503,7 @@ def to50rc3(context):
                              'mark_special_links',
                              'calendar_starting_year',
                              'calendar_future_years_available',
-                             'redirect_links',
-                             'default_page_types']
+                             'redirect_links']
     for p in properties_to_migrate:
         if site_properties.hasProperty(p):
             value = site_properties.getProperty(p)
@@ -517,6 +518,11 @@ def to50rc3(context):
             except KeyError:
                 logger.warn('could not upgrade %s property' % p)
 
+    if site_properties.hasProperty('default_page_types'):
+        value = site_properties.getProperty('default_page_types')
+        registry['plone.default_page_types'] = [safe_unicode(i) for i in value]
+        site_properties._delProperty('default_page_types')
+
     if site_properties.hasProperty('sitemapDepth'):
         value = site_properties.getProperty('sitemapDepth')
         registry['plone.sitemap_depth'] = value


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:07+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/569c4392ba7f5e71ef9804cd0dae0c9397e8122c

Remove from site_properties, no portal_properties

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 6fd517a..4048cf7 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -494,10 +494,13 @@ def to50rc3(context):
 
     site_properties_to_remove = ['invalid_ids',
                                  'currentFolderOnlyInNavtree']
+    site_properties_to_remove = ['invalid_ids']
 
     for p in site_properties_to_remove:
         if portal.hasProperty(p):
             portal._delProperty(p)
+        if site_properties.hasProperty(p):
+            site_properties._delProperty(p)
 
     properties_to_migrate = ['external_links_open_new_window',
                              'mark_special_links',


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:07+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/e5b78aee49eec0326123ef1defa7b00c3de0409d

Use safe_unicode

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 4048cf7..1ab2b26 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -533,7 +533,7 @@ def to50rc3(context):
 
     if site_properties.hasProperty('typesLinkToFolderContentsInFC'):
         value = site_properties.getProperty('typesLinkToFolderContentsInFC')
-        value = [unicode(a) for a in value]
+        value = [safe_unicode(a) for a in value]
         registry['plone.types_link_to_folder_contents'] = value
         site_properties._delProperty('typesLinkToFolderContentsInFC')
 


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:07+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/f4a84c2873099f0e21d66e1adb2ec6e5d413daba

Migrate default_page

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 1ab2b26..f5a5c16 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -497,8 +497,6 @@ def to50rc3(context):
     site_properties_to_remove = ['invalid_ids']
 
     for p in site_properties_to_remove:
-        if portal.hasProperty(p):
-            portal._delProperty(p)
         if site_properties.hasProperty(p):
             site_properties._delProperty(p)
 
@@ -531,11 +529,19 @@ def to50rc3(context):
         registry['plone.sitemap_depth'] = value
         site_properties._delProperty('sitemapDepth')
 
-    if site_properties.hasProperty('typesLinkToFolderContentsInFC'):
-        value = site_properties.getProperty('typesLinkToFolderContentsInFC')
-        value = [safe_unicode(a) for a in value]
-        registry['plone.types_link_to_folder_contents'] = value
-        site_properties._delProperty('typesLinkToFolderContentsInFC')
+    def _migrate_list(original_id, new_id=None):
+        if new_id is None:
+            new_id = original_id
+        if site_properties.hasProperty(original_id):
+            value = site_properties.getProperty(original_id)
+            value = [safe_unicode(a) for a in value]
+            registry['plone.%s' % new_id] = value
+            site_properties._delProperty(original_id)
+
+    _migrate_list('typesLinkToFolderContentsInFC',
+                  'types_use_view_action_in_listings')
+    _migrate_list('default_page')
+
 
     # migrate navtree properties
     upgrade_navigation_controlpanel_settings_2(context)


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:07+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/4bcdc8c00f08b3446186e1c5b5809efc8d52a66a

Move nav property upgrades into their own method

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index f5a5c16..d57f593 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -482,6 +482,21 @@ def upgrade_navigation_controlpanel_settings_2(context):
         settings.root = root.decode('utf8')
         navigation_properties._delProperty('root')
 
+    if navigation_properties.hasProperty('sitemapDepth'):
+        value = navigation_properties.getProperty('sitemapDepth')
+        registry['plone.sitemap_depth'] = value
+        navigation_properties._delProperty('sitemapDepth')
+
+    properties_to_remove = ['idsNotToList',
+                            'currentFolderOnlyInNavtree',
+                            'includeTop',
+                            'topLevel',
+                            'bottomLevel']
+
+    for p in properties_to_remove:
+        if navigation_properties.hasProperty(p):
+            navigation_properties._delProperty(p)
+
 
 def to50rc3(context):
     """5.0rc2 -> 5.0rc3"""
@@ -492,8 +507,6 @@ def to50rc3(context):
     site_properties = pprop['site_properties']
     registry = getUtility(IRegistry)
 
-    site_properties_to_remove = ['invalid_ids',
-                                 'currentFolderOnlyInNavtree']
     site_properties_to_remove = ['invalid_ids']
 
     for p in site_properties_to_remove:


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:08+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/141d6bdd23f2e567bbf817cda848c8f8006ae6be

Remove showAllParents

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index d57f593..3c1e598 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -491,7 +491,8 @@ def upgrade_navigation_controlpanel_settings_2(context):
                             'currentFolderOnlyInNavtree',
                             'includeTop',
                             'topLevel',
-                            'bottomLevel']
+                            'bottomLevel',
+                            'showAllParents']
 
     for p in properties_to_remove:
         if navigation_properties.hasProperty(p):


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:08+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/c349f317ddd445bbbff53fb9b26ebd99dc75fc3c

remove ellipsis

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 3c1e598..b96f435 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -508,7 +508,7 @@ def to50rc3(context):
     site_properties = pprop['site_properties']
     registry = getUtility(IRegistry)
 
-    site_properties_to_remove = ['invalid_ids']
+    site_properties_to_remove = ['invalid_ids', 'ellipsis']
 
     for p in site_properties_to_remove:
         if site_properties.hasProperty(p):


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:08+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/b7d552d708b826f28e4172a49ca30b8a45b16ac6

Move default_charset to the registry

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index b96f435..733d90e 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -538,6 +538,11 @@ def to50rc3(context):
         registry['plone.default_page_types'] = [safe_unicode(i) for i in value]
         site_properties._delProperty('default_page_types')
 
+    if site_properties.hasProperty('default_charset'):
+        value = site_properties.getProperty('default_charset')
+        registry['plone.default_charset'] = safe_unicode(value)
+        site_properties._delProperty('default_charset')
+
     if site_properties.hasProperty('sitemapDepth'):
         value = site_properties.getProperty('sitemapDepth')
         registry['plone.sitemap_depth'] = value


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:08+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/42c05c9d5a9429eedb3523283baf95e772f7f319

migrate parentMetaTypesNotToQuery to registry (as parent_types_not_to_query)

Files changed:
M plone/app/upgrade/v40/betas.py
M plone/app/upgrade/v40/tests.py
M plone/app/upgrade/v50/betas.py
D plone/app/upgrade/v40/profiles/to_beta4/propertiestool.xml

diff --git a/plone/app/upgrade/v40/betas.py b/plone/app/upgrade/v40/betas.py
index 5035480..fae8fd7 100644
--- a/plone/app/upgrade/v40/betas.py
+++ b/plone/app/upgrade/v40/betas.py
@@ -99,6 +99,13 @@ def beta3_beta4(context):
             value.remove('Large Plone Folder')
         site_properties.setProperty('typesLinkToFolderContentsInFC', value)
 
+    navtree_properties = pprop.navtree_properties
+    if navtree_properties.hasProperty('parentMetaTypesNotToQuery'):
+        value = navtree_properties.getProperty('parentMetaTypesNotToQuery')
+        if 'Large Plone Folder' in value:
+            value.remove('Large Plone Folder')
+        navtree_properties.setProperty('parentMetaTypesNotToQuery', value)
+
 
 def removeLargePloneFolder(context):
     """Complete removal of Large Plone Folder
diff --git a/plone/app/upgrade/v40/profiles/to_beta4/propertiestool.xml b/plone/app/upgrade/v40/profiles/to_beta4/propertiestool.xml
deleted file mode 100644
index 045c480..0000000
--- a/plone/app/upgrade/v40/profiles/to_beta4/propertiestool.xml
+++ /dev/null
@@ -1,8 +0,0 @@
-<?xml version="1.0"?>
-<object name="portal_properties" meta_type="Plone Properties Tool">
- <object name="navtree_properties" meta_type="Plone Property Sheet">
-  <property name="parentMetaTypesNotToQuery" purge="False">
-   <element value="Large Plone Folder" remove="True"/>
-  </property>
- </object>
-</object>
diff --git a/plone/app/upgrade/v40/tests.py b/plone/app/upgrade/v40/tests.py
index 42b7bb0..4ad4651 100644
--- a/plone/app/upgrade/v40/tests.py
+++ b/plone/app/upgrade/v40/tests.py
@@ -554,6 +554,8 @@ def testRemoveLargePloneFolder(self):
         # re-create pre-migration settings
         ptool = self.portal.portal_properties
         nav_props = ptool.navtree_properties
+        if not nav_props.hasProperty('parentMetaTypesNotToQuery'):
+            return
         l = list(nav_props.parentMetaTypesNotToQuery)
         nav_props.parentMetaTypesNotToQuery = l + ['Large Plone Folder']
         site_props = ptool.site_properties
diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 733d90e..40e4708 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -560,6 +560,7 @@ def _migrate_list(original_id, new_id=None):
     _migrate_list('typesLinkToFolderContentsInFC',
                   'types_use_view_action_in_listings')
     _migrate_list('default_page')
+    _migrate_list('parentMetaTypesNotToQuery', 'parent_types_not_to_query')
 
 
     # migrate navtree properties


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:08+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/2491cf13f2fdd6eb7926ab73836fdd1d767c57e9

Migrate portal.email_charset

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 40e4708..5cd7c1f 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -508,6 +508,9 @@ def to50rc3(context):
     site_properties = pprop['site_properties']
     registry = getUtility(IRegistry)
 
+    if hasattr(portal, 'email_charset'):
+        registry['plone.email_charset'] = portal.email_charset
+
     site_properties_to_remove = ['invalid_ids', 'ellipsis']
 
     for p in site_properties_to_remove:


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:08+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/9de2d5cbf45c307727a7dd7362750e63c94a8244

allowRolesToAddKeywords -&gt; roles_allowed_to_add_keywords

Files changed:
M plone/app/upgrade/v40/betas.py
M plone/app/upgrade/v42/betas.py
M plone/app/upgrade/v42/tests.py
M plone/app/upgrade/v50/betas.py
D plone/app/upgrade/v42/profiles/to_beta1/propertiestool.xml

diff --git a/plone/app/upgrade/v40/betas.py b/plone/app/upgrade/v40/betas.py
index fae8fd7..aa8bbe9 100644
--- a/plone/app/upgrade/v40/betas.py
+++ b/plone/app/upgrade/v40/betas.py
@@ -97,14 +97,14 @@ def beta3_beta4(context):
         value = site_properties.getProperty('typesLinkToFolderContentsInFC')
         if 'Large Plone Folder' in value:
             value.remove('Large Plone Folder')
-        site_properties.setProperty('typesLinkToFolderContentsInFC', value)
+            site_properties.typesLinkToFolderContentsInFC = value
 
     navtree_properties = pprop.navtree_properties
     if navtree_properties.hasProperty('parentMetaTypesNotToQuery'):
         value = navtree_properties.getProperty('parentMetaTypesNotToQuery')
         if 'Large Plone Folder' in value:
             value.remove('Large Plone Folder')
-        navtree_properties.setProperty('parentMetaTypesNotToQuery', value)
+            navtree_properties.parentMetaTypesNotToQuery = value
 
 
 def removeLargePloneFolder(context):
diff --git a/plone/app/upgrade/v42/betas.py b/plone/app/upgrade/v42/betas.py
index de21118..5645643 100644
--- a/plone/app/upgrade/v42/betas.py
+++ b/plone/app/upgrade/v42/betas.py
@@ -34,6 +34,14 @@ def to42beta1(context):
     """4.2a2 -> 4.2b1
     """
     loadMigrationProfile(context, 'profile-plone.app.upgrade.v42:to42beta1')
+    pprop = getToolByName(context, 'portal_properties')
+    site_properties = pprop.site_properties
+    if site_properties.hasProperty('allowRolesToAddKeywords'):
+        value = site_properties.getProperty('allowRolesToAddKeywords')
+        if 'Site Administrator' not in value:
+            value = list(value)
+            value.append('Site Administrator')
+            site_properties.allowRolesToAddKeywords = tuple(value)
 
 
 def to42beta1_owner_tuples(context):
diff --git a/plone/app/upgrade/v42/profiles/to_beta1/propertiestool.xml b/plone/app/upgrade/v42/profiles/to_beta1/propertiestool.xml
deleted file mode 100644
index 768c75d..0000000
--- a/plone/app/upgrade/v42/profiles/to_beta1/propertiestool.xml
+++ /dev/null
@@ -1,8 +0,0 @@
-<?xml version="1.0"?>
-<object name="portal_properties" meta_type="Plone Properties Tool">
-  <object name="site_properties" meta_type="Plone Property Sheet">
-    <property name="allowRolesToAddKeywords" type="lines" purge="False">
-      <element value="Site Administrator"/>
-    </property>
-  </object>
-</object>
\ No newline at end of file
diff --git a/plone/app/upgrade/v42/tests.py b/plone/app/upgrade/v42/tests.py
index 0ff501e..e21bccb 100644
--- a/plone/app/upgrade/v42/tests.py
+++ b/plone/app/upgrade/v42/tests.py
@@ -14,6 +14,8 @@ def testProfile(self):
     def testAddSiteAdminToKeywordRoles(self):
         ptool = self.portal.portal_properties
         site_props = ptool.site_properties
+        if not site_props.hasProperty('allowRolesToAddKeywords'):
+            return
         site_props.allowRolesToAddKeywords = ('Manager', 'Reviewer')
         loadMigrationProfile(self.portal, self.profile)
         roles = site_props.allowRolesToAddKeywords
diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 5cd7c1f..5bf9c53 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -564,8 +564,7 @@ def _migrate_list(original_id, new_id=None):
                   'types_use_view_action_in_listings')
     _migrate_list('default_page')
     _migrate_list('parentMetaTypesNotToQuery', 'parent_types_not_to_query')
-
+    _migrate_list('allowRolesToAddKeywords', 'roles_allowed_to_add_keywords')
 
     # migrate navtree properties
     upgrade_navigation_controlpanel_settings_2(context)
-


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:08+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/bde2b2c70725c951f61e054f45a9e1ef23abb37a

Add plone.app.iterate upgrades.

Files changed:
M plone/app/upgrade/v50/betas.py
M plone/app/upgrade/v50/profiles/to_rc3/registry.xml

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 5bf9c53..e07fea3 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -508,8 +508,9 @@ def to50rc3(context):
     site_properties = pprop['site_properties']
     registry = getUtility(IRegistry)
 
-    if hasattr(portal, 'email_charset'):
+    if portal.hasProperty('email_charset'):
         registry['plone.email_charset'] = portal.email_charset
+        portal._delProperty('email_charset')
 
     site_properties_to_remove = ['invalid_ids', 'ellipsis']
 
@@ -521,7 +522,9 @@ def to50rc3(context):
                              'mark_special_links',
                              'calendar_starting_year',
                              'calendar_future_years_available',
-                             'redirect_links']
+                             'redirect_links',
+                             'enable_checkout_workflow'
+                             ]
     for p in properties_to_migrate:
         if site_properties.hasProperty(p):
             value = site_properties.getProperty(p)
@@ -536,6 +539,13 @@ def to50rc3(context):
             except KeyError:
                 logger.warn('could not upgrade %s property' % p)
 
+    if site_properties.hasProperty('checkout_workflow_policy'):
+        value = site_properties.getProperty('checkout_workflow_policy')
+        from plone.app.iterate.interfaces import IIterateSchema
+        settings = registry.forInterface(IIterateSchema)
+        settings.checkout_workflow_policy = safe_unicode(value)
+        site_properties._delProperty('checkout_workflow_policy')
+
     if site_properties.hasProperty('default_page_types'):
         value = site_properties.getProperty('default_page_types')
         registry['plone.default_page_types'] = [safe_unicode(i) for i in value]
diff --git a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
index 87c358f..a70f560 100644
--- a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
+++ b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
@@ -8,6 +8,8 @@
            prefix="plone" />
   <records interface="Products.CMFPlone.interfaces.ITypesSchema"
            prefix="plone" />
+  <records interface="plone.app.iterate.interfaces.IIterateSchema"
+           prefix="plone" />
   <records prefix="plone.resources/resource-plone-app-discussion-stylesheets"
         interface='Products.CMFPlone.interfaces.IResourceRegistry'
         remove="True">


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:08+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/39a54219ad6f13f6ca76d57a56fe418028ec565d

Add iterate schema

Files changed:
M plone/app/upgrade/v50/profiles/to_rc3/registry.xml

diff --git a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
index a70f560..12af84e 100644
--- a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
+++ b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
@@ -8,7 +8,7 @@
            prefix="plone" />
   <records interface="Products.CMFPlone.interfaces.ITypesSchema"
            prefix="plone" />
-  <records interface="plone.app.iterate.interfaces.IIterateSchema"
+  <records interface="plone.app.iterate.interfaces.IIterateSettings"
            prefix="plone" />
   <records prefix="plone.resources/resource-plone-app-discussion-stylesheets"
         interface='Products.CMFPlone.interfaces.IResourceRegistry'


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T20:19:08+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/44a6aed3218e29ae7e431aabd4d58df91cf57500

This is an ascii field now, no need to safe_unicode

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index e07fea3..55953e1 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -523,7 +523,8 @@ def to50rc3(context):
                              'calendar_starting_year',
                              'calendar_future_years_available',
                              'redirect_links',
-                             'enable_checkout_workflow'
+                             'enable_checkout_workflow',
+                             'default_charset'
                              ]
     for p in properties_to_migrate:
         if site_properties.hasProperty(p):
@@ -551,11 +552,6 @@ def to50rc3(context):
         registry['plone.default_page_types'] = [safe_unicode(i) for i in value]
         site_properties._delProperty('default_page_types')
 
-    if site_properties.hasProperty('default_charset'):
-        value = site_properties.getProperty('default_charset')
-        registry['plone.default_charset'] = safe_unicode(value)
-        site_properties._delProperty('default_charset')
-
     if site_properties.hasProperty('sitemapDepth'):
         value = site_properties.getProperty('sitemapDepth')
         registry['plone.sitemap_depth'] = value


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-19T23:57:40+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/f3e5d6be9e9ef6b42037bb10647029bae00cc70a

Merge remote-tracking branch 'remotes/origin/portal-properties-cleanup' into portal-properties-cleanup

Files changed:
M CHANGES.rst
M plone/app/upgrade/v42/final.py
M plone/app/upgrade/v43/alphas.py
M plone/app/upgrade/v43/betas.py
M plone/app/upgrade/v43/final.py

diff --git a/CHANGES.rst b/CHANGES.rst
index e4c48db..21178ee 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,6 +4,13 @@ Changelog
 1.3.16 (unreleased)
 -------------------
 
+- Plone 4.3: upgrade TinyMCE correctly.  Update sunburst theme profile
+  version when applying its upgrade step.  Update CMFEditions.  Update
+  plone.app.jquery.
+  This fixes
+  https://github.com/plone/Products.CMFPlone/issues/812
+  [maurits]
+
 - Portal properties calendar_starting_year and calendar_future_years_available
   were moved to registry.
   [pbauer]
diff --git a/plone/app/upgrade/v42/final.py b/plone/app/upgrade/v42/final.py
index 0894895..5320204 100644
--- a/plone/app/upgrade/v42/final.py
+++ b/plone/app/upgrade/v42/final.py
@@ -13,25 +13,8 @@ def to42final_cmfeditions_registry_bases(context):
     # profile isn't installed and so has no installed version number.
     # this applies a necessary upgrade step but also establishes a
     # version for the profile
-    setup = getToolByName(context, 'portal_setup')
-
-    # Copied from Products.GenericSetup.tool.SetupTool.manage_doUpgrades
-    logger = logging.getLogger('GenericSetup')
-    steps_to_run = ['36634937']
-    profile_id = 'Products.CMFEditions:CMFEditions'
-    step = None
-    for step_id in steps_to_run:
-        step = _upgrade_registry.getUpgradeStep(profile_id, step_id)
-        if step is not None:
-            step.doStep(setup)
-            msg = "Ran upgrade step %s for profile %s" % (step.title,
-                                                          profile_id)
-            logger.log(logging.INFO, msg)
-
-    # We update the profile version to the last one we have reached
-    # with running an upgrade step.
-    if step and step.dest is not None and step.checker is None:
-        setup.setLastVersionForProfile(profile_id, step.dest)
+    qi = getToolByName(context, 'portal_quickinstaller')
+    qi.upgradeProduct('Products.CMFEditions')
 
 
 def to42final(context):
diff --git a/plone/app/upgrade/v43/alphas.py b/plone/app/upgrade/v43/alphas.py
index e4db876..7aadde6 100644
--- a/plone/app/upgrade/v43/alphas.py
+++ b/plone/app/upgrade/v43/alphas.py
@@ -69,13 +69,17 @@ def upgradeToI18NCaseNormalizer(context):
 
 def upgradeTinyMCE(context):
     """ Upgrade TinyMCE WYSIWYG Editor to jQuery based version 1.3
+
+    This is profile version 4.
     """
     try:
-        from Products.TinyMCE.upgrades import upgrade_12_to_13
+        # Is the package still there?  Not on Plone 5.
+        import Products.TinyMCE.upgrades
+        Products.TinyMCE.upgrades  # pyflakes
     except ImportError:
-        pass
-    else:
-        upgrade_12_to_13(context)
+        return
+    context.upgradeProfile('Products.TinyMCE:TinyMCE', dest='4')
+
 
 def upgradePloneAppTheming(context):
     """Re-install plone.app.theming if previously installed
@@ -101,14 +105,18 @@ def upgradePloneAppTheming(context):
     portal_setup = getToolByName(context, 'portal_setup')
     return portal_setup.runAllImportStepsFromProfile('profile-plone.app.theming:default')
 
+
 def upgradePloneAppJQuery(context):
-    """ Upgrade TinyMCE WYSIWYG Editor to jQuery based version 1.3
+    """ Upgrade plone.app.jquery to profile version 3.
     """
     try:
-        from plone.app.jquery.upgrades import upgrade_2_to_3
-        upgrade_2_to_3(context)
+        # Is the package still there?  Not on Plone 5.
+        import plone.app.jquery
+        plone.app.jquery  # pyflakes
     except ImportError:
-        pass
+        return
+    context.upgradeProfile('plone.app.jquery:default', dest='3')
+
 
 def to43alpha1(context):
     """4.2 -> 4.3alpha1"""
@@ -116,9 +124,7 @@ def to43alpha1(context):
     reindex_sortable_title(context)
     upgradeTinyMCE(context)
     upgradePloneAppTheming(context)
-    # XXX only for plone.app.jquery 1.7
-    # we're on 1.4 right now
-    # upgradePloneAppJQuery(context)
+    upgradePloneAppJQuery(context)
 
 
 def upgradeSyndication(context):
@@ -231,6 +237,10 @@ def removeKSS(context):
 
 
 def upgradeTinyMCEAgain(context):
-    qi = getToolByName(context, 'portal_quickinstaller')
-    if 'Products.TinyMCE' in qi:
-        qi.upgradeProduct('Products.TinyMCE')
\ No newline at end of file
+    try:
+        # Is the package still there?  Not on Plone 5.
+        import Products.TinyMCE.upgrades
+        Products.TinyMCE.upgrades  # pyflakes
+    except ImportError:
+        return
+    context.upgradeProfile('Products.TinyMCE:TinyMCE')
diff --git a/plone/app/upgrade/v43/betas.py b/plone/app/upgrade/v43/betas.py
index dc7e045..0b34497 100644
--- a/plone/app/upgrade/v43/betas.py
+++ b/plone/app/upgrade/v43/betas.py
@@ -1,9 +1,11 @@
 from plone.app.upgrade.utils import loadMigrationProfile
 from plone.app.upgrade.v43.alphas import upgradeToI18NCaseNormalizer
 
+
 def to43beta2(context):
     loadMigrationProfile(context, 'profile-plone.app.upgrade.v43:to43beta2')
 
+
 def to43rc1(context):
     loadMigrationProfile(context, 'profile-plone.app.upgrade.v43:to43rc1')
     upgradeToI18NCaseNormalizer(context)
@@ -13,8 +15,9 @@ def upgradeSunburst(context):
     """ Upgrade plonetheme.sunburst to version 1.4
     """
     try:
-        from plonetheme.sunburst.setuphandlers import upgrade_step_2_3
+        # Is the package still there?  Not on Plone 5.
+        import plonetheme.sunburst
+        plonetheme.sunburst  # pyflakes
     except ImportError:
-        pass
-    else:
-        upgrade_step_2_3(context)
+        return
+    context.upgradeProfile('plonetheme.sunburst:default', dest='3')
diff --git a/plone/app/upgrade/v43/final.py b/plone/app/upgrade/v43/final.py
index 6eda84f..b14e380 100644
--- a/plone/app/upgrade/v43/final.py
+++ b/plone/app/upgrade/v43/final.py
@@ -7,7 +7,11 @@
 
 from plone.app.upgrade.utils import loadMigrationProfile
 from plone.app.upgrade.utils import unregisterSteps
+from plone.app.upgrade.v43.alphas import upgradeTinyMCEAgain
 
+# We had our own version of this, but it was just a copy.  We keep a
+# reference here to avoid breakage if someone imports it.
+upgradeTinyMCEAgain  # Pyflakes
 logger = logging.getLogger('plone.app.upgrade')
 
 
@@ -32,12 +36,6 @@ def upgradeContentRulesNames(context):
         check_rules_with_dotted_name_moved(storage[key])
 
 
-def upgradeTinyMCEAgain(context):
-    qi = getToolByName(context, 'portal_quickinstaller')
-    if 'Products.TinyMCE' in qi:
-        qi.upgradeProduct('Products.TinyMCE')
-
-
 def removePersistentKSSMimeTypeImportStep(context):
     unregisterSteps(context, import_steps=['kss_mimetype'])
 


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-20T12:21:15+02:00
Author: esteele (esteele) <eric@esteele.net>
Commit: https://github.com/plone/plone.app.upgrade/commit/641a6774f434a18e16a4b65b4ee70825f9a099ae

Remove default_charset property

Files changed:
M plone/app/upgrade/v50/betas.py

diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 55953e1..b7b01c2 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -512,7 +512,7 @@ def to50rc3(context):
         registry['plone.email_charset'] = portal.email_charset
         portal._delProperty('email_charset')
 
-    site_properties_to_remove = ['invalid_ids', 'ellipsis']
+    site_properties_to_remove = ['invalid_ids', 'ellipsis', 'default_charset']
 
     for p in site_properties_to_remove:
         if site_properties.hasProperty(p):
@@ -523,9 +523,7 @@ def to50rc3(context):
                              'calendar_starting_year',
                              'calendar_future_years_available',
                              'redirect_links',
-                             'enable_checkout_workflow',
-                             'default_charset'
-                             ]
+                             'enable_checkout_workflow']
     for p in properties_to_migrate:
         if site_properties.hasProperty(p):
             value = site_properties.getProperty(p)


Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2015-09-20T17:33:37+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/d9b65535f367ab59ab8b61f7db830470ca987436

Merge pull request #52 from plone/portal-properties-cleanup

Portal properties cleanup

Files changed:
M plone/app/upgrade/v40/betas.py
M plone/app/upgrade/v40/tests.py
M plone/app/upgrade/v42/betas.py
M plone/app/upgrade/v42/tests.py
M plone/app/upgrade/v50/betas.py
M plone/app/upgrade/v50/profiles/to_rc3/registry.xml
D plone/app/upgrade/v40/profiles/to_beta4/propertiestool.xml
D plone/app/upgrade/v42/profiles/to_beta1/propertiestool.xml

diff --git a/plone/app/upgrade/v40/betas.py b/plone/app/upgrade/v40/betas.py
index 9eb3d5a..aa8bbe9 100644
--- a/plone/app/upgrade/v40/betas.py
+++ b/plone/app/upgrade/v40/betas.py
@@ -91,6 +91,21 @@ def beta3_beta4(context):
     """
     loadMigrationProfile(context, 'profile-plone.app.upgrade.v40:4beta3-4beta4')
 
+    pprop = getToolByName(context, 'portal_properties')
+    site_properties = pprop.site_properties
+    if site_properties.hasProperty('typesLinkToFolderContentsInFC'):
+        value = site_properties.getProperty('typesLinkToFolderContentsInFC')
+        if 'Large Plone Folder' in value:
+            value.remove('Large Plone Folder')
+            site_properties.typesLinkToFolderContentsInFC = value
+
+    navtree_properties = pprop.navtree_properties
+    if navtree_properties.hasProperty('parentMetaTypesNotToQuery'):
+        value = navtree_properties.getProperty('parentMetaTypesNotToQuery')
+        if 'Large Plone Folder' in value:
+            value.remove('Large Plone Folder')
+            navtree_properties.parentMetaTypesNotToQuery = value
+
 
 def removeLargePloneFolder(context):
     """Complete removal of Large Plone Folder
diff --git a/plone/app/upgrade/v40/profiles/to_beta4/propertiestool.xml b/plone/app/upgrade/v40/profiles/to_beta4/propertiestool.xml
deleted file mode 100644
index 9da5e65..0000000
--- a/plone/app/upgrade/v40/profiles/to_beta4/propertiestool.xml
+++ /dev/null
@@ -1,13 +0,0 @@
-<?xml version="1.0"?>
-<object name="portal_properties" meta_type="Plone Properties Tool">
- <object name="navtree_properties" meta_type="Plone Property Sheet">
-  <property name="parentMetaTypesNotToQuery" purge="False">
-   <element value="Large Plone Folder" remove="True"/>
-  </property>
- </object>
- <object name="site_properties" meta_type="Plone Property Sheet">
-  <property name="typesLinkToFolderContentsInFC" purge="False">
-   <element value="Large Plone Folder" remove="True"/>
-  </property>
- </object>
-</object>
diff --git a/plone/app/upgrade/v40/tests.py b/plone/app/upgrade/v40/tests.py
index 42b7bb0..4ad4651 100644
--- a/plone/app/upgrade/v40/tests.py
+++ b/plone/app/upgrade/v40/tests.py
@@ -554,6 +554,8 @@ def testRemoveLargePloneFolder(self):
         # re-create pre-migration settings
         ptool = self.portal.portal_properties
         nav_props = ptool.navtree_properties
+        if not nav_props.hasProperty('parentMetaTypesNotToQuery'):
+            return
         l = list(nav_props.parentMetaTypesNotToQuery)
         nav_props.parentMetaTypesNotToQuery = l + ['Large Plone Folder']
         site_props = ptool.site_properties
diff --git a/plone/app/upgrade/v42/betas.py b/plone/app/upgrade/v42/betas.py
index de21118..5645643 100644
--- a/plone/app/upgrade/v42/betas.py
+++ b/plone/app/upgrade/v42/betas.py
@@ -34,6 +34,14 @@ def to42beta1(context):
     """4.2a2 -> 4.2b1
     """
     loadMigrationProfile(context, 'profile-plone.app.upgrade.v42:to42beta1')
+    pprop = getToolByName(context, 'portal_properties')
+    site_properties = pprop.site_properties
+    if site_properties.hasProperty('allowRolesToAddKeywords'):
+        value = site_properties.getProperty('allowRolesToAddKeywords')
+        if 'Site Administrator' not in value:
+            value = list(value)
+            value.append('Site Administrator')
+            site_properties.allowRolesToAddKeywords = tuple(value)
 
 
 def to42beta1_owner_tuples(context):
diff --git a/plone/app/upgrade/v42/profiles/to_beta1/propertiestool.xml b/plone/app/upgrade/v42/profiles/to_beta1/propertiestool.xml
deleted file mode 100644
index 768c75d..0000000
--- a/plone/app/upgrade/v42/profiles/to_beta1/propertiestool.xml
+++ /dev/null
@@ -1,8 +0,0 @@
-<?xml version="1.0"?>
-<object name="portal_properties" meta_type="Plone Properties Tool">
-  <object name="site_properties" meta_type="Plone Property Sheet">
-    <property name="allowRolesToAddKeywords" type="lines" purge="False">
-      <element value="Site Administrator"/>
-    </property>
-  </object>
-</object>
\ No newline at end of file
diff --git a/plone/app/upgrade/v42/tests.py b/plone/app/upgrade/v42/tests.py
index 0ff501e..e21bccb 100644
--- a/plone/app/upgrade/v42/tests.py
+++ b/plone/app/upgrade/v42/tests.py
@@ -14,6 +14,8 @@ def testProfile(self):
     def testAddSiteAdminToKeywordRoles(self):
         ptool = self.portal.portal_properties
         site_props = ptool.site_properties
+        if not site_props.hasProperty('allowRolesToAddKeywords'):
+            return
         site_props.allowRolesToAddKeywords = ('Manager', 'Reviewer')
         loadMigrationProfile(self.portal, self.profile)
         roles = site_props.allowRolesToAddKeywords
diff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py
index 6f8fbd6..b7b01c2 100644
--- a/plone/app/upgrade/v50/betas.py
+++ b/plone/app/upgrade/v50/betas.py
@@ -1,21 +1,22 @@
 # -*- coding: utf-8 -*-
-import logging
-
+from plone.app.linkintegrity.upgrades import migrate_linkintegrity_relations
+from plone.app.upgrade.utils import loadMigrationProfile
+from plone.registry.interfaces import IRegistry
 from Products.CMFCore.interfaces import ISiteRoot
 from Products.CMFCore.utils import getToolByName
 from Products.CMFPlone.interfaces import ILanguageSchema
 from Products.CMFPlone.interfaces import IMailSchema
 from Products.CMFPlone.interfaces import IMarkupSchema
+from Products.CMFPlone.interfaces import INavigationSchema
 from Products.CMFPlone.interfaces import ISearchSchema
 from Products.CMFPlone.interfaces import ISecuritySchema
 from Products.CMFPlone.interfaces import ISiteSchema
 from Products.CMFPlone.interfaces import IUserGroupsSettingsSchema
 from Products.CMFPlone.interfaces.controlpanel import IImagingSchema
-from plone.app.linkintegrity.upgrades import migrate_linkintegrity_relations
-from plone.app.upgrade.utils import loadMigrationProfile
-from plone.registry.interfaces import IRegistry
+from Products.CMFPlone.utils import safe_unicode
 from zope.component import getUtility
 from zope.component.hooks import getSite
+import logging
 
 
 logger = logging.getLogger('plone.app.upgrade')
@@ -445,6 +446,59 @@ def to50rc2(context):
         site_properties._delProperty('allow_external_login_sites')
 
 
+def upgrade_navigation_controlpanel_settings_2(context):
+    """Copy navigation control panel settings from portal properties into the
+       new registry.
+       only missing values not migrated before
+    """
+    # get the old site properties
+    portal_properties = getToolByName(context, "portal_properties")
+    navigation_properties = portal_properties.navtree_properties
+    # get the new registry
+    registry = getUtility(IRegistry)
+    try:
+        settings = registry.forInterface(
+            INavigationSchema,
+            prefix='plone',
+        )
+    except KeyError:
+        return
+
+    if navigation_properties.hasProperty('idsNotToList'):
+        navigation_properties._delProperty('idsNotToList')
+
+    if navigation_properties.hasProperty('sortAttribute'):
+        settings.sort_tabs_on = navigation_properties.getProperty(
+            'sortAttribute').decode('utf8')
+        navigation_properties._delProperty('sortAttribute')
+
+    order = navigation_properties.getProperty('sortOrder', None)
+    if order is not None:
+        settings.sort_tabs_reversed = order in ['descending', 'reverse']
+        navigation_properties._delProperty('sortOrder')
+
+    root = navigation_properties.getProperty('root', None)
+    if root is not None:
+        settings.root = root.decode('utf8')
+        navigation_properties._delProperty('root')
+
+    if navigation_properties.hasProperty('sitemapDepth'):
+        value = navigation_properties.getProperty('sitemapDepth')
+        registry['plone.sitemap_depth'] = value
+        navigation_properties._delProperty('sitemapDepth')
+
+    properties_to_remove = ['idsNotToList',
+                            'currentFolderOnlyInNavtree',
+                            'includeTop',
+                            'topLevel',
+                            'bottomLevel',
+                            'showAllParents']
+
+    for p in properties_to_remove:
+        if navigation_properties.hasProperty(p):
+            navigation_properties._delProperty(p)
+
+
 def to50rc3(context):
     """5.0rc2 -> 5.0rc3"""
     loadMigrationProfile(context, 'profile-plone.app.upgrade.v50:to50rc3')
@@ -454,20 +508,67 @@ def to50rc3(context):
     site_properties = pprop['site_properties']
     registry = getUtility(IRegistry)
 
-    site_properties_to_remove = ['invalid_ids']
+    if portal.hasProperty('email_charset'):
+        registry['plone.email_charset'] = portal.email_charset
+        portal._delProperty('email_charset')
+
+    site_properties_to_remove = ['invalid_ids', 'ellipsis', 'default_charset']
 
     for p in site_properties_to_remove:
-        if portal.hasProperty(p):
-            portal._delProperty(p)
+        if site_properties.hasProperty(p):
+            site_properties._delProperty(p)
 
     properties_to_migrate = ['external_links_open_new_window',
+                             'mark_special_links',
                              'calendar_starting_year',
-                             'calendar_future_years_available']
+                             'calendar_future_years_available',
+                             'redirect_links',
+                             'enable_checkout_workflow']
     for p in properties_to_migrate:
         if site_properties.hasProperty(p):
             value = site_properties.getProperty(p)
+            if isinstance(value, basestring):
+                if value.lower() == 'true':
+                    value = True
+                elif value.lower() == 'false':
+                    value = False
             try:
                 registry['plone.%s' % p] = value
                 site_properties._delProperty(p)
             except KeyError:
                 logger.warn('could not upgrade %s property' % p)
+
+    if site_properties.hasProperty('checkout_workflow_policy'):
+        value = site_properties.getProperty('checkout_workflow_policy')
+        from plone.app.iterate.interfaces import IIterateSchema
+        settings = registry.forInterface(IIterateSchema)
+        settings.checkout_workflow_policy = safe_unicode(value)
+        site_properties._delProperty('checkout_workflow_policy')
+
+    if site_properties.hasProperty('default_page_types'):
+        value = site_properties.getProperty('default_page_types')
+        registry['plone.default_page_types'] = [safe_unicode(i) for i in value]
+        site_properties._delProperty('default_page_types')
+
+    if site_properties.hasProperty('sitemapDepth'):
+        value = site_properties.getProperty('sitemapDepth')
+        registry['plone.sitemap_depth'] = value
+        site_properties._delProperty('sitemapDepth')
+
+    def _migrate_list(original_id, new_id=None):
+        if new_id is None:
+            new_id = original_id
+        if site_properties.hasProperty(original_id):
+            value = site_properties.getProperty(original_id)
+            value = [safe_unicode(a) for a in value]
+            registry['plone.%s' % new_id] = value
+            site_properties._delProperty(original_id)
+
+    _migrate_list('typesLinkToFolderContentsInFC',
+                  'types_use_view_action_in_listings')
+    _migrate_list('default_page')
+    _migrate_list('parentMetaTypesNotToQuery', 'parent_types_not_to_query')
+    _migrate_list('allowRolesToAddKeywords', 'roles_allowed_to_add_keywords')
+
+    # migrate navtree properties
+    upgrade_navigation_controlpanel_settings_2(context)
diff --git a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
index 3019d95..12af84e 100644
--- a/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
+++ b/plone/app/upgrade/v50/profiles/to_rc3/registry.xml
@@ -1,7 +1,17 @@
 <?xml version="1.0"?>
 <registry>
-    <records prefix="plone.resources/resource-plone-app-discussion-stylesheets"
+  <records interface="Products.CMFPlone.interfaces.ISiteSchema"
+           prefix="plone" />
+  <records interface="Products.CMFPlone.interfaces.ILinkSchema"
+           prefix="plone" />
+  <records interface="Products.CMFPlone.interfaces.INavigationSchema"
+           prefix="plone" />
+  <records interface="Products.CMFPlone.interfaces.ITypesSchema"
+           prefix="plone" />
+  <records interface="plone.app.iterate.interfaces.IIterateSettings"
+           prefix="plone" />
+  <records prefix="plone.resources/resource-plone-app-discussion-stylesheets"
         interface='Products.CMFPlone.interfaces.IResourceRegistry'
         remove="True">
-    </records>
-</registry>
+  </records>
+</registry>
\ No newline at end of file


