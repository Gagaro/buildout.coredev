Repository: Products.CMFPlone
Branch: refs/heads/master
Date: 2015-05-02T01:58:49-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/184805fe7f4d3e7ed6c7cfedd2045dafec3cc12c

fix search form usability closes #432

Files changed:
M CHANGES.rst
M Products/CMFPlone/browser/configure.zcml
M Products/CMFPlone/browser/search.py
M Products/CMFPlone/browser/static/search.js
M Products/CMFPlone/browser/templates/search.pt
D Products/CMFPlone/browser/templates/updated_search.pt

diff --git a/CHANGES.rst b/CHANGES.rst
index 10e6085..5972a09 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -8,6 +8,9 @@ Changelog
 5.0b2 (unreleased)
 ------------------
 
+- fix search form usability
+  [vangheem]
+
 - detect when changes are made to the legacy bundle through the interface
   so resources are re-built when they need to be
   [vangheem]
diff --git a/Products/CMFPlone/browser/configure.zcml b/Products/CMFPlone/browser/configure.zcml
index f9a6413..c60ee11 100644
--- a/Products/CMFPlone/browser/configure.zcml
+++ b/Products/CMFPlone/browser/configure.zcml
@@ -184,14 +184,6 @@
       for="plone.app.layout.navigation.interfaces.INavigationRoot"
       />
 
-  <browser:page
-      name="updated_search"
-      class=".search.Search"
-      permission="zope2.View"
-      for="plone.app.layout.navigation.interfaces.INavigationRoot"
-      template="templates/updated_search.pt"
-      />
-
   <browser:resource
       name="search.js"
       file="static/search.js"
diff --git a/Products/CMFPlone/browser/search.py b/Products/CMFPlone/browser/search.py
index 5551540..f8980b3 100644
--- a/Products/CMFPlone/browser/search.py
+++ b/Products/CMFPlone/browser/search.py
@@ -6,7 +6,6 @@
 from Products.CMFPlone.browser.navtree import getNavigationRoot
 from Products.CMFPlone.PloneBatch import Batch
 from Products.ZCTextIndex.ParseTree import ParseError
-from urllib import quote_plus
 from zope.component import getMultiAdapter
 from zope.i18nmessageid import MessageFactory
 from zope.publisher.browser import BrowserView
@@ -118,6 +117,8 @@ def filter_query(self, query):
         if 'path' not in query:
             query['path'] = getNavigationRoot(self.context)
 
+        if 'sort_order' in query and not query['sort_order']:
+            del query['sort_order']
         return query
 
     def filter_types(self, types):
@@ -240,9 +241,4 @@ def url(self):
             q['sort_order'] = 'reverse'
 
         base_url = self.request.URL
-        # After the AJAX call the request is changed and thus the URL part of
-        # it as well. In this case we need to tweak the URL to point to have
-        # correct URLs
-        if '@@updated_search' in base_url:
-            base_url = base_url.replace('@@updated_search', '@@search')
         return base_url + '?' + make_query(q)
diff --git a/Products/CMFPlone/browser/static/search.js b/Products/CMFPlone/browser/static/search.js
index d38e4a4..5608631 100644
--- a/Products/CMFPlone/browser/static/search.js
+++ b/Products/CMFPlone/browser/static/search.js
@@ -1,5 +1,6 @@
 /* The following line defines global variables defined elsewhere. */
-/*globals jQuery, portal_url, alert, history, window, location, require*/
+/*globals require*/
+
 
 if(require === undefined){
   require = function(reqs, torun){
@@ -9,198 +10,112 @@ if(require === undefined){
 }
 
 require([
-  'jquery'
+  'jquery',
 ], function($) {
   'use strict';
 
-    var query, pushState, popped, initialURL,
-        $default_res_container = $('#search-results'),
-        $search_filter = $('#search-filter'),
-        $search_field = $('#search-field'),
-        $search_gadget =  $('#searchGadget'),
-        $form_search_page = $("form.searchPage"),
-        navigation_root_url = $('body').attr('data-portal-url');
-
-    // The globally available method to pull the search results for the
-    // 'query' into the element, on which the method is invoked
-    $.fn.pullSearchResults = function (query) {
-        return this.each(function () {
-            var $container = $(this);
-            $.get(
-                '@@updated_search',
-                query,
-                function (data) {
-                    $container.hide();
-                    var $ajax_search_res = $('<div id="ajax-search-res"></div>').html(data),
-                        $search_term = $('#search-term');
-
-                    var $data_res = $ajax_search_res.find('#search-results').children(),
-                        data_search_term = $ajax_search_res.find('#updated-search-term').text(),
-                        data_res_number = $ajax_search_res.find('#updated-search-results-number').text(),
-                        data_sorting_opt = $ajax_search_res.find('#updated-sorting-options').html(),
-                        new_header = $ajax_search_res.find('#update-search-header');
-
-                    $container.html($data_res);
-                    $container.fadeIn();
-
-                    if (!$search_term.length) {
-                        // Until now we had queries with empty search term.
-                        // we need to fetch the new header, with proper translations
-                        if(new_header.length){
-                            $('h1.documentFirstHeading').html(new_header.html());
-                        }
-                    } else {
-                        $search_term.text(data_search_term);
-                    }
-
-                    $('#search-results-number').text(data_res_number);
-                    $('#search-results-bar').find('#sorting-options').html(data_sorting_opt);
-
-                    $('#rss-subscription').find('a.link-feed').attr('href', function () {
-                        return navigation_root_url + '/search_rss?' + query;
-                    });
-                });
-        });
-    };
-
-    pushState = function (query) {
-        // Now we need to update the browser's path bar to reflect
-        // the URL we are at now and to push a history state change
-        // in the browser's history. 
-        // API natively or it needs a polyfill, that provides
-        // hash-change events to the older browser
-        if (window.history && window.history.pushState){
-            var url = navigation_root_url + '/@@search?' + query;
-            history.pushState(null, null, url);
-        }
-    };
-
-    // THE HANDLER FOR 'POPSTATE' EVENT IS COPIED FROM PJAX.JS
-    // https://github.com/defunkt/jquery-pjax
-
-    // Used to detect initial (useless) popstate.
-    // If history.state exists, assume browser isn't going to fire initial popstate.
-    popped = (window.history && 'state' in window.history);
-    initialURL = location.href;
-
-
-    // popstate handler takes care of the back and forward buttons
-    //
-    $(window).bind('popstate', function (event) {
-        var initialPop, str;
-        // Ignore initial popstate that some browsers fire on page load
-        initialPop = !popped && location.href === initialURL;
-        popped = true;
-        if (initialPop) {
-            return;
-        }
-
-        if (!location.search){
-            return;
-        }
-
-        query = location.search.split('?')[1];
-        // We need to make sure we update the search field with the search
-        // term from previous query when going back in history
-        var results = query.match(/SearchableText=[^&]*/);
-        if (results){ // not all pages have results
-            str = results[0];
-            str = decodeURIComponent(str.replace(/\+/g, ' ')); // we remove '+' used between words
-            // in search queries.
-
-        // Now we have something like 'SearchableText=test' in str
-        // variable. So, we know when the actual search term begins at
-        // position 15 in that string.
-        $.merge($search_field.find('input[name="SearchableText"]'), $search_gadget).val(str.substr(15, str.length));
-
-            $default_res_container.pullSearchResults(query);
-        }
-
-    });
-
-    $search_filter.find('input.searchPage[type="submit"]').hide();
-
-    // We don't submit the whole form with all the fields when only the
-    // search term is being changed. We just alter the current URL to
-    // substitute the search term and make a new ajax call to get updated
-    // results
-    $search_field.find('input.searchButton').click(function (e) {
-        var st, queryString = location.search.substring(1),
-            re = /([^&=]+)=([^&]*)/g, m, queryParameters = [], key;
-        st = $search_field.find('input[name="SearchableText"]').val();
-        queryParameters.push({"name":"SearchableText", "value": st});
-
-        // parse query string into array of hash
-        while (m = re.exec(queryString)) {
-            key = decodeURIComponent(m[1]);
-            if (key !== 'SearchableText') {
-                // we remove '+' used between words
-                queryParameters.push({"name": key, "value": decodeURIComponent(m[2].replace(/\+/g, ' '))});
-            }
-        }
-        queryString = $.param(queryParameters);
-        $default_res_container.pullSearchResults(queryString);
-        pushState(queryString);
-        e.preventDefault();
-    });
-    $form_search_page.submit(function (e) {
-        query = $(this).serialize();
-        $default_res_container.pullSearchResults(query);
-        pushState(query);
-        e.preventDefault();
-    });
-
-    // We need to update the site-wide search field (at the top right in
-    // stock Plone) when the main search field is updated
-    $search_field.find('input[name="SearchableText"]').keyup(function () {
-        $search_gadget.val($(this).val());
+  var $loader = $('.plone-modal-loading');
+  if($loader.size() === 0){
+    $loader = $('<div class="plone-loader"><div class="loader"/></div>');
+    $('body').append($loader);
+  }
+
+  var $filter = $('.actionMenu');
+  var $filterBtn = $('#search-filter-toggle', $filter);
+  var $advSearchInput = $('#advanced-search-input');
+  var $ctSelectAll = $('#pt_toggle');
+  var $selectAllContainer = $('.search-type-options');
+  var $sortingContainer = $('#sorting-options');
+
+
+  /* handle history */
+  if (window.history && window.history.pushState){
+    $(window).bind('popstate', function () {
+      /* we're just going to cheat and reload the page so
+         we aren't keep moving around state here.. 
+         Here, I'm lazy, we're not using react here... */
+      window.location = window.location.href;
     });
+  }
 
-    // When we click any option in the Filter menu, we need to prevent the
-    // menu from being closed as it is dictated by dropdown.js for all
-    // dl.actionMenu > dd.actionMenuContent
-    $('#search-results-bar').find('dl.actionMenu > dd.actionMenuContent').click(function (e) {
-        e.stopImmediatePropagation();
-    });
+  var pushHistory = function(){
+    if(window.history && window.history.pushState){
+      var url = window.location.origin + window.location.pathname + '?' + $('#searchform').serialize();
+      window.history.pushState(null, null, url);
+    }
+  };
 
-    // Now we can handle the actual menu options and update the search
-    // results after any of them has been chosen.
-    $search_filter.delegate('input, select', 'change',
-        function (e) {
-            query = '';
-            // only fill query when there is at least one type selected
-            // by default we have a checked date radio input button
-            if ($search_filter.find('input:checked').length > 1) {
-                query = $form_search_page.serialize();
-            }
-            $default_res_container.pullSearchResults(query);
-            pushState(query);
-        }
-    );
-
-    // Since we replace the whole sorting options with HTML, coming in
-    // AJAX response, we should bind the click event with delegate() in order
-    // for this to keep working with the HTML elements, coming from AJAX
-    // response
-    $('#sorting-options').delegate('a', 'click', function (e) {
-        if ($(this).attr('data-sort')) {
-            $form_search_page.find("input[name='sort_on']").val($(this).attr('data-sort'));
-        }
-        else {
-            $form_search_page.find("input[name='sort_on']").val('');
-        }
-        query = this.search.split('?')[1];
-        $default_res_container.pullSearchResults(query);
-        pushState(query);
-        e.preventDefault();
+  var timeout = 0;
+  var search = function(){
+    $loader.show();
+    pushHistory();
+    $.ajax({
+      url: window.location.origin + window.location.pathname,
+      data: $('#searchform').serialize()
+    }).done(function(html){
+      var $html = $(html);
+      $('#search-results').replaceWith($('#search-results', $html));
+      $('#search-term').replaceWith($('#search-term', $html));
+      $('#results-count').replaceWith($('#results-count', $html));
+      $loader.hide();
     });
+  };
+  var searchDelayed = function(){
+    clearTimeout(timeout);
+    timeout = setTimeout(search, 200);
+  };
 
-    // Handle clicks in the batch navigation bar. Load those with Ajax as
-    // well.
-    $default_res_container.delegate('.listingBar a', 'click', function (e) {
-        query = this.search.split('?')[1];
-        $default_res_container.pullSearchResults(query);
-        pushState(query);
-        e.preventDefault();
-    });
+  /* sorting */
+  $('a', $sortingContainer).click(function(e){
+    e.preventDefault();
+    $('a', $sortingContainer).removeClass('active');
+    $(this).addClass('active');
+    var sort = $(this).attr('data-sort');
+    var order = $(this).attr('data-order');
+    if(sort){
+      $('[name="sort_on"]').attr('value', sort);
+      if(order && order == 'reverse'){
+        $('[name="sort_order"]').attr('value', 'reverse');
+      }
+    }else{
+      $('[name="sort_on"]').attr('value', '');
+      $('[name="sort_order"]').attr('value', '');
+    }
+    search();
+  });
+
+
+  /* form submission */
+  $('.searchPage').submit(function(e){
+    e.preventDefault();
+    search();
+  });
+
+
+  /* filters */
+  $filterBtn.click(function(e){
+    e.preventDefault();
+    $filter.toggleClass('activated');
+    if($filter.hasClass('activated')){
+      $advSearchInput.attr('value', 'True');
+    }else{
+      $advSearchInput.attr('value', 'False');
+    }
+  });
+
+  $ctSelectAll.change(function(){
+    if($ctSelectAll[0].checked){
+      $('input', $selectAllContainer).each(function(){
+        this.checked = true;
+      });
+    }else{
+      $('input', $selectAllContainer).each(function(){
+        this.checked = false;
+      });
+    }
+  });
+
+  $('input', $filter).change(function(){
+    searchDelayed();
+  });
 });
diff --git a/Products/CMFPlone/browser/templates/search.pt b/Products/CMFPlone/browser/templates/search.pt
index 9212096..c820d1f 100644
--- a/Products/CMFPlone/browser/templates/search.pt
+++ b/Products/CMFPlone/browser/templates/search.pt
@@ -39,6 +39,7 @@
 
         <input type="hidden" name="advanced_search" value="False" />
         <input type="hidden" name="sort_on" value="" />
+        <input type="hidden" name="sort_order" value="" />
 
         <div class="input-group">
           <input class="searchPage form-control"
@@ -56,37 +57,126 @@
           </span>
         </div>
 
-        <div>
-
-            <div>
-                <h1 class="documentFirstHeading"
-                    i18n:translate=""
-                    tal:condition="not:st">
-                    Search results
-                </h1>
-                <h1 class="documentFirstHeading"
-                    i18n:translate=""
-                    tal:condition="st">
-                    Search results for
-                    <strong id="search-term" tal:content="st" i18n:name="term">
-                        Search Term
-                    </strong>
-                </h1>
+        <dl class="actionMenu"
+            tal:attributes="class python:view.show_advanced_search() and 'actionMenu activated' or 'actionMenu'">
+
+          <dt class="actionMenuHeader">
+            <input type="hidden" id="advanced-search-input" name="advanced_search"
+                   tal:attributes="value python: view.show_advanced_search() and 'True' or 'False'" />
+            <button
+                 id="search-filter-toggle"
+                 i18n:translate="narrow_search_options">
+                  Filter the results
+            </button>
+          </dt>
+          <dd class="actionMenuContent">
+            <div id="search-filter" i18n:domain="plone">
+              <fieldset class="noborder">
+                <legend i18n:translate="label_item_type">Item type</legend>
+                  <div class="field"
+                       tal:define="portal_types portal/portal_types;
+                                   types_list view/types_list;
+                                   all_checked python:(len(types_list) == len(request.get('portal_type', []))) or first_call;
+                                   toggle_select_state python:all_checked and 'true' or 'false';">
+                    <div class="optionsToggle">
+                      <input type="checkbox" onchange="" name="pt_toggle" value="#" id="pt_toggle" class="noborder" checked="checked"
+                             tal:attributes="checked python:all_checked and 'checked' or '';" />
+
+                      <label for="pt_toggle"
+                             i18n:translate="label_toggle">Select All/None</label>
+                    </div>
+                    <div class="search-type-options">
+                      <tal:div tal:define="typeLists python:context.createMultiColumnList(types_list, numCols=2, sort_on='self');"
+                               tal:repeat="sublist typeLists">
+                        <tal:items repeat="type sublist">
+                          <div>
+                            <input type="checkbox" name="portal_type:list" value="#" class="noborder" checked="checked"
+                                   tal:attributes="value type;
+                                                   id string:portal_type_${repeat/sublist/number}_${repeat/type/number};
+                                                   checked python:((type in request.get('portal_type', [])) or first_call) and 'checked' or ''"/>
+                              <label for="" i18n:translate=""
+                                     tal:attributes="for string:portal_type_${repeat/sublist/number}_${repeat/type/number}"
+                                     tal:content="python: portal_types.getTypeInfo(type).Title()" />
+                          </div>
+                        </tal:items>
+                      </tal:div>
+                    </div>
+                  </div>
+                </fieldset>
+                <fieldset class="noborder">
+                  <legend i18n:translate="label_new_items_since">New items since</legend>
+                  <div class="field">
+                    <div class="search-date-options">
+                      <tal:datetime define="today python:DateTime().earliestTime();
+                                            yesterday python:(today-1).Date();
+                                            lastweek python:(today-7).Date();
+                                            lastmonth python:(today-31).Date();
+                                            ever string:1970-01-02;
+                                            checked python:request.get('created', []);
+                                            checked python:(len(checked) == 1) and checked[0] or ever">
+                        <div>
+                          <input type="radio" id="query-date-yesterday" name="created.query:record:list:date"
+                                 tal:attributes="value yesterday;
+                                                 checked python:checked==yesterday and 'checked' or '';" />
+                          <label for="query-date-yesterday" i18n:translate="time_yesterday">Yesterday</label>
+                        </div>
+                        <div>
+                          <input type="radio" id="query-date-lastweek" name="created.query:record:list:date"
+                                 tal:attributes="value lastweek;
+                                                 checked python:checked==lastweek and 'checked' or '';" />
+                          <label for="query-date-lastweek" i18n:translate="time_last_week">Last week</label>
+                        </div>
+                        <div>
+                          <input type="radio" id="query-date-lastmonth" name="created.query:record:list:date"
+                                 tal:attributes="value lastmonth;
+                                                 checked python:checked==lastmonth and 'checked' or '';" />
+                          <label for="query-date-lastmonth" i18n:translate="time_last_month">Last month</label>
+                        </div>
+                        <div>
+                          <input type="radio" id="query-date-ever" name="created.query:record:list:date"
+                                 tal:attributes="value ever;
+                                                 checked python:checked==ever and 'checked' or '';" />
+                          <label for="query-date-ever" i18n:translate="time_ever">Ever</label>
+                        </div>
+                      </tal:datetime>
+                    </div>
+                    <input type="hidden" name="created.range:record" value="min" />
+                  </div>
+                </fieldset>
+              </div>
+            </dd>
+          </dl>
 
-                <p id="rss-subscription" i18n:domain="plone"
-                   tal:define="syndication context/@@tools/syndication|nothing"
-                   tal:condition="syndication/isSiteSyndicationAllowed|nothing">
-                      <img src="" alt="RSS"
-                           tal:attributes="src string:${portal_url}/rss.gif"/>
-                    <a href=""
-                       class="link-feed"
-                       tal:define="here_url context/@@plone_context_state/object_url"
-                       tal:attributes="href string:$here_url/search_rss?${request/QUERY_STRING}">
-                        <span i18n:translate="title_subscribe_rss_feed">
-                          Subscribe to an always-updated RSS feed.
-                        </span>
-                    </a>
-                </p>
+        <div>
+          <div>
+            <h1 class="documentFirstHeading"
+                i18n:translate=""
+                tal:condition="not:st">
+              Search results
+            </h1>
+            <h1 class="documentFirstHeading"
+                i18n:translate=""
+                tal:condition="st">
+              Search results for
+              <strong id="search-term" tal:content="st" i18n:name="term">
+                Search Term
+              </strong>
+            </h1>
+
+            <p id="rss-subscription" i18n:domain="plone"
+               tal:define="syndication context/@@tools/syndication|nothing"
+               tal:condition="syndication/isSiteSyndicationAllowed|nothing">
+               <img src="" alt="RSS"
+                    tal:attributes="src string:${portal_url}/rss.gif"/>
+                <a href=""
+                   class="link-feed"
+                   tal:define="here_url context/@@plone_context_state/object_url"
+                   tal:attributes="href string:$here_url/search_rss?${request/QUERY_STRING}">
+                    <span i18n:translate="title_subscribe_rss_feed">
+                      Subscribe to an always-updated RSS feed.
+                    </span>
+                </a>
+              </p>
             </div>
             <div class="visualClear"><!-- --></div>
             <div id="search-results-wrapper"
@@ -95,294 +185,138 @@
                              batch python: view.results(b_start=b_start);
                              normalizeString nocall:context/@@plone/normalizeString;">
 
-                <div id="search-results-bar">
-                    <span i18n:translate="batch_x_items_matching_your_criteria" i18n:domain="plone">
-                        <strong i18n:name="number" id="search-results-number"
-                                tal:content="batch/sequence_length|string:0">234</strong>
-                        items matching your search terms.
-                    </span>
-
-                    <dl class="actionMenu deactivated"
-                        tal:attributes="class python:view.show_advanced_search() and 'actionMenu activated' or 'actionMenu deactivated'">
-
-                      <dt class="actionMenuHeader">
-                          <a href="#"
-                             tal:attributes="href view/advanced_search_trigger"
-                             id="search-filter-toggle"
-                             i18n:translate="narrow_search_options">
-                              Filter the results.
-                          </a>
-                      </dt>
-                      <dd class="actionMenuContent">
-                          <div id="search-filter" i18n:domain="plone">
-
-                              <fieldset class="noborder">
-
-                                  <legend i18n:translate="label_item_type">Item type</legend>
-
-                                  <div class="field"
-                                       tal:define="portal_types portal/portal_types;
-                                                   types_list view/types_list;
-                                                   all_checked python:(len(types_list) == len(request.get('portal_type', []))) or first_call;
-                                                   toggle_select_state python:all_checked and 'true' or 'false';">
-
-                                      <div class="formHelp"></div>
-
-                                      <div class="optionsToggle">
-                                          <input type="checkbox"
-                                                 onchange=""
-                                                 name="pt_toggle"
-                                                 value="#"
-                                                 id="pt_toggle"
-                                                 class="noborder"
-                                                 checked="checked"
-                                                 tal:attributes="checked python:all_checked and 'checked' or '';
-                                                                 onchange string:javascript:toggleSelect(this, 'portal_type:list', ${toggle_select_state});"/>
-
-                                          <label for="pt_toggle"
-                                                 i18n:translate="label_toggle"
-                                                 >Select All/None
-                                          </label>
-                                      </div>
-                                      <div class="search-type-options">
-                                        <tal:div
-                                           tal:define="typeLists python:context.createMultiColumnList(types_list, numCols=2, sort_on='self');"
-
-                                           tal:repeat="sublist typeLists">
-                                          <tal:items repeat="type sublist">
-                                            <div>
-                                              <input type="checkbox"
-                                                     name="portal_type:list"
-                                                     value="#"
-                                                     class="noborder"
-                                                     checked="checked"
-                                                     tal:attributes="value type;
-                                                                     id string:portal_type_${repeat/sublist/number}_${repeat/type/number};
-                                                                     checked python:((type in request.get('portal_type', [])) or first_call) and 'checked' or ''"/>
-                                              <label for=""
-                                                     i18n:translate=""
-                                                     tal:attributes="for string:portal_type_${repeat/sublist/number}_${repeat/type/number}"
-                                                     tal:content="python: portal_types.getTypeInfo(type).Title()"
-                                                     />
-                                            </div>
-                                          </tal:items>
-                                        </tal:div>
-                                      </div>
-                                  </div>
-                              </fieldset>
-
-                              <fieldset class="noborder">
-
-                                  <legend i18n:translate="label_new_items_since">New items since</legend>
-
-                                  <div class="field">
-
-                                      <div class="formHelp"></div>
-                                      <div class="search-date-options">
-                                      <tal:datetime define="today python:DateTime().earliestTime();
-                                                            yesterday python:(today-1).Date();
-                                                            lastweek python:(today-7).Date();
-                                                            lastmonth python:(today-31).Date();
-                                                            ever string:1970-01-02;
-                                                            checked python:request.get('created', []);
-                                                            checked python:(len(checked) == 1) and checked[0] or ever">
-                                          <div>
-                                            <input type="radio"
-                                                   id="query-date-yesterday"
-                                                   name="created.query:record:list:date"
-                                                   tal:attributes="value yesterday;
-                                                                   checked python:checked==yesterday and 'checked' or '';"
-                                                   />
-                                            <label for="query-date-yesterday" i18n:translate="time_yesterday">Yesterday</label>
-                                          </div>
-                                          <div>
-                                            <input type="radio"
-                                                   id="query-date-lastweek"
-                                                   name="created.query:record:list:date"
-                                                   tal:attributes="value lastweek;
-                                                                   checked python:checked==lastweek and 'checked' or '';"
-                                                   />
-                                            <label for="query-date-lastweek" i18n:translate="time_last_week">Last week</label>
-                                          </div>
-                                          <div>
-                                            <input type="radio"
-                                                   id="query-date-lastmonth"
-                                                   name="created.query:record:list:date"
-                                                   tal:attributes="value lastmonth;
-                                                                   checked python:checked==lastmonth and 'checked' or '';"
-                                                   />
-                                            <label for="query-date-lastmonth" i18n:translate="time_last_month">Last month</label>
-                                          </div>
-                                          <div>
-                                            <input type="radio"
-                                                   id="query-date-ever"
-                                                   name="created.query:record:list:date"
-                                                   tal:attributes="value ever;
-                                                                   checked python:checked==ever and 'checked' or '';"
-                                                   />
-                                            <label for="query-date-ever" i18n:translate="time_ever">Ever</label>
-                                          </div>
-                                      </tal:datetime>
-                                      </div>
-                                      <input type="hidden" name="created.range:record" value="min" />
-                                  </div>
-
-                                  <div class="formControls">
-                                      <input class="searchPage searchButton allowMultiSubmit"
-                                             type="submit"
-                                             value="Search"
-                                             i18n:attributes="value label_search;"/>
-                                  </div>
-                              </fieldset>
-
-                          </div>
-                      </dd>
-
-                    </dl>
-
-
-                </div>
+              <div id="search-results-bar">
+                <span i18n:translate="batch_x_items_matching_your_criteria" i18n:domain="plone" id="results-count">
+                  <strong i18n:name="number" id="search-results-number"
+                          tal:content="batch/sequence_length|string:0">234</strong>
+                    items matching your search terms.
+                  </span>
 
+                  
 
                 <metal:searchresults define-macro="search_results">
                 <div class="autotabs">
-                    <nav class="autotoc-nav" id="searchResultsSort">
-                      <span i18n:translate="sort_by" class="autotab-heading">Sort by</span>
-                          <span id="sorting-options">
-                              <metal:sorting define-macro="sorting">
-                                  <tal:block repeat="item view/sort_options">
-                                      <tal:item define="selected item/selected">
-                                      <a data-sort=""
-                                         tal:condition="not:selected"
-                                         tal:content="item/title"
-                                         tal:attributes="href item/url;
-                                                         data-sort python:item.sortkey and item.sortkey or None"></a>
-                                      <a tal:condition="selected" tal:content="item/title" class="active" aria-disabled="true"></a>
-                                      </tal:item>
-                                  </tal:block>
-                              </metal:sorting>
-                          </span>
+                  <nav class="autotoc-nav" id="searchResultsSort">
+                    <span i18n:translate="sort_by" class="autotab-heading">Sort by</span>
+                      <span id="sorting-options">
+                        <metal:sorting define-macro="sorting">
+                          <tal:block repeat="item view/sort_options">
+                            <a data-sort="" tal:content="item/title"
+                               tal:attributes="href item/url;
+                                               data-sort python:item.sortkey and item.sortkey or None;
+                                               data-order python: item.reverse and 'reverse' or '';
+                                               class python: item.selected and 'active' or ''"></a>
+                          </tal:block>
+                        </metal:sorting>
+                      </span>
                     </nav>
                     <div id="search-results"
                          tal:define="navigation_root_url context/@@plone_portal_state/navigation_root_url;">
 
-                        <metal:noresults tal:condition="not: batch">
-                          <p i18n:domain="plone"><strong i18n:translate="description_no_results_found">No results were found.</strong></p>
-                        </metal:noresults>
-
-                        <metal:results tal:condition="batch"
-                                       tal:define="isAnon context/@@plone_portal_state/anonymous;
-                                                   toLocalizedTime nocall: context/@@plone/toLocalizedTime;
-                                                   site_properties context/portal_properties/site_properties;
-                                                   use_view_action site_properties/typesUseViewActionInListings|python:();
-                                                   allowAnonymousViewAbout python:context.portal_registry['plone.allow_anon_views_about'];
-                                                   show_about python:not isAnon or allowAnonymousViewAbout;">
-                          <ol class="searchResults">
-                              <tal:results repeat="item batch">
-                                    <li>
-                                      <span tal:attributes="class item/ContentTypeClass">
-                                        <img tal:replace="structure item/getIcon" />
-                                        <a href="#"
-                                           tal:define="item_url item/getURL;
-                                                       item_type item/PortalType"
-                                           tal:attributes="href python:item_type in use_view_action and (item_url + '/view') or item_url;
-                                                           class string:state-${item/review_state}"
-                                           tal:content="python:item.getDataOrigin().pretty_title_or_id()" />
-                                      </span>
-                                      <span class="discreet" i18n:domain="plone"
-                                        tal:condition="show_about">
-                                        <span class="documentAuthor"
-                                            i18n:translate="label_by_author">
-                                        by
-                                            <tal:block tal:condition="item/Creator"
-                                                tal:define="author python:context.portal_membership.getMemberInfo(item.Creator())">
-                                              <a href="#"
-                                                 tal:attributes="href string:$navigation_root_url/author/${item/Creator}"
-                                                 tal:content="python:author and author['fullname'] or item.Creator()"
-                                                 tal:omit-tag="not:item/Creator"
-                                                 i18n:name="author">
-                                                Bob Dobalina
-                                              </a>
-                                            </tal:block>
-                                        </span>
-
-                                        <span tal:define="publication_date item/EffectiveDate;
-                                                          modification_date item/ModificationDate">
-
-                                            <span class="documentPublished" tal:condition="python: publication_date != 'None'">
-                                              &mdash;
-                                              <span i18n:translate="box_published">
-                                                published
-                                              </span>
-                                              <span tal:replace="python:toLocalizedTime(publication_date, long_format=0)">
-                                                August 16, 2001 at 23:35:59
-                                              </span>
-                                            </span>
-
-                                            <span class="documentModified" tal:condition="python: modification_date != publication_date">
-                                              &mdash;
-                                              <span i18n:translate="box_last_modified">
-                                                last modified
-                                              </span>
-                                              <span tal:replace="python:toLocalizedTime(modification_date, long_format=1)">
-                                                August 16, 2001 at 23:35:59
-                                              </span>
-                                            </span>
-
-                                        </span>
-
-                                        <span tal:define="categories item/Subject|nothing"
-                                              tal:condition="categories">
-                                          &mdash;
-                                          <tal:filedunder i18n:translate="">filed under:</tal:filedunder>
-                                          <span tal:repeat="category categories">
-                                            <a href=""
-                                               class="link-category"
-                                               rel="tag"
-                                               tal:content="category"
-                                               tal:attributes="href string:$navigation_root_url/@@search?Subject%3Alist=${category}">
-                                              Category
-                                            </a><tal:separator condition="not: repeat/category/end">,</tal:separator>
-                                          </span>
-                                        </span>
-                                      </span>
-                                      <p class="discreet croppedDescription"
-                                            tal:condition="item/CroppedDescription" tal:content="item/CroppedDescription">
-                                        Cropped description
-                                      </p>
-
-                                      <cite class="documentLocation link-location"
-                                            tal:define="breadcrumbs python: view.breadcrumbs(item);
-                                                        is_rtl context/@@plone_portal_state/is_rtl;"
-                                            tal:condition='breadcrumbs'>
-                                          <span i18n:translate="text_searchitem_location">
-                                              Located in
-                                          </span>
-                                          <span tal:repeat="crumb breadcrumbs"
-                                                tal:attributes="dir python:is_rtl and 'rtl' or 'ltr';">
-                                              <tal:item tal:define="is_last repeat/crumb/end;
-                                                                    url crumb/absolute_url;
-                                                                    title crumb/Title">
-                                                  <a href="#"
-                                                     tal:omit-tag="not: url"
-                                                     tal:attributes="href url"
-                                                     tal:content="title">
-                                                      crumb
-                                                  </a>
-                                                  <span class="breadcrumbSeparator" tal:condition="not: is_last">
-                                                      <tal:ltr condition="not: is_rtl">/</tal:ltr>
-                                                      <tal:rtl condition="is_rtl">/</tal:rtl>
-                                                  </span>
-                                               </tal:item>
-                                          </span>
-
-                                      </cite>
-
-                                    </li>
-                              </tal:results>
-                          </ol>
-                          <div metal:use-macro="context/batch_macros/macros/navigation" />
-                        </metal:results>
+                      <metal:noresults tal:condition="not: batch">
+                        <p i18n:domain="plone"><strong i18n:translate="description_no_results_found">No results were found.</strong></p>
+                      </metal:noresults>
+
+                      <metal:results tal:condition="batch"
+                                     tal:define="isAnon context/@@plone_portal_state/anonymous;
+                                                 toLocalizedTime nocall: context/@@plone/toLocalizedTime;
+                                                 site_properties context/portal_properties/site_properties;
+                                                 use_view_action site_properties/typesUseViewActionInListings|python:();
+                                                 allowAnonymousViewAbout python:context.portal_registry['plone.allow_anon_views_about'];
+                                                 show_about python:not isAnon or allowAnonymousViewAbout;">
+                        <ol class="searchResults">
+                          <tal:results repeat="item batch">
+                            <li>
+                              <span>
+                                <img tal:replace="structure item/getIcon" />
+                                <a href="#"
+                                   tal:define="item_url item/getURL;
+                                               item_type item/PortalType"
+                                   tal:attributes="href python:item_type in use_view_action and (item_url + '/view') or item_url;
+                                                   class string:state-${item/review_state}"
+                                   tal:content="python:item.getDataOrigin().pretty_title_or_id()" />
+                              </span>
+                              <span class="discreet" i18n:domain="plone"
+                                    tal:condition="show_about">
+                                <span class="documentAuthor"
+                                      i18n:translate="label_by_author">
+                                  by
+                                  <tal:block tal:condition="item/Creator"
+                                             tal:define="author python:context.portal_membership.getMemberInfo(item.Creator())">
+                                    <a href="#"
+                                       tal:attributes="href string:$navigation_root_url/author/${item/Creator}"
+                                       tal:content="python:author and author['fullname'] or item.Creator()"
+                                       tal:omit-tag="not:item/Creator"
+                                       i18n:name="author">
+                                        Bob Dobalina
+                                    </a>
+                                  </tal:block>
+                                </span>
+                                <span tal:define="publication_date item/EffectiveDate;
+                                                  modification_date item/ModificationDate">
+
+                                  <span class="documentPublished" tal:condition="python: publication_date != 'None'">
+                                    &mdash;
+                                    <span i18n:translate="box_published">
+                                      published
+                                    </span>
+                                    <span tal:replace="python:toLocalizedTime(publication_date, long_format=0)">
+                                      August 16, 2001 at 23:35:59
+                                    </span>
+                                  </span>
+
+                                  <span class="documentModified" tal:condition="python: modification_date != publication_date">
+                                    &mdash;
+                                    <span i18n:translate="box_last_modified">
+                                      last modified
+                                    </span>
+                                    <span tal:replace="python:toLocalizedTime(modification_date, long_format=1)">
+                                      August 16, 2001 at 23:35:59
+                                    </span>
+                                  </span>
+                                </span>
+                                <span tal:define="categories item/Subject|nothing"
+                                      tal:condition="categories">
+                                  &mdash;
+                                  <tal:filedunder i18n:translate="">filed under:</tal:filedunder>
+                                  <span tal:repeat="category categories">
+                                    <a href="" class="link-category" rel="tag" tal:content="category"
+                                       tal:attributes="href string:$navigation_root_url/@@search?Subject%3Alist=${category}">
+                                      Category
+                                    </a><tal:separator condition="not: repeat/category/end">,</tal:separator>
+                                  </span>
+                                </span>
+                              </span>
+                              <p class="discreet croppedDescription"
+                                 tal:condition="item/CroppedDescription" tal:content="item/CroppedDescription">
+                                Cropped description
+                              </p>
+
+                              <cite class="documentLocation link-location"
+                                    tal:define="breadcrumbs python: view.breadcrumbs(item);
+                                                is_rtl context/@@plone_portal_state/is_rtl;"
+                                    tal:condition='breadcrumbs'>
+                                <span i18n:translate="text_searchitem_location">
+                                  Located in
+                                </span>
+                                <span tal:repeat="crumb breadcrumbs"
+                                      tal:attributes="dir python:is_rtl and 'rtl' or 'ltr';">
+                                  <tal:item tal:define="is_last repeat/crumb/end;
+                                                        url crumb/absolute_url;
+                                                        title crumb/Title">
+                                    <a href="#" tal:omit-tag="not: url" tal:attributes="href url" tal:content="title">crumb</a>
+                                    <span class="breadcrumbSeparator" tal:condition="not: is_last">
+                                      <tal:ltr condition="not: is_rtl">/</tal:ltr>
+                                      <tal:rtl condition="is_rtl">/</tal:rtl>
+                                    </span>
+                                  </tal:item>
+                                </span>
+                              </cite>
+                            </li>
+                          </tal:results>
+                        </ol>
+                        <div metal:use-macro="context/batch_macros/macros/navigation" />
+                      </metal:results>
                     </div>
                   </div>
                 </metal:searchresults>
diff --git a/Products/CMFPlone/browser/templates/updated_search.pt b/Products/CMFPlone/browser/templates/updated_search.pt
deleted file mode 100644
index 6cbb2f6..0000000
--- a/Products/CMFPlone/browser/templates/updated_search.pt
+++ /dev/null
@@ -1,32 +0,0 @@
-<html xmlns:tal="http://xml.zope.org/namespaces/tal"
-      xmlns:metal="http://xml.zope.org/namespaces/metal"
-      xmlns:i18n="http://xml.zope.org/namespaces/i18n">
-<body i18n:domain="plone"
-      tal:define="b_start python:0;
-                  b_start request/b_start | b_start;
-                  batch python:view.results(b_start=b_start);
-                  st python:request.get('SearchableText', '');
-                  here_url context/@@plone_context_state/object_url;
-                  batch_base_url string:${here_url}/@@search;
-                  ">
-    <h1 id='update-search-header' class="documentFirstHeading"
-        i18n:translate=""
-        tal:condition="st">
-        Search results for
-        <strong id="search-term" tal:content="st" i18n:name="term">
-            Search Term
-        </strong>
-    </h1>
-    <span id="updated-search-term" tal:content="st">Search Term</span>
-
-    <strong id="updated-search-results-number"
-            tal:content="batch/sequence_length|string:0">234</strong>
-
-    <span id="updated-sorting-options">
-        <metal:results use-macro="context/@@search/sorting" />
-    </span>
-
-    <metal:results use-macro="context/@@search/search_results" />
-
-</body>
-</html>


