Repository: Products.CMFEditions


Branch: refs/heads/master
Date: 2015-09-23T13:05:21+02:00
Author: Nejc Zupan (zupo) <nejc.zupan@gmail.com>
Commit: https://github.com/plone/Products.CMFEditions/commit/d8d123c6b03fe45e819b7a8f2c033bcfd0ea1030

Input sanitation for retrieveSubstitute()

Under some conditions, like when calculating summary of histories on old sites
with lots of stale/broken objects, the selector is None and the
retrieveSubstitute() breaks when casting None to int. This fixes this by
setting selector to 0 if selector parameter is None.

Files changed:
M Products/CMFEditions/KeepLastNVersionsTool.py

diff --git a/Products/CMFEditions/KeepLastNVersionsTool.py b/Products/CMFEditions/KeepLastNVersionsTool.py
index c586d01..52488cb 100644
--- a/Products/CMFEditions/KeepLastNVersionsTool.py
+++ b/Products/CMFEditions/KeepLastNVersionsTool.py
@@ -96,7 +96,10 @@ def retrieveSubstitute(self, history_id, selector, default=None):
 
         If there isn't a next older one returns the next newer one.
         """
-        selector = int(selector)
+        if selector is None:
+            selector = 0
+        else:
+            selector = int(selector)
         storage = getToolByName(self, 'portal_historiesstorage')
         savedSelector = selector
         while selector:


Repository: Products.CMFEditions


Branch: refs/heads/master
Date: 2015-09-23T13:05:21+02:00
Author: Nejc Zupan (zupo) <nejc.zupan@gmail.com>
Commit: https://github.com/plone/Products.CMFEditions/commit/b9af24cfd72d440898d6e82069b9cabbc1602c1d

handling 'Removed' objects

Files changed:
M Products/CMFEditions/ZVCStorageTool.py

diff --git a/Products/CMFEditions/ZVCStorageTool.py b/Products/CMFEditions/ZVCStorageTool.py
index 02676a0..1dc96a2 100644
--- a/Products/CMFEditions/ZVCStorageTool.py
+++ b/Products/CMFEditions/ZVCStorageTool.py
@@ -673,8 +673,11 @@ def zmi_getStorageStatistics(self):
             else:
                 path = None
                 url = None
-                retrieved = self.retrieve(hid).object.object
-                portal_type = retrieved.getPortalTypeName()
+                object_ = self.retrieve(hid).object
+                if isinstance(object_, Removed):
+                    portal_type = 'Removed'
+                else:
+                    portal_type = object_.object.getPortalTypeName()
             histData = {
                 "history_id": hid,
                 "length": length,


Repository: Products.CMFEditions


Branch: refs/heads/master
Date: 2015-09-23T13:07:24+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFEditions/commit/3fb3c08d61ba51130cd8af91aade59bd0eaa00a2

document change

Files changed:
M CHANGES.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index 9a6f6e7..e6d0bf1 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,13 +4,15 @@ Changelog
 2.2.16 (unreleased)
 -------------------
 
-- Nothing changed yet.
+- Input sanitation for retrieveSubstitute()
+  [zupo]
 
 
 2.2.15 (2015-09-15)
 -------------------
 
-- use unrestricted search for storage statistics [tschorr]
+- use unrestricted search for storage statistics
+  [tschorr]
 
 
 2.2.14 (2015-08-13)


Repository: Products.CMFEditions


Branch: refs/heads/master
Date: 2015-09-23T13:08:21+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFEditions/commit/326389d7ce780be018513505d6407183d366b260

Merge pull request #23 from plone/retrieveSubstitute_sanitation

Input sanitation for retrieveSubstitute()

Files changed:
M CHANGES.rst
M Products/CMFEditions/KeepLastNVersionsTool.py
M Products/CMFEditions/ZVCStorageTool.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 9a6f6e7..e6d0bf1 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,13 +4,15 @@ Changelog
 2.2.16 (unreleased)
 -------------------
 
-- Nothing changed yet.
+- Input sanitation for retrieveSubstitute()
+  [zupo]
 
 
 2.2.15 (2015-09-15)
 -------------------
 
-- use unrestricted search for storage statistics [tschorr]
+- use unrestricted search for storage statistics
+  [tschorr]
 
 
 2.2.14 (2015-08-13)
diff --git a/Products/CMFEditions/KeepLastNVersionsTool.py b/Products/CMFEditions/KeepLastNVersionsTool.py
index c586d01..52488cb 100644
--- a/Products/CMFEditions/KeepLastNVersionsTool.py
+++ b/Products/CMFEditions/KeepLastNVersionsTool.py
@@ -96,7 +96,10 @@ def retrieveSubstitute(self, history_id, selector, default=None):
 
         If there isn't a next older one returns the next newer one.
         """
-        selector = int(selector)
+        if selector is None:
+            selector = 0
+        else:
+            selector = int(selector)
         storage = getToolByName(self, 'portal_historiesstorage')
         savedSelector = selector
         while selector:
diff --git a/Products/CMFEditions/ZVCStorageTool.py b/Products/CMFEditions/ZVCStorageTool.py
index 02676a0..1dc96a2 100644
--- a/Products/CMFEditions/ZVCStorageTool.py
+++ b/Products/CMFEditions/ZVCStorageTool.py
@@ -673,8 +673,11 @@ def zmi_getStorageStatistics(self):
             else:
                 path = None
                 url = None
-                retrieved = self.retrieve(hid).object.object
-                portal_type = retrieved.getPortalTypeName()
+                object_ = self.retrieve(hid).object
+                if isinstance(object_, Removed):
+                    portal_type = 'Removed'
+                else:
+                    portal_type = object_.object.getPortalTypeName()
             histData = {
                 "history_id": hid,
                 "length": length,


