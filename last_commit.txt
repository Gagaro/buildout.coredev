Repository: plone.app.layout
Branch: refs/heads/master
Date: 2015-05-13T16:28:08-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.app.layout/commit/ab5675b807f86137f3fe70bf4cb66d2d30bce197

render the footer portlets in a way where they can still
  be edited with @@manage-portlets

Files changed:
M CHANGES.rst
M plone/app/layout/viewlets/common.py
M plone/app/layout/viewlets/footer.pt

diff --git a/CHANGES.rst b/CHANGES.rst
index 4061de1..a75efab 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,8 +4,9 @@ Changelog
 2.5.7 (unreleased)
 ------------------
 
-- Nothing changed yet.
-
+- render the footer portlets in a way where they can still
+  be edited with @@manage-portlets
+  [vangheem]
 
 2.5.6 (2015-05-13)
 ------------------
diff --git a/plone/app/layout/viewlets/common.py b/plone/app/layout/viewlets/common.py
index 86493b9..0e58d3f 100644
--- a/plone/app/layout/viewlets/common.py
+++ b/plone/app/layout/viewlets/common.py
@@ -459,3 +459,28 @@ class FooterViewlet(ViewletBase):
     def update(self):
         super(FooterViewlet, self).update()
         self.year = date.today().year
+
+    def render_footer_portlets(self):
+        """
+        You might ask, why is this necessary. Well, let me tell you a story...
+
+        plone.app.portlets, in order to provide @@manage-portlets on a context,
+        overrides the IPortletRenderer for the IManageContextualPortletsView view.
+        See plone.portlets and plone.app.portlets
+
+        Seems fine right? Well, most of the time it is. Except, here. Previously,
+        we were just using the syntax like `provider:plone.footerportlets` to
+        render the footer portlets. Since this tal expression was inside
+        a viewlet, the view is no longer IManageContextualPortletsView when
+        visiting @@manage-portlets. Instead, it was IViewlet.
+        See zope.contentprovider
+
+        In to fix this short coming, we render the portlet column by
+        manually doing the multi adapter lookup and then manually
+        doing the rendering for the content provider.
+        See zope.contentprovider
+        """
+        portlet_manager = getMultiAdapter(
+            (self.context, self.request, self.__parent__), name='plone.footerportlets')
+        portlet_manager.update()
+        return portlet_manager.render()
\ No newline at end of file
diff --git a/plone/app/layout/viewlets/footer.pt b/plone/app/layout/viewlets/footer.pt
index 0d1f793..df16ba9 100644
--- a/plone/app/layout/viewlets/footer.pt
+++ b/plone/app/layout/viewlets/footer.pt
@@ -1,5 +1,5 @@
 <div class="row">
 	<div class="col-xs-12">
-		<div tal:on-error="nothing" tal:replace="structure provider:plone.footerportlets" />
+		<div tal:on-error="nothing" tal:replace="structure view/render_footer_portlets" />
 	</div>
 </div>


Repository: plone.app.layout
Branch: refs/heads/master
Date: 2015-05-14T08:44:13-05:00
Author: Nathan Van Gheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.app.layout/commit/3382b851ff901a74ab01c753a5458196f9dcd50a

Merge pull request #44 from plone/portlet-manager

render the footer portlets in a way where they can still  be edited with @@manage-portlets

Files changed:
M CHANGES.rst
M plone/app/layout/viewlets/common.py
M plone/app/layout/viewlets/footer.pt

diff --git a/CHANGES.rst b/CHANGES.rst
index 4061de1..a75efab 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,8 +4,9 @@ Changelog
 2.5.7 (unreleased)
 ------------------
 
-- Nothing changed yet.
-
+- render the footer portlets in a way where they can still
+  be edited with @@manage-portlets
+  [vangheem]
 
 2.5.6 (2015-05-13)
 ------------------
diff --git a/plone/app/layout/viewlets/common.py b/plone/app/layout/viewlets/common.py
index 86493b9..0e58d3f 100644
--- a/plone/app/layout/viewlets/common.py
+++ b/plone/app/layout/viewlets/common.py
@@ -459,3 +459,28 @@ class FooterViewlet(ViewletBase):
     def update(self):
         super(FooterViewlet, self).update()
         self.year = date.today().year
+
+    def render_footer_portlets(self):
+        """
+        You might ask, why is this necessary. Well, let me tell you a story...
+
+        plone.app.portlets, in order to provide @@manage-portlets on a context,
+        overrides the IPortletRenderer for the IManageContextualPortletsView view.
+        See plone.portlets and plone.app.portlets
+
+        Seems fine right? Well, most of the time it is. Except, here. Previously,
+        we were just using the syntax like `provider:plone.footerportlets` to
+        render the footer portlets. Since this tal expression was inside
+        a viewlet, the view is no longer IManageContextualPortletsView when
+        visiting @@manage-portlets. Instead, it was IViewlet.
+        See zope.contentprovider
+
+        In to fix this short coming, we render the portlet column by
+        manually doing the multi adapter lookup and then manually
+        doing the rendering for the content provider.
+        See zope.contentprovider
+        """
+        portlet_manager = getMultiAdapter(
+            (self.context, self.request, self.__parent__), name='plone.footerportlets')
+        portlet_manager.update()
+        return portlet_manager.render()
\ No newline at end of file
diff --git a/plone/app/layout/viewlets/footer.pt b/plone/app/layout/viewlets/footer.pt
index 0d1f793..df16ba9 100644
--- a/plone/app/layout/viewlets/footer.pt
+++ b/plone/app/layout/viewlets/footer.pt
@@ -1,5 +1,5 @@
 <div class="row">
 	<div class="col-xs-12">
-		<div tal:on-error="nothing" tal:replace="structure provider:plone.footerportlets" />
+		<div tal:on-error="nothing" tal:replace="structure view/render_footer_portlets" />
 	</div>
 </div>


