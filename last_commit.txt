Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-07-16T15:20:49+02:00
Author: Gagaro (Gagaro) <gagaro42@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/bee291ddfcf9714b13977628ffca7aa378380783

fix: PloneSettingsAdapter during Archetype creation

Files changed:
M Products/CMFPlone/patterns/__init__.py

diff --git a/Products/CMFPlone/patterns/__init__.py b/Products/CMFPlone/patterns/__init__.py
index 399df6f..404cc72 100644
--- a/Products/CMFPlone/patterns/__init__.py
+++ b/Products/CMFPlone/patterns/__init__.py
@@ -1,3 +1,4 @@
+from borg.localrole.interfaces import IFactoryTempFolder
 from Products.CMFPlone.interfaces import IPatternsSettings
 from Products.CMFPlone.interfaces import ITinyMCESchema
 from zope.interface import implements
@@ -8,7 +9,7 @@
 from Products.CMFCore.interfaces._content import IFolderish
 from plone.uuid.interfaces import IUUID
 from Products.CMFPlone.interfaces import IPloneSiteRoot
-from Acquisition import aq_parent
+from Acquisition import aq_parent, aq_inner
 from plone.app.theming.utils import theming_policy
 from Products.CMFCore.utils import getToolByName
 from zope.component.hooks import getSite
@@ -200,9 +201,13 @@ def tinymce(self):
         generator = TinyMCESettingsGenerator(self.context, self.request)
         settings = generator.settings
 
-        folder = self.context
-        if not IFolderish.providedBy(self.context):
-            folder = aq_parent(self.context)
+        folder = aq_inner(self.context)
+        # Test if we are currently creating an Archetype object
+        if IFactoryTempFolder.providedBy(aq_parent(folder)):
+            folder = aq_parent(aq_parent(aq_parent(folder)))
+        if not IFolderish.providedBy(folder):
+            folder = aq_parent(folder)
+
         if IPloneSiteRoot.providedBy(folder):
             initial = None
         else:


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-07-16T17:05:09+02:00
Author: Nathan Van Gheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/3b30408556a73595a448051a93aa4b6e91cb1061

Merge pull request #694 from plone/fix_archetype_tinymce

fix: PloneSettingsAdapter during Archetype creation

Files changed:
M Products/CMFPlone/patterns/__init__.py

diff --git a/Products/CMFPlone/patterns/__init__.py b/Products/CMFPlone/patterns/__init__.py
index 399df6f..404cc72 100644
--- a/Products/CMFPlone/patterns/__init__.py
+++ b/Products/CMFPlone/patterns/__init__.py
@@ -1,3 +1,4 @@
+from borg.localrole.interfaces import IFactoryTempFolder
 from Products.CMFPlone.interfaces import IPatternsSettings
 from Products.CMFPlone.interfaces import ITinyMCESchema
 from zope.interface import implements
@@ -8,7 +9,7 @@
 from Products.CMFCore.interfaces._content import IFolderish
 from plone.uuid.interfaces import IUUID
 from Products.CMFPlone.interfaces import IPloneSiteRoot
-from Acquisition import aq_parent
+from Acquisition import aq_parent, aq_inner
 from plone.app.theming.utils import theming_policy
 from Products.CMFCore.utils import getToolByName
 from zope.component.hooks import getSite
@@ -200,9 +201,13 @@ def tinymce(self):
         generator = TinyMCESettingsGenerator(self.context, self.request)
         settings = generator.settings
 
-        folder = self.context
-        if not IFolderish.providedBy(self.context):
-            folder = aq_parent(self.context)
+        folder = aq_inner(self.context)
+        # Test if we are currently creating an Archetype object
+        if IFactoryTempFolder.providedBy(aq_parent(folder)):
+            folder = aq_parent(aq_parent(aq_parent(folder)))
+        if not IFolderish.providedBy(folder):
+            folder = aq_parent(folder)
+
         if IPloneSiteRoot.providedBy(folder):
             initial = None
         else:


