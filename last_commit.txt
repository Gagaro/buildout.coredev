Repository: plone.app.content


Branch: refs/heads/master
Date: 2015-06-25T03:10:04+02:00
Author: Johannes Raggam (thet) <raggam-nl@adm.at>
Commit: https://github.com/plone/plone.app.content/commit/9927a5251bcf3b7a9262ee85a097d45d32181300

Let @@getVocabulary return the vocabulary's value instead of the token for the id in the result set. The token is binary encoded and leads to encoding errors when selecting a value with non-ASCII data from vocabulary list in a select2 based widget.  Fixes: https://github.com/plone/Products.CMFPlone/issues/650

Files changed:
M CHANGES.rst
M plone/app/content/browser/vocabulary.py
M plone/app/content/tests/test_widgets.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 9e9d820..7fca280 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,12 @@ Changelog
 3.0.7 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- Let ``@@getVocabulary`` return the vocabulary's value instead of the token
+  for the id in the result set. The token is binary encoded and leads to
+  encoding errors when selecting a value with non-ASCII data from vocabulary
+  list in a select2 based widget.
+  Fixes: https://github.com/plone/Products.CMFPlone/issues/650
+  [thet]
 
 
 3.0.6 (2015-06-05)
diff --git a/plone/app/content/browser/vocabulary.py b/plone/app/content/browser/vocabulary.py
index 9754fc3..9108a20 100644
--- a/plone/app/content/browser/vocabulary.py
+++ b/plone/app/content/browser/vocabulary.py
@@ -153,7 +153,7 @@ def __call__(self):
                 items.append(item)
         else:
             for item in results:
-                items.append({'id': item.token, 'text': item.title})
+                items.append({'id': item.value, 'text': item.title})
 
         if total == 0:
             total = len(items)
diff --git a/plone/app/content/tests/test_widgets.py b/plone/app/content/tests/test_widgets.py
index be32820..ba4a7b6 100644
--- a/plone/app/content/tests/test_widgets.py
+++ b/plone/app/content/tests/test_widgets.py
@@ -15,6 +15,7 @@
 from plone.app.widgets.testing import ExampleVocabulary
 from plone.app.widgets.testing import PLONEAPPWIDGETS_INTEGRATION_TESTING
 from plone.app.widgets.testing import TestRequest
+from zope.component import getMultiAdapter
 from zope.component import provideAdapter
 from zope.component import provideUtility
 from zope.component.globalregistry import base
@@ -175,6 +176,29 @@ def testVocabularyBatching(self):
         self.assertEquals(len(data['results']), 10)
         self.assertEquals(data['total'], amount)
 
+    def testVocabularyEncoding(self):
+        """The vocabulary should not return the binary encoded token
+        ("N=C3=A5=C3=B8=C3=AF"), but instead the value as the id in the result
+        set. Fixes an encoding problem. See:
+        https://github.com/plone/Products.CMFPlone/issues/650
+        """
+        test_val = u'Nåøï'
+
+        self.portal.invokeFactory('Document', id="page", title="page")
+        self.portal.page.subject = (test_val,)
+        self.portal.page.reindexObject(idxs=['Subject'])
+
+        self.request.form['name'] = 'plone.app.vocabularies.Keywords'
+        results = getMultiAdapter(
+            (self.portal, self.request),
+            name='getVocabulary'
+        )()
+        results = json.loads(results)
+        result = results['results'][0]
+
+        self.assertEquals(result['text'], test_val)
+        self.assertEquals(result['id'], test_val)
+
     def testVocabularyUnauthorized(self):
         setRoles(self.portal, TEST_USER_ID, [])
         view = VocabularyView(self.portal, self.request)


Repository: plone.app.content


Branch: refs/heads/master
Date: 2015-06-25T10:57:01+02:00
Author: Johannes Raggam (thet) <raggam-nl@adm.at>
Commit: https://github.com/plone/plone.app.content/commit/62bbf28c17ab89c55f8b26c1844404b781aef712

Merge pull request #34 from plone/thet-vocabularyencoding

Fix encoding problems with Mockup Select2 widget

Files changed:
M CHANGES.rst
M plone/app/content/browser/vocabulary.py
M plone/app/content/tests/test_widgets.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 9e9d820..7fca280 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,12 @@ Changelog
 3.0.7 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- Let ``@@getVocabulary`` return the vocabulary's value instead of the token
+  for the id in the result set. The token is binary encoded and leads to
+  encoding errors when selecting a value with non-ASCII data from vocabulary
+  list in a select2 based widget.
+  Fixes: https://github.com/plone/Products.CMFPlone/issues/650
+  [thet]
 
 
 3.0.6 (2015-06-05)
diff --git a/plone/app/content/browser/vocabulary.py b/plone/app/content/browser/vocabulary.py
index 9754fc3..9108a20 100644
--- a/plone/app/content/browser/vocabulary.py
+++ b/plone/app/content/browser/vocabulary.py
@@ -153,7 +153,7 @@ def __call__(self):
                 items.append(item)
         else:
             for item in results:
-                items.append({'id': item.token, 'text': item.title})
+                items.append({'id': item.value, 'text': item.title})
 
         if total == 0:
             total = len(items)
diff --git a/plone/app/content/tests/test_widgets.py b/plone/app/content/tests/test_widgets.py
index be32820..ba4a7b6 100644
--- a/plone/app/content/tests/test_widgets.py
+++ b/plone/app/content/tests/test_widgets.py
@@ -15,6 +15,7 @@
 from plone.app.widgets.testing import ExampleVocabulary
 from plone.app.widgets.testing import PLONEAPPWIDGETS_INTEGRATION_TESTING
 from plone.app.widgets.testing import TestRequest
+from zope.component import getMultiAdapter
 from zope.component import provideAdapter
 from zope.component import provideUtility
 from zope.component.globalregistry import base
@@ -175,6 +176,29 @@ def testVocabularyBatching(self):
         self.assertEquals(len(data['results']), 10)
         self.assertEquals(data['total'], amount)
 
+    def testVocabularyEncoding(self):
+        """The vocabulary should not return the binary encoded token
+        ("N=C3=A5=C3=B8=C3=AF"), but instead the value as the id in the result
+        set. Fixes an encoding problem. See:
+        https://github.com/plone/Products.CMFPlone/issues/650
+        """
+        test_val = u'Nåøï'
+
+        self.portal.invokeFactory('Document', id="page", title="page")
+        self.portal.page.subject = (test_val,)
+        self.portal.page.reindexObject(idxs=['Subject'])
+
+        self.request.form['name'] = 'plone.app.vocabularies.Keywords'
+        results = getMultiAdapter(
+            (self.portal, self.request),
+            name='getVocabulary'
+        )()
+        results = json.loads(results)
+        result = results['results'][0]
+
+        self.assertEquals(result['text'], test_val)
+        self.assertEquals(result['id'], test_val)
+
     def testVocabularyUnauthorized(self):
         setRoles(self.portal, TEST_USER_ID, [])
         view = VocabularyView(self.portal, self.request)


