Repository: plone.app.textfield
Branch: refs/heads/master
Date: 2014-12-11T12:49:00+02:00
Author: Asko Soukka (datakurre) <asko.soukka@iki.fi>
Commit: https://github.com/plone/plone.app.textfield/commit/ee198e3eead223b65188ff889f454180db3409f4

Fix marshaler decode to always decode raw value into unicode

Files changed:
M plone/app/textfield/marshaler.py

diff --git a/plone/app/textfield/marshaler.py b/plone/app/textfield/marshaler.py
index 482647e..baf0bdb 100644
--- a/plone/app/textfield/marshaler.py
+++ b/plone/app/textfield/marshaler.py
@@ -32,8 +32,12 @@ def decode(
                 charset='utf-8',
                 contentType=None,
                 primary=False):
+            try:
+                unicode_value = value.decode(charset)
+            except UnicodeEncodeError:
+                unicode_value = value  # was already unicode
             return RichTextValue(
-                raw=value,
+                raw=unicode_value,
                 mimeType=contentType or self.field.default_mime_type,
                 outputMimeType=self.field.output_mime_type,
                 encoding=charset


Repository: plone.app.textfield
Branch: refs/heads/master
Date: 2014-12-11T12:52:11+02:00
Author: Asko Soukka (datakurre) <asko.soukka@iki.fi>
Commit: https://github.com/plone/plone.app.textfield/commit/325322bbc38ff160ea077ee8c29c672f3d3e2809

Update changelog

Files changed:
M docs/HISTORY.rst

diff --git a/docs/HISTORY.rst b/docs/HISTORY.rst
index 7da4a34..4fae0b8 100644
--- a/docs/HISTORY.rst
+++ b/docs/HISTORY.rst
@@ -4,6 +4,20 @@ Changelog
 1.2.5 (unreleased)
 ------------------
 
+- Fix marshaler decode to always decode raw value into unicode
+  [datakurre]
+
+- Remove utils.getSiteEncoding, which was deprecated and not used anywhere.
+  [thet]
+
+- For Plone 5, support getting markup control panel settings from the registry,
+  while still supporting normal portal_properties access for Plone < 5.
+  [thet]
+
+- Resolved an interesting circular import case, which wasnt effective because
+  of sort order of imports
+  [thet]
+
 - For Plone 5, support getting markup control panel settings from the registry,
   while still supporting normal portal_properties access for Plone < 5.
   [thet]


Repository: plone.app.textfield
Branch: refs/heads/master
Date: 2015-01-22T17:27:37+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.textfield/commit/ae1f1f5b825780c80a39435effe46184504cd11d

Merge pull request #13 from plone/datakurre-fix-decode

Fix marshaler decode to always set raw value as unicode

Files changed:
M docs/HISTORY.rst
M plone/app/textfield/marshaler.py

diff --git a/docs/HISTORY.rst b/docs/HISTORY.rst
index 7da4a34..4fae0b8 100644
--- a/docs/HISTORY.rst
+++ b/docs/HISTORY.rst
@@ -4,6 +4,20 @@ Changelog
 1.2.5 (unreleased)
 ------------------
 
+- Fix marshaler decode to always decode raw value into unicode
+  [datakurre]
+
+- Remove utils.getSiteEncoding, which was deprecated and not used anywhere.
+  [thet]
+
+- For Plone 5, support getting markup control panel settings from the registry,
+  while still supporting normal portal_properties access for Plone < 5.
+  [thet]
+
+- Resolved an interesting circular import case, which wasnt effective because
+  of sort order of imports
+  [thet]
+
 - For Plone 5, support getting markup control panel settings from the registry,
   while still supporting normal portal_properties access for Plone < 5.
   [thet]
diff --git a/plone/app/textfield/marshaler.py b/plone/app/textfield/marshaler.py
index 482647e..baf0bdb 100644
--- a/plone/app/textfield/marshaler.py
+++ b/plone/app/textfield/marshaler.py
@@ -32,8 +32,12 @@ def decode(
                 charset='utf-8',
                 contentType=None,
                 primary=False):
+            try:
+                unicode_value = value.decode(charset)
+            except UnicodeEncodeError:
+                unicode_value = value  # was already unicode
             return RichTextValue(
-                raw=value,
+                raw=unicode_value,
                 mimeType=contentType or self.field.default_mime_type,
                 outputMimeType=self.field.output_mime_type,
                 encoding=charset


