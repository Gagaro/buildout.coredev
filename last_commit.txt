Repository: plone.protect


Branch: refs/heads/master
Date: 2015-10-05T23:50:58-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.protect/commit/7525d2d77644299cecb4759f7eba94ea5ec8031d

make imports backward compatible

Files changed:
M CHANGES.rst
M plone/protect/auto.py
M plone/protect/configure.zcml
M plone/protect/subscribers.py

diff --git a/CHANGES.rst b/CHANGES.rst
index b571816..f5d0cb2 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,8 @@ Changelog
 3.0.10 (unreleased)
 -------------------
 
-- Nothing changed yet.
+- make imports backward compatible
+  [vangheem]
 
 
 3.0.9 (2015-09-27)
diff --git a/plone/protect/auto.py b/plone/protect/auto.py
index c27051b..7df3b22 100644
--- a/plone/protect/auto.py
+++ b/plone/protect/auto.py
@@ -7,6 +7,7 @@
 
 from AccessControl import getSecurityManager
 from Acquisition import aq_parent
+from Products.CMFCore.utils import getToolByName
 from lxml import etree
 from plone.keyring.interfaces import IKeyManager
 from plone.portlets.interfaces import IPortletAssignment
@@ -27,9 +28,13 @@
 from zope.component import ComponentLookupError
 from zope.component import adapts
 from zope.component import getUtility
-from zope.component.hooks import getSite
 from zope.interface import implements, Interface
 
+
+try:
+    from zope.component.hooks import getSite
+except:
+    from zope.app.component.hooks import getSite
 LOGGER = logging.getLogger('plone.protect')
 
 
@@ -121,10 +126,17 @@ def transformIterable(self, result, encoding):
             root = getRoot(context)
             self.key_manager = getRootKeyManager(root)
 
-        if self.site is None and self.key_manager is None:
-            # key manager not installed and no site object.
-            # key manager must not be installed on site root, ignore
-            return
+        if self.site is None:
+            if self.key_manager is None:
+                # key manager not installed and no site object.
+                # key manager must not be installed on site root, ignore
+                return
+        else:
+            try:
+                self.site = getToolByName(
+                    self.site, 'portal_url', None).getPortalObject()
+            except AttributeError:
+                pass
 
         if not self.check():
             # we don't need to transform the doc, we're getting redirected
@@ -267,4 +279,4 @@ def transform(self, result):
                 hidden.attrib['value'] = token
                 form.append(hidden)
 
-        return result
+        return result
\ No newline at end of file
diff --git a/plone/protect/configure.zcml b/plone/protect/configure.zcml
index d824e6e..c9524df 100644
--- a/plone/protect/configure.zcml
+++ b/plone/protect/configure.zcml
@@ -6,7 +6,8 @@
     xmlns:monkey="http://namespaces.plone.org/monkey"
     i18n_domain="plone.protect">
 
-    <include package="AccessControl" />
+    <include package="AccessControl"
+             zcml:condition="installed AccessControl.rolemanager" />
     <include package="plone.keyring" />
     <include package="plone.transformchain" />
     <include package="five.globalrequest" />
diff --git a/plone/protect/subscribers.py b/plone/protect/subscribers.py
index 2589ca7..c3e5145 100644
--- a/plone/protect/subscribers.py
+++ b/plone/protect/subscribers.py
@@ -7,7 +7,10 @@
 from zope.component import ComponentLookupError
 from zope.component import adapter
 from zope.component import getUtility
-from zope.component.hooks import getSite
+try:
+    from zope.component.hooks import getSite
+except ImportError:
+    from zope.app.component.hooks import getSite
 from zope.globalrequest import getRequest
 from zope.interface import alsoProvides
 from plone.protect.utils import getRootKeyManager


Repository: plone.protect


Branch: refs/heads/master
Date: 2015-10-06T00:02:24-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.protect/commit/3bfc3a54df18c0071acd8b5adc868b310f651faa

switch to not use getSite since we end up using portal_url object anyway

Files changed:
M plone/protect/auto.py

diff --git a/plone/protect/auto.py b/plone/protect/auto.py
index 7df3b22..49c65a6 100644
--- a/plone/protect/auto.py
+++ b/plone/protect/auto.py
@@ -30,11 +30,6 @@
 from zope.component import getUtility
 from zope.interface import implements, Interface
 
-
-try:
-    from zope.component.hooks import getSite
-except:
-    from zope.app.component.hooks import getSite
 LOGGER = logging.getLogger('plone.protect')
 
 
@@ -119,24 +114,19 @@ def transformIterable(self, result, encoding):
         if not context:
             return
 
-        self.site = getSite()
+        tool = getToolByName(context, 'portal_url', None)
+        if tool:
+            self.site = tool.getPortalObject()
         try:
             self.key_manager = getUtility(IKeyManager)
         except ComponentLookupError:
             root = getRoot(context)
             self.key_manager = getRootKeyManager(root)
 
-        if self.site is None:
-            if self.key_manager is None:
-                # key manager not installed and no site object.
-                # key manager must not be installed on site root, ignore
-                return
-        else:
-            try:
-                self.site = getToolByName(
-                    self.site, 'portal_url', None).getPortalObject()
-            except AttributeError:
-                pass
+        if self.site is None and self.key_manager is None:
+            # key manager not installed and no site object.
+            # key manager must not be installed on site root, ignore
+            return
 
         if not self.check():
             # we don't need to transform the doc, we're getting redirected


Repository: plone.protect


Branch: refs/heads/master
Date: 2015-10-06T06:57:45-05:00
Author: Nathan Van Gheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.protect/commit/9d5ee4a9a4d08b2fb13dabf0f62aad7758afd771

Merge pull request #21 from plone/backward-compat

make imports backward compatible

Files changed:
M CHANGES.rst
M plone/protect/auto.py
M plone/protect/configure.zcml
M plone/protect/subscribers.py

diff --git a/CHANGES.rst b/CHANGES.rst
index b571816..f5d0cb2 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,8 @@ Changelog
 3.0.10 (unreleased)
 -------------------
 
-- Nothing changed yet.
+- make imports backward compatible
+  [vangheem]
 
 
 3.0.9 (2015-09-27)
diff --git a/plone/protect/auto.py b/plone/protect/auto.py
index c27051b..49c65a6 100644
--- a/plone/protect/auto.py
+++ b/plone/protect/auto.py
@@ -7,6 +7,7 @@
 
 from AccessControl import getSecurityManager
 from Acquisition import aq_parent
+from Products.CMFCore.utils import getToolByName
 from lxml import etree
 from plone.keyring.interfaces import IKeyManager
 from plone.portlets.interfaces import IPortletAssignment
@@ -27,7 +28,6 @@
 from zope.component import ComponentLookupError
 from zope.component import adapts
 from zope.component import getUtility
-from zope.component.hooks import getSite
 from zope.interface import implements, Interface
 
 LOGGER = logging.getLogger('plone.protect')
@@ -114,7 +114,9 @@ def transformIterable(self, result, encoding):
         if not context:
             return
 
-        self.site = getSite()
+        tool = getToolByName(context, 'portal_url', None)
+        if tool:
+            self.site = tool.getPortalObject()
         try:
             self.key_manager = getUtility(IKeyManager)
         except ComponentLookupError:
@@ -267,4 +269,4 @@ def transform(self, result):
                 hidden.attrib['value'] = token
                 form.append(hidden)
 
-        return result
+        return result
\ No newline at end of file
diff --git a/plone/protect/configure.zcml b/plone/protect/configure.zcml
index d824e6e..c9524df 100644
--- a/plone/protect/configure.zcml
+++ b/plone/protect/configure.zcml
@@ -6,7 +6,8 @@
     xmlns:monkey="http://namespaces.plone.org/monkey"
     i18n_domain="plone.protect">
 
-    <include package="AccessControl" />
+    <include package="AccessControl"
+             zcml:condition="installed AccessControl.rolemanager" />
     <include package="plone.keyring" />
     <include package="plone.transformchain" />
     <include package="five.globalrequest" />
diff --git a/plone/protect/subscribers.py b/plone/protect/subscribers.py
index 2589ca7..c3e5145 100644
--- a/plone/protect/subscribers.py
+++ b/plone/protect/subscribers.py
@@ -7,7 +7,10 @@
 from zope.component import ComponentLookupError
 from zope.component import adapter
 from zope.component import getUtility
-from zope.component.hooks import getSite
+try:
+    from zope.component.hooks import getSite
+except ImportError:
+    from zope.app.component.hooks import getSite
 from zope.globalrequest import getRequest
 from zope.interface import alsoProvides
 from plone.protect.utils import getRootKeyManager


