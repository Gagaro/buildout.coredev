Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-10-30T02:10:26+01:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/0eac3fef65a82c7ab2171585bf0c53d1c4af9748

Contact-info: do not use secureSend.

This is deprecated.
Instead set Reply-To header on the message.
Thanks to David for sharing the code.
See @#1208

Files changed:
M CHANGES.rst
M Products/CMFPlone/browser/contact_info.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 9351b46..8fe5a15 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -15,7 +15,7 @@ New:
   [vangheem]
 
 - Set Reply-to address in contact-info emails so you can reply to them.
-  [tkimnguyen]
+  [tkimnguyen, maurits, davisagli]
 
 - Added syndication for plone.app.contenttypes collections.
   [do3cc]
diff --git a/Products/CMFPlone/browser/contact_info.py b/Products/CMFPlone/browser/contact_info.py
index 6d5bd23..b03c461 100644
--- a/Products/CMFPlone/browser/contact_info.py
+++ b/Products/CMFPlone/browser/contact_info.py
@@ -6,6 +6,8 @@
 from Products.CMFPlone.interfaces.controlpanel import IMailSchema
 from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile
 from Products.statusmessages.interfaces import IStatusMessage
+from email.Header import Header
+from email.MIMEText import MIMEText
 from plone.registry.interfaces import IRegistry
 from smtplib import SMTPException
 from z3c.form import form, field, button
@@ -64,16 +66,18 @@ def send_message(self, data):
         host = getToolByName(self.context, 'MailHost')
 
         data['url'] = portal.absolute_url()
+        message = self.generate_mail(data, encoding)
+        message = MIMEText(message, 'plain', encoding)
+        message['Reply-To'] = Header(data['sender_from_address'], encoding)
 
         try:
             # This actually sends out the mail
-            host.secureSend(
-                self.generate_mail(data, encoding),
+            host.send(
+                message,
                 send_to_address,
                 from_address,
                 subject=subject,
-                charset=encoding,
-                **{'Reply-to':data['sender_from_address']}
+                charset=encoding
             )
         except (SMTPException, RuntimeError), e:
             log.error(e)


