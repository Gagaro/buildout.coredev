Repository: Products.CMFPlone
Branch: refs/heads/master
Date: 2015-04-09T06:14:00+02:00
Author: Timo Stollenwerk (tisto) <tisto@plone.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/9ee500d7e01e2866bea9d0a3a340298095eded92

Monkey patch SMTPMailer init method to pick up the mail settings from the registry instead of from the MailHost itself.

Files changed:
M CHANGES.rst
M Products/CMFPlone/patches/sendmail.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 927540d..30c678e 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -8,6 +8,10 @@ Changelog
 5.0b2 (unreleased)
 ------------------
 
+- Monkey patch SMTPMailer init method to pick up the mail settings from the
+  registry instead of from the MailHost itself.
+  [timo]
+
 - Add `resource_blacklist` attribute to resource registry importer, to
   allow filtering of known bad legacy resource imports.  Filter js from
   plone.app.jquery.
diff --git a/Products/CMFPlone/patches/sendmail.py b/Products/CMFPlone/patches/sendmail.py
index e6dec2d..fbb0161 100644
--- a/Products/CMFPlone/patches/sendmail.py
+++ b/Products/CMFPlone/patches/sendmail.py
@@ -1,6 +1,11 @@
+from plone.registry.interfaces import IRegistry
+from Products.CMFPlone.interfaces import IMailSchema
+from transaction._transaction import Status
+from zope.component import getUtility
+from zope.sendmail.mailer import SMTPMailer
+
 import logging
 import transaction
-from transaction._transaction import Status
 
 log = logging.getLogger("MailDataManager")
 
@@ -28,3 +33,24 @@ def applyPatches():
     old_mailer = getattr(SMTPMailer, 'vote', None) is None
     if old_mailer:
         SMTPMailer.send = catchAllExceptions(SMTPMailer.send)
+
+
+def new_init(
+        self,
+        hostname='localhost',
+        port=25,
+        username=None,
+        password=None,
+        no_tls=False,
+        force_tls=False):
+
+    registry = getUtility(IRegistry)
+    mail_settings = registry.forInterface(IMailSchema, prefix='plone')
+    self.hostname = mail_settings.smtp_host
+    self.port = mail_settings.smtp_port
+    self.username = mail_settings.smtp_userid
+    self.password = mail_settings.smtp_pass
+    self.force_tls = force_tls
+    self.no_tls = no_tls
+
+SMTPMailer.__init__ = new_init


