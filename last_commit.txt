Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-10-13T09:14:58Z
Author: Korbinian Preisler () <kpreisler@virtual-things.biz>
Commit: https://github.com/plone/Products.CMFPlone/commit/50e02be551eba6b9270c457c0a9d25f029191fa1

Allow to compile bundle with more than one resource

see #1131

Files changed:
M Products/CMFPlone/_scripts/_generate_gruntfile.py

diff --git a/Products/CMFPlone/_scripts/_generate_gruntfile.py b/Products/CMFPlone/_scripts/_generate_gruntfile.py
index fa76f49..6ab0c58 100644
--- a/Products/CMFPlone/_scripts/_generate_gruntfile.py
+++ b/Products/CMFPlone/_scripts/_generate_gruntfile.py
@@ -131,9 +131,9 @@
                       {globalVars}
                     }}
                 }},
-                files: {{
+                files: [
                     {files}
-                }}
+                ]
             }}
 """
 
@@ -317,7 +317,7 @@ def resource_to_dir(resource, file_type='.js'):
 
 for bkey, bundle in bundles.items():
     if bundle.compile:
-        less_files = []
+        less_files = {}
         js_files = []
         js_resources = []
         for resource in bundle.resources:
@@ -352,9 +352,10 @@ def resource_to_dir(resource, file_type='.js'):
                         target_dir = '/'.join(bundle.csscompilation.split('/')[:-1])  # noqa
                         target_name = bundle.csscompilation.split('/')[-1]
                         target_path = resource_to_dir(portal.unrestrictedTraverse(target_dir))  # noqa
-                        less_file = "\"%s/%s\": \"%s\"" % (target_path, target_name, main_css_path)  # noqa
+                        dest_path = '{}/{}'.format(target_path, target_name)
+                        less_files.setdefault(dest_path, [])
+                        less_files[dest_path].append(main_css_path)
                         sourceMap_url = target_name + '.map'
-                        less_files.append(less_file)
                         watch_files.append(main_css_path)
                         # replace urls
 
@@ -379,7 +380,7 @@ def resource_to_dir(resource, file_type='.js'):
         less_configs.append(less_config.format(
             name=bkey,
             globalVars=globalVars_string,
-            files=',\n'.join(less_files),
+            files=json.dumps(less_files),
             less_paths=json.dumps(less_paths),
             sourcemap_url=sourceMap_url,
             base_path=os.getcwd()))


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-10-13T10:46:10Z
Author: Korbinian Preisler () <kpreisler@virtual-things.biz>
Commit: https://github.com/plone/Products.CMFPlone/commit/ebf0c559ae5d9cbe54d5a3efb10d01bcdb38f963

Add changelog entry for #1311

Files changed:
M CHANGES.rst

diff --git a/CHANGES.rst b/CHANGES.rst
index 6a4b02c..0165044 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -8,6 +8,9 @@ Changelog
 5.0.1 (unreleased)
 ------------------
 
+- Fix #1131: Allow to compile bundle with more than one resource
+  [timitos]
+
 - fix issue where clicking tabs would cause odd scroll movement
   [vangheem]
 


Repository: Products.CMFPlone


Branch: refs/heads/master
Date: 2015-10-13T13:47:54+03:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/e6b5a5eca75d3cfc9ef351004ad131168e492421

Merge pull request #1159 from plone/timitos/generate_gruntfile

Allow to compile bundle with more than one resource

Files changed:
M CHANGES.rst
M Products/CMFPlone/_scripts/_generate_gruntfile.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 6a4b02c..0165044 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -8,6 +8,9 @@ Changelog
 5.0.1 (unreleased)
 ------------------
 
+- Fix #1131: Allow to compile bundle with more than one resource
+  [timitos]
+
 - fix issue where clicking tabs would cause odd scroll movement
   [vangheem]
 
diff --git a/Products/CMFPlone/_scripts/_generate_gruntfile.py b/Products/CMFPlone/_scripts/_generate_gruntfile.py
index fa76f49..6ab0c58 100644
--- a/Products/CMFPlone/_scripts/_generate_gruntfile.py
+++ b/Products/CMFPlone/_scripts/_generate_gruntfile.py
@@ -131,9 +131,9 @@
                       {globalVars}
                     }}
                 }},
-                files: {{
+                files: [
                     {files}
-                }}
+                ]
             }}
 """
 
@@ -317,7 +317,7 @@ def resource_to_dir(resource, file_type='.js'):
 
 for bkey, bundle in bundles.items():
     if bundle.compile:
-        less_files = []
+        less_files = {}
         js_files = []
         js_resources = []
         for resource in bundle.resources:
@@ -352,9 +352,10 @@ def resource_to_dir(resource, file_type='.js'):
                         target_dir = '/'.join(bundle.csscompilation.split('/')[:-1])  # noqa
                         target_name = bundle.csscompilation.split('/')[-1]
                         target_path = resource_to_dir(portal.unrestrictedTraverse(target_dir))  # noqa
-                        less_file = "\"%s/%s\": \"%s\"" % (target_path, target_name, main_css_path)  # noqa
+                        dest_path = '{}/{}'.format(target_path, target_name)
+                        less_files.setdefault(dest_path, [])
+                        less_files[dest_path].append(main_css_path)
                         sourceMap_url = target_name + '.map'
-                        less_files.append(less_file)
                         watch_files.append(main_css_path)
                         # replace urls
 
@@ -379,7 +380,7 @@ def resource_to_dir(resource, file_type='.js'):
         less_configs.append(less_config.format(
             name=bkey,
             globalVars=globalVars_string,
-            files=',\n'.join(less_files),
+            files=json.dumps(less_files),
             less_paths=json.dumps(less_paths),
             sourcemap_url=sourceMap_url,
             base_path=os.getcwd()))


