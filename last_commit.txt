Repository: plone.protect


Branch: refs/heads/master
Date: 2015-07-23T16:05:52-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.protect/commit/31f64835f78a6f36a803ad5ad1e1e20e1c112310

fix pluggable auth CSRF warnings on zope root. Very difficult to reproduce.
  Just let plone.protect do it's job also on zope root

Files changed:
M CHANGES.rst
M plone/protect/configure.zcml
M plone/protect/monkey.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 947264c..bfa5721 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,9 @@ Changelog
 3.0.7 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- fix pluggable auth CSRF warnings on zope root. Very difficult to reproduce.
+  Just let plone.protect do it's job also on zope root
+  [vangheem]
 
 
 3.0.6 (2015-07-20)
diff --git a/plone/protect/configure.zcml b/plone/protect/configure.zcml
index 2772d43..51cc314 100644
--- a/plone/protect/configure.zcml
+++ b/plone/protect/configure.zcml
@@ -65,14 +65,12 @@
         class="Products.PluggableAuthService.utils"
         original="getCSRFToken"
         replacement=".monkey.pluggableauth__getCSRFToken"
-        preserveOriginal="True"
         />
     <monkey:patch
         description="Patch old pluggable auth to use plone mechanism"
         class="Products.PluggableAuthService.utils"
         original="checkCSRFToken"
         replacement=".monkey.pluggableauth__checkCSRFToken"
-        preserveOriginal="True"
         />
 
 </configure>
diff --git a/plone/protect/monkey.py b/plone/protect/monkey.py
index 84d5f5e..45b2763 100644
--- a/plone/protect/monkey.py
+++ b/plone/protect/monkey.py
@@ -1,7 +1,5 @@
-from zope.component.hooks import getSite
 from urlparse import urlparse, urljoin
 from plone.protect.auto import safeWrite
-from Products.PluggableAuthService import utils as pluaggable_utils
 
 
 def RedirectTo__call__(self, controller_state):
@@ -43,17 +41,13 @@ def wl_lockmapping(self, killinvalids=0, create=0):
 
 def pluggableauth__getCSRFToken(request):
     """
-    if we have a site object, let plone.protect do it's job
+    let plone.protect do it's job
     """
-    if getSite():
-        return
-    return pluaggable_utils._old_getCSRFToken(request)
+    return ''
 
 
 def pluggableauth__checkCSRFToken(request, token='csrf_token', raises=True):
     """
-    if we have a site object, let plone.protect do it's job
+    let plone.protect do it's job
     """
-    if getSite():
-        return
-    return pluaggable_utils._old_checkCSRFToken(request)
+    pass


Repository: plone.protect


Branch: refs/heads/master
Date: 2015-07-23T22:34:07-05:00
Author: Nathan Van Gheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.protect/commit/1288fc1234bfaf1742552de1065d4558863538d5

Merge pull request #13 from plone/fix-pluggable-auth-zope-root

fix pluggable auth CSRF warnings on zope root

Files changed:
M CHANGES.rst
M plone/protect/configure.zcml
M plone/protect/monkey.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 947264c..bfa5721 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,9 @@ Changelog
 3.0.7 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- fix pluggable auth CSRF warnings on zope root. Very difficult to reproduce.
+  Just let plone.protect do it's job also on zope root
+  [vangheem]
 
 
 3.0.6 (2015-07-20)
diff --git a/plone/protect/configure.zcml b/plone/protect/configure.zcml
index 2772d43..51cc314 100644
--- a/plone/protect/configure.zcml
+++ b/plone/protect/configure.zcml
@@ -65,14 +65,12 @@
         class="Products.PluggableAuthService.utils"
         original="getCSRFToken"
         replacement=".monkey.pluggableauth__getCSRFToken"
-        preserveOriginal="True"
         />
     <monkey:patch
         description="Patch old pluggable auth to use plone mechanism"
         class="Products.PluggableAuthService.utils"
         original="checkCSRFToken"
         replacement=".monkey.pluggableauth__checkCSRFToken"
-        preserveOriginal="True"
         />
 
 </configure>
diff --git a/plone/protect/monkey.py b/plone/protect/monkey.py
index 84d5f5e..45b2763 100644
--- a/plone/protect/monkey.py
+++ b/plone/protect/monkey.py
@@ -1,7 +1,5 @@
-from zope.component.hooks import getSite
 from urlparse import urlparse, urljoin
 from plone.protect.auto import safeWrite
-from Products.PluggableAuthService import utils as pluaggable_utils
 
 
 def RedirectTo__call__(self, controller_state):
@@ -43,17 +41,13 @@ def wl_lockmapping(self, killinvalids=0, create=0):
 
 def pluggableauth__getCSRFToken(request):
     """
-    if we have a site object, let plone.protect do it's job
+    let plone.protect do it's job
     """
-    if getSite():
-        return
-    return pluaggable_utils._old_getCSRFToken(request)
+    return ''
 
 
 def pluggableauth__checkCSRFToken(request, token='csrf_token', raises=True):
     """
-    if we have a site object, let plone.protect do it's job
+    let plone.protect do it's job
     """
-    if getSite():
-        return
-    return pluaggable_utils._old_checkCSRFToken(request)
+    pass


