Repository: plone.app.layout


Branch: refs/heads/master
Date: 2015-09-06T15:25:02-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.app.layout/commit/b147ff375dd3afb811be70346cfd09bfb4654def

Be more defensive in getting registry settings so upgraded
  schema does not cause errors

Files changed:
M CHANGES.rst
M plone/app/layout/analytics/view.py
M plone/app/layout/globals/portal.py
M plone/app/layout/viewlets/common.py
M plone/app/layout/viewlets/toolbar.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 48bc83b..3a096e6 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,9 @@ Changelog
 2.5.11 (unreleased)
 -------------------
 
-- Nothing changed yet.
+- Be more defensive in getting registry settings so upgraded
+  schema does not cause errors
+  [vangheem]
 
 
 2.5.10 (2015-08-20)
diff --git a/plone/app/layout/analytics/view.py b/plone/app/layout/analytics/view.py
index 002edab..6294f53 100644
--- a/plone/app/layout/analytics/view.py
+++ b/plone/app/layout/analytics/view.py
@@ -25,7 +25,10 @@ def update(self):
     def render(self):
         """render the webstats snippet"""
         registry = getUtility(IRegistry)
-        site_settings = registry.forInterface(ISiteSchema, prefix="plone")
-        if site_settings.webstats_js:
-            return site_settings.webstats_js
-        return ''
+        site_settings = registry.forInterface(ISiteSchema, prefix="plone", check=False)
+        try:
+            if site_settings.webstats_js:
+                return site_settings.webstats_js
+            return ''
+        except AttributeError:
+            return ''
diff --git a/plone/app/layout/globals/portal.py b/plone/app/layout/globals/portal.py
index 4a42b6e..aecf393 100644
--- a/plone/app/layout/globals/portal.py
+++ b/plone/app/layout/globals/portal.py
@@ -32,7 +32,7 @@ def portal(self):
     @memoize_contextless
     def portal_title(self):
         registry = getUtility(IRegistry)
-        settings = registry.forInterface(ISiteSchema, prefix="plone")
+        settings = registry.forInterface(ISiteSchema, prefix="plone", check=False)
         return settings.site_title
 
     @memoize_contextless
diff --git a/plone/app/layout/viewlets/common.py b/plone/app/layout/viewlets/common.py
index 0c166c6..0693fc7 100644
--- a/plone/app/layout/viewlets/common.py
+++ b/plone/app/layout/viewlets/common.py
@@ -70,7 +70,7 @@ class TitleViewlet(ViewletBase):
     @memoize
     def site_title_setting(self):
         registry = getUtility(IRegistry)
-        site_settings = registry.forInterface(ISiteSchema, prefix="plone")
+        site_settings = registry.forInterface(ISiteSchema, prefix="plone", check=False)
         return site_settings.site_title
 
     @property
@@ -184,7 +184,7 @@ def update(self):
         self.navigation_root_title = self.portal_state.navigation_root_title()
 
         registry = getUtility(IRegistry)
-        settings = registry.forInterface(ISiteSchema, prefix="plone")
+        settings = registry.forInterface(ISiteSchema, prefix="plone", check=False)
         self.logo_title = settings.site_title
         self.img_src = getSiteLogo(self.portal_state.portal())
 
diff --git a/plone/app/layout/viewlets/toolbar.py b/plone/app/layout/viewlets/toolbar.py
index cbda321..29c89b6 100644
--- a/plone/app/layout/viewlets/toolbar.py
+++ b/plone/app/layout/viewlets/toolbar.py
@@ -29,7 +29,7 @@ def get_personal_bar(self):
 
     def get_toolbar_logo(self):
         registry = getUtility(IRegistry)
-        settings = registry.forInterface(ISiteSchema, prefix='plone')
+        settings = registry.forInterface(ISiteSchema, prefix='plone', check=False)
         portal_url = self.portal_state.portal_url()
         try:
             logo = settings.toolbar_logo


