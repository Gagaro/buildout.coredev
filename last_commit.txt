Repository: plone.protect


Branch: refs/heads/master
Date: 2015-09-19T01:57:22-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.protect/commit/093da6c64710a1d44be8549fc91bc8a197fa87ff

conditionally patch Products.PluggableAuthService if needed

Files changed:
M CHANGES.rst
M plone/protect/authenticator.py
M plone/protect/configure.zcml

diff --git a/CHANGES.rst b/CHANGES.rst
index 80fd3ce..28cc317 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,6 +4,9 @@ Changelog
 3.0.8 (unreleased)
 ------------------
 
+- conditionally patch Products.PluggableAuthService if needed
+  [vangheem]
+
 - Do not raise ComponentLookupError on transform
   [vangheem]
 
diff --git a/plone/protect/authenticator.py b/plone/protect/authenticator.py
index b3b40d9..066f812 100644
--- a/plone/protect/authenticator.py
+++ b/plone/protect/authenticator.py
@@ -59,7 +59,7 @@ def _getKeyring(username):
     return ring
 
 
-def _verify(request, extra='', name='_authenticator'):
+def _verify_request(request, extra='', name='_authenticator'):
     auth = request.get(name)
     if auth is None:
         auth = request.getHeader('X-CSRF-TOKEN')
@@ -81,6 +81,9 @@ def _verify(request, extra='', name='_authenticator'):
 
     return False
 
+# We had to rename because previous hotfixes patched _verify
+_verify = _verify_request
+
 
 def createToken(extra=''):
     user = _getUserName()
@@ -100,12 +103,12 @@ def authenticator(self, extra='', name='_authenticator'):
         return '<input type="hidden" name="%s" value="%s"/>' % (name, auth)
 
     def verify(self, extra='', name="_authenticator"):
-        return _verify(self.request, extra=extra, name=name)
+        return _verify_request(self.request, extra=extra, name=name)
 
 
 def check(request, extra='', name="_authenticator"):
     if isinstance(request, HTTPRequest):
-        if not _verify(request, extra=extra, name=name):
+        if not _verify_request(request, extra=extra, name=name):
             raise Forbidden('Form authenticator is invalid.')
 
 
diff --git a/plone/protect/configure.zcml b/plone/protect/configure.zcml
index 51cc314..0a53d7b 100644
--- a/plone/protect/configure.zcml
+++ b/plone/protect/configure.zcml
@@ -61,12 +61,14 @@
         />
 
     <monkey:patch
+        zcml:condition="Products.PluggableAuthService.utils.getCSRFToken"
         description="Patch old pluggable auth to use plone mechanism"
         class="Products.PluggableAuthService.utils"
         original="getCSRFToken"
         replacement=".monkey.pluggableauth__getCSRFToken"
         />
     <monkey:patch
+        zcml:condition="Products.PluggableAuthService.utils.checkCSRFToken"
         description="Patch old pluggable auth to use plone mechanism"
         class="Products.PluggableAuthService.utils"
         original="checkCSRFToken"


