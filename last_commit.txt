Repository: plone.app.contenttypes
Branch: refs/heads/master
Date: 2015-04-21T16:24:11+02:00
Author: Johannes Raggam (thet) <raggam-nl@adm.at>
Commit: https://github.com/plone/plone.app.contenttypes/commit/6b0c1056505228396b5388b5042b987989c6ce3b

Fix contentFilter for collections.

Files changed:
M docs/CHANGES.rst
M plone/app/contenttypes/browser/collection.py
M plone/app/contenttypes/browser/folder.py

diff --git a/docs/CHANGES.rst b/docs/CHANGES.rst
index 05edf1b..4d9dedb 100644
--- a/docs/CHANGES.rst
+++ b/docs/CHANGES.rst
@@ -4,6 +4,9 @@ Changelog
 1.2a8 (unreleased)
 ------------------
 
+- Fix ``contentFilter`` for collections.
+  [thet]
+
 - Cache the results of the collection and folder view on the request. The
   results might be called again by other packages to extract information on the
   result list.
diff --git a/plone/app/contenttypes/browser/collection.py b/plone/app/contenttypes/browser/collection.py
index 00487cd..31e25fd 100644
--- a/plone/app/contenttypes/browser/collection.py
+++ b/plone/app/contenttypes/browser/collection.py
@@ -30,7 +30,9 @@ def results(self, **kwargs):
                 sequence.
         """
         # Extra filter
-        kwargs.update(dict(getattr(self.request, 'contentFilter', {})))
+        contentFilter = self.request.get('contentFilter', {})
+        contentFilter.update(kwargs.get('contentFilter', {}))
+        kwargs.setdefault('custom_query', contentFilter)
         kwargs.setdefault('batch', True)
         kwargs.setdefault('b_size', self.b_size)
         kwargs.setdefault('b_start', self.b_start)
diff --git a/plone/app/contenttypes/browser/folder.py b/plone/app/contenttypes/browser/folder.py
index 25fd160..c1d88d5 100644
--- a/plone/app/contenttypes/browser/folder.py
+++ b/plone/app/contenttypes/browser/folder.py
@@ -56,7 +56,7 @@ def results(self, **kwargs):
                 sequence.
         """
         # Extra filter
-        kwargs.update(dict(getattr(self.request, 'contentFilter', {})))
+        kwargs.update(self.request.get('contentFilter', {}))
         kwargs.setdefault('portal_type', self.friendly_types)
         kwargs.setdefault('batch', True)
         kwargs.setdefault('b_size', self.b_size)


