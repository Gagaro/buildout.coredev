Repository: plone.app.theming
Branch: refs/heads/master
Date: 2015-06-01T09:48:50-05:00
Author: Sam Schwartz (obct537) <obct537@gmail.com>
Commit: https://github.com/plone/plone.app.theming/commit/b3c191e821781beb652f743ee422735851c38695

Manually re-applying the theme overriding changes

Files changed:
M src/plone/app/theming/browser/controlpanel.pt
M src/plone/app/theming/browser/controlpanel.py
M src/plone/app/theming/browser/resources/controlpanel.css
M src/plone/app/theming/utils.py

diff --git a/src/plone/app/theming/browser/controlpanel.pt b/src/plone/app/theming/browser/controlpanel.pt
index f9b8f12..3058cbe 100644
--- a/src/plone/app/theming/browser/controlpanel.pt
+++ b/src/plone/app/theming/browser/controlpanel.pt
@@ -144,6 +144,7 @@
 
                     <span class="themeEntryTitle">
                         <span tal:replace="theme/title">Title</span>
+                        <span class="warning" tal:condition="theme/override">(this theme overrides a filesystem theme)</span>
                         <span
                             tal:condition="theme/selected"
                             class="themeActive"
@@ -290,7 +291,7 @@
                                 tal:attributes="id string:modal-delete-${theme/name}"
                                 tal:condition="theme/editable">
                                 <h1 class="documentFirstHeading" i18n:translate="theming_controlpanel_delete_confirm">
-                                    Are you sure you want to delete <span 
+                                    Are you sure you want to delete <span
                                         tal:content="string:${theme/name}"
                                         i18n:name="theme_name"></span>
                                 </h1>
diff --git a/src/plone/app/theming/browser/controlpanel.py b/src/plone/app/theming/browser/controlpanel.py
index 75796cf..6546558 100644
--- a/src/plone/app/theming/browser/controlpanel.py
+++ b/src/plone/app/theming/browser/controlpanel.py
@@ -356,6 +356,17 @@ def update(self):
                 return True
 
             else:
+
+                if any(x.__name__ == title for x in getZODBThemes()):
+                    self.errors['title'] = _(u"Duplicate title")
+
+                    IStatusMessage(self.request).add(
+                        _(u"This title is already in use"),
+                        'error'
+                    )
+
+                    return True
+
                 name = createThemeFromTemplate(title, description, baseOn)
                 self._setup()
 
@@ -408,10 +419,24 @@ def themeList(self):
 
         portalUrl = getToolByName(self.context, 'portal_url')()
 
+        complete = [];
+
         for theme in self.availableThemes:
             if theme.__name__ == TEMPLATE_THEME:
                 continue
 
+            #We've overwritten this theme, skip it
+            if complete.__contains__(theme.__name__):
+                continue
+
+            override = False
+
+            #Is there more than one theme with the same name?
+            if len( filter(lambda x: x.__name__ == theme.__name__, self.availableThemes) ) > 1:
+                #Then we make sure we're using the TTW version, not the filesystem version.
+                theme = filter(lambda x: x.__name__ == theme.__name__, self.zodbThemes)[0]
+                override = True
+
             previewUrl = "++resource++plone.app.theming/defaultPreview.png"
             if theme.preview:
                 previewUrl = "++theme++{0:s}/{1:s}".format(
@@ -423,11 +448,14 @@ def themeList(self):
                 'name': theme.__name__,
                 'title': theme.title,
                 'description': theme.description,
+                'override': override,
                 'editable': theme.__name__ in zodbNames,
                 'preview': "{0}/{1}".format(portalUrl, previewUrl),
                 'selected': theme.__name__ == self.selectedTheme,
             })
 
+            complete.append(theme.__name__)
+
         themes.sort(key=lambda x: x['title'])
 
         return themes
diff --git a/src/plone/app/theming/browser/resources/controlpanel.css b/src/plone/app/theming/browser/resources/controlpanel.css
index 5c23aff..bf45d00 100644
--- a/src/plone/app/theming/browser/resources/controlpanel.css
+++ b/src/plone/app/theming/browser/resources/controlpanel.css
@@ -103,6 +103,12 @@ a.plone-btn {
     font-weight: normal;
 }
 
+.warning {
+    color: red;
+    display: block;
+    font-size: smaller;
+}
+
 .plone-btn-group {
     margin: 10px;
 }
diff --git a/src/plone/app/theming/utils.py b/src/plone/app/theming/utils.py
index 4aae0d6..afd35b8 100644
--- a/src/plone/app/theming/utils.py
+++ b/src/plone/app/theming/utils.py
@@ -21,10 +21,11 @@
 from plone.resource.interfaces import IResourceDirectory
 from plone.resource.manifest import MANIFEST_FILENAME
 from plone.resource.manifest import extractManifestFromZipFile
-from plone.resource.manifest import getAllResources
 from plone.resource.manifest import getManifest
 from plone.resource.manifest import getZODBResources
+from plone.resource.manifest import getAllResources
 from plone.resource.utils import cloneResourceDirectory
+from plone.resource.utils import iterDirectoriesOfType
 from plone.resource.utils import queryResourceDirectory
 from plone.subrequest import subrequest
 from urlparse import urlsplit
@@ -61,7 +62,6 @@ def resolve(self, system_url, public_id, context):
 
 def resolvePythonURL(url):
     """Resolve the python resource url to it's path
-
     This can resolve python://dotted.package.name/file/path URLs to paths.
     """
     assert url.lower().startswith('python://')
@@ -235,10 +235,8 @@ def isValidThemeDirectory(directory):
 
 def extractThemeInfo(zipfile, checkRules=True):
     """Return an ITheme based on the information in the given zipfile.
-
     Will throw a ValueError if the theme directory does not contain a single
     top level directory or the rules file cannot be found.
-
     Set checkRules=False to disable the rules check.
     """
 
@@ -330,14 +328,39 @@ def getTheme(name, manifest=None, resources=None):
 def getAvailableThemes():
     """Get a list of all ITheme's available in resource directories.
     """
-    resources = getAllResources(MANIFEST_FORMAT, filter=isValidThemeDirectory)
+    resources = getThemeResources(MANIFEST_FORMAT, filter=isValidThemeDirectory)
     themes = []
-    for name, manifest in resources.items():
-        themes.append(getTheme(name, manifest))
+    for theme in resources:
+        themes.append(getTheme(theme['name'], theme))
 
     themes.sort(key=lambda x: safe_unicode(x.title))
     return themes
 
+def getThemeResources(format, defaults=None, filter=None, manifestFilename=MANIFEST_FILENAME):
+
+    resources = []
+
+    for directory in iterDirectoriesOfType(format.resourceType, filter_duplicates=False):
+
+        if filter is not None and not filter(directory):
+            continue
+
+        name = directory.__name__
+
+        if directory.isFile(manifestFilename):
+
+            manifest = directory.openFile(manifestFilename)
+            try:
+                theme = getManifest(manifest, format, defaults)
+                theme['name'] = name
+                resources.append(theme)
+            except:
+                LOGGER.exception("Unable to read manifest for theme directory %s", name)
+            finally:
+                manifest.close()
+
+    return resources
+
 
 def getThemeFromResourceDirectory(resourceDirectory):
     """Return a Theme object from a resource directory
@@ -504,11 +527,6 @@ def createThemeFromTemplate(title, description, baseOn='template'):
         themeName = themeName.encode('utf-8')
 
     resources = getOrCreatePersistentResourceDirectory()
-    if themeName in resources:
-        idx = 1
-        while '-'.join((themeName, idx)) in resources:
-            idx += 1
-        themeName = '-'.join((themeName, idx))
 
     resources.makeDirectory(themeName)
     target = resources[themeName]


Repository: plone.app.theming
Branch: refs/heads/master
Date: 2015-06-01T09:55:19-05:00
Author: Nathan Van Gheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.app.theming/commit/d115f302baf6b21957beb2f171b682be46e04aca

Merge pull request #58 from plone/unreverting

Manually re-applying the theme overriding changes

Files changed:
M src/plone/app/theming/browser/controlpanel.pt
M src/plone/app/theming/browser/controlpanel.py
M src/plone/app/theming/browser/resources/controlpanel.css
M src/plone/app/theming/utils.py

diff --git a/src/plone/app/theming/browser/controlpanel.pt b/src/plone/app/theming/browser/controlpanel.pt
index f9b8f12..3058cbe 100644
--- a/src/plone/app/theming/browser/controlpanel.pt
+++ b/src/plone/app/theming/browser/controlpanel.pt
@@ -144,6 +144,7 @@
 
                     <span class="themeEntryTitle">
                         <span tal:replace="theme/title">Title</span>
+                        <span class="warning" tal:condition="theme/override">(this theme overrides a filesystem theme)</span>
                         <span
                             tal:condition="theme/selected"
                             class="themeActive"
@@ -290,7 +291,7 @@
                                 tal:attributes="id string:modal-delete-${theme/name}"
                                 tal:condition="theme/editable">
                                 <h1 class="documentFirstHeading" i18n:translate="theming_controlpanel_delete_confirm">
-                                    Are you sure you want to delete <span 
+                                    Are you sure you want to delete <span
                                         tal:content="string:${theme/name}"
                                         i18n:name="theme_name"></span>
                                 </h1>
diff --git a/src/plone/app/theming/browser/controlpanel.py b/src/plone/app/theming/browser/controlpanel.py
index 75796cf..6546558 100644
--- a/src/plone/app/theming/browser/controlpanel.py
+++ b/src/plone/app/theming/browser/controlpanel.py
@@ -356,6 +356,17 @@ def update(self):
                 return True
 
             else:
+
+                if any(x.__name__ == title for x in getZODBThemes()):
+                    self.errors['title'] = _(u"Duplicate title")
+
+                    IStatusMessage(self.request).add(
+                        _(u"This title is already in use"),
+                        'error'
+                    )
+
+                    return True
+
                 name = createThemeFromTemplate(title, description, baseOn)
                 self._setup()
 
@@ -408,10 +419,24 @@ def themeList(self):
 
         portalUrl = getToolByName(self.context, 'portal_url')()
 
+        complete = [];
+
         for theme in self.availableThemes:
             if theme.__name__ == TEMPLATE_THEME:
                 continue
 
+            #We've overwritten this theme, skip it
+            if complete.__contains__(theme.__name__):
+                continue
+
+            override = False
+
+            #Is there more than one theme with the same name?
+            if len( filter(lambda x: x.__name__ == theme.__name__, self.availableThemes) ) > 1:
+                #Then we make sure we're using the TTW version, not the filesystem version.
+                theme = filter(lambda x: x.__name__ == theme.__name__, self.zodbThemes)[0]
+                override = True
+
             previewUrl = "++resource++plone.app.theming/defaultPreview.png"
             if theme.preview:
                 previewUrl = "++theme++{0:s}/{1:s}".format(
@@ -423,11 +448,14 @@ def themeList(self):
                 'name': theme.__name__,
                 'title': theme.title,
                 'description': theme.description,
+                'override': override,
                 'editable': theme.__name__ in zodbNames,
                 'preview': "{0}/{1}".format(portalUrl, previewUrl),
                 'selected': theme.__name__ == self.selectedTheme,
             })
 
+            complete.append(theme.__name__)
+
         themes.sort(key=lambda x: x['title'])
 
         return themes
diff --git a/src/plone/app/theming/browser/resources/controlpanel.css b/src/plone/app/theming/browser/resources/controlpanel.css
index 5c23aff..bf45d00 100644
--- a/src/plone/app/theming/browser/resources/controlpanel.css
+++ b/src/plone/app/theming/browser/resources/controlpanel.css
@@ -103,6 +103,12 @@ a.plone-btn {
     font-weight: normal;
 }
 
+.warning {
+    color: red;
+    display: block;
+    font-size: smaller;
+}
+
 .plone-btn-group {
     margin: 10px;
 }
diff --git a/src/plone/app/theming/utils.py b/src/plone/app/theming/utils.py
index 4aae0d6..afd35b8 100644
--- a/src/plone/app/theming/utils.py
+++ b/src/plone/app/theming/utils.py
@@ -21,10 +21,11 @@
 from plone.resource.interfaces import IResourceDirectory
 from plone.resource.manifest import MANIFEST_FILENAME
 from plone.resource.manifest import extractManifestFromZipFile
-from plone.resource.manifest import getAllResources
 from plone.resource.manifest import getManifest
 from plone.resource.manifest import getZODBResources
+from plone.resource.manifest import getAllResources
 from plone.resource.utils import cloneResourceDirectory
+from plone.resource.utils import iterDirectoriesOfType
 from plone.resource.utils import queryResourceDirectory
 from plone.subrequest import subrequest
 from urlparse import urlsplit
@@ -61,7 +62,6 @@ def resolve(self, system_url, public_id, context):
 
 def resolvePythonURL(url):
     """Resolve the python resource url to it's path
-
     This can resolve python://dotted.package.name/file/path URLs to paths.
     """
     assert url.lower().startswith('python://')
@@ -235,10 +235,8 @@ def isValidThemeDirectory(directory):
 
 def extractThemeInfo(zipfile, checkRules=True):
     """Return an ITheme based on the information in the given zipfile.
-
     Will throw a ValueError if the theme directory does not contain a single
     top level directory or the rules file cannot be found.
-
     Set checkRules=False to disable the rules check.
     """
 
@@ -330,14 +328,39 @@ def getTheme(name, manifest=None, resources=None):
 def getAvailableThemes():
     """Get a list of all ITheme's available in resource directories.
     """
-    resources = getAllResources(MANIFEST_FORMAT, filter=isValidThemeDirectory)
+    resources = getThemeResources(MANIFEST_FORMAT, filter=isValidThemeDirectory)
     themes = []
-    for name, manifest in resources.items():
-        themes.append(getTheme(name, manifest))
+    for theme in resources:
+        themes.append(getTheme(theme['name'], theme))
 
     themes.sort(key=lambda x: safe_unicode(x.title))
     return themes
 
+def getThemeResources(format, defaults=None, filter=None, manifestFilename=MANIFEST_FILENAME):
+
+    resources = []
+
+    for directory in iterDirectoriesOfType(format.resourceType, filter_duplicates=False):
+
+        if filter is not None and not filter(directory):
+            continue
+
+        name = directory.__name__
+
+        if directory.isFile(manifestFilename):
+
+            manifest = directory.openFile(manifestFilename)
+            try:
+                theme = getManifest(manifest, format, defaults)
+                theme['name'] = name
+                resources.append(theme)
+            except:
+                LOGGER.exception("Unable to read manifest for theme directory %s", name)
+            finally:
+                manifest.close()
+
+    return resources
+
 
 def getThemeFromResourceDirectory(resourceDirectory):
     """Return a Theme object from a resource directory
@@ -504,11 +527,6 @@ def createThemeFromTemplate(title, description, baseOn='template'):
         themeName = themeName.encode('utf-8')
 
     resources = getOrCreatePersistentResourceDirectory()
-    if themeName in resources:
-        idx = 1
-        while '-'.join((themeName, idx)) in resources:
-            idx += 1
-        themeName = '-'.join((themeName, idx))
 
     resources.makeDirectory(themeName)
     target = resources[themeName]


