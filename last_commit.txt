Repository: plone.app.content
Branch: refs/heads/master
Date: 2015-05-02T21:22:50-05:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.app.content/commit/2f40444a65df0dd81dc52265580dc4510c6afa8e

provide _authenticator token on old style createObject factory views close https://github.com/plone/Products.CMFPlone/issues/474

Files changed:
M CHANGES.rst
M plone/app/content/browser/folderfactories.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 3e81bf2..21ae447 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,6 +4,9 @@ Changelog
 3.0.4 (unreleased)
 ------------------
 
+- provide _authenticator token on old style createObject factory views
+  [vangheem]
+
 - Translate folder contents add menu
   [vangheem]
 
diff --git a/plone/app/content/browser/folderfactories.py b/plone/app/content/browser/folderfactories.py
index 088583b..7d505ad 100644
--- a/plone/app/content/browser/folderfactories.py
+++ b/plone/app/content/browser/folderfactories.py
@@ -8,6 +8,7 @@
 from plone.i18n.normalizer.interfaces import IIDNormalizer
 from plone.memoize.instance import memoize
 from plone.memoize.request import memoize_diy_request
+from plone.protect.authenticator import createToken
 from urllib import quote_plus
 from zope.component import getMultiAdapter
 from zope.component import queryUtility
@@ -82,6 +83,7 @@ def addable_types(self, include=None):
 
         addContext = self.add_context()
         baseUrl = addContext.absolute_url()
+        token = createToken()
 
         allowedTypes = _allowedTypes(request, addContext)
 
@@ -112,8 +114,8 @@ def addable_types(self, include=None):
                     url = addAction['url']
 
                 if not url:
-                    url = '%s/createObject?type_name=%s' % (baseUrl,
-                                                            quote_plus(typeId))
+                    url = '%s/createObject?type_name=%s&_authenticator=%s' % (
+                        baseUrl, quote_plus(typeId), token)
 
                 icon = t.getIconExprObject()
                 if icon:


