Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2015-07-13T13:29:20+02:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.app.contenttypes/commit/e505c4e8a3961e26fe6f882ca0258abb865ac0c1

Fix @@custom_migraton when they type-name has a space (fixes #243)

Files changed:
M plone/app/contenttypes/migration/custom_migration.pt
M plone/app/contenttypes/migration/custom_migration.py
M plone/app/contenttypes/migration/custom_migration_display_dx_fields.pt

diff --git a/plone/app/contenttypes/migration/custom_migration.pt b/plone/app/contenttypes/migration/custom_migration.pt
index db21bae..12ba748 100644
--- a/plone/app/contenttypes/migration/custom_migration.pt
+++ b/plone/app/contenttypes/migration/custom_migration.pt
@@ -41,14 +41,15 @@
     <script type="text/javascript">
         // function that toggle an icon by calling the p_viewName view
         function getDXFields(at_typename, dx_typename) {
+          at_safe = at_typename.replace(' ', '_space_');
           $.ajax({
             url: '@@display_dx_fields',
             dataType: 'html',
-            data: {at_typename: at_typename,
-                   dx_typename: dx_typename},
+            data: {'at_typename': at_typename,
+                   'dx_typename': dx_typename},
             cache: false,
             success: function(data) {
-                var $div = $('#hook_at_fti_' + at_typename);
+                var $div = $('#hook_at_fti_' + at_safe);
                 $div.empty();
                 $div.html(data);
               },
@@ -97,25 +98,27 @@
                   tal:attributes="action python:context.absolute_url() + '/@@custom_migration'">
             <table>
                 <tr tal:repeat="at_type at_types">
-                <p tal:content="at_type"></p>
+                  <tal:block tal:define="safe_at_id python:at_type['id'].replace(' ', '_space_')">
                     <td valign="top">
                         <p tal:content="at_type/title" style="font-weight: bold;">AT content type title</p>
                         <tal:block repeat="field python: view.getFieldsForATType(at_type)">
                             <p tal:content="field/title">Field name</p>
-                            <input type="hidden" tal:attributes="name string:${at_type/id}:list;
+                            <input type="hidden" tal:attributes="name string:${safe_at_id}:list;
                                                                  value string:${field/id}__type__${field/type};" />
                         </tal:block>
                     </td>
                     <td valign="top">
                         <select tal:attributes="onChange string:javascript:getDXFields(at_typename='${at_type/id}', this.value);
-                                                name string:dx_select_${at_type/id};"
+                                                name string:dx_select_${safe_at_id};"
                                 class="selectedType">
                             <option value="" selected="selected">Do not migrate</option>
                             <option tal:repeat="dx_type view/getDXFTIs"
                                     tal:attributes="value dx_type/id"
                                     tal:content="dx_type/title">DX type name</option>
                         </select>
-                        <div id="hook_at_fti" class="field fieldsMapping" tal:attributes="id string:hook_at_fti_${at_type/id}" />
+                        <div id="hook_at_fti_News_Item"
+                             class="field fieldsMapping"
+                             tal:attributes="id string:hook_at_fti_${safe_at_id}" />
                         <br />
                         <div class="testConfig">
                             <input type="submit"
@@ -126,6 +129,7 @@
                                    i18n:domain="plone"/>&nbsp;
                         </div>
                     </td>
+                  </tal:block>
                 </tr>
             </table>
             <div>
diff --git a/plone/app/contenttypes/migration/custom_migration.py b/plone/app/contenttypes/migration/custom_migration.py
index 24f5bf4..b26680b 100644
--- a/plone/app/contenttypes/migration/custom_migration.py
+++ b/plone/app/contenttypes/migration/custom_migration.py
@@ -234,7 +234,9 @@ def migrate(self, dry_run=False):
                 # definition we have 2 keys we relevant mappings, first key
                 # is the AT typename second key is a particular key like
                 # 'dx_DXPortalType__for__MyATPortalType
-                dx_key = 'dx_%s__for__%s' % (dx_typename, at_typename)
+                safe_dx = dx_typename.replace('_space_', '')
+                safe_at = at_typename.replace('_space_', '')
+                dx_key = 'dx_%s__for__%s' % (safe_dx, safe_at)
                 for at_field in form[at_typename]:
                     dx_field = form[dx_key][form[at_typename].index(at_field)]
                     if not dx_field:
@@ -268,8 +270,8 @@ class DisplayDXFields(CustomMigrationForm):
 
     def __init__(self, context, request):
         CustomMigrationForm.__init__(self, context, request)
-        self.at_typename = request.get('at_typename')
-        self.dx_typename = request.get('dx_typename')
+        self.at_typename = request.form.get('at_typename')
+        self.dx_typename = request.form.get('dx_typename')
 
     def __call__(self):
         '''
diff --git a/plone/app/contenttypes/migration/custom_migration_display_dx_fields.pt b/plone/app/contenttypes/migration/custom_migration_display_dx_fields.pt
index 775f40a..c8829ca 100644
--- a/plone/app/contenttypes/migration/custom_migration_display_dx_fields.pt
+++ b/plone/app/contenttypes/migration/custom_migration_display_dx_fields.pt
@@ -1,8 +1,13 @@
-<tal:loop repeat="at_field python: view.getFieldsForATTypeWithoutFTI(view.at_typename)">
-    <select tal:attributes="name string:dx_${view/dx_typename}__for__${view/at_typename}:list;">
+<tal:block tal:define="dx_typename view/dx_typename;
+                       at_typename view/at_typename;
+                       safe_dx_typename python:dx_typename.replace(' ', '_space_');
+                       safe_at_typename python:at_typename.replace(' ', '_space_')">
+<tal:loop repeat="at_field python: view.getFieldsForATTypeWithoutFTI(at_typename)">
+    <select tal:attributes="name string:dx_${safe_dx_typename}__for__${safe_at_typename}:list;">
         <option value="">Do not migrate</option>
-        <option tal:repeat="dx_field python: view.getFieldsForDXType(view.dx_typename)"
+        <option tal:repeat="dx_field python: view.getFieldsForDXType(dx_typename)"
                 tal:attributes="value string:${dx_field/id}__type__${dx_field/type};"
                 tal:content="string:${dx_field/title}">DX field name</option>
     </select>
 </tal:loop>
+</tal:block>
\ No newline at end of file


