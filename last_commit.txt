Repository: plone.app.querystring


Branch: refs/heads/master
Date: 2015-08-03T18:26:00+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.querystring/commit/191665d0ca1bb9dd20896f7ed5f5f7c3fd79c121

Fixed possible problem with 'custom_query' parameter.

Theoretically a second invocation could inadvertently be using the
value from the first invocation.

Do not use a dictionary (or any mutable object) as a default value for
a keyword argument.

Files changed:
M CHANGES.rst
M plone/app/querystring/querybuilder.py

diff --git a/CHANGES.rst b/CHANGES.rst
index b7d47ad..49567ed 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,10 @@ Changelog
 1.3.4 (unreleased)
 ------------------
 
-- Nothing changed yet.
+- Fixed possible problem with ``custom_query`` parameter where
+  theoretically a second invocation could inadvertently be using the
+  value from the first invocation.
+  [maurits]
 
 
 1.3.3 (2015-07-18)
diff --git a/plone/app/querystring/querybuilder.py b/plone/app/querystring/querybuilder.py
index f9f71ae..9b65380 100644
--- a/plone/app/querystring/querybuilder.py
+++ b/plone/app/querystring/querybuilder.py
@@ -38,7 +38,7 @@ def __init__(self, context, request):
 
     def __call__(self, query, batch=False, b_start=0, b_size=30,
                  sort_on=None, sort_order=None, limit=0, brains=False,
-                 custom_query={}):
+                 custom_query=None):
         """Create a zope catalog query and return results.
 
         :param query: The querystring to be parsed into a zope catalog query.
@@ -71,7 +71,8 @@ def __call__(self, query, batch=False, b_start=0, b_size=30,
         :param custom_query: A dictionary of index names and their associated
                              query values. The custom_query updates the parsed
                              query, thus overriding the query string.
-        :type custom_query: dictionary
+                             May be None.
+        :type custom_query: dictionary or None
 
         """
         if self._results is None:
@@ -102,7 +103,7 @@ def html_results(self, query):
 
     def _makequery(self, query=None, batch=False, b_start=0, b_size=30,
                    sort_on=None, sort_order=None, limit=0, brains=False,
-                   custom_query={}):
+                   custom_query=None):
         """Parse the (form)query and return using multi-adapter"""
         parsedquery = queryparser.parseFormquery(
             self.context, query, sort_on, sort_order)


